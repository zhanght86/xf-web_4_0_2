/*! xf 2017-12-06 */
"use strict";function knowledgeAddServer($resource){function getDataServer(url,params,onSuccess,onError,needToken,ajaxType,timeout,timeoutCall){var url=url,header={Accept:"text/plain,text/html,application/json","Content-Type":"application/json"};return $resource(url,{},{create:{method:ajaxType||"POST",params:{},timeout:timeout||1e4,headers:header}}).create(JSON.stringify(params)).$promise.then(onSuccess,onError)}function getDimensions(params,onSuccess,onError){return $resource("/api/application/dimension/list",{},{create:{method:"POST",params:{}}}).create(JSON.stringify(params)).$promise.then(onSuccess,onError)}function getChannels(params,onSuccess,onError){return $resource("/api/application/channel/listChannels",{},{create:{method:"POST",params:{}}}).create(JSON.stringify(params)).$promise.then(onSuccess,onError)}function faqSave(params,onSuccess,onError){return $resource("/api/ms/faqKnowledge/addFAQKnowledge",{},{create:{method:"POST",params:{}}}).create(JSON.stringify(params)).$promise.then(onSuccess,onError)}function getFrame(id){return $resource("/api/ms/modeling/frame/listbyattribute",{},{}).save()}function conceptGetExtensionByDialogTitle(params,onSuccess,onError){return $resource("/api/ms/conceptKnowledge/productExtensionQuestion",{},{create:{method:"POST",params:{}}}).create(JSON.stringify(params)).$promise.then(onSuccess,onError)}return{getDimensions:getDimensions,getChannels:getChannels,getFrame:getFrame,faqSave:faqSave,conceptGetExtensionByDialogTitle:conceptGetExtensionByDialogTitle,getDataServer:getDataServer}}knowledge_static_web.controller("ApplicationController",["$scope","$location","$anchorScroll","AuthService","TipService","AUTH_EVENTS","$timeout","ngDialog","$interval","$state","localStorageService","$stateParams","$sce","$window","KnowDocService","knowledgeAddServer","$cookieStore",function($scope,$location,$anchorScroll,AuthService,TipService,AUTH_EVENTS,$timeout,ngDialog,$interval,$state,localStorageService,$stateParams,$sce,$window,KnowDocService,knowledgeAddServer,$cookieStore){function isTitleHasTag(title,arr){var result=!1;return angular.forEach(arr,function(item){item.extensionQuestionTitle==title&&(result=!0)}),result}function querydimensionList(applicationId){knowledgeAddServer.getDimensions({applicationId:applicationId},function(data){data.data&&($scope.master.dimensionList=data.data)},function(error){})}function queryChannelList(applicationId){knowledgeAddServer.getChannels({applicationId:applicationId},function(data){data.data&&($scope.master.channelList=data.data)},function(error){})}function slideToggle(el,callBack){$timeout(function(){angular.element(el).slideToggle()},50),callBack&&callBack()}function setNgTimeOut(callBack,time){$timeout(callBack,time)}function setNgInterval(callBack,time){$interval(callBack,time)}function openNgDialog(self,tempUrl,width,closeIssue,closeClear,closeCondition,complex){function open(){ngDialog.openConfirm({template:tempUrl,width:width,scope:self,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){1===e?closeIssue&&closeIssue():closeClear&&closeClear(),closeCondition&&closeCondition()}})}var diaSize=angular.element(".ngdialog ").length;"true"!=complex&&diaSize<1?open():"true"==complex&&open()}function getDimensions(self,arr){knowledgeAddServer.getDimensions({applicationId:APPLICATION_ID},function(data){data.data&&angular.forEach(arr,function(item){self.vm[item]=data.data})},function(error){})}function getChannels(self,arr){knowledgeAddServer.getChannels({applicationId:APPLICATION_ID},function(data){data.data&&angular.forEach(arr,function(item){self.vm[item]=data.data})},function(error){})}function isBotRepeat(id,path,type,allBot){var result={className:path,classificationId:id,classificationType:type||67},len=allBot.length,backUpPath=angular.copy(path).join("/");return len&&angular.forEach(allBot,function(item){if(item.className.join("/")==backUpPath)return result=!1,layer.msg("添加分类重复，已阻止添加")}),result}function searchBotAutoTag(el,url,callback){$(el).autocomplete({serviceUrl:url,type:"POST",params:{categoryName:$(el).val(),categoryAttributeName:"node",categoryApplicationId:APPLICATION_ID},paramName:"categoryName",dataType:"json",transformResult:function(data){var result={suggestions:[]};return data.data&&angular.forEach(data.data,function(item){result.suggestions.push({data:item.categoryId,value:item.categoryName,type:item.categoryTypeId})}),result},onSelect:function(suggestion){callback(suggestion)}})}function searchAppointAutoTag(self,el,url,responseList,callback){function listener(){$(el).on("input",function(){var title=$(el).val();httpRequestPost(url,{title:title,applicationId:APPLICATION_ID},function(data){self.$apply(function(){self.vm[responseList]=data.data})},function(){})})}function blur(){$timeout(function(){self.$apply(function(){self.vm[responseList]=[]})},200)}function select(item,arr){-1==arr.indexOf(item)?arr.push(item):layer.msg("相关问添加重复")}function remove(item){self.vm.appointRelativeGroup.remove(item)}return{listener:listener,blur:blur,select:select,remove:remove}}function isExtensionTagRepeat(current,allExtension,title,weight){var isRepeat=!0,tag=[];if(angular.forEach(current,function(tagList){angular.forEach(tagList.extensionQuestionTagList,function(item){item.exist&&tag.push(item.tagName)})}),angular.forEach(allExtension,function(extension){var tagLen=0,itemTag=[];angular.forEach(extension.extensionQuestionTagList,function(item){item.exist&&itemTag.push(item.tagName),tag.inArray(item.tagName)&&item.exist&&(tagLen+=1)}),tagLen==itemTag.length&&tag.length==itemTag.length&&(layer.msg('根据"'+title+'"生成扩展问重复,已阻止添加'),isRepeat=!1)}),0!=isRepeat){var extension={extensionQuestionTitle:title,extensionQuestionType:weight,wholeDecorateTagList:[{wholeDecorateTagNameList:[],wholeDecorateTagType:"36"},{wholeDecorateTagNameList:[],wholeDecorateTagType:"37"},{wholeDecorateTagNameList:[],wholeDecorateTagType:"38"}],extensionQuestionTagList:[]};angular.forEach(current,function(tagList){angular.forEach(tagList.extensionQuestionTagList,function(item){var tagTem={exist:item.exist,tagClass:item.tagClass,tagName:item.tagName,tagType:item.tagType};extension.extensionQuestionTagList.push(tagTem)})}),isRepeat=extension}return isRepeat}function removeExtensionHasTag(self,container,item){item.wholeDecorateTagList=[{wholeDecorateTagNameList:[],wholeDecorateTagType:"36"},{wholeDecorateTagNameList:[],wholeDecorateTagType:"37"},{wholeDecorateTagNameList:[],wholeDecorateTagType:"38"}],self.vm[container].push(item)}function botTreeOperate(self,initUrl,getNodeUrl,selectCall,searchAutoUrl,parentNode){function getChildNode(){$(parentNode).on("click","i",function(){var id=$(this).attr("data-option"),that=$(this);that.parent().parent().siblings().length?"0% 0%"==that.css("backgroundPosition")?(that.css("backgroundPosition","0% 100%"),that.parent().parent().next().slideDown()):(that.css("backgroundPosition","0% 0%"),that.parent().parent().next().slideUp()):(that.css("backgroundPosition","0% 100%"),httpRequestPost(getNodeUrl,{categoryApplicationId:APPLICATION_ID,categoryPid:id},function(data){if(data.data){for(var html='<ul class="menus">',i=0;i<data.data.length;i++){var typeClass;0==data.data[i].categoryLeaf?typeClass="bot-leaf":0!=data.data[i].categoryLeaf&&"edge"==data.data[i].categoryAttributeName?typeClass="bot-edge":0!=data.data[i].categoryLeaf&&"node"==data.data[i].categoryAttributeName&&(typeClass="icon-jj");var backImage;switch(data.data[i].categoryTypeId){case 160:backImage=" bot-divide";break;case 161:backImage=" bot-process";break;case 162:backImage=" bot-attr";break;case 163:backImage=" bot-default"}html+='<li><div class="slide-a"> <a class="ellipsis" href="javascript:;">',html+='<i class="'+typeClass+backImage+'" data-option="'+data.data[i].categoryId+'"></i>',html+="<span>"+data.data[i].categoryName+"</span></a></div></li>"}html+="</ul>",$(html).appendTo(that.parent().parent().parent()),that.parent().parent().next().slideDown()}},function(err){}))})}function selectNode(){$(parentNode).on("click","span",function(){var pre=$(this).prev();angular.element(".icon-jj").css("backgroundPosition","0% 0%");var id=pre.attr("data-option");selectCall(id),angular.element(parentNode).slideToggle(),angular.element(".menu").slideToggle()})}parentNode=parentNode||".aside-navs";var tree={init:function(){httpRequestPost(initUrl,{categoryApplicationId:APPLICATION_ID,categoryPid:"root"},function(data){self.vm.botRoot=data.data},function(error){})},getChildNode:getChildNode,selectNode:selectNode};tree.init(),tree.getChildNode(),tree.selectNode()}$scope.master={headImage:$cookieStore.get("robotHead"),applicationName:APPLICATION_NAME,slideToggle:slideToggle,openNgDialog:openNgDialog,setNgTimeOut:setNgTimeOut,setNgInterval:setNgInterval,dimensionList:"",channelList:"",getDimensions:getDimensions,getChannels:getChannels,isBotRepeat:isBotRepeat,searchBotAutoTag:searchBotAutoTag,searchAppointAutoTag:searchAppointAutoTag,isExtensionTagRepeat:isExtensionTagRepeat,removeExtensionHasTag:removeExtensionHasTag,isTitleHasTag:isTitleHasTag,botTreeOperate:botTreeOperate},querydimensionList(APPLICATION_ID),queryChannelList(APPLICATION_ID),$scope.currentUser=null,$scope.isAuthorized=AuthService.isAuthorized,$scope.currentPage=1,$scope.pageSize=10,$scope.tipService=TipService,$scope.backTage=!($location.url().indexOf("index")>0),$scope.getCurrentUserId=function(){return $scope.currentUser&&$scope.currentUser.id?$scope.currentUser.id:localStorageService.get("SessionId")?localStorageService.get("SessionId"):null},$scope.goto=function(id){$location.hash(id),$anchorScroll()},$scope.initSearchPOJO=function(){return $stateParams.isGo||!localStorageService.get($state.current.name)?{currentPage:$scope.currentPage,pageSize:$scope.pageSize}:localStorageService.get($state.current.name)},$scope.notEmpty=function(param){return null!=param&&void 0!=param&&""!=$.trim(param)},$scope.sceConvertHtml=function(objectList){return $scope.notEmpty(objectList)&&objectList.length>0&&objectList.forEach(function(item){var title=$sce.trustAsHtml(item.title),content=$sce.trustAsHtml(item.content);item.titleHtml=title,item.contentHtml=content}),objectList},$scope.CheckStr=function(str){return!!new RegExp("[`~!@#$^&*()=|{}':;',\\[\\].<>/?~！@#￥……&*（）——|{}\"%'+-/_【】‘；：”“'。，、？]").test(str)},$scope.format=function(time,format){var t=new Date(time),tf=function(i){return(i<10?"0":"")+i};return format.replace(/yyyy|MM|dd|HH|mm|ss/g,function(a){switch(a){case"yyyy":return tf(t.getFullYear());case"MM":return tf(t.getMonth()+1);case"mm":return tf(t.getMinutes());case"dd":return tf(t.getDate());case"HH":return tf(t.getHours());case"ss":return tf(t.getSeconds())}})},$scope.changeURLArg=function(url,arg,arg_val){var pattern=arg+"=([^&]*)",replaceText=arg+"="+arg_val;if(url.match(pattern)){var tmp="/("+arg+"=)([^&]*)/gi";return tmp=url.replace(eval(tmp),replaceText)}return url.match("[?]")?url+"&"+replaceText:url+"?"+replaceText},$scope.storeParams=function(value){var key=$state.current.name;localStorageService.set(key,value)},$scope.goHistory=function(){$window.history.back()},$scope.$on(AUTH_EVENTS.notAuthorized,function(event,data){}),$scope.$on(AUTH_EVENTS.logoutSuccess,function(event,data){}),$scope.$on(AUTH_EVENTS.loginSuccess,function(event,data){$scope.initKnowCheckNoticeView(),$scope.initNoCheckTaskView(),$scope.initAnalyseTaskCount()})}]),angular.module("adminModule").controller("adminController",["$scope","$state","$stateParams",function($scope,$state,$stateParams){$state.go("admin.manage",{userPermission:$stateParams.userPermission})}]),angular.module("adminModule").controller("adminContentController",["$scope","$state","$timeout","$stateParams","ngDialog","$cookieStore","$rootScope",function($scope,$state,$timeout,$stateParams,ngDialog,$cookieStore,$rootScope){function selectScene(id,applicationId){$cookieStore.put("sceneId",id),$cookieStore.put("applicationId",applicationId),$.getScript("/js/common/config.js")}function getUserInfo(){httpRequestPost("/api/user/findRoleIdByUserId",{userId:$cookieStore.get("userId")},function(data){$scope.vm.userPermission=data.data.roleList,$scope.$apply()},function(err){})}function myApplication(){httpRequestPost("/api/application/application/listApplicationByUserId",{userId:$cookieStore.get("userId")},function(data){$scope.vm.myApplication=data.data,$scope.$apply()},function(err){})}function selectLicence(){httpRequestPost("/api/application/scene/listAllScene",{},function(data){return $scope.vm.selectLicence=data.data,$scope.vm.newScene=data.data[0].sceneId,$scope.$apply(),data.data},function(err){})}function addApplicationWindow(){ngDialog.openConfirm({template:"/static/admin/addAdmin.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){if(1===e){if(0==applicationValidate())return!1;addApplication()}else $scope.vm.newApplicationName="",$scope.vm.newLicence="",$scope.vm.newDescribe=""}})}function applicationValidate(){return 0==lengthCheck($scope.vm.newApplicationName,0,50)?(layer.msg("应用名称不能为空或超过长度限制50"),!1):0!=lengthCheck($scope.vm.newLicence,0,20)||(layer.msg("LICENSE不能为空或超过长度限制20"),!1)}function addApplication(){httpRequestPost("/api/application/application/addApplication",{userId:$cookieStore.get("userId"),applicationName:$scope.vm.newApplicationName,sceneId:$scope.vm.newScene,applicationLisence:$scope.vm.newLicence,applicationDescription:$scope.vm.newDescribe},function(data){200==data.status?$state.reload():(layer.msg(data.info),$scope.vm.newApplicationName="",$scope.vm.newLicence="",$scope.vm.newDescribe="")},function(err){})}$scope.vm={userName:$cookieStore.get("userName"),userPermission:$stateParams.userPermission,addApplicationWindow:addApplicationWindow,myApplication:"",selectLicence:"",newApplicationName:"",newScene:"",newLicence:"",newDescribe:"",selectScene:selectScene},getUserInfo(),myApplication(),selectLicence()}]),angular.module("adminModule").controller("userManageController",["$scope","localStorageService","$state","$timeout","$stateParams","ngDialog","$cookieStore",function($scope,localStorageService,$state,$timeout,$stateParams,ngDialog,$cookieStore){function selectAll(ev){$scope.vm.selectAllCheck?($scope.vm.selectAllCheck=!1,$scope.vm.deleteIds=[]):($scope.vm.selectAllCheck=!0,$scope.vm.deleteIds=[],angular.forEach($scope.vm.listData,function(item){$scope.vm.deleteIds.push(item.userId)}))}function selectSingle(ev,id){$scope.vm.deleteIds.inArray(id)?($scope.vm.deleteIds.remove(id),$scope.vm.selectAllCheck=!1):$scope.vm.deleteIds.push(id)}function getData(index){$scope.vm.deleteIds=[],httpRequestPost("/api/user/listUser",{index:(index-1)*$scope.vm.pageSize,pageSize:$scope.vm.pageSize},function(data){$scope.vm.listData=data.data.userManageList,$scope.vm.userDataTotal=data.data.total,$scope.vm.paginationConf={currentPage:index,totalItems:data.data.total,pageSize:$scope.vm.pageSize,pagesLength:8},$scope.$apply()},function(){})}function verifyRelease(){return null==$scope.vm.userName||""==$scope.vm.userName?(layer.msg("姓名不能为空!"),$scope.vm.allowSubmit=0,0):/^[A-Za-z\u4e00-\u9fa5]+$/.test($scope.vm.userName)?$scope.vm.userName.length>20?(layer.msg("姓名的长度不能超过20个字符!"),$scope.vm.allowSubmit=0,0):null==$scope.vm.userLoginName||""==$scope.vm.userLoginName?(layer.msg("登录名不能为空!"),$scope.vm.allowSubmit=0,0):/^[0-9a-zA-Z_]{4,20}$/.test($scope.vm.userLoginName)?null==$scope.vm.userPassword||""==$scope.vm.userPassword?(layer.msg("密码不能为空!"),$scope.vm.allowSubmit=0,0):/^[0-9a-zA-Z]+$/.test($scope.vm.userPassword)?$scope.vm.userPassword.length>20?(layer.msg("密码长度不能超过20个字符!"),$scope.vm.allowSubmit=0,0):null==$scope.vm.userPhoneNumber||""==$scope.vm.userPhoneNumber?(layer.msg("手机号不能为空!"),$scope.vm.allowSubmit=0,0):/^1[0-9]{10}$/.test($scope.vm.userPhoneNumber)?null==$scope.vm.userEmail||""==$scope.vm.userEmail?(layer.msg("邮箱不能为空!"),$scope.vm.allowSubmit=0,0):0==$scope.vm.prop.length?(layer.msg("请至少选择一个应用!"),$scope.vm.allowSubmit=0,0):1:(layer.msg("手机号只可以为1开头的11位数字!"),$scope.vm.allowSubmit=0,0):(layer.msg("密码只可以是数字和字母组合!"),$scope.vm.allowSubmit=0,0):(layer.msg("登录名只可以是数字、字母、下划线组合，4-20个字符!",{time:1e3}),$scope.vm.allowSubmit=0,0):(layer.msg("姓名只可以输入汉字或字母的组合!"),$scope.vm.allowSubmit=0,0)}function addUser(){ngDialog.openConfirm({template:"/static/admin/userManageDialog.html",width:"680px",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){1===e?($scope.vm.allowSubmit&&httpRequestPost("/api/user/addUser",{userId:$scope.vm.userId,userName:$scope.vm.userName,userLoginName:$scope.vm.userLoginName,userPassword:$scope.vm.userPassword,userPhoneNumber:$scope.vm.userPhoneNumber,userEmail:$scope.vm.userEmail,roleId:$scope.vm.roleId,applicationIds:$scope.vm.prop,remark:$scope.vm.remark},function(data){$state.reload(),10009==data.status?layer.msg("该登录名已经存在，请重新添加!"):10008==data.status&&layer.msg("用户添加成功!")},function(){}),$scope.vm.userName="",$scope.vm.userLoginName="",$scope.vm.userPassword="",$scope.vm.userPassWord="",$scope.vm.userPhoneNumber="",$scope.vm.userEmail="",$scope.vm.prop=[],$scope.vm.remark=""):($scope.vm.userName="",$scope.vm.userLoginName="",$scope.vm.userPassword="",$scope.vm.userPassWord="",$scope.vm.userPhoneNumber="",$scope.vm.userEmail="",$scope.vm.prop=[],$scope.vm.remark="")}})}function editUser(data){$scope.vm.userId=data.userId,$scope.vm.userName=data.userName,$scope.vm.userLoginName=data.userLoginName,$scope.vm.userPassword=data.userPassword,$scope.vm.userPassWord=data.userPassword,$scope.vm.userPhoneNumber=data.userPhoneNumber,$scope.vm.userEmail=data.userEmail,$scope.vm.remark=data.remark,$scope.vm.roleId=data.roleId,$scope.vm.roleName=data.roleName,$scope.vm.prop=data.applicationName,$scope.vm.applicationIds=data.applicationIds,$scope.vm.modifyRoleid=$scope.vm.roleId;ngDialog.openConfirm({template:"/static/admin/userManageDialog2.html",width:"680px",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){1===e?$scope.vm.allowSubmit&&httpRequestPost("/api/user/updateUserById",{userId:data.userId,userName:$scope.vm.userName,userLoginName:$scope.vm.userLoginName,userPassword:$scope.vm.userPassword,userPhoneNumber:$scope.vm.userPhoneNumber,userEmail:$scope.vm.userEmail,roleId:$scope.vm.modifyRoleid,applicationIds:$scope.vm.applicationIds,remark:$scope.vm.remark},function(data){$state.reload(),10012==data.status?layer.msg("用户修改成功!"):(data.status=10009)&&layer.msg("登录名重复!")},function(){}):($scope.vm.userName="",$scope.vm.userLoginName="",$scope.vm.userPassword="",$scope.vm.userPassWord="",$scope.vm.userPhoneNumber="",$scope.vm.userEmail="",$scope.vm.prop=[],$scope.vm.remark="")}})}function search(index){""==$scope.vm.searchName||null==$scope.vm.searchName?getData(1):httpRequestPost("/api/user/queryUserByUserName",{userName:$scope.vm.searchName,index:(index-1)*$scope.vm.pageSize,pageSize:$scope.vm.pageSize},function(data){10016==data.status&&($scope.vm.listData="",$scope.vm.userDataTotal=0,$scope.$apply(),layer.msg("没有查询到记录!")),$scope.vm.listData=data.data.userManageList,$scope.vm.userDataTotal=data.data.total,$scope.vm.paginationConf={currentPage:index,totalItems:data.data.total,pageSize:$scope.vm.pageSize,pagesLength:8},$scope.$apply()},function(){})}function deleteUser(userId){ngDialog.openConfirm({template:"/static/admin/deleteDialog.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){1===e&&httpRequestPost("/api/user/deleteUser",{userId:userId},function(data){10010==data.status&&layer.msg("用户删除成功!"),$state.reload()},function(){})}})}function deleteUsers(){if(0==$scope.vm.deleteIds)return void layer.msg("请您选择要删除的用户！");ngDialog.openConfirm({template:"/static/admin/deleteDialog.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){1===e&&httpRequestPost("/api/user/deleteUserByIds",{ids:$scope.vm.deleteIds},function(data){$state.reload()},function(){})}})}function stop(userId,statusId){if(10002==statusId){ngDialog.openConfirm({template:"/static/admin/updateDialog1.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){1===e&&httpRequestPost("/api/user/updateStatus",{userId:userId,statusId:statusId},function(data){$state.reload(),10012==data.status&&layer.msg("用户状态修改成功!")},function(){})}})}else{ngDialog.openConfirm({template:"/static/admin/updateDialog.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){1===e&&httpRequestPost("/api/user/updateStatus",{userId:userId,statusId:statusId},function(data){$state.reload(),10012==data.status&&layer.msg("用户状态修改成功!")},function(){})}})}}function getApplication(){httpRequestPost("/api/application/application/listAllApplication",{},function(data){$scope.vm.listApplication=data.data},function(){})}function getRole(){httpRequestPost("/api/user/role/findAll",{},function(data){$scope.vm.listRole=data.data,$scope.vm.roleId=data.data[0].roleId,$scope.$apply()},function(){})}function savaProp(ev,id){$(ev.target).prop("checked")?$scope.vm.prop.push(id):$scope.vm.prop.remove(id)}function saveProp(ev,id){$(ev.target).prop("checked")?$scope.vm.applicationIds.push(id):$scope.vm.applicationIds.remove(id)}function filter(val,arr){for(var len=arr.length,i=0;i<arr.length;i++)val!=arr[i]&&(len-=1);return 0!=len}$state.go("admin.userManage"),$scope.vm={listData:"",getData:getData,paginationConf:"",userDataTotal:"",pageSize:5,addUser:addUser,editUser:editUser,deleteUser:deleteUser,search:search,stop:stop,userId:$cookieStore.get("userId"),verifyRelease:verifyRelease,userName:"",userLonginName:"",userPassword:"",userPassWord:"",userPhoneNumber:"",userEmail:"",remark:"",allowSubmit:1,searchName:"",listApplication:"",listRole:"",roleId:"",prop:[],applicationIds:[],savaProp:savaProp,saveProp:saveProp,filter:filter,selectAll:selectAll,selectSingle:selectSingle,deleteIds:[],selectAllCheck:!1,deleteUsers:deleteUsers,modifyRoleid:""},getData(1);var timeout;$scope.$watch("vm.paginationConf.currentPage",function(current){current&&(timeout&&$timeout.cancel(timeout),timeout=$timeout(function(){$scope.vm.searchName?search(current):getData(current)},0))},!0),getApplication(),getRole()}]),angular.module("adminModule").controller("roleManageController",["$scope","localStorageService","$state","$timeout","$stateParams","ngDialog","$cookieStore",function($scope,localStorageService,$state,$timeout,$stateParams,ngDialog,$cookieStore){function search(){httpRequestPost("/api/user/role/findAll",{roleName:$scope.vm.roleName},function(data){$scope.vm.listData=data.data,$scope.$apply()},function(){})}function addRole(){ngDialog.openConfirm({template:"/static/admin/addRole.html",width:"650px",scope:$scope,closeByNavigation:!1,overlay:!0,closeByDocument:!1,closeByEscape:!0,showClose:!0,preCloseCallback:function(e){if(1===e){if(""==$scope.vm.addRoleName)return layer.msg("角色名不能为空"),!1;if(""==$scope.vm.roleDescribe)return layer.msg("角色描述不能为空"),!1;newRole()}}})}function roleModular(ids){var ids=ids.toString();$scope.vm.roleIds.inArray(ids)?$scope.vm.roleIds.remove(ids):$scope.vm.roleIds.push(ids)}function selectAll(){$scope.vm.isSelectAll?($scope.vm.isSelectAll=!1,$scope.vm.deleteIds=[]):($scope.vm.isSelectAll=!0,$scope.vm.deleteIds=[],angular.forEach($scope.vm.listData,function(val){$scope.vm.deleteIds.push(val.roleId)}))}function selectSingle(id){$scope.vm.deleteIds.inArray(id)?($scope.vm.deleteIds.remove(id),$scope.vm.isSelectAll=!1):$scope.vm.deleteIds.push(id),$scope.vm.deleteIds.length==$scope.vm.listData.length&&($scope.vm.isSelectAll=!0)}function newRole(){httpRequestPost("/api/user/role/add ",{roleName:$scope.vm.addRoleName,roleDescribe:$scope.vm.roleDescribe,permissionId:$scope.vm.roleIds.join(","),creatorName:USER_NAME},function(data){if(200==data.status)layer.msg(data.info),$state.reload();else if(data.status=10009)return layer.msg(data.info),!1})}function delRole(roleId){ngDialog.openConfirm({template:"/static/admin/deleteDialog.html",width:"320px",scope:$scope,closeByNavigation:!1,overlay:!0,closeByDocument:!1,closeByEscape:!0,showClose:!0,preCloseCallback:function(e){1==e&&httpRequestPost("/api/user/role/del",{roleIds:roleId},function(data){200==data.status&&(layer.msg(data.info),$state.reload())})}})}function deleteAllroles(){if(!$scope.vm.deleteIds||0===$scope.vm.deleteIds.length)return layer.msg("请选择删除角色",{time:800}),!1;ngDialog.openConfirm({template:"/static/admin/deleteDialog.html",width:"320px",scope:$scope,closeByNavigation:!1,overlay:!0,closeByDocument:!1,closeByEscape:!0,showClose:!0,preCloseCallback:function(e){1==e&&httpRequestPost("/api/user/role/del",{roleIds:$scope.vm.deleteIds.join(",")},function(data){200==data.status&&(layer.msg(data.info),$state.reload())})}})}function editRole(item){$scope.vm.modifyRoleName=item.roleName,$scope.vm.modifyRoleId=item.roleId,$scope.vm.modifyRoleDescribe=item.roleDescribe,$scope.vm.permissionId=item.permissionId,""==item.permissionId?$scope.vm.roleIds=[]:$scope.vm.roleIds=item.permissionId.split(",");ngDialog.openConfirm({template:"/static/admin/modifyRole.html",width:"650px",scope:$scope,closeByNavigation:!1,overlay:!0,closeByDocument:!1,closeByEscape:!0,showClose:!0,preCloseCallback:function(e){if(1===e){if(""==$scope.vm.modifyRoleName)return layer.msg("角色名不能为空"),!1;if(""==$scope.vm.modifyRoleDescribe)return layer.msg("角色描述不能为空"),!1;httpRequestPost("/api/user/role/update",{roleId:$scope.vm.modifyRoleId,roleName:$scope.vm.modifyRoleName,roleDescribe:$scope.vm.modifyRoleDescribe,permissionId:$scope.vm.roleIds.join(",")},function(data){200==data.status&&(layer.msg(data.info),$state.reload())})}}})}$state.go("admin.roleManage"),$scope.vm={listData:"",search:search,delRole:delRole,editRole:editRole,selectAll:selectAll,selectSingle:selectSingle,deleteAllroles:deleteAllroles,isSelectAll:!1,userId:$cookieStore.get("userId"),roleName:"",addRoleName:"",addRole:addRole,roleModular:roleModular,roleIds:[],deleteIds:[],roleDescribe:"",permissionId:"",modifyRoleId:"",modifyRoleName:"",modifyRoleDescribe:""},search()}]),angular.module("applAnalysisModule").controller("accessStatisticsController",["$scope","localStorageService","$state","$timeout","$stateParams","ngDialog","$cookieStore","$filter","$interval",function($scope,localStorageService,$state,$timeout,$stateParams,ngDialog,$cookieStore,$filter,$interval){function setTimerChartOption(xData,yData1,yData2){return{title:{text:"访问数据时间统计"},tooltip:{trigger:"axis"},legend:{data:["人数"]},toolbox:{show:!0,feature:{mark:{show:!0}}},calculable:!0,xAxis:[{type:"category",boundaryGap:!1,axisTick:{onGap:!1},splitLine:{show:!1},data:xData}],yAxis:[{type:"value",axisLabel:{formatter:"{value} "}}],series:[{name:"总会话数",type:"line",data:yData1,markPoint:{data:[{type:"max",name:"最大值"},{type:"min",name:"最小值"}]},markLine:{data:[{type:"average",name:"平均值"}]}},{name:"总用户人数",type:"line",data:yData2,markPoint:{data:[{name:"周最低",value:-2,xAxis:1,yAxis:-1.5}]},markLine:{data:[{type:"average",name:"平均值"}]}}]}}function setAccessChartOption(ydata130,ydata131,ydata132){return{title:{text:"总会话数"},tooltip:{trigger:"axis",axisPointer:{type:"shadow"},formatter:function(params){var tar=params[0];return tar.name+"<br/>"+tar.seriesName+" : "+tar.value}},toolbox:{show:!0,feature:{mark:{show:!0}}},xAxis:[{type:"category",splitLine:{show:!1},data:["微信","web","app"]}],yAxis:[{type:"value"}],series:[{name:"会话数",type:"bar",stack:"总量",data:[ydata130,ydata131,ydata132]}]}}function getOriginData(n,data){for(var originData={"时间":[],"有效用户数":[],"有效会话数":[],"总会话数":[],"总用户人数":[]},i=0;i<n;i++)originData["时间"].push(data[i]),originData["有效用户数"].push({date:data[i],users:0}),originData["有效会话数"].push({date:data[i],times:0}),originData["总会话数"].push({date:data[i],times:0}),originData["总用户人数"].push({date:data[i],users:0});return originData}function exportByTime(){httpRequestPost("/api/analysis/access/export",{applicationId:APPLICATION_ID,startTime:$scope.vm.timerSearchStartTime,endTime:$scope.vm.timerSearchEndTime,requestTimeType:$scope.vm.TimerSearchTimeType,dimensionId:$scope.vm.dimensionId,channelId:$scope.vm.channelId},function(data){500==data.status||window.open("/api/analysis/download/downloadExcel?fileName="+data.data)},function(err){})}function exportByChannel(){httpRequestPost("/api/analysis/access/exportByChannel",{applicationId:APPLICATION_ID,startTime:$scope.vm.accessSearchStartTime,endTime:$scope.vm.accessSearchEndTime,requestTimeType:$scope.vm.accessSearchTimeType,dimensionId:$scope.vm.dimensionId,channelId:$scope.vm.channelId},function(data){500==data.status||window.open("/api/analysis/download/downloadExcel?fileName="+data.data)},function(err){})}function queryAccessDataByTime(){var xData,yData1,yData2,dateJump;dateJump=$scope.vm.timerSearchStartTime&&$scope.vm.timerSearchEndTime?getTimeJump($scope.vm.timerSearchStartTime,$scope.vm.timerSearchEndTime)+1:1==$scope.vm.TimerSearchTimeType||2==$scope.vm.TimerSearchTimeType?1:7;var parameter={applicationId:APPLICATION_ID,startTime:$scope.vm.timerSearchStartTime&&$scope.vm.timerSearchEndTime?$scope.vm.timerSearchStartTime:"",endTime:$scope.vm.timerSearchStartTime&&$scope.vm.timerSearchEndTime?$scope.vm.timerSearchEndTime:"",requestTimeType:$scope.vm.TimerSearchTimeType,dimensionId:$scope.vm.dimensionId,channelId:$scope.vm.channelId};httpRequestPost("/api/analysis/access/queryAccessDataByTime",parameter,function(data){$scope.$apply(function(){if(0==data.data["有效用户数"].length&&0==data.data["有效会话数"].length&&0==data.data["总会话数"].length&&0==data.data["总用户人数"].length)layer.msg("所查询时间段有效数据为空"),$scope.vm.timerData="",$scope.vm.isTimerChartShow=!1;else{if($scope.vm.isTimerChartShow=!0,1==dateJump){xData=["00:00","01:00","02:00","03:00","04:00","05:00","06:00","07:00","08:00","09:00","10:00","11:00","12:00","13:00","14:00","15:00","16:00","17:00","18:00","19:00","20:00","21:00","22:00","23:00","24:00"],yData1=[].fill.call(new Array(24),0),yData2=[].fill.call(new Array(24),0),angular.forEach(data.data["总会话数"],function(data,index1){yData1[data.date]=data.times}),angular.forEach(data.data["总用户人数"],function(data,index1){yData2[data.date]=data.users});for(var tableDate=[],i=0;i<xData.length;i++)i!=xData.length-1&&tableDate.push(xData[i]+"-"+xData[i+1]);$scope.vm.timerData=getOriginData(tableDate.length,tableDate),angular.forEach($scope.vm.timerData["有效用户数"],function(useData,useIndex){angular.forEach(data.data["有效用户数"],function(item,index){$scope.vm.timerData["有效用户数"][item.date].users=item.users})}),angular.forEach($scope.vm.timerData["有效会话数"],function(useData,useIndex){angular.forEach(data.data["有效会话数"],function(item,index){$scope.vm.timerData["有效会话数"][item.date].times=item.times})}),angular.forEach($scope.vm.timerData["总会话数"],function(useData,useIndex){angular.forEach(data.data["总会话数"],function(item,index){$scope.vm.timerData["总会话数"][item.date].times=item.times})}),angular.forEach($scope.vm.timerData["总用户人数"],function(useData,useIndex){angular.forEach(data.data["总用户人数"],function(item,index){$scope.vm.timerData["总用户人数"][item.date].users=item.users})})}else xData=$scope.vm.timerSearchStartTime&&$scope.vm.timerSearchEndTime?getAllDateFromDateJump($scope.vm.timerSearchStartTime,$scope.vm.timerSearchEndTime):getBeforeDate(dateJump,!0,!0),$scope.vm.timerData=getOriginData(xData.length,xData),angular.forEach($scope.vm.timerData["有效用户数"],function(useData,useIndex){angular.forEach(data.data["有效用户数"],function(item,index){item.date==useData.date&&($scope.vm.timerData["有效用户数"][useIndex].users=item.users)})}),angular.forEach($scope.vm.timerData["有效会话数"],function(useData,useIndex){angular.forEach(data.data["有效会话数"],function(item,index){item.date==useData.date&&($scope.vm.timerData["有效会话数"][useIndex].times=item.times)})}),angular.forEach($scope.vm.timerData["总会话数"],function(useData,useIndex){angular.forEach(data.data["总会话数"],function(item,index){item.date==useData.date&&($scope.vm.timerData["总会话数"][useIndex].times=item.times)})}),angular.forEach($scope.vm.timerData["总用户人数"],function(useData,useIndex){angular.forEach(data.data["总用户人数"],function(item,index){item.date==useData.date&&($scope.vm.timerData["总用户人数"][useIndex].users=item.users)})}),yData1=[].fill.call(new Array(7),0),yData2=[].fill.call(new Array(7),0),angular.forEach($scope.vm.timerData["总会话数"],function(item,index){yData1[index]=item.times}),angular.forEach($scope.vm.timerData["总用户人数"],function(item,index){yData2[index]=item.users});TimerChart.setOption(setTimerChartOption(xData,yData1,yData2))}})},function(){})}function queryAccessDataByChannel(){httpRequestPost("/api/analysis/access/queryAccessDataByType",{applicationId:APPLICATION_ID,startTime:$scope.vm.accessSearchStartTime,endTime:$scope.vm.accessSearchEndTime,requestTimeType:$scope.vm.accessSearchTimeType},function(data){var tableList=[],intervaler=$interval(function(){if($scope.master.channelList){angular.forEach($scope.master.channelList,function(item,index){tableList.push({name:item.channelName,index:index,tableData:[0,0,0,0]})}),$interval.cancel(intervaler);var data130=[],data131=[],data132=[];$scope.dataChannelTalk=data.data["总会话数"],$scope.dataChannelUser=data.data["总用户人数"],$scope.dataChannelVilidTalk=data.data["有效会话数"],$scope.dataChannelVilidUser=data.data["有效用户数"];for(var i=0;i<$scope.dataChannelTalk.length;i++)"130"==$scope.dataChannelTalk[i].channel&&data130.push({_key:0,_value:$scope.dataChannelTalk[i].times}),"131"==$scope.dataChannelTalk[i].channel&&data131.push({_key:0,_value:$scope.dataChannelTalk[i].times}),"132"==$scope.dataChannelTalk[i].channel&&data132.push({_key:0,_value:$scope.dataChannelTalk[i].times});for(var i=0;i<$scope.dataChannelUser.length;i++)"130"==$scope.dataChannelUser[i].channel&&data130.push({_key:1,_value:$scope.dataChannelUser[i].users}),"131"==$scope.dataChannelUser[i].channel&&data131.push({_key:1,_value:$scope.dataChannelUser[i].users}),"132"==$scope.dataChannelUser[i].channel&&data132.push({_key:1,_value:$scope.dataChannelUser[i].users});for(var i=0;i<$scope.dataChannelVilidTalk.length;i++)"130"==$scope.dataChannelVilidTalk[i].channel&&data130.push({_key:2,_value:$scope.dataChannelVilidTalk[i].times}),"131"==$scope.dataChannelVilidTalk[i].channel&&data131.push({_key:2,_value:$scope.dataChannelVilidTalk[i].times}),"132"==$scope.dataChannelVilidTalk[i].channel&&data132.push({_key:2,_value:$scope.dataChannelVilidTalk[i].times});for(var i=0;i<$scope.dataChannelVilidUser.length;i++)"130"==$scope.dataChannelVilidUser[i].channel&&data130.push({_key:3,_value:$scope.dataChannelVilidUser[i].users}),"131"==$scope.dataChannelVilidUser[i].channel&&data131.push({_key:3,_value:$scope.dataChannelVilidUser[i].users}),"132"==$scope.dataChannelVilidUser[i].channel&&data132.push({_key:3,_value:$scope.dataChannelVilidUser[i].users});$scope.data130=data130,$scope.data131=data131,$scope.data132=data132;var ydata130,ydata131,ydata132;ydata130=void 0==data130[0]?0:$scope.data130[0]._value,ydata131=void 0==data131[0]?0:$scope.data131[0]._value,ydata132=void 0==data132[0]?0:$scope.data132[0]._value,accessChart.setOption(setAccessChartOption(ydata130,ydata131,ydata132))}},50)},function(){})}function exportByTime(){httpRequestPost("/api/analysis/access/export",{applicationId:APPLICATION_ID,startTime:$scope.vm.timerSearchStartTime,endTime:$scope.vm.timerSearchEndTime,requestTimeType:$scope.vm.TimerSearchTimeType,dimensionId:$scope.vm.dimensionId,channelId:$scope.vm.channelId},function(data){500==data.status||window.open("/api/analysis/download/downloadExcel?fileName="+data.data)},function(err){})}function exportByChannel(){httpRequestPost("/api/analysis/access/exportByChannel",{applicationId:APPLICATION_ID,startTime:$scope.vm.accessSearchStartTime,endTime:$scope.vm.accessSearchEndTime,requestTimeType:$scope.vm.accessSearchTimeType,dimensionId:$scope.vm.dimensionId,channelId:$scope.vm.channelId},function(data){500==data.status||window.open("/api/analysis/download/downloadExcel?fileName="+data.data)},function(err){})}$scope.vm={applicationId:$cookieStore.get("applicationId"),dataTopLeft:"",dataTopRigth:"",dataByTimeTotalUser:"",contentType:0,timerData:"",channelId:"",dimensionId:"",TimerSearchTimeType:1,timerSearchStartTime:"",timerSearchEndTime:"",queryAccessDataByTime:queryAccessDataByTime,isTimerChartShow:!0,exportByTime:exportByTime,exportByChannel:exportByChannel,accessSearchTimeType:1,accessSearchStartTime:"",accessSearchEndTime:"",queryAccessDataByType:queryAccessDataByChannel};var TimerChart=echarts.init(document.getElementById("access_echart_div")),accessChart=echarts.init(document.getElementById("access_echart_div2"));!function(){httpRequestPost("/api/analysis/access/queryAccessDataTopLeft",{applicationId:APPLICATION_ID},function(data){$scope.$apply(function(){$scope.vm.dataTopLeft=[{name:"今日",data:data.data["今天"]},{name:"昨天",data:data.data["昨天"]},{name:"历史最高",data:data.data["历史最高"]}]})},function(){})}(),function(){httpRequestPost("/api/analysis/access/queryAccessDataTopright",{applicationId:APPLICATION_ID},function(data){$scope.$apply(function(){$scope.vm.dataTopRigth={today:data.data["今日"],history:data.data["历史"]}})},function(){})}(),queryAccessDataByTime(),queryAccessDataByChannel()}]),angular.module("applAnalysisModule").controller("applAnalysisController",["$scope","localStorageService","$state","$timeout","$stateParams","ngDialog",function($scope,localStorageService,$state,$timeout,$stateParams,ngDialog){$scope.vm={}}]),angular.module("applAnalysisModule").controller("flowMonitoringController",["$scope","localStorageService","$state","$timeout","$stateParams","ngDialog","$cookieStore","$filter",function($scope,localStorageService,$state,$timeout,$stateParams,ngDialog,$cookieStore,$filter){$scope.vm={applicationId:$cookieStore.get("applicationId"),serviceMemory:"",cpuOccupancy:"",xAxis:"",cpu:"",memory:"",responseTime:"",responseStatus:""},$scope.vm.serviceMemory=[],$scope.vm.cpuOccupancy=[],$scope.vm.xAxis=[],httpRequestPost("/api/ms/monitoringServerABC/monitoringABC",{applicationId:$scope.vm.applicationId},function(data){for(var len=data.data.length,i=0;i<len;i++)$scope.vm.cpuOccupancy.push(data.data[i].cpu),$scope.vm.serviceMemory.push(data.data[i].memory),$scope.vm.xAxis.push(data.data[i].date);$scope.vm.cpu=data.data[len-1].cpu,$scope.vm.memory=data.data[len-1].memory,$scope.vm.responseTime=data.data[len-1].responseTime,$scope.vm.responseStatus=data.data[len-1].responseStatus,$scope.$apply()})}]),angular.module("applAnalysisModule").controller("knowledgeRankingController",["$scope","localStorageService","$state","$timeout","$stateParams","ngDialog","$cookieStore","$filter","$window",function($scope,localStorageService,$state,$timeout,$stateParams,ngDialog,$cookieStore,$filter,$window){function getList(index){getKnowledgeList(1),httpRequestPost("/api/analysis/noMatch/searchList",{applicationId:$scope.vm.applicationId,channelId:$scope.vm.channelId,dimensionId:$scope.vm.dimensionId,requestTimeType:$scope.vm.timeType,startTime:$scope.vm.timeStart,endTime:$scope.vm.timeEnd,index:0,pageSize:10},function(data){$scope.$apply(function(){var xData=[],yData=[];angular.forEach(data.data.objs,function(item,index){xData.push(item.userQuestion),yData.push(item.questionNumber)}),0!=yData.length&&0!=xData.length||(yData=[0,0,0,0,0,0]),myChartQuestion.setOption(setEchartOption(xData,yData)),$scope.vm.listData=data.data.objs,$scope.vm.listDataTotal=data.data.total})})}function getKnowledgeList(index){httpRequestPost("/api/analysis/knowledgeRanking/searchKnowledgeRankingList",{applicationId:$scope.vm.applicationId,channelId:$scope.vm.channelId,dimensionId:$scope.vm.dimensionId,requestTimeType:$scope.vm.timeType,startTime:$scope.vm.timeStart,endTime:$scope.vm.timeEnd,index:0,pageSize:10},function(data){$scope.$apply(function(){var xData=[],yData=[];angular.forEach(data.data.objs,function(item,index){xData.push(item.knowledgeTitle),yData.push(item.questionNumber)}),0!=yData.length&&0!=xData.length||(yData=[0,0,0,0,0,0]),myChart.setOption(setEchartOption(xData,yData)),$scope.vm.listDataK=data.data.objs,$scope.vm.listDataTotalK=data.data.total})})}function init(){getDimensions(),getChannel(),getKnowledgeList(1),getList(1)}function getDimensions(){httpRequestPost("/api/application/dimension/list",{applicationId:$scope.vm.applicationId},function(data){data.data&&($scope.vm.dimensions=data.data,$scope.$apply())},function(err){})}function getChannel(){httpRequestPost("/api/application/channel/listChannels",{applicationId:$scope.vm.applicationId},function(data){data.data&&($scope.vm.channels=data.data,$scope.$apply())},function(err){})}function exportKnowledgeExcel(){httpRequestPost("/api/analysis/knowledgeRanking/export",{applicationId:$scope.vm.applicationId,channelId:$scope.vm.channelId,dimensionId:$scope.vm.dimensionId,requestTimeType:$scope.vm.timeType,startTime:$scope.vm.timeStart,endTime:$scope.vm.timeEnd,index:0,pageSize:10},function(data){500==data.status||window.open("/api/analysis/download/downloadExcel?fileName="+data.data)},function(err){})}function exportNoMatchExcel(){httpRequestPost("/api/analysis/noMatch/export",{applicationId:$scope.vm.applicationId,channelId:$scope.vm.channelId,dimensionId:$scope.vm.dimensionId,requestTimeType:$scope.vm.timeType,startTime:$scope.vm.timeStart,endTime:$scope.vm.timeEnd,index:0,pageSize:10},function(data){500==data.status||window.open("/api/analysis/download/downloadExcel?fileName="+data.data)},function(err){})}function setEchartOption(xData,yData){return{color:["#3398DB"],tooltip:{trigger:"axis",axisPointer:{type:"shadow"}},formatDate:function(datestring){if(8==datestring.length)return datestring.substring(2,4)+"/"+datestring.substring(4,6)+"/"+datestring.substring(6,8)},xAxis:[{type:"category",data:xData,axisTick:{alignWithLabel:!0},axisLabel:{interval:0,rotate:-30,formatter:function(val){return val.length>7&&(val=val.toString().substring(0,7)+"..."),val}}}],grid:{x:40,x2:100,y2:150},yAxis:[{type:"value"}],series:[{name:"访问次数",type:"bar",barWidth:"60%",data:yData,itemStyle:{normal:{color:function(params){return["#C1232B","#B5C334","#FCCE10","#E87C25","#27727B","#FE8463","#9BCA63","#FAD860","#F3A43B","#60C0DD","#D7504B","#C6E579","#F4E001","#F0805A","#26C0C0"][params.dataIndex]}}}}]}}$scope.vm={applicationId:APPLICATION_ID,getList:getList,getKnowledgeList:getKnowledgeList,listData:null,listDataK:null,dimensions:[],channels:[],channelId:null,dimensionId:null,timeType:1,timeStart:null,timeEnd:null,timeList:[],total:null,talkDetail:null,talkDetailTotal:0,userId:null,exportKnowledgeExcel:exportKnowledgeExcel,exportNoMatchExcel:exportNoMatchExcel,contentType:0};var myChart=echarts.init(document.getElementById("knowRanking")),myChartQuestion=echarts.init(document.getElementById("questionRanking"));init()}]),angular.module("applAnalysisModule").controller("newKnowledgeDiscoveryLearnController",["$scope","localStorageService","$state","$timeout","$stateParams","ngDialog","$cookieStore",function($scope,localStorageService,$state,$timeout,$stateParams,ngDialog,$cookieStore){function keyLogin(e){var srcObj=e.srcElement?e.srcElement:e.target;13==(window.event?e.keyCode:e.which)&&(srcObj.blur(),searchByKnowledgeTitle(1),srcObj.focus())}function tab(obj1,obj2){$(obj1).click(function(){$(this).addClass("cur").siblings().removeClass(),$(obj2).children("div").eq($(this).index()).attr("class","db").siblings().attr("class","dn"),searchNewKnowledgeDiscovery(1),listNoReview(1)})}function searchNewKnowledgeDiscovery(index){var question=null;1==nullCheck($scope.vm.question)&&(question="%"+$scope.vm.question+"%"),httpRequestPost("/api/analysis/knowledgeLearn/newKnowledgeDiscoveryLearnUnlearn",{applicationId:$scope.vm.applicationId,channelId:$scope.vm.channelId,question:question,dimensionId:$scope.vm.dimensionId,requestTimeType:$scope.vm.timeType,startTime:$scope.vm.timeStart,endTime:$scope.vm.timeEnd,index:(index-1)*$scope.vm.pageSize,pageSize:$scope.vm.pageSize},function(data){$scope.vm.listData=data.qaLogs,$scope.vm.paginationConf={currentPage:index,totalItems:Math.ceil(data.qalogTotal/5),pageSize:1,pagesLength:8},$scope.$apply()})}function searchByKnowledgeTitle(index){1==nullCheck($("#inputValue").val())?httpRequestPost("/api/ms/knowledgeManage/overView/searchList",{applicationId:$scope.vm.applicationId,index:(index-1)*$scope.vm.pageSize1,pageSize:$scope.vm.pageSize1,sceneIds:null,knowledgeTitle:$("#inputValue").val().trim(),knowledgeContent:null,knowledgeUpdate:null,knowledgeExpDateEnd:null,knowledgeExpDateStart:null,knowledgeOrigin:0,updateTimeType:0,knowledgeType:"",knowledgeExtensionQuestion:""},function(data){$scope.vm.knowledgeList=data.data.objs,$scope.vm.paginationConf2={currentPage:index,totalItems:Math.ceil(data.data.total/5),pageSize:1,pagesLength:8},$scope.$apply()}):layer.msg("请输入要查找的标题")}function listNoReview(index){var question=null;1==nullCheck($scope.vm.question1)&&(question="%"+$scope.vm.question1+"%"),httpRequestPost("/api/analysis/knowledgeLearn/listNoReview",{applicationId:$scope.vm.applicationId,channelId:$scope.vm.channelId1,question:question,dimensionId:$scope.vm.dimensionId1,requestTimeType:$scope.vm.timeType1,startTime:$scope.vm.timeStart1,endTime:$scope.vm.timeEnd1,index:(index-1)*$scope.vm.pageSize1,pageSize:$scope.vm.pageSize1,status_id:$scope.vm.statusId,pass_status_id:$scope.vm.passStatusId,learn_type:1},function(data){$scope.vm.listData1=data.reviewRecords,$scope.vm.paginationConf1={currentPage:index,totalItems:Math.ceil(data.reviewRecordTotal/5),pageSize:1,pagesLength:8},$scope.$apply()})}function init(){getDimensions(),getChannel(),searchNewKnowledgeDiscovery(1),listNoReview(1)}function ignore(){for(var ids=document.getElementsByName("sid"),id_array=[],i=0;i<ids.length;i++)ids[i].checked&&id_array.push(ids[i].value);if(0==id_array.length)return void layer.msg("请选择要忽略的记录！");layer.confirm("确认要忽略吗？",function(index){layer.close(index);var request=new Object;request.ids=id_array,httpRequestPost("/api/analysis/knowledgeLearn/ignoreByContent",request,function(data){null!=data&&searchNewKnowledgeDiscovery($scope.vm.paginationConf.currentPage)})})}function associate(requestId,content){$scope.vm.knowledgeList=null,$scope.vm.currQuestion="用户问题:"+content;ngDialog.openConfirm({template:"/static/applicationAnalysis/associateLearn.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){1===e&&assembleLearnData(requestId)}})}function assembleLearnData(requestId){for(var ids=document.getElementsByName("sid2"),id_array=[],knowledgeTitle="",knowledgeType=0,i=0;i<ids.length;i++)ids[i].checked&&(id_array.push(ids[i].value),knowledgeTitle=$(ids[i]).attr("knowledgeTitle"),knowledgeType=$(ids[i]).attr("knowledgeType"));if(0==id_array.length)return void layer.msg("请选择要关联的知识");httpRequestPost("/api/analysis/knowledgeLearn/learnByContent",{qalog_id:requestId,knowledge_id:id_array.pop(),knowledge_type:knowledgeType,knowledge_title:knowledgeTitle,learn_type:1,knowledge_learn_type:0},function(data){data.info&&(layer.msg(data.info),searchNewKnowledgeDiscovery(1))},function(err){})}function review(pass){for(var ids=document.getElementsByName("sid1"),id_array=[],i=0;i<ids.length;i++)ids[i].checked&&id_array.push(ids[i].value);var msg="";if(msg=0==pass?"拒绝":"通过",0==id_array.length)return void layer.msg("请选择要"+msg+"的记录！");layer.confirm("确认要"+msg+"吗？",function(index){layer.close(index),httpRequestPost("/api/analysis/knowledgeLearn/review",{ids:id_array,pass_status_id:pass,userId:$scope.vm.userId,userName:$scope.vm.userName},function(data){data.info&&(layer.msg(data.info),listNoReview(1))},function(err){})})}function getDimensions(){httpRequestPost("/api/application/dimension/list",{applicationId:$scope.vm.applicationId},function(data){data.data&&($scope.vm.dimensions=data.data,$scope.$apply())},function(err){})}function getChannel(){httpRequestPost("/api/application/channel/listChannels",{applicationId:$scope.vm.applicationId},function(data){data.data&&($scope.vm.channels=data.data,$scope.$apply())},function(err){})}function learn(requestId,content){$scope.vm.knowledgeContent=content;ngDialog.openConfirm({template:"/static/applicationAnalysis/switchKnowledgeType.html",width:"500px",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){}})}function associateCheck(content,knowledgeTitle){$scope.vm.currQuestion="用户问题:"+content,$scope.vm.currKnowledgeTitle=knowledgeTitle,ngDialog.openConfirm({template:"/static/applicationAnalysis/associateLearnCheck.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){}})}function content(requestId){httpRequestPost("/api/analysis/userSession/searchContent",{qalogId:requestId,index:0,pageSize:32767},function(data){null!=data&&($scope.vm.talkDetail=data.data.objs,$scope.$apply())},function(err){}),ngDialog.openConfirm({template:"/static/applicationAnalysis/content.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",width:"930px",preCloseCallback:function(e){}})}$scope.vm={applicationId:$cookieStore.get("applicationId"),userId:$cookieStore.get("userId"),userName:$cookieStore.get("userLoginName"),searchNewKnowledgeDiscovery:searchNewKnowledgeDiscovery,listNoReview:listNoReview,listData:null,paginationConf:null,pageSize:5,listData1:null,paginationConf1:null,paginationConf2:null,pageSize1:5,dimensions:[],channels:[],channelId:null,dimensionId:null,timeType:0,timeStart:null,timeEnd:null,channelId1:null,dimensionId1:null,timeType1:0,timeStart1:null,timeEnd1:null,timeList:[],currentPage:1,total:null,total1:null,ignore:ignore,associate:associate,learn:learn,review:review,statusId:0,passStatusId:0,tab:tab,currQuestion:"",searchByKnowledgeTitle:searchByKnowledgeTitle,knowledgeList:null,question:null,question1:null,content:content,talkDetail:null,associateCheck:associateCheck,currKnowledgeTitle:null,knowledgeContent:"",keyLogin:keyLogin},tab(".tab_tit span",".tab_con");var timeout;$scope.$watch("vm.paginationConf.currentPage",function(current){current&&(timeout&&$timeout.cancel(timeout),timeout=$timeout(function(){searchNewKnowledgeDiscovery(current)},100))},!0);var timeout1;$scope.$watch("vm.paginationConf1.currentPage",function(current){current&&(timeout1&&$timeout.cancel(timeout1),timeout1=$timeout(function(){listNoReview(current)},100))},!0);var timeout2;$scope.$watch("vm.paginationConf2.currentPage",function(current){current&&(timeout2&&$timeout.cancel(timeout2),timeout2=$timeout(function(){searchByKnowledgeTitle(current)},100))},!0),$scope.$watch("vm.channelId1",function(){$scope.vm.listData1=null,$scope.vm.paginationConf1={currentPage:0,totalItems:0,pageSize:1,pagesLength:8}}),init(),$("#selectAll").on("click",function(){var ids=document.getElementsByName("sid"),flag=!1;this.checked&&(flag=!0),$.each(ids,function(index,value){flag?($(value).attr("checked",!0),$(value).prop("checked",!0)):($(value).attr("checked",!1),$(value).prop("checked",!1))})}),$("#selectAll1").on("click",function(){var ids=document.getElementsByName("sid1"),flag=!1;this.checked&&(flag=!0),$.each(ids,function(index,value){flag?($(value).attr("checked",!0),$(value).prop("checked",!0)):($(value).attr("checked",!1),$(value).prop("checked",!1))})})}]),angular.module("applAnalysisModule").controller("operationLogController",["$scope","localStorageService","$state","$timeout","$stateParams","ngDialog","$cookieStore","$filter",function($scope,localStorageService,$state,$timeout,$stateParams,ngDialog,$cookieStore,$filter){function getData(index){httpRequestPost("/api/analysis/operationLog/searchOperationLog",{startTime:$scope.vm.startTime,endTime:$scope.vm.endTime,index:(index-1)*$scope.vm.paginationConf.pageSize,pageSize:$scope.vm.paginationConf.pageSize,operationLogAuthor:$scope.vm.operationLogAuthor},function(data){200==data.status&&$scope.$apply(function(){$scope.vm.listData=data.data,$scope.vm.paginationConf.currentPage=index,$scope.vm.paginationConf.totalItems=data.data.total,$scope.vm.paginationConf.numberOfPages=Math.ceil(data.data.total/$scope.vm.paginationConf.pageSize)})},function(error){})}$scope.vm={listData:"",getData:getData,startTime:"",endTime:"",operationLogAuthor:"",paginationConf:{pageSize:8,pagesLength:10}},getData(1);var timeout;$scope.$watch("vm.paginationConf.currentPage",function(current){current&&(timeout&&$timeout.cancel(timeout),timeout=$timeout(function(){getData(current)},100))},!0)}]),angular.module("applAnalysisModule").controller("reinforcementLearnController",["$scope","localStorageService","$state","$timeout","$stateParams","ngDialog","$cookieStore",function($scope,localStorageService,$state,$timeout,$stateParams,ngDialog,$cookieStore){function keyLogin(e){var srcObj=e.srcElement?e.srcElement:e.target;13==(window.event?e.keyCode:e.which)&&(srcObj.blur(),searchByKnowledgeTitle(1),srcObj.focus())}function searchReinforcement(index){var question=null;1==nullCheck($scope.vm.question)&&(question="%"+$scope.vm.question+"%"),httpRequestPost("/api/analysis/knowledgeLearn/reinforcementLearnUnlearn",{applicationId:$scope.vm.applicationId,channelId:$scope.vm.channelId,question:question,dimensionId:$scope.vm.dimensionId,requestTimeType:$scope.vm.timeType,startTime:$scope.vm.timeStart,endTime:$scope.vm.timeEnd,index:(index-1)*$scope.vm.pageSize,pageSize:$scope.vm.pageSize},function(data){$scope.vm.listData=data.qaLogs,$scope.vm.paginationConf={currentPage:index,totalItems:Math.ceil(data.qalogTotal/5),pageSize:1,pagesLength:8},$scope.$apply()})}function searchByKnowledgeTitle(index){$scope.vm.knowledgeList=null,1==nullCheck($("#inputValue").val())?httpRequestPost("/api/ms/knowledgeManage/overView/searchList",{applicationId:$scope.vm.applicationId,index:(index-1)*$scope.vm.pageSize1,pageSize:$scope.vm.pageSize1,sceneIds:null,knowledgeTitle:$("#inputValue").val().trim(),knowledgeContent:null,knowledgeUpdate:null,knowledgeExpDateEnd:null,knowledgeExpDateStart:null,knowledgeOrigin:0,updateTimeType:0,knowledgeType:"",knowledgeExtensionQuestion:""},function(data){$scope.vm.knowledgeList=data.data.objs,$scope.vm.paginationConf2={currentPage:index,totalItems:Math.ceil(data.data.total/5),pageSize:1,pagesLength:8},$scope.$apply()}):layer.msg("请输入要查找的标题")}function listNoReview(index){var question=null;1==nullCheck($scope.vm.question1)&&(question="%"+$scope.vm.question1+"%"),httpRequestPost("/api/analysis/knowledgeLearn/listNoReview",{applicationId:$scope.vm.applicationId,channelId:$scope.vm.channelId1,question:question,dimensionId:$scope.vm.dimensionId1,requestTimeType:$scope.vm.timeType1,startTime:$scope.vm.timeStart1,endTime:$scope.vm.timeEnd1,index:(index-1)*$scope.vm.pageSize1,pageSize:$scope.vm.pageSize1,status_id:$scope.vm.statusId,pass_status_id:$scope.vm.passStatusId,learn_type:0},function(data){$scope.vm.listData1=data.reviewRecords,$scope.vm.paginationConf1={currentPage:index,totalItems:Math.ceil(data.reviewRecordTotal/5),pageSize:1,pagesLength:8},$scope.$apply()})}function init(){getDimensions(),getChannel(),searchReinforcement(1),listNoReview(1)}function ignore(){for(var ids=document.getElementsByName("sid"),id_array=[],i=0;i<ids.length;i++)ids[i].checked&&id_array.push(ids[i].value);if(0==id_array.length)return void layer.msg("请选择要忽略的记录！");layer.confirm("确认要忽略吗？",function(index){layer.close(index);var request=new Object;request.ids=id_array,httpRequestPost("/api/analysis/knowledgeLearn/ignoreByContent",request,function(data){null!=data&&searchReinforcement($scope.vm.paginationConf.currentPage)})})}function getRecommend(requestId){httpRequestPost("/api/analysis/userSession/getOneRecommend",{qalogId:requestId},function(data){$scope.vm.knowledgeList=data.data,$scope.$apply()})}function learn(requestId,content){$scope.vm.knowledgeList=null,getRecommend(requestId),$scope.vm.currQuestion="用户问题:"+content;ngDialog.openConfirm({template:"/static/applicationAnalysis/associateLearn.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){1===e&&assembleLearnData(requestId)}})}function assembleLearnData(requestId){for(var ids=document.getElementsByName("sid2"),id_array=[],knowledgeTitle="",i=0;i<ids.length;i++)ids[i].checked&&(id_array.push(ids[i].value),knowledgeTitle=$(ids[i]).attr("knowledgeTitle"),$(ids[i]).attr("knowledgeType"));if(0==id_array.length)return void layer.msg("请选择要关联的知识");httpRequestPost("/api/analysis/knowledgeLearn/learnByContent",{qalog_id:requestId,knowledge_id:id_array.pop(),knowledge_type:100,knowledge_title:knowledgeTitle,learn_type:0,knowledge_learn_type:0},function(data){data.info&&(layer.msg(data.info),searchReinforcement(1))},function(err){})}function review(pass){for(var ids=document.getElementsByName("sid1"),id_array=[],i=0;i<ids.length;i++)ids[i].checked&&id_array.push(ids[i].value);var msg="";if(msg=0==pass?"拒绝":"通过",0==id_array.length)return void layer.msg("请选择要"+msg+"的记录！");layer.confirm("确认要"+msg+"吗？",function(index){layer.close(index),httpRequestPost("/api/analysis/knowledgeLearn/review",{ids:id_array,pass_status_id:pass,userId:$scope.vm.userId,userName:$scope.vm.userName},function(data){data.info&&(layer.msg(data.info),listNoReview(1))},function(err){})})}function getDimensions(){httpRequestPost("/api/application/dimension/list",{applicationId:$scope.vm.applicationId},function(data){data.data&&($scope.vm.dimensions=data.data,$scope.$apply())},function(err){})}function getChannel(){httpRequestPost("/api/application/channel/listChannels",{applicationId:$scope.vm.applicationId},function(data){data.data&&($scope.vm.channels=data.data,$scope.$apply())},function(err){})}$scope.vm={applicationId:$cookieStore.get("applicationId"),userId:$cookieStore.get("userId"),userName:$cookieStore.get("userLoginName"),searchReinforcement:searchReinforcement,listNoReview:listNoReview,listData:null,paginationConf:null,pageSize:5,listData1:null,paginationConf1:null,paginationConf2:null,pageSize1:5,dimensions:[],channels:[],channelId:null,dimensionId:null,timeType:0,timeStart:null,timeEnd:null,channelId1:null,dimensionId1:null,timeType1:0,timeStart1:null,timeEnd1:null,timeList:[],currentPage:1,total:null,total1:null,ignore:ignore,learn:learn,review:review,statusId:0,passStatusId:0,contentType:0,currQuestion:"",searchByKnowledgeTitle:searchByKnowledgeTitle,knowledgeList:null,question:null,question1:null,keyLogin:keyLogin,getRecommend:getRecommend},searchReinforcement(1),listNoReview(1);var timeout;$scope.$watch("vm.paginationConf.currentPage",function(current){current&&(timeout&&$timeout.cancel(timeout),timeout=$timeout(function(){searchReinforcement(current)},0))},!0);var timeout1;$scope.$watch("vm.paginationConf1.currentPage",function(current){current&&(timeout1&&$timeout.cancel(timeout1),timeout1=$timeout(function(){listNoReview(current)},0))},!0);var timeout2;$scope.$watch("vm.paginationConf2.currentPage",function(current){current&&(timeout2&&$timeout.cancel(timeout2),timeout2=$timeout(function(){searchByKnowledgeTitle(current)},0))},!0),$scope.$watch("vm.channelId1",function(){$scope.vm.listData1=null,$scope.vm.paginationConf1={currentPage:0,totalItems:0,pageSize:1,pagesLength:8}}),init(),$("#selectAll").on("click",function(){var ids=document.getElementsByName("sid"),flag=!1;this.checked&&(flag=!0),$.each(ids,function(index,value){flag?($(value).attr("checked",!0),$(value).prop("checked",!0)):($(value).attr("checked",!1),$(value).prop("checked",!1))})}),$("#selectAll1").on("click",function(){var ids=document.getElementsByName("sid1"),flag=!1;this.checked&&(flag=!0),$.each(ids,function(index,value){flag?($(value).attr("checked",!0),$(value).prop("checked",!0)):($(value).attr("checked",!1),$(value).prop("checked",!1))})})}]),angular.module("applAnalysisModule").controller("resolutionStatisticsController",["$scope","localStorageService","$state","$timeout","$stateParams","ngDialog","$cookieStore","$filter",function($scope,localStorageService,$state,$timeout,$stateParams,ngDialog,$cookieStore,$filter){function getList(index){httpRequestPost("/api/analysis/",{startTime:$scope.vm.startTime,endTime:$scope.vm.endTime,operationLogAuthor:$scope.vm.operationLogAuthor},function(data){200==data.status&&$scope.$apply(function(){})},function(error){})}function chartsSetOption(data1,data2){solutionRateChart.setOption({title:{text:"解决率统计",x:"center"},tooltip:{trigger:"item",formatter:"{a} <br/>{b} : {c} ({d}%)"},legend:{orient:"vertical",left:"left",data:["未解决","解决"]},series:[{type:"pie",radius:"55%",center:["50%","60%"],data:[{value:500,name:"未解决"},{value:2e3,name:"解决"}],itemStyle:{emphasis:{shadowBlur:10,shadowOffsetX:0,shadowColor:"rgba(0, 0, 0, 0.5)"}}}]}),specificRateChart.setOption({tooltip:{trigger:"item",formatter:"{a} <br/>{b} : {c} ({d}%)"},legend:{orient:"vertical",x:"left",data:["直接回答","推荐回答","引导回答","未知回答","引导成功","敏感词回答"]},toolbox:{show:!0,feature:{mark:{show:!0},dataView:{show:!0,readOnly:!1},magicType:{show:!0,type:["pie","funnel"],option:{funnel:{x:"25%",width:"50%",funnelAlign:"center",max:1548}}},restore:{show:!0},saveAsImage:{show:!0}}},calculable:!0,series:[{name:"访问来源",type:"pie",radius:["50%","70%"],itemStyle:{normal:{label:{show:!1},labelLine:{show:!1}},emphasis:{label:{show:!0,position:"center",textStyle:{fontSize:"14",fontWeight:""}}}},data:[{value:335,name:"直接回答"},{value:310,name:"推荐回答"},{value:234,name:"引导回答"},{value:135,name:"未知回答"},{value:548,name:"引导成功"},{value:1e3,name:"敏感词回答"}]}]})}$scope.vm={getList:getList,dimensions:[],channels:[],channelId:"",dimensionId:"",timeType:0,timeStart:"",timeEnd:""},$scope.master.getDimensions($scope,["dimensions"]),$scope.master.getChannels($scope,["channels"]);var solutionRateChart,specificRateChart;!function(){solutionRateChart=echarts.init(document.getElementById("resolution_echart")),specificRateChart=echarts.init(document.getElementById("resolution_echart2"))}(),chartsSetOption()}]),angular.module("applAnalysisModule").controller("satisfactionDegreeController",["$scope","localStorageService","$state","$timeout","$stateParams","ngDialog","$cookieStore","$filter",function($scope,localStorageService,$state,$timeout,$stateParams,ngDialog,$cookieStore,$filter){function sotrBySe(){$scope.vm.orderForSessionNumber=$scope.vm.orderForSessionNumber?0:1,$scope.vm.orderForUnsatisfiedNumber=null,$scope.vm.orderForSatisfactionRate=null,getList(1)}function sotrBySa(){$scope.vm.orderForUnsatisfiedNumber=$scope.vm.orderForUnsatisfiedNumber?0:1,$scope.vm.orderForSessionNumber=null,$scope.vm.orderForSatisfactionRate=null,getList(1)}function sotrBySaRa(){$scope.vm.orderForSatisfactionRate=$scope.vm.orderForSatisfactionRate?0:1,$scope.vm.orderForUnsatisfiedNumber=null,$scope.vm.orderForSessionNumber=null,getList(1)}function getList(index){httpRequestPost("/api/analysis/satisfaction/searchList",{channelId:$scope.vm.channelId,dimensionId:$scope.vm.dimensionId,applicationId:$scope.vm.applicationId,requestTimeType:$scope.vm.timeType,startTime:$scope.vm.timeStart,endTime:$scope.vm.timeEnd,index:(index-1)*$scope.vm.pageSize,pageSize:$scope.vm.pageSize,orderForSatisfactionRate:$scope.vm.orderForSatisfactionRate,orderForSessionNumber:$scope.vm.orderForSessionNumber,orderForUnsatisfiedNumber:$scope.vm.orderForUnsatisfiedNumber},function(data){$scope.vm.listData=data.data.objs,$scope.vm.paginationConf={currentPage:index,totalItems:Math.ceil(data.data.total/5),pageSize:1,pagesLength:8},$scope.$apply()},function(){})}function getPieData(){httpRequestPost("/api/analysis/satisfaction/chartAndTotal",{applicationId:$scope.vm.applicationId,channelId:$scope.vm.channelId,dimensionId:$scope.vm.dimensionId,requestTimeType:$scope.vm.timeType,startTime:$scope.vm.timeStart,endTime:$scope.vm.timeEnd},function(data){var params;params=data&&200==data.status&&null!=data.data&&0!=data.data.length?data.data.objs[0]:{satisfiedNumber:0,unsatisfiedNumber:0};var myChart=echarts.init(document.getElementById("statistics")),option={title:{text:"满意率统计",x:"center"},tooltip:{trigger:"item",formatter:"{a} <br/>{b} : {c} ({d}%)"},legend:{orient:"vertical",left:"left",data:["满意率","不满意率"]},series:[{type:"pie",radius:"55%",center:["50%","60%"],data:[{value:params.satisfiedNumber,name:"满意率"},{value:params.unsatisfiedNumber,name:"不满意率"}],itemStyle:{emphasis:{shadowBlur:10,shadowOffsetX:0,shadowColor:"rgba(0, 0, 0, 0.5)"}}}]};myChart.setOption(option)},function(err){})}function init(){getDimensions(),getChannel(),getList(1),getPieData()}function getDimensions(){httpRequestPost("/api/application/dimension/list",{applicationId:$scope.vm.applicationId},function(data){data.data&&($scope.vm.dimensions=data.data,$scope.$apply())},function(err){})}function getChannel(){httpRequestPost("/api/application/channel/listChannels",{applicationId:$scope.vm.applicationId},function(data){data.data&&($scope.vm.channels=data.data,$scope.$apply())},function(err){})}$scope.vm={applicationId:$cookieStore.get("applicationId"),getList:getList,listData:null,paginationConf:null,pageSize:5,dimensions:[],channels:[],channelId:null,dimensionId:null,sendDimensions:[],sendChannels:[],timeType:0,timeStart:$filter("date")(new Date,"yyyy-MM-dd"),timeEnd:$filter("date")(new Date,"yyyy-MM-dd"),orderForSessionNumber:null,orderForUnsatisfiedNumber:null,orderForSatisfactionRate:null,sotrBySe:sotrBySe,sotrBySa:sotrBySa,sotrBySaRa:sotrBySaRa},$scope.$watch("vm.paginationConf.currentPage",function(current){current&&getList(current)}),init()}]),angular.module("applAnalysisModule").controller("serviceMonitoringController",["$scope","localStorageService","$state","$timeout","$stateParams","ngDialog","$cookieStore","$filter","$window","$interval",function($scope,localStorageService,$state,$timeout,$stateParams,ngDialog,$cookieStore,$filter,$window,$interval){function setTimerChartOption(xData,yData,dataName,color,formatter){return{tooltip:{trigger:"axis"},toolbox:{show:!0,feature:{mark:{show:!0},dataView:{show:!0,readOnly:!1},magicType:{show:!0,type:["line","bar"]},restore:{show:!0},saveAsImage:{show:!0}}},grid:{left:"2%",right:"4%",bottom:"3%",top:"60",containLabel:!0},calculable:!1,animation:!0,color:[color],xAxis:[{type:"category",boundaryGap:!1,data:xData,axisLine:{show:!0,lineStyle:{color:"#989898",type:"solid",width:2}},axisTick:{show:!0,length:5,lineStyle:{color:"#989898",type:"solid",width:2}},axisLabel:{show:!0,interval:"auto",rotate:0,margin:8,formatter:"{value}",textStyle:{color:"#444444",fontFamily:"Microsoft YaHei",fontSize:15,fontStyle:"normal",fontWeight:"bold"}}}],yAxis:[{name:"",type:"value",axisLine:{show:!0,lineStyle:{color:"#989898",type:"solid",width:2}},axisTick:{show:!1,length:1,lineStyle:{color:"#989898",type:"solid",width:2}},axisLabel:{show:!0,interval:"auto",rotate:0,margin:8,formatter:formatter,textStyle:{color:"#444444",fontFamily:"Microsoft YaHei",fontSize:15,fontStyle:"normal",fontWeight:"bold"}}}],series:[{name:dataName,type:"line",symbol:"emptyCircle",smooth:!1,data:yData,markPoint:{symbolSize:60,data:[{type:"max",name:"最大值"},{type:"min",name:"最小值"}]}}]}}$scope.vm={applicationId:$cookieStore.get("applicationId"),serviceMemory:"",cpuOccupancy:"",xAxis:"",cpu:"",memory:"",responseTime:"",responseStatus:"",linuxIp:"",applicationName:"",inspectFrequency:""},$scope.vm.serviceMemory=[],$scope.vm.cpuOccupancy=[],$scope.vm.xAxis=[];var serviceMemory=echarts.init(document.getElementById("main")),cpuOccupancy=echarts.init(document.getElementById("main1"));httpRequestPost("/api/ms/monitoringServerABC/monitoringABC",{applicationId:$scope.vm.applicationId},function(data){$scope.vm.linuxIp=data.data.linuxIp,$scope.vm.inspectFrequency=data.data.inspectFrequency;for(var data=data.data.data,len=data.length,i=0;i<len;i++)$scope.vm.cpuOccupancy.push(data[i].cpu),$scope.vm.serviceMemory.push(data[i].memory),$scope.vm.xAxis.push(data[i].date);$scope.vm.cpu=data[len-1].cpu,$scope.vm.memory=data[len-1].memory,$scope.vm.responseTime=data[len-1].responseTime,$scope.vm.responseStatus=data[len-1].responseStatus,$scope.$apply(),serviceMemory.setOption(setTimerChartOption($scope.vm.xAxis,$scope.vm.serviceMemory,"使用内存","#E87C25","{value}MB")),cpuOccupancy.setOption(setTimerChartOption($scope.vm.xAxis,$scope.vm.cpuOccupancy,"CPU占用率","#26C0C0","{value}%"))}),httpRequestPost("/api/application/application/findApplication",{applicationId:$scope.vm.applicationId},function(data){200==data.status&&($scope.vm.applicationName=data.data.applicationName,$scope.$apply())}),$scope.reloadRoute=function(){$window.location.reload()};$interval($scope.reloadRoute,6e4)}]),angular.module("applAnalysisModule").controller("sessionDetailsController",["$scope","localStorageService","$state","$timeout","$stateParams","ngDialog","$cookieStore",function($scope,localStorageService,$state,$timeout,$stateParams,ngDialog,$cookieStore){function scan(id){$scope.vm.userId=id,getScanData(id,1),ngDialog.openConfirm({template:"/static/applicationAnalysis/sessionDetailsDialog.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",width:"930px",preCloseCallback:function(e){}})}function clearHistory(){$scope.vm.total=0,$scope.vm.talkDetailTotal=0,$scope.vm.timeList=null,$scope.vm.talkDetail=null}function getScanData(id,index){clearHistory(),httpRequestPost("/api/analysis/userSession/searchTimeBar",{applicationId:$scope.vm.applicationId,channelId:$scope.vm.channelId,dimensionId:$scope.vm.dimensionId,requestTimeType:$scope.vm.timeType,startTime:$scope.vm.timeStart,endTime:$scope.vm.timeEnd,index:(index-1)*$scope.vm.pageSize,pageSize:$scope.vm.pageSize,userId:id},function(data){null!=data&&($scope.vm.total=data.data.total/$scope.vm.pageSize<1?1:data.data.total/$scope.vm.pageSize,$scope.vm.timeList=data.data.objs,$scope.$apply(),getdetail($scope.vm.timeList[0].sessionId,1))})}function getList(index){httpRequestPost("/api/analysis/userSession/searchList",{applicationId:$scope.vm.applicationId,channelId:$scope.vm.channelId,dimensionId:$scope.vm.dimensionId,requestTimeType:$scope.vm.timeType,startTime:$scope.vm.timeStart,endTime:$scope.vm.timeEnd,index:(index-1)*$scope.vm.pageSize,pageSize:$scope.vm.pageSize,orderForSessionNumber:$scope.vm.orderForSessionNumber,orderForSessionTime:$scope.vm.orderForSessionTime},function(data){$scope.$apply(function(){var xData=[],yData=[];angular.forEach(data.data.objs,function(item,index){xData.push(item.userId),yData.push(item.sessionNumber)}),0!=yData.length&&0!=xData.length||(yData=[0,0,0,0,0,0]),myChart.setOption(setEchartOption(xData,yData)),$scope.vm.listData=data.data.objs})})}function getdetail(sessionId,index){httpRequestPost("/api/analysis/userSession/searchTimeBarContent",{sessionId:sessionId,index:(index-1)*$scope.vm.pageSize,pageSize:$scope.vm.pageSize},function(data){null!=data&&($scope.vm.talkDetail=data.data.objs,$scope.vm.talkDetailTotal=data.data.total,$scope.$apply())},function(err){})}function nextPage(){$scope.vm.currentPage<$scope.vm.total?($scope.vm.currentPage+=1,getScanData($scope.vm.userId,$scope.vm.currentPage),getdetail($scope.vm.timeList[0].sessionId,1)):($scope.vm.currentPage=$scope.vm.total)&&($scope.vm.currentPage=$scope.vm.total)}function prePage(){($scope.vm.currentPage=1)?$scope.vm.currentPage=1:(getScanData($scope.vm.userId,$scope.vm.currentPage),getdetail($scope.vm.timeList[0].sessionId,1))}function init(){getDimensions(),getChannel(),getList(1)}function getDimensions(){httpRequestPost("/api/application/dimension/list",{applicationId:$scope.vm.applicationId},function(data){data.data&&($scope.vm.dimensions=data.data,$scope.$apply())},function(err){})}function getChannel(){httpRequestPost("/api/application/channel/listChannels",{applicationId:$scope.vm.applicationId},function(data){data.data&&($scope.vm.channels=data.data,$scope.$apply())},function(err){})}function exportExcel(){httpRequestPost("/api/analysis/userSession/export",{applicationId:$scope.vm.applicationId,channelId:$scope.vm.channelId,dimensionId:$scope.vm.dimensionId,requestTimeType:$scope.vm.timeType,startTime:$scope.vm.timeStart,endTime:$scope.vm.timeEnd,orderForSessionNumber:$scope.vm.orderForSessionNumber,orderForSessionTime:$scope.vm.orderForSessionTime,index:0,pageSize:10},function(data){500==data.status||window.open("/api/analysis/download/downloadExcel?fileName="+data.data)},function(err){})}function setEchartOption(xData,yData){return{color:["#3398DB"],tooltip:{trigger:"axis",axisPointer:{type:"shadow"}},xAxis:[{type:"category",data:xData,axisTick:{alignWithLabel:!0},axisLabel:{interval:0,rotate:-30,formatter:function(val){return val.length>10&&(val=val.toString().substring(0,10)+"..."),val}}}],grid:{x:40,x2:100,y2:150},yAxis:[{type:"value"}],series:[{name:"会话数量",type:"bar",barWidth:"60%",data:yData,itemStyle:{normal:{color:function(params){return["#C1232B","#B5C334","#FCCE10","#E87C25","#27727B","#FE8463","#9BCA63","#FAD860","#F3A43B","#60C0DD","#D7504B","#C6E579","#F4E001","#F0805A","#26C0C0"][params.dataIndex]}}}}]}}$scope.vm={applicationId:$cookieStore.get("applicationId"),scan:scan,getList:getList,listData:null,paginationConf:null,pageSize:10,dimensions:[],channels:[],channelId:null,dimensionId:null,timeType:1,timeStart:null,timeEnd:null,orderForSessionNumber:null,orderForSessionTime:null,timeList:[],getdetail:getdetail,currentPage:1,total:null,talkDetail:null,talkDetailTotal:0,userId:null,prePage:prePage,nextPage:nextPage,clearHistory:clearHistory,contentIndex:2,exportExcel:exportExcel};var myChart=echarts.init(document.getElementById("sessionDetail"));$scope.$watch("vm.paginationConf.currentPage",function(current){current&&getList(current)}),$scope.$watch("vm.orderForSessionNumber",function(){getList($scope.vm.paginationConf.currentPage?$scope.vm.paginationConf.currentPage:1)}),$scope.$watch("vm.orderForSessionTime",function(){$scope.vm.orderForSessionNumber=null,getList($scope.vm.paginationConf.currentPage?$scope.vm.paginationConf.currentPage:1)}),init()}]),angular.module("applAnalysisModule").controller("sessionLogController",["$scope","localStorageService","$state","$timeout","$stateParams","ngDialog","$cookieStore",function($scope,localStorageService,$state,$timeout,$stateParams,ngDialog,$cookieStore){function scan(id){$scope.vm.userId=id,getScanData(id,1),ngDialog.openConfirm({template:"/static/applicationAnalysis/sessionDetailsDialog.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",width:"930px",preCloseCallback:function(e){}})}function clearHistory(){$scope.vm.total=0,$scope.vm.talkDetailTotal=0,$scope.vm.timeList=null,$scope.vm.talkDetail=null}function getScanData(id,index){clearHistory(),httpRequestPost("/api/analysis/userSession/searchTimeBar",{applicationId:$scope.vm.applicationId,channelId:$scope.vm.channelId,dimensionId:$scope.vm.dimensionId,requestTimeType:$scope.vm.timeType,startTime:$scope.vm.timeStart,endTime:$scope.vm.timeEnd,index:(index-1)*$scope.vm.pageSize,pageSize:$scope.vm.pageSize,userId:id},function(data){null!=data&&($scope.vm.total=data.data.total/$scope.vm.pageSize<1?1:data.data.total/$scope.vm.pageSize,$scope.vm.timeList=data.data.objs,$scope.$apply(),getdetail($scope.vm.timeList[0].sessionId,1))})}function getList(index){httpRequestPost("/api/analysis/userSession/searchList",{applicationId:$scope.vm.applicationId,channelId:$scope.vm.channelId,dimensionId:$scope.vm.dimensionId,requestTimeType:$scope.vm.timeType,startTime:$scope.vm.timeStart,endTime:$scope.vm.timeEnd,index:(index-1)*$scope.vm.paginationConf.pageSize,pageSize:$scope.vm.paginationConf.pageSize,orderForSessionNumber:$scope.vm.orderForSessionNumber,orderForSessionTime:$scope.vm.orderForSessionTime},function(data){"没有查询到记录"==data.info?(layer.msg("此时间段内查询无会话日志"),$scope.$apply(function(){$scope.vm.paginationConf.totalItems=0,$scope.vm.listData=""})):$scope.$apply(function(){$scope.vm.paginationConf.currentPage=index,$scope.vm.paginationConf.totalItems=data.data.total,$scope.vm.paginationConf.numberOfPages=Math.ceil(data.data.total/$scope.vm.paginationConf.pageSize),$scope.vm.listData=data.data})})}function getdetail(sessionId,index){httpRequestPost("/api/analysis/userSession/searchTimeBarContent",{sessionId:sessionId,index:(index-1)*$scope.vm.pageSize,pageSize:$scope.vm.pageSize},function(data){null!=data&&($scope.vm.talkDetail=data.data.objs,$scope.vm.talkDetailTotal=data.data.total,$scope.$apply())},function(err){})}function nextPage(){$scope.vm.currentPage<$scope.vm.total?($scope.vm.currentPage+=1,getScanData($scope.vm.userId,$scope.vm.currentPage),getdetail($scope.vm.timeList[0].sessionId,1)):($scope.vm.currentPage=$scope.vm.total)&&($scope.vm.currentPage=$scope.vm.total)}function prePage(){($scope.vm.currentPage=1)?$scope.vm.currentPage=1:(getScanData($scope.vm.userId,$scope.vm.currentPage),getdetail($scope.vm.timeList[0].sessionId,1))}function init(){getDimensions(),getChannel(),getList(1)}function getDimensions(){httpRequestPost("/api/application/dimension/list",{applicationId:$scope.vm.applicationId},function(data){data.data&&($scope.vm.dimensions=data.data,$scope.$apply())},function(err){})}function getChannel(){httpRequestPost("/api/application/channel/listChannels",{applicationId:$scope.vm.applicationId},function(data){data.data&&($scope.vm.channels=data.data,$scope.$apply())},function(err){})}function exportExcel(){httpRequestPost("/api/analysis/userSession/export",{applicationId:$scope.vm.applicationId,channelId:$scope.vm.channelId,dimensionId:$scope.vm.dimensionId,requestTimeType:$scope.vm.timeType,startTime:$scope.vm.timeStart,endTime:$scope.vm.timeEnd,orderForSessionNumber:$scope.vm.orderForSessionNumber,orderForSessionTime:$scope.vm.orderForSessionTime},function(data){500==data.status||window.open("/api/analysis/download/downloadExcel?fileName="+data.data)},function(err){})}$scope.vm={applicationId:$cookieStore.get("applicationId"),scan:scan,getList:getList,listData:null,paginationConf:{pageSize:5,pagesLength:10},pageSize:10,dimensions:[],channels:[],channelId:null,dimensionId:null,timeType:1,timeStart:null,timeEnd:null,orderForSessionNumber:null,orderForSessionTime:null,timeList:[],getdetail:getdetail,currentPage:1,total:null,talkDetail:null,talkDetailTotal:0,userId:null,prePage:prePage,nextPage:nextPage,clearHistory:clearHistory,contentIndex:2,exportExcel:exportExcel};var timeout;$scope.$watch("vm.paginationConf.currentPage",function(current){current&&(timeout&&$timeout.cancel(timeout),timeout=$timeout(function(){getList(current)},100))},!0),$scope.$watch("vm.orderForSessionNumber",function(){getList($scope.vm.paginationConf.currentPage?$scope.vm.paginationConf.currentPage:1)}),$scope.$watch("vm.orderForSessionTime",function(){$scope.vm.orderForSessionNumber=null,getList($scope.vm.paginationConf.currentPage?$scope.vm.paginationConf.currentPage:1)}),init()}]),angular.module("applAnalysisModule").controller("vioceStatisticsController",["$scope","localStorageService","$state","$timeout","$stateParams","ngDialog","$cookieStore","$filter","$window",function($scope,localStorageService,$state,$timeout,$stateParams,ngDialog,$cookieStore,$filter,$window){$scope.vm={}}]),knowledge_static_web.directive("sort",function(){return{restrict:"EA",scope:{},template:'<a href="javascript:;"  ng-click="toggle()" ng-class="flag?\'sorting_asc\':\'sorting_asc2\'"></a>',link:function(scope,element,attrs){scope.flag=!1,scope.toggle=function(){scope.flag=!scope.flag}}}}),angular.module("applAnalysisModule").filter("operateState",[function(){return function(val,title){var result;switch(null==title&&(title=""),val){case"133":result="修改知识:"+title;break;case"134":result="删除知识:"+title;break;case"135":result="发布应用";break;case"136":result="删除应用";break;case"137":result="登录系统";break;case"138":result="退出系统";break;case"139":result="添加知识:"+title}return result}}]),angular.module("applAnalysisModule").filter("trustHtml",function($sce){return function(input){return $sce.trustAsHtml(input)}}),angular.module("know.auth").constant("AUTH_EVENTS",{loginSuccess:"auth-login-success",loginFailed:"auth-login-failed",logoutSuccess:"auth-logout-success",sessionTimeout:"auth-session-timeout",notAuthenticated:"auth-not-authenticated",notAuthorized:"auth-not-authorized"}),angular.module("know.auth").factory("AuthService",["$resource","$rootScope","$location","Session","AUTH_EVENTS","localStorageService",function($resource,$rootScope,$location,Session,AUTH_EVENTS,localStorageService){var authService={},loginSuccessFunction=function(fun,result){var data=result.data;Session.create(data.id),localStorageService.set("SessionId",data.id),localStorageService.set("privileges",data.privileges),$rootScope.$broadcast(AUTH_EVENTS.loginSuccess),fun(data)},logoutSuccessFunction=function(fun,result){var data=result.data;Session.destroy(data.id),localStorageService.clearAll(),$rootScope.$broadcast(AUTH_EVENTS.logoutSuccess),fun(data)},authFun=$resource("/back/system/user/:action",{},{login:{method:"POST",params:{action:"login"},isArray:!1,responseType:"json"},checkLoginStatus:{method:"GET",params:{action:"loadUser"},isArray:!1,responseType:"json"},logout:{method:"POST",params:{action:"logout"},isArray:!1,responseType:"json"}});return authService.login=function(credentials,successFunction,failedFunction){authFun.login({loginName:credentials.loginName,loginPwd:credentials.loginPwd,randCheckCode:credentials.randCheckCode,rember:credentials.rememberUser},function(result,b,c){"200"==result.status?(loginSuccessFunction(successFunction,result),$location.path("/index/home")):failedFunction(result.err)},function(a,b,c){$rootScope.$broadcast(AUTH_EVENTS.loginFailed)})},authService.logout=function(successFunction,failedFunction){authFun.logout({},function(result,b,c){"200"==result.status?(logoutSuccessFunction(successFunction,result),$location.path("/login")):failedFunction(result.err)},function(a,b,c){$rootScope.$broadcast(AUTH_EVENTS.loginFailed)})},authService.checkLoginStatus=function(credentials,fun){authFun.checkLoginStatus({},function(result,b,c){"200"==result.status&&loginSuccessFunction(fun,result)},function(a,b,c){Session.destroy(data.id),localStorageService.clearAll(),$rootScope.$broadcast(AUTH_EVENTS.loginFailed)})},authService}]),angular.module("know.auth").factory("AuthInterceptor",function($rootScope,$q,AUTH_EVENTS){return{responseError:function(response){return $rootScope.$broadcast({401:AUTH_EVENTS.notAuthenticated,403:AUTH_EVENTS.notAuthorized,419:AUTH_EVENTS.sessionTimeout,440:AUTH_EVENTS.sessionTimeout}[response.status],response),$q.reject(response)},request:function(config){var ts="?^="+(new Date).getTime();return config.url.indexOf("?")>0?config.url=config.url.replace("?",ts+"&"):config.url=config.url+ts,config}}}),angular.module("know.auth").service("Session",function(){return this.create=function(userId){this.userId=userId},this.destroy=function(){this.userId=null},this}),knowledge_static_web.directive("checkbox",function($parse){return{restrict:"EA",template:'<div class="my-checkbox" ng-click="toggle()"><label ng-class="flag?\'\':\'my-checkbox-on\'"></label></div>',link:function(scope,element,attrs){scope.flag=!0,scope.toggle=function(){scope.flag=!scope.flag}}}}).directive("checkboxOverview",[function(){return{restrict:"EA",scope:{arr:"=",item:"@",result:"="},template:'<div class="my-checkbox" ng-click="toggle()"><label ng-class="flag?\'\':\'my-checkbox-on\'"></label></div>',link:function(scope,element,attrs){scope.$watch("result",function(val){scope.flag=!val}),scope.toggle=function(){scope.flag=!scope.flag}}}}]),knowledge_static_web.directive("uploader",["$parse",function($parse){return{restrict:"EA",scope:{accept:"=",server:"=",type:"="},template:'<div id="uploader" class="wu-example upWrapper"><div id="thelist" class="uploader-list upList"></div><div class="btns"><div id="picker">选择文件</div></div></div>',link:function(scope,element,attrs){var $list=angular.element("#thelist"),uploader=WebUploader.create({auto:!0,swf:"Uploader.swf",formData:{title:"is Image  ====   uploader"},server:scope.server,accept:{title:"file",extensions:"xls,xlsx",mimeTypes:"file/*"},pick:"#picker",resize:!1,chunked:!0,chunkRetry:10,thread:100,disableGlobalDnd:!0,fileNumLimit:300,fileSizeLimit:209715200,fileSingleSizeLimit:52428800});uploader.on("fileQueued",function(file){$list.append('<div id="'+file.id+'" class="item"><h4 class="info">'+file.name+'</h4><p class="state">等待上传...</p></div>')}),uploader.on("uploadProgress",function(file,percentage){var $li=$("#"+file.id),$percent=$li.find(".progress .progress-bar");$percent.length||($percent=$('<div class="progress progress-striped active miles-progress" style="height: 50px;background: red; width: 200px;"><div class="progress-bar miles-progressBar" role="progressbar" style="width: 0%"></div></div>').appendTo($li).find(".progress-bar")),$li.find("p.state").text("上传中"),$percent.css("width",100*percentage+"%")}),uploader.on("uploadSuccess",function(file){$("#"+file.id).find("p.state").text("已上传")}),uploader.on("uploadError",function(file){$("#"+file.id).find("p.state").text("上传失败"),$("#"+file.id).find(".progress").fadeOut()}),uploader.on("uploadComplete",function(file){$("#"+file.id).find(".progress").fadeOut()})}}}]),angular.module("knowledge_static_web").filter("frameTypeFilter",function(){return function(value){switch(value){case 10011:return"FAQ框架";case 10012:return"概念扩展框架";case 10013:return"要素框架"}}}),knowledge_static_web.directive("knowledgeitem",["KnowledgePortalService","ngDialog",function(KnowledgePortalService){return{templateUrl:"../../..//base/knowledge_item/directives/knowledge_item.html",restrict:"E",replace:!0,link:function(scope,element){scope.focusKnowItem=function(knowItem){KnowledgePortalService.focus(knowItem)},scope.toShareKnowItem=function(selectedKnowItem){KnowledgePortalService.toShareKnowItem(selectedKnowItem)},scope.showCommentContainer=function(knowItemId){$("#commentContent"+knowItemId).is(":hidden")?($("#commentContent"+knowItemId).attr("class","show"),scope.comment=""):$("#commentContent"+knowItemId).attr("class","hide")},scope.submitComment=function(knowItemId){var comment=$("#commentContent"+knowItemId).find("textarea").val();null!=comment&&""!=$.trim(comment)&&KnowledgePortalService.replyKnowItem(knowItemId,comment)}}}}]),angular.module("knowledge_static_web").filter("limitCheckFilter",function(){return function(value){return value.substring(0,6)+"..."}}),angular.module("pagination",[]).directive("pagination",[function(){return{restrict:"EA",templateUrl:"static/base/page/template.html",replace:!0,scope:{conf:"="},link:function(scope,element,attrs){function getPagination(newValve,oldValue){if(scope.conf.currentPage=parseInt(scope.conf.currentPage)?parseInt(scope.conf.currentPage):1,scope.conf.totalItems=parseInt(scope.conf.totalItems)?parseInt(scope.conf.totalItems):0,scope.conf.pageSize=parseInt(scope.conf.pageSize)?parseInt(scope.conf.pageSize):15,scope.conf.numberOfPages=Math.ceil(scope.conf.totalItems/scope.conf.pageSize),scope.conf.currentPage<1&&(scope.conf.currentPage=1),scope.conf.numberOfPages>0&&scope.conf.currentPage>scope.conf.numberOfPages&&(scope.conf.currentPage=scope.conf.numberOfPages),scope.jumpPageNum=scope.conf.currentPage,scope.pageList=[],scope.conf.numberOfPages<=scope.conf.pagesLength)for(var i=1;i<=scope.conf.numberOfPages;i++)scope.pageList.push(i);else{var offset=scope.conf.pagesLength%2==0?scope.conf.pagesLength/2:(scope.conf.pagesLength-1)/2;if(scope.conf.currentPage<=offset){for(var i=1;i<=offset+1;i++)scope.pageList.push(i);scope.pageList.push("..."),scope.pageList.push(scope.conf.numberOfPages)}else if(scope.conf.currentPage>scope.conf.numberOfPages-offset){for(scope.pageList.push(1),scope.pageList.push("..."),i=offset;i>=1;i--)scope.pageList.push(scope.conf.numberOfPages-i);scope.pageList.push(scope.conf.numberOfPages)}else{scope.pageList.push(1),scope.pageList.push("...");for(var i=Math.ceil(offset/2)-1;i>=1;i--)scope.pageList.push(scope.conf.currentPage-i);scope.pageList.push(scope.conf.currentPage);for(var i=1;i<=offset/2;i++)scope.pageList.push(scope.conf.currentPage+i);scope.pageList.push("..."),scope.pageList.push(scope.conf.numberOfPages)}}scope.conf.onClick&&(oldValue!=newValve&&0==oldValue[0]||scope.conf.onClick(scope.conf)),scope.conf.target?scope.conf.target.currentPage=scope.conf.currentPage:scope.$parent.SearchPOJO?scope.$parent.SearchPOJO.currentPage=scope.conf.currentPage:scope.conf.methodFn&&scope.conf.methodFn(scope.conf)}scope.changeCurrentPage=function(item){"..."!=item&&(scope.conf.currentPage=item,$(window).scrollTop(0))},scope.prevPage=function(){scope.conf.currentPage>1&&(scope.conf.currentPage-=1)},scope.nextPage=function(){scope.conf.currentPage<scope.conf.numberOfPages&&(scope.conf.currentPage+=1)},scope.checkInput=function(){scope.jumpPageNum=scope.jumpPageNum.replace(/[^0-9]/g,"")},scope.jumpToPage=function(e){13==(window.event?e.keyCode:e.which)&&""!==scope.jumpPageNum&&(scope.conf.currentPage=scope.jumpPageNum)},scope.$watch(function(){return scope.conf.numberOfPages+" "+scope.conf.currentPage+" "+scope.conf.pageSize},getPagination)}}}]),angular.module("knowledge_static_web").filter("strReplace",["$sce",function($sce){return function(value){return value.split("；")}}]),angular.module("knowledge_static_web").filter("strReplace 2",function(){return function(value){return value.split(",")}}),knowledge_static_web.directive("onRenderFinish",[function(){return{restrict:"A",link:function(scope,element,attrs,controller){!0===scope.$last&&scope.$emit("onRenderFinish")}}}]),knowledge_static_web.directive("alertBar",[function(){return{restrict:"EA",templateUrl:"static/base/tip/directives/tip.html",scope:{message:"=",type:"="},link:function(scope,element,attrs){scope.hideAlert=function(){scope.message=null,scope.type=null}}}}]),knowledge_static_web.factory("TipService",["$timeout",function($timeout){return{message:null,type:null,setMessage:function(msg,type){this.message=msg,this.type=type;var _self=this;$timeout(function(){_self.clear()},3e3)},clear:function(){this.message=null,this.type=null}}}]),angular.module("knowledge_static_web").filter("weightFilter",function(){return function(value){switch(value){case 35:return"极不重要";case 34:return"不重要";case 33:return"一般";case 32:return"重要";case 31:return"极重要"}}}).filter("extensionWeightFilter",function(){return function(value){switch(value){case 1:return"普通";case 0:return"否定"}}}).filter("channelFilter",function(){return function(value){switch(value){case"130":return"微信";case"131":return"web";case"132":return"app"}}}).filter("channelFilterMulti",function(){return function(value){var channel="";return value.indexOf("130")>=0&&(channel+="微信,"),value.indexOf("131")>=0&&(channel+="web,"),value.indexOf("132")>=0&&(channel+="app,"),""!=channel&&","==channel.substring(channel.length-1,channel.length)&&(channel=channel.substring(0,channel.length-1)),channel}}).filter("sentimentTypeFilter",function(){return function(value){switch(value){case 490:return"乐";case 491:return"好";case 492:return"怒";case 493:return"哀";case 494:return"惧";case 495:return"恶";case 496:return"惊"}}}),knowledge_static_web.controller("knowItemDeleteController",["$scope","KnowledgeManagementService","TipService","KnowledgePortalService",function($scope,KnowledgeManagementService,TipService,KnowledgePortalService){$scope.knowItemDelete=function(){var knowItemId=$scope.ngDialogData.selectedKnowItem.id;if(null==knowItemId||""==knowItemId)return void TipService.setMessage("知识条目ID不能为空","warning ");KnowledgePortalService.deleteKnowItem(knowItemId)}}]),knowledge_static_web.controller("knowItemShareController",["$scope","KnowledgeManagementService","TipService","KnowledgePortalService",function($scope,KnowledgeManagementService,TipService,KnowledgePortalService){KnowledgeManagementService.get({},function(result){200==result.status&&result.data.list.length>0&&($scope.knowLibraries=result.data.list)}),$scope.knowItemShare=function(){var knowItemId=$scope.ngDialogData.selectedKnowItem.id;return null==$scope.selectedKnowLibrary||""==$scope.selectedKnowLibrary?void TipService.setMessage("请选定知识库","warning "):null==knowItemId&&""==$knowItemId?void TipService.setMessage("请选定知识条目","warning "):void KnowledgePortalService.share(knowItemId,$scope.selectedKnowLibrary)}}]),angular.module("businessModelingModule").controller("aggregateConceptManageController",["$scope","localStorageService","$state","ngDialog","$timeout","$cookieStore",function($scope,localStorageService,$state,ngDialog,$timeout,$cookieStore){function init(){$scope.vm.paginationConf={currentPage:1,totalItems:0,pageSize:0,pagesLength:8}}function loadCollectiveConceptTable(current){httpRequestPost("/api/ms/modeling/concept/collective/listByAttribute",{collectiveConceptApplicationId:$scope.vm.applicationId,index:(current-1)*$scope.vm.pageSize,pageSize:$scope.vm.pageSize},function(data){loadCollectiveConcept(current,data)},function(){})}function loadCollectiveConcept(current,data){clearSelectAll(),$scope.vm.listData=data.data,$scope.vm.paginationConf={currentPage:current,totalItems:data.total,pageSize:$scope.vm.pageSize,pagesLength:8},$scope.$apply()}function clearSelectAll(){$("#selectAll").attr("checked",!1),$("#selectAll").prop("checked",!1)}function batchDelete(){for(var ids=document.getElementsByName("sid"),id_array=[],i=0;i<ids.length;i++)ids[i].checked&&id_array.push(ids[i].value);if(0==id_array.length)return void layer.msg("请选择要删除的记录！",{time:1e3});layer.confirm("确认要删除吗？",function(index){layer.close(index);var request=new Object;request.ids=id_array,httpRequestPost("/api/ms/modeling/concept/collective/batchDelete",request,function(data){1==responseView(data)&&loadCollectiveConceptTable($scope.vm.paginationConf.currentPage)})})}function editCollective(item){$scope.vm.dialogTitle="编辑集合概念",$scope.vm.key=item.collectiveConceptKey,$scope.vm.term=item.collectiveConceptTerm,$scope.vm.weight=item.collectiveConceptWeight,addCollectiveConceptDialog(singleEditCollectiveConcept,item)}function searchCollectiveConcept(current){"collectiveConceptModifier"==$scope.vm.searchType?searchCollectiveConceptByUser(current):searchCollectiveConceptByType(current)}function searchCollectiveConceptByUser(current){httpRequestPost("/api/ms/modeling/concept/collective/listByModifier",{collectiveConceptModifier:$scope.vm.searchVal,collectiveConceptApplicationId:$scope.vm.applicationId,index:(current-1)*$scope.vm.pageSize,pageSize:$scope.vm.pageSize},function(data){loadCollectiveConcept(current,data)},function(){layer.msg("查询没有对应信息",{time:1e3})})}function searchCollectiveConceptByType(current){var request=new Object;if(request.collectiveConceptApplicationId=$scope.vm.applicationId,request.index=(current-1)*$scope.vm.pageSize,request.pageSize=$scope.vm.pageSize,"collectiveConceptModifyTime"!=$scope.vm.searchType)request=switchCollectiveConceptSearchType(request,$scope.vm.searchVal);else{if(1!=nullCheck($scope.vm.timeStart)||1!=nullCheck($scope.vm.timeEnd))return void layer.msg("请选择时间段",{time:1e3});request.startTimeRequest=$scope.vm.timeStart,request.endTimeRequest=$scope.vm.timeEnd}httpRequestPost("/api/ms/modeling/concept/collective/listByAttribute",request,function(data){loadCollectiveConcept(current,data)},function(){layer.msg("查询没有对应信息")})}function switchCollectiveConceptSearchType(request,value){return"collectiveConceptKey"==$("#searchType").val()?request.collectiveConceptKey=$scope.vm.percent+value+$scope.vm.percent:"collectiveConceptWeight"==$("#searchType").val()?request.collectiveConceptWeight=$("#collectiveConceptWeight").val():"collectiveConceptTerm"==$("#searchType").val()&&(request.collectiveConceptTerm=$scope.vm.percent+value+$scope.vm.percent),request}function addCollective(){ngDialog.openConfirm({template:"/static/businessModeling/aggregate/aggregateConceptManageDialog.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){if(1===e){if(0==lengthCheck($scope.vm.key,0,50))return $("#keyAddError").html($scope.vm.keyNullOrBeyondLimit),!1;httpRequestPost("/api/ms/modeling/concept/collective/repeatCheck",{collectiveConceptApplicationId:$scope.vm.applicationId,collectiveConceptKey:$scope.vm.key},function(data){10002===data.status?layer.confirm("您添加的概念类已经在，是否前往编辑？",{btn:["前往","取消"],shade:!1},function(index){layer.close(index),httpRequestPost("/api/ms/modeling/concept/collective/listByAttribute",{collectiveConceptApplicationId:$scope.vm.applicationId,collectiveConceptKey:$scope.vm.key,index:0,pageSize:1},function(data){$scope.vm.dialogTitle="编辑集合概念",addCollectiveConceptDialog(singleEditCollectiveConcept,data.data[0]),$scope.vm.key=data.data[0].collectiveConceptKey,$scope.vm.term=data.data[0].collectiveConceptTerm,$scope.vm.weight=data.data[0].collectiveConceptWeight},function(){})},function(){}):($scope.vm.dialogTitle="增加集合概念",$scope.vm.term="",$scope.vm.weight="33",addCollectiveConceptDialog(singleAddCollectiveConcept))},function(){})}else $scope.vm.key="",$scope.vm.term="",$scope.vm.weight=33}})&&$timeout(function(){termSpliterTagEditor(),$("#collectiveKey").blur(function(){0==lengthCheck($("#collectiveKey").val(),0,50)?$("#keyAddError").html($scope.vm.keyNullOrBeyondLimit):$("#keyAddError").html("")})},100)}function addCollectiveConceptDialog(callback,item){ngDialog.openConfirm({template:"/static/businessModeling/aggregate/aggregateConceptManageDialog2.html",scope:$scope,Returns:{a:1},closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){if(1===e){if(0==lengthCheck($scope.vm.key,0,50))return $("#keyAddError").html($scope.vm.keyNullOrBeyondLimit),!1;var obj=$("#term").next(),term="";if(obj.find("li").length<=0)return $("#termAddError").html($scope.vm.termNullOrBeyondLimit),!1;if($("#termAddError").html(""),$.each(obj.find("li"),function(index,value){index>0&&$.each($(value).find("div"),function(index1,value1){1==index1&&(term+=$(value1).html()+$scope.vm.termSpliter)})}),term=term.substring(0,term.length-1),$scope.vm.term=term,0==lengthCheck(term,0,500))return $("#termAddError").html($scope.vm.termNullOrBeyondLimit),!1;$("#termAddError").html(""),callback(item)}else $scope.vm.key="",$scope.vm.term="",$scope.vm.weight=33}})&&$timeout(function(){termSpliterTagEditor(),$("#colectiveKeyTwo").blur(function(){0==lengthCheck($("#colectiveKeyTwo").val(),0,50)?$("#keyAddError").html($scope.vm.keyNullOrBeyondLimit):$("#keyAddError").html("")})},100)}function deleteCollective(id){ngDialog.openConfirm({template:"/static/businessModeling/conceptManageDialog.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){1===e&&singleDelCollectiveConcept(id)}})}function batchUpload(){ngDialog.openConfirm({template:"/static/businessModeling/batchUpload.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){loadCollectiveConceptTable($scope.vm.paginationConf.currentPage)}})&&$timeout(function(){initUpload("/api/ms/modeling/concept/collective/batchAdd?applicationId="+$scope.vm.applicationId+"&modifierId="+$scope.vm.modifier)},100)}function singleEditCollectiveConcept(item){assembleCollectiveConceptTerm(),httpRequestPost("/api/ms/modeling/concept/collective/update",{collectiveConceptId:item.collectiveConceptId,collectiveConceptApplicationId:$scope.vm.applicationId,applicationId:$scope.vm.applicationId,collectiveConceptKey:$scope.vm.key,collectiveConceptModifier:$scope.vm.modifier,collectiveConceptTerm:$scope.vm.term,collectiveConceptWeight:$scope.vm.weight},function(data){1==responseView(data)&&loadCollectiveConceptTable($scope.vm.paginationConf.currentPage)})}function singleAddCollectiveConcept(){assembleCollectiveConceptTerm(),httpRequestPost("/api/ms/modeling/concept/collective/add",{collectiveConceptApplicationId:$scope.vm.applicationId,applicationId:$scope.vm.applicationId,collectiveConceptKey:$scope.vm.key,collectiveConceptModifier:$scope.vm.modifier,collectiveConceptTerm:$scope.vm.term,collectiveConceptWeight:$scope.vm.weight},function(data){1==responseView(data)&&loadCollectiveConceptTable($scope.vm.paginationConf.currentPage)})}function singleDelCollectiveConcept(id){httpRequestPost("/api/ms/modeling/concept/collective/delete",{collectiveConceptId:id},function(data){1==responseView(data)&&loadCollectiveConceptTable($scope.vm.paginationConf.currentPage)})}function termSpliterTagEditor(){var term=$scope.vm.term;if(""==term)$("#term").tagEditor({forceLowercase:!1});else{var terms=term.split($scope.vm.termSpliter);$("#term").tagEditor({initialTags:terms,autocomplete:{delay:0,position:{collision:"flip"},source:terms},forceLowercase:!1})}}function assembleCollectiveConceptTerm(){var obj=$("#term").next(),term="";$.each(obj.find("li"),function(index,value){index>0&&$.each($(value).find("div"),function(index1,value1){1==index1&&(term+=$(value1).html()+$scope.vm.termSpliter)})}),term=term.substring(0,term.length-1),$scope.vm.term=term}function responseView(data){return $scope.vm.key="",$scope.vm.term="",$scope.vm.weight=33,clearSelectAll(),null!=data&&(layer.msg(data.info),data.status==$scope.vm.success)}function downloadTemplate(){downloadFile("/api/ms/knowledgeManage/downloadKnowledgeTemplate","","concept_with_weight_template.xlsx")}function exportAll(){httpRequestPost("/api/ms/modeling/concept/collective/export",{collectiveConceptApplicationId:$scope.vm.applicationId},function(data){if(1==responseView(data))for(var i=0;i<data.exportFileNameList.length;i++)downloadFile("/api/ms/modeling/downloadWithPath",data.filePath,data.exportFileNameList[0])})}$scope.vm={success:1e4,illegal:10003,failed:10004,empty:10005,applicationId:$cookieStore.get("applicationId"),addCollective:addCollective,editCollective:editCollective,deleteCollective:deleteCollective,listData:"",singleDelCollectiveConcept:singleDelCollectiveConcept,singleAddCollectiveConcept:singleAddCollectiveConcept,paginationConf:"",pageSize:5,searchCollectiveConcept:searchCollectiveConcept,searchVal:"",searchType:"collectiveConceptKey",timeStart:"",timeEnd:"",key:"",modifier:$cookieStore.get("userId"),term:"",weight:"33",dialogTitle:"",inputSelect:[],inputVal:"",termSpliter:"；",percent:"%",keyNullOrBeyondLimit:"概念类名不能为空或超过长度限制50",termNullOrBeyondLimit:"概念集合不能为空或超过长度限制5000",downloadTemplate:downloadTemplate,exportAll:exportAll,batchUpload:batchUpload,batchDelete:batchDelete},init();var timeout;$scope.$watch("vm.paginationConf.currentPage",function(current){current&&(timeout&&$timeout.cancel(timeout),timeout=$timeout(function(){1==nullCheck($("#collectiveConceptWeight").val())||1==nullCheck($scope.vm.searchVal)||1==nullCheck($scope.vm.timeStart)&&1==nullCheck($scope.vm.timeEnd)?searchCollectiveConcept(current):loadCollectiveConceptTable(current)},100))},!0),$("#selectAll").on("click",function(){var ids=document.getElementsByName("sid"),flag=!1;this.checked&&(flag=!0),$.each(ids,function(index,value){flag?($(value).attr("checked",!0),$(value).prop("checked",!0)):($(value).attr("checked",!1),$(value).prop("checked",!1))})})}]),angular.module("businessModelingModule").controller("botConceptManageController",["$scope","localStorageService","$state","ngDialog","$timeout","$cookieStore",function($scope,localStorageService,$state,ngDialog,$timeout,$cookieStore){function init(){$scope.vm.paginationConf={currentPage:1,totalItems:0,pageSize:0,pagesLength:8}}function loadBotConceptTable(current){httpRequestPost("/api/ms/modeling/concept/bot/listByAttribute",{botConceptApplicationId:$scope.vm.applicationId,index:(current-1)*$scope.vm.pageSize,pageSize:$scope.vm.pageSize},function(data){loadBotConcept(current,data)},function(){})}function loadBotConcept(current,data){$scope.vm.listData=data.data,$scope.vm.paginationConf={currentPage:current,totalItems:data.total,pageSize:$scope.vm.pageSize,pagesLength:8},$scope.$apply()}function editBot(item){$scope.vm.dialogTitle="编辑BOT概念",$scope.vm.key=item.botConceptKey,$scope.vm.term=item.botConceptTerm,$scope.vm.weight=item.botConceptWeight,addBotConceptDialog(singleEditBotConcept,item)}function searchBotConcept(current){"botConceptModifier"==$scope.vm.searchType?searchBotConceptByUser(current):searchBotConceptByType(current)}function searchBotConceptByUser(current){httpRequestPost("/api/ms/modeling/concept/bot/listByModifier",{botConceptModifier:$scope.vm.searchVal,botConceptApplicationId:$scope.vm.applicationId,index:(current-1)*$scope.vm.pageSize,pageSize:$scope.vm.pageSize},function(data){loadBotConcept(current,data)},function(){layer.msg("查询没有对应信息")})}function searchBotConceptByType(current){var request=new Object;if(request.botConceptApplicationId=$scope.vm.applicationId,request.index=(current-1)*$scope.vm.pageSize,request.pageSize=$scope.vm.pageSize,"botConceptModifyTime"!=$scope.vm.searchType)request=switchBotConceptSearchType(request,$scope.vm.searchVal);else{if(1!=nullCheck($scope.vm.timeStart)||1!=nullCheck($scope.vm.timeEnd))return void layer.msg("请选择时间段");request.startTimeRequest=$scope.vm.timeStart,request.endTimeRequest=$scope.vm.timeEnd}httpRequestPost("/api/ms/modeling/concept/bot/listByAttribute",request,function(data){loadBotConcept(current,data)},function(){layer.msg("查询没有对应信息")})}function switchBotConceptSearchType(request,value){return"botConceptKey"==$("#searchType").val()?request.botConceptKey=$scope.vm.percent+value+$scope.vm.percent:"botConceptWeight"==$("#searchType").val()?request.botConceptWeight=$("#botConceptWeight").val():"botConceptTerm"==$("#searchType").val()&&(request.botConceptTerm=$scope.vm.percent+value+$scope.vm.percent),request}function addBot(){ngDialog.openConfirm({template:"/static/businessModeling/bot/botConceptManageDialog.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){if(1===e){if(0==lengthCheck($scope.vm.key,0,50))return $("#keyAddError").html($scope.vm.keyNullOrBeyondLimit),!1;httpRequestPost("/api/ms/modeling/concept/bot/repeatCheck",{botConceptApplicationId:$scope.vm.applicationId,botConceptKey:$scope.vm.key},function(data){10002===data.status?layer.confirm("您添加的概念类已经在，是否前往编辑？",{btn:["前往","取消"],shade:!1},function(index){layer.close(index),httpRequestPost("/api/ms/modeling/concept/bot/listByAttribute",{botConceptApplicationId:$scope.vm.applicationId,botConceptKey:$scope.vm.key,index:0,pageSize:1},function(data){$scope.vm.dialogTitle="编辑BOT概念",addBotConceptDialog(singleEditBotConcept,data.data[0]),$scope.vm.key=data.data[0].botConceptKey,$scope.vm.term=data.data[0].botConceptTerm,$scope.vm.weight=data.data[0].botConceptWeight},function(){})},function(){}):($scope.vm.dialogTitle="增加BOT概念",$scope.vm.term="",$scope.vm.weight="33",addBotConceptDialog(singleAddBotConcept))},function(){})}else $scope.vm.key="",$scope.vm.term="",$scope.vm.weight=33}})&&$timeout(function(){termSpliterTagEditor(),$("#botKey").blur(function(){0==lengthCheck($("#botKey").val(),0,50)?$("#keyAddError").html($scope.vm.keyNullOrBeyondLimit):$("#keyAddError").html("")})},100)}function addBotConceptDialog(callback,item){ngDialog.openConfirm({template:"/static/businessModeling/bot/botConceptManageDialog2.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){if(1===e){if(0==lengthCheck($scope.vm.key,0,50))return $("#keyAddError").html($scope.vm.keyNullOrBeyondLimit),!1;var obj=$("#term").next(),term="";if(obj.find("li").length<=0)return $("#termAddError").html($scope.vm.termNullOrBeyondLimit),!1;if($("#termAddError").html(""),$.each(obj.find("li"),function(index,value){index>0&&$.each($(value).find("div"),function(index1,value1){1==index1&&(term+=$(value1).html()+$scope.vm.termSpliter)})}),term=term.substring(0,term.length-1),$scope.vm.term=term,0==lengthCheck(term,0,500))return $("#termAddError").html($scope.vm.termNullOrBeyondLimit),!1;$("#termAddError").html(""),callback(item)}else $scope.vm.key="",$scope.vm.term="",$scope.vm.weight=33}})&&$timeout(function(){termSpliterTagEditor(),$("#botKeyTwo").blur(function(){0==lengthCheck($("#botKeyTwo").val(),0,50)?$("#keyAddError").html($scope.vm.keyNullOrBeyondLimit):$("#keyAddError").html("")})},100)}function deleteBot(id){ngDialog.openConfirm({template:"/static/businessModeling/conceptManageDialog.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){1===e&&singleDelBotConcept(id)}})}function singleEditBotConcept(item){assembleBotConceptTerm(),httpRequestPost("/api/ms/modeling/concept/bot/update",{botConceptId:item.botConceptId,botConceptApplicationId:$scope.vm.applicationId,applicationId:$scope.vm.applicationId,botConceptKey:$scope.vm.key,botConceptModifier:$scope.vm.modifier,botConceptTerm:$scope.vm.term,botConceptWeight:$scope.vm.weight},function(data){1==responseView(data)&&loadBotConceptTable($scope.vm.paginationConf.currentPage)})}function singleAddBotConcept(){assembleBotConceptTerm(),httpRequestPost("/api/ms/modeling/concept/bot/add",{botConceptApplicationId:$scope.vm.applicationId,applicationId:$scope.vm.applicationId,botConceptKey:$scope.vm.key,botConceptModifier:$scope.vm.modifier,botConceptTerm:$scope.vm.term,botConceptWeight:$scope.vm.weight},function(data){1==responseView(data)&&loadBotConceptTable($scope.vm.paginationConf.currentPage)})}function singleDelBotConcept(id){httpRequestPost("/api/ms/modeling/concept/bot/delete",{botConceptId:id},function(data){1==responseView(data)&&loadBotConceptTable($scope.vm.paginationConf.currentPage)})}function termSpliterTagEditor(){var term=$scope.vm.term;if(""==term)$("#term").tagEditor({forceLowercase:!1});else{var terms=term.split($scope.vm.termSpliter);$("#term").tagEditor({initialTags:terms,autocomplete:{delay:0,position:{collision:"flip"},source:terms},forceLowercase:!1})}}function assembleBotConceptTerm(){var obj=$("#term").next(),term="";$.each(obj.find("li"),function(index,value){index>0&&$.each($(value).find("div"),function(index1,value1){1==index1&&(term+=$(value1).html()+$scope.vm.termSpliter)})}),term=term.substring(0,term.length-1),$scope.vm.term=term}function responseView(data){return null!=data&&(layer.msg(data.info),data.status==$scope.vm.success)}$scope.vm={success:1e4,illegal:10003,failed:10004,empty:10005,applicationId:$cookieStore.get("applicationId"),addBot:addBot,editBot:editBot,deleteBot:deleteBot,listData:"",singleDelBotConcept:singleDelBotConcept,singleAddBotConcept:singleAddBotConcept,paginationConf:"",pageSize:5,searchBotConcept:searchBotConcept,searchVal:"",searchType:"botConceptKey",timeStart:"",timeEnd:"",key:"",modifier:$cookieStore.get("userId"),term:"",weight:"33",dialogTitle:"",inputSelect:[],inputVal:"",termSpliter:"；",percent:"%",keyNullOrBeyondLimit:"概念类名不能为空或超过长度限制50",termNullOrBeyondLimit:"概念集合不能为空或超过长度限制5000"},init();var timeout;$scope.$watch("vm.paginationConf.currentPage",function(current){current&&(timeout&&$timeout.cancel(timeout),timeout=$timeout(function(){1==nullCheck($("#botConceptWeight").val())||1==nullCheck($scope.vm.searchVal)||1==nullCheck($scope.vm.timeStart)&&1==nullCheck($scope.vm.timeEnd)?searchBotConcept(current):loadBotConceptTable(current)},100))},!0)}]),angular.module("businessModelingModule").controller("businessConceptManageController",["$scope","localStorageService","$state","ngDialog","$timeout","$interval","$cookieStore",function($scope,localStorageService,$state,ngDialog,$timeout,$interval,$cookieStore){function init(){$scope.vm.paginationConf={currentPage:1,totalItems:0,pageSize:0,pagesLength:8}}function loadBusinessConceptTable(current){httpRequestPost("/api/ms/modeling/concept/business/listByAttribute",{businessConceptApplicationId:$scope.vm.applicationId,index:(current-1)*$scope.vm.pageSize,pageSize:$scope.vm.pageSize},function(data){loadBusinessConcept(current,data)},function(){})}function loadBusinessConcept(current,data){clearSelectAll(),$scope.vm.listData=data.data,$scope.vm.paginationConf={currentPage:current,totalItems:data.total,pageSize:$scope.vm.pageSize,pagesLength:8},$scope.$apply()}function clearSelectAll(){$("#selectAll").attr("checked",!1),$("#selectAll").prop("checked",!1)}function batchDelete(){for(var ids=document.getElementsByName("sid"),id_array=[],i=0;i<ids.length;i++)ids[i].checked&&id_array.push(ids[i].value);if(0==id_array.length)return void layer.msg("请选择要删除的记录！");layer.confirm("确认要删除吗？",function(index){layer.close(index);var request=new Object;request.ids=id_array,httpRequestPost("/api/ms/modeling/concept/business/batchDelete",request,function(data){1==responseView(data)&&loadBusinessConceptTable($scope.vm.paginationConf.currentPage)})})}function editBusiness(item){$scope.vm.dialogTitle="编辑业务概念",$scope.vm.key=item.businessConceptKey,$scope.vm.term=item.businessConceptTerm,$scope.vm.relate=item.businessConceptRelate,$scope.vm.weight=item.businessConceptWeight,addBusinessConceptDialog(singleEditBusinessConcept,item)}function searchBusinessConcept(current){"businessConceptModifier"==$scope.vm.searchType?searchBusinessConceptByUser(current):searchBusinessConceptByType(current)}function searchBusinessConceptByUser(current){httpRequestPost("/api/ms/modeling/concept/business/listByModifier",{businessConceptApplicationId:$scope.vm.applicationId,businessConceptModifier:$scope.vm.searchVal,index:(current-1)*$scope.vm.pageSize,pageSize:$scope.vm.pageSize},function(data){loadBusinessConcept(current,data)},function(){layer.msg("查询没有对应信息")})}function searchBusinessConceptByType(current){var request=new Object;if(request.businessConceptApplicationId=$scope.vm.applicationId,request.index=(current-1)*$scope.vm.pageSize,request.pageSize=$scope.vm.pageSize,"businessConceptModifyTime"!=$scope.vm.searchType)request=switchBusinessConceptSearchType(request,$scope.vm.searchVal);else{if(1!=nullCheck($scope.vm.timeStart)||1!=nullCheck($scope.vm.timeEnd))return void layer.msg("请选择时间段");request.startTimeRequest=$scope.vm.timeStart,request.endTimeRequest=$scope.vm.timeEnd}httpRequestPost("/api/ms/modeling/concept/business/listByAttribute",request,function(data){loadBusinessConcept(current,data)},function(){layer.msg("查询没有对应信息")})}function switchBusinessConceptSearchType(request,value){return"businessConceptKey"==$("#searchType").val()?request.businessConceptKey=$scope.vm.percent+value+$scope.vm.percent:"businessConceptWeight"==$("#searchType").val()?request.businessConceptWeight=$("#businessConceptWeight").val():"businessConceptTerm"==$("#searchType").val()&&(request.businessConceptTerm=$scope.vm.percent+value+$scope.vm.percent),request}function addBusiness(){ngDialog.openConfirm({template:"/static/businessModeling/business/businessConceptManageDialog.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){if(1===e){if(0==lengthCheck($scope.vm.key,0,50))return $("#keyAddError").html($scope.vm.keyNullOrBeyondLimit),!1;httpRequestPost("/api/ms/modeling/concept/business/repeatCheck",{businessConceptApplicationId:$scope.vm.applicationId,businessConceptKey:$scope.vm.key},function(data){10002===data.status?layer.confirm("您添加的概念类已经在，是否前往编辑？",{btn:["前往","取消"],shade:!1},function(index){layer.close(index),httpRequestPost("/api/ms/modeling/concept/business/listByAttribute",{businessConceptApplicationId:$scope.vm.applicationId,businessConceptKey:$scope.vm.key,index:0,pageSize:1},function(data){$scope.vm.dialogTitle="编辑业务概念",addBusinessConceptDialog(singleEditBusinessConcept,data.data[0]),$scope.vm.key=data.data[0].businessConceptKey,$scope.vm.term=data.data[0].businessConceptTerm,$scope.vm.relate=data.data[0].businessConceptRelate,$scope.vm.weight=data.data[0].businessConceptWeight},function(){})},function(){}):($scope.vm.dialogTitle="增加业务概念",$scope.vm.term="",$scope.vm.relate="",$scope.vm.weight="33",findMining())},function(){})}else $scope.vm.key="",$scope.vm.term="",$scope.vm.relate="",$scope.vm.weight=33}})&&$timeout(function(){$("#businessKey").blur(function(){0==lengthCheck($("#businessKey").val(),0,50)?$("#keyAddError").html($scope.vm.keyNullOrBeyondLimit):$("#keyAddError").html("")})},100)}function addBusinessConceptDialog(callback,item){ngDialog.openConfirm({template:"/static/businessModeling/business/businessConceptManageDialog2.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){if(1===e){if(0==lengthCheck($scope.vm.key,0,50))return $("#keyAddError").html($scope.vm.keyNullOrBeyondLimit),!1;var obj=$("#term").next(),term="";if(obj.find("li").length<=0)return $("#termAddError").html($scope.vm.termNullOrBeyondLimit),!1;$("#termAddError").html("");var objRelate=$("#relate").next(),relate="";if(objRelate.find("li").length>20)return $("#relateAddError").html($scope.vm.relateBeyondLimit),!1;if($("#relateAddError").html(""),$.each(obj.find("li"),function(index,value){index>0&&$.each($(value).find("div"),function(index1,value1){1==index1&&(term+=$(value1).html()+$scope.vm.termSpliter)})}),term=term.substring(0,term.length-1),$scope.vm.term=term,0==lengthCheck(term,0,5e3))return $("#termAddError").html($scope.vm.termNullOrBeyondLimit),!1;if($("#termAddError").html(""),$.each(objRelate.find("li"),function(index,value){index>0&&$.each($(value).find("div"),function(index1,value1){1==index1&&(relate+=$(value1).html()+$scope.vm.termSpliter)})}),""!=relate){if(relate=relate.substring(0,relate.length-1),$scope.vm.relate=relate,0==lengthCheck(relate,0,5e3))return $("#relateAddError").html($scope.vm.relateNullOrBeyondLimit),!1;$("#relateAddError").html("")}callback(item)}else $scope.vm.key="",$scope.vm.term="",$scope.vm.relate="",$scope.vm.weight=33}})&&$timeout(function(){termSpliterTagEditor(),relateSpliterTagEditor(),$("#businessKeyTwo").blur(function(){0==lengthCheck($("#businessKeyTwo").val(),0,50)?$("#keyAddError").html($scope.vm.keyNullOrBeyondLimit):$("#keyAddError").html("")})},100)}function findMining(){httpRequestPostParam("/api/ms/modeling/concept/mining/listByConceptKey",{request:"string",question:$scope.vm.key,count:5},function(data){200==data.status?($scope.vm.term=data.data,addBusinessConceptDialog(singleAddBusinessConcept,$scope.vm.term)):addBusinessConceptDialog(singleAddBusinessConcept)})}function deleteBusiness(id){ngDialog.openConfirm({template:"/static/businessModeling/conceptManageDialog.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){1===e&&singleDelBusinessConcept(id)}})}function batchUpload(){ngDialog.openConfirm({template:"/static/businessModeling/batchUpload.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){loadBusinessConceptTable($scope.vm.paginationConf.currentPage)}})&&$timeout(function(){initUpload("/api/ms/modeling/concept/business/batchAdd?applicationId="+$scope.vm.applicationId+"&modifierId="+$scope.vm.modifier)},100)}function singleEditBusinessConcept(item){assembleBusinessConceptTerm(),assembleBusinessConceptRelate(),httpRequestPost("/api/ms/modeling/concept/business/update",{businessConceptId:item.businessConceptId,businessConceptApplicationId:$scope.vm.applicationId,applicationId:$scope.vm.applicationId,businessConceptKey:$scope.vm.key,businessConceptModifier:$scope.vm.modifier,businessConceptTerm:$scope.vm.term,businessConceptRelate:$scope.vm.relate,businessConceptWeight:$scope.vm.weight},function(data){1==responseView(data)&&loadBusinessConceptTable($scope.vm.paginationConf.currentPage)})}function singleAddBusinessConcept(){assembleBusinessConceptTerm(),assembleBusinessConceptRelate(),httpRequestPost("/api/ms/modeling/concept/business/add",{businessConceptApplicationId:$scope.vm.applicationId,applicationId:$scope.vm.applicationId,businessConceptKey:$scope.vm.key,businessConceptModifier:$scope.vm.modifier,businessConceptTerm:$scope.vm.term,businessConceptRelate:$scope.vm.relate,businessConceptWeight:$scope.vm.weight},function(data){1==responseView(data)&&loadBusinessConceptTable($scope.vm.paginationConf.currentPage)})}function singleDelBusinessConcept(id){httpRequestPost("/api/ms/modeling/concept/business/delete",{businessConceptId:id},function(data){1==responseView(data)&&loadBusinessConceptTable($scope.vm.paginationConf.currentPage)})}function termSpliterTagEditor(){var term=$scope.vm.term;if(""==term)$("#term").tagEditor({forceLowercase:!1});else if(term instanceof Array)$("#term").tagEditor({initialTags:term,autocomplete:{delay:0,position:{collision:"flip"},source:term},forceLowercase:!1});else{var terms=term.split($scope.vm.termSpliter);$("#term").tagEditor({initialTags:terms,autocomplete:{delay:0,position:{collision:"flip"},source:terms},forceLowercase:!1})}}function relateSpliterTagEditor(){var relate=$scope.vm.relate;if(""==relate||null==relate)$("#relate").tagEditor({forceLowercase:!1});else{var relates=relate.split($scope.vm.termSpliter);$("#relate").tagEditor({initialTags:relates,autocomplete:{delay:0,position:{collision:"flip"},source:relates},forceLowercase:!1})}}function assembleBusinessConceptTerm(){var obj=$("#term").next(),term="";obj.find("li").length;$.each(obj.find("li"),function(index,value){index>0&&$.each($(value).find("div"),function(index1,value1){1==index1&&(term+=$(value1).html()+$scope.vm.termSpliter)})}),term=term.substring(0,term.length-1),$scope.vm.term=term}function assembleBusinessConceptRelate(){var obj=$("#relate").next(),relate="";obj.find("li").length;$.each(obj.find("li"),function(index,value){index>0&&$.each($(value).find("div"),function(index1,value1){1==index1&&(relate+=$(value1).html()+$scope.vm.termSpliter)})}),relate=relate.substring(0,relate.length-1),$scope.vm.relate=relate}function responseView(data){return $scope.vm.key="",$scope.vm.term="",$scope.vm.relate="",$scope.vm.weight=33,clearSelectAll(),null!=data&&(layer.msg(data.info),data.status==$scope.vm.success)}function downloadTemplate(){downloadFile("/api/ms/knowledgeManage/downloadKnowledgeTemplate","","business_concept_template.xlsx")}function exportAll(){httpRequestPost("/api/ms/modeling/concept/business/export",{businessConceptApplicationId:$scope.vm.applicationId},function(data){if(1==responseView(data))for(var i=0;i<data.exportFileNameList.length;i++)downloadFile("/api/ms/modeling/downloadWithPath",data.filePath,data.exportFileNameList[0])})}$scope.vm={success:1e4,illegal:10003,failed:10004,empty:10005,applicationId:$cookieStore.get("applicationId"),addBusiness:addBusiness,editBusiness:editBusiness,deleteBusiness:deleteBusiness,listData:"",singleDelBusinessConcept:singleDelBusinessConcept,singleAddBusinessConcept:singleAddBusinessConcept,paginationConf:"",pageSize:5,searchBusinessConcept:searchBusinessConcept,searchVal:"",searchType:"businessConceptKey",timeStart:"",timeEnd:"",key:"",modifier:$cookieStore.get("userId"),term:"",relate:"",weight:"33",dialogTitle:"",inputSelect:[],inputVal:"",termSpliter:"；",percent:"%",keyNullOrBeyondLimit:"概念类名不能为空或超过长度限制50",termNullOrBeyondLimit:"概念集合不能为空或超过长度限制5000",relateNullOrBeyondLimit:"相关概念不能超过长度限制2000",relateBeyondLimit:"相关概念个数不能超过20个",downloadTemplate:downloadTemplate,exportAll:exportAll,batchUpload:batchUpload,batchDelete:batchDelete,findMining:findMining},init();var timeout;$scope.$watch("vm.paginationConf.currentPage",function(current){current&&(timeout&&$timeout.cancel(timeout),timeout=$timeout(function(){1==nullCheck($("#businessConceptWeight").val())||1==nullCheck($scope.vm.searchVal)||1==nullCheck($scope.vm.timeStart)&&1==nullCheck($scope.vm.timeEnd)?searchBusinessConcept(current):loadBusinessConceptTable(current)},100))},!0),$("#selectAll").on("click",function(){var ids=document.getElementsByName("sid"),flag=!1;this.checked&&(flag=!0),$.each(ids,function(index,value){flag?($(value).attr("checked",!0),$(value).prop("checked",!0)):($(value).attr("checked",!1),$(value).prop("checked",!1))})})}]),angular.module("businessModelingModule").controller("businessModelingController",["$scope","$state","$stateParams",function($scope,$state,$stateParams){}]),angular.module("businessModelingModule").controller("disableConceptManageController",["$scope","localStorageService","$state","ngDialog","$timeout","$cookieStore",function($scope,localStorageService,$state,ngDialog,$timeout,$cookieStore){function init(){$scope.vm.paginationConf={currentPage:1,totalItems:0,pageSize:0,pagesLength:8}}function loadStopConceptTable(current){httpRequestPost("/api/ms/modeling/concept/stop/listByAttribute",{stopConceptApplicationId:$scope.vm.applicationId,index:(current-1)*$scope.vm.pageSize,pageSize:$scope.vm.pageSize},function(data){loadStopConcept(current,data)},function(){})}function loadStopConcept(current,data){clearSelectAll(),$scope.vm.listData=data.data,$scope.vm.paginationConf={currentPage:current,totalItems:data.total,pageSize:$scope.vm.pageSize,pagesLength:8},$scope.$apply()}function clearSelectAll(){$("#selectAll").attr("checked",!1),$("#selectAll").prop("checked",!1)}function batchDelete(){for(var ids=document.getElementsByName("sid"),id_array=[],i=0;i<ids.length;i++)ids[i].checked&&id_array.push(ids[i].value);if(0==id_array.length)return void layer.msg("请选择要删除的记录！");layer.confirm("确认要删除吗？",function(index){layer.close(index);var request=new Object;request.ids=id_array,httpRequestPost("/api/ms/modeling/concept/stop/batchDelete",request,function(data){1==responseView(data)&&loadStopConceptTable($scope.vm.paginationConf.currentPage)})})}function editStop(item){$scope.vm.dialogTitle="编辑停用概念",$scope.vm.key=item.stopConceptKey,$scope.vm.term=item.stopConceptTerm,addStopConceptDialog(singleEditStopConcept,item)}function searchStopConcept(current){"stopConceptModifier"==$scope.vm.searchType?searchStopConceptByUser(current):searchStopConceptByType(current)}function searchStopConceptByUser(current){httpRequestPost("/api/ms/modeling/concept/stop/listByModifier",{stopConceptModifier:$scope.vm.searchVal,stopConceptApplicationId:$scope.vm.applicationId,index:(current-1)*$scope.vm.pageSize,pageSize:$scope.vm.pageSize},function(data){loadStopConcept(current,data)},function(){layer.msg("查询没有对应信息")})}function searchStopConceptByType(current){var request=new Object;if(request.stopConceptApplicationId=$scope.vm.applicationId,request.index=(current-1)*$scope.vm.pageSize,request.pageSize=$scope.vm.pageSize,"stopConceptModifyTime"!=$scope.vm.searchType)request=switchStopConceptSearchType(request,$scope.vm.searchVal);else{if(1!=nullCheck($scope.vm.timeStart)||1!=nullCheck($scope.vm.timeEnd))return void layer.msg("请选择时间段");request.startTimeRequest=$scope.vm.timeStart,request.endTimeRequest=$scope.vm.timeEnd}httpRequestPost("/api/ms/modeling/concept/stop/listByAttribute",request,function(data){loadStopConcept(current,data)},function(){layer.msg("查询没有对应信息")})}function switchStopConceptSearchType(request,value){return"stopConceptKey"==$("#searchType").val()?request.stopConceptKey=$scope.vm.percent+value+$scope.vm.percent:"stopConceptTerm"==$("#searchType").val()&&(request.stopConceptTerm=$scope.vm.percent+value+$scope.vm.percent),request}function addStop(){ngDialog.openConfirm({template:"/static/businessModeling/disable/disableConceptManageDialog.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){if(1===e){if(0==lengthCheck($scope.vm.key,0,50))return $("#keyAddError").html($scope.vm.keyNullOrBeyondLimit),!1;httpRequestPost("/api/ms/modeling/concept/stop/repeatCheck",{stopConceptApplicationId:$scope.vm.applicationId,stopConceptKey:$scope.vm.key},function(data){10002===data.status?layer.confirm("您添加的概念类已经在，是否前往编辑？",{btn:["前往","取消"],shade:!1},function(index){layer.close(index),httpRequestPost("/api/ms/modeling/concept/stop/listByAttribute",{stopConceptApplicationId:$scope.vm.applicationId,stopConceptKey:$scope.vm.key,index:0,pageSize:1},function(data){$scope.vm.dialogTitle="编辑停用概念",addStopConceptDialog(singleEditStopConcept,data.data[0]),$scope.vm.key=data.data[0].stopConceptKey,$scope.vm.term=data.data[0].stopConceptTerm},function(){})},function(){}):($scope.vm.dialogTitle="增加停用概念",$scope.vm.term="",addStopConceptDialog(singleAddStopConcept))},function(){})}else $scope.vm.key="",$scope.vm.term=""}})&&$timeout(function(){termSpliterTagEditor(),$("#stopKey").blur(function(){0==lengthCheck($("#stopKey").val(),0,50)?$("#keyAddError").html($scope.vm.keyNullOrBeyondLimit):$("#keyAddError").html("")})},100)}function addStopConceptDialog(callback,item){ngDialog.openConfirm({template:"/static/businessModeling/disable/disableConceptManageDialog2.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){if(1===e){if(0==lengthCheck($scope.vm.key,0,50))return $("#keyAddError").html($scope.vm.keyNullOrBeyondLimit),!1;var obj=$("#term").next(),term="";if(obj.find("li").length<=0)return $("#termAddError").html($scope.vm.termNullOrBeyondLimit),!1;if($("#termAddError").html(""),$.each(obj.find("li"),function(index,value){index>0&&$.each($(value).find("div"),function(index1,value1){1==index1&&(term+=$(value1).html()+$scope.vm.termSpliter)})}),term=term.substring(0,term.length-1),$scope.vm.term=term,0==lengthCheck(term,0,500))return $("#termAddError").html($scope.vm.termNullOrBeyondLimit),!1;$("#termAddError").html(""),callback(item)}else $scope.vm.key="",$scope.vm.term=""}})&&$timeout(function(){termSpliterTagEditor(),$("#stopKeyTwo").blur(function(){0==lengthCheck($("#stopKeyTwo").val(),0,50)?$("#keyAddError").html($scope.vm.keyNullOrBeyondLimit):$("#keyAddError").html("")})},100)}function deleteStop(id){ngDialog.openConfirm({template:"/static/businessModeling/conceptManageDialog.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){1===e&&singleDelStopConcept(id)}})}function batchUpload(){ngDialog.openConfirm({template:"/static/businessModeling/batchUpload.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){loadStopConceptTable($scope.vm.paginationConf.currentPage)}})&&$timeout(function(){initUpload("/api/ms/modeling/concept/stop/batchAdd?applicationId="+$scope.vm.applicationId+"&modifierId="+$scope.vm.modifier)},100)}function singleEditStopConcept(item){assembleStopConceptTerm(),httpRequestPost("/api/ms/modeling/concept/stop/update",{stopConceptId:item.stopConceptId,stopConceptApplicationId:$scope.vm.applicationId,applicationId:$scope.vm.applicationId,stopConceptKey:$scope.vm.key,stopConceptModifier:$scope.vm.modifier,stopConceptTerm:$scope.vm.term},function(data){1==responseView(data)&&loadStopConceptTable($scope.vm.paginationConf.currentPage)})}function singleAddStopConcept(){assembleStopConceptTerm(),httpRequestPost("/api/ms/modeling/concept/stop/add",{stopConceptApplicationId:$scope.vm.applicationId,applicationId:$scope.vm.applicationId,stopConceptKey:$scope.vm.key,stopConceptModifier:$scope.vm.modifier,stopConceptTerm:$scope.vm.term},function(data){1==responseView(data)&&loadStopConceptTable($scope.vm.paginationConf.currentPage)})}function singleDelStopConcept(id){httpRequestPost("/api/ms/modeling/concept/stop/delete",{stopConceptId:id},function(data){1==responseView(data)&&loadStopConceptTable($scope.vm.paginationConf.currentPage)})}function termSpliterTagEditor(){var term=$scope.vm.term;if(""==term)$("#term").tagEditor({forceLowercase:!1});else{var terms=term.split($scope.vm.termSpliter);$("#term").tagEditor({initialTags:terms,autocomplete:{delay:0,position:{collision:"flip"},source:terms},forceLowercase:!1})}}function assembleStopConceptTerm(){var obj=$("#term").next(),term="";$.each(obj.find("li"),function(index,value){index>0&&$.each($(value).find("div"),function(index1,value1){1==index1&&(term+=$(value1).html()+$scope.vm.termSpliter)})}),term=term.substring(0,term.length-1),$scope.vm.term=term}function responseView(data){return $scope.vm.key="",$scope.vm.term="",clearSelectAll(),null!=data&&(layer.msg(data.info),data.status==$scope.vm.success)}function downloadTemplate(){downloadFile("/api/ms/knowledgeManage/downloadKnowledgeTemplate","","concept_template.xlsx")}function exportAll(){httpRequestPost("/api/ms/modeling/concept/stop/export",{stopConceptApplicationId:$scope.vm.applicationId},function(data){if(1==responseView(data))for(var i=0;i<data.exportFileNameList.length;i++)downloadFile("/api/ms/modeling/downloadWithPath",data.filePath,data.exportFileNameList[0])})}$scope.vm={success:1e4,illegal:10003,failed:10004,empty:10005,applicationId:$cookieStore.get("applicationId"),addStop:addStop,editStop:editStop,deleteStop:deleteStop,listData:"",singleDelStopConcept:singleDelStopConcept,singleAddStopConcept:singleAddStopConcept,paginationConf:"",pageSize:5,searchStopConcept:searchStopConcept,searchVal:"",searchType:"stopConceptKey",timeStart:"",timeEnd:"",key:"",modifier:$cookieStore.get("userId"),term:"",dialogTitle:"",inputSelect:[],inputVal:"",termSpliter:"；",percent:"%",keyNullOrBeyondLimit:"概念类名不能为空或超过长度限制50",termNullOrBeyondLimit:"概念集合不能为空或超过长度限制5000",downloadTemplate:downloadTemplate,exportAll:exportAll,batchUpload:batchUpload,batchDelete:batchDelete},init();var timeout;$scope.$watch("vm.paginationConf.currentPage",function(current){current&&(timeout&&$timeout.cancel(timeout),timeout=$timeout(function(){1==nullCheck($scope.vm.searchVal)||1==nullCheck($scope.vm.timeStart)&&1==nullCheck($scope.vm.timeEnd)?searchStopConcept(current):loadStopConceptTable(current)},100))},!0),$("#selectAll").on("click",function(){var ids=document.getElementsByName("sid"),flag=!1;this.checked&&(flag=!0),$.each(ids,function(index,value){flag?($(value).attr("checked",!0),$(value).prop("checked",!0)):($(value).attr("checked",!1),$(value).prop("checked",!1))})})}]),angular.module("businessModelingModule").controller("errorCorrectionConceptManageController",["$scope","localStorageService","$state","ngDialog","$timeout","$cookieStore",function($scope,localStorageService,$state,ngDialog,$timeout,$cookieStore){function init(){$scope.vm.paginationConf={currentPage:1,totalItems:0,pageSize:0,pagesLength:8}}function loadCorrectionConceptTable(current){httpRequestPost("/api/ms/modeling/concept/correction/listByAttribute",{correctionConceptApplicationId:$scope.vm.applicationId,index:(current-1)*$scope.vm.pageSize,pageSize:$scope.vm.pageSize},function(data){loadCorrectionConcept(current,data)},function(){})}function loadCorrectionConcept(current,data){clearSelectAll(),$scope.vm.listData=data.data,$scope.vm.paginationConf={currentPage:current,totalItems:data.total,pageSize:$scope.vm.pageSize,pagesLength:8},$scope.$apply()}function clearSelectAll(){$("#selectAll").attr("checked",!1),$("#selectAll").prop("checked",!1)}function batchDelete(){for(var ids=document.getElementsByName("sid"),id_array=[],i=0;i<ids.length;i++)ids[i].checked&&id_array.push(ids[i].value);if(0==id_array.length)return void layer.msg("请选择要删除的记录！");layer.confirm("确认要删除吗？",function(index){layer.close(index);var request=new Object;request.ids=id_array,httpRequestPost("/api/ms/modeling/concept/correction/batchDelete",request,function(data){1==responseView(data)&&loadCorrectionConceptTable($scope.vm.paginationConf.currentPage)})})}function editCorrection(item){$scope.vm.dialogTitle="编辑纠错概念",$scope.vm.key=item.correctionConceptKey,$scope.vm.term=item.correctionConceptTerm,addCorrectionConceptDialog(singleEditCorrectionConcept,item)}function searchCorrectionConcept(current){"correctionConceptModifier"==$scope.vm.searchType?searchCorrectionConceptByUser(current):searchCorrectionConceptByType(current)}function searchCorrectionConceptByUser(current){httpRequestPost("/api/ms/modeling/concept/correction/listByModifier",{correctionConceptModifier:$scope.vm.searchVal,correctionConceptApplicationId:$scope.vm.applicationId,index:(current-1)*$scope.vm.pageSize,pageSize:$scope.vm.pageSize},function(data){loadCorrectionConcept(current,data)},function(){layer.msg("查询没有对应信息")})}function searchCorrectionConceptByType(current){var request=new Object;if(request.correctionConceptApplicationId=$scope.vm.applicationId,request.index=(current-1)*$scope.vm.pageSize,request.pageSize=$scope.vm.pageSize,"correctionConceptModifyTime"!=$scope.vm.searchType)request=switchCorrectionConceptSearchType(request,$scope.vm.searchVal);else{if(1!=nullCheck($scope.vm.timeStart)||1!=nullCheck($scope.vm.timeEnd))return void layer.msg("请选择时间段");request.startTimeRequest=$scope.vm.timeStart,request.endTimeRequest=$scope.vm.timeEnd}httpRequestPost("/api/ms/modeling/concept/correction/listByAttribute",request,function(data){loadCorrectionConcept(current,data)},function(){layer.msg("查询没有对应信息")})}function switchCorrectionConceptSearchType(request,value){return"correctionConceptKey"==$("#searchType").val()?request.correctionConceptKey=$scope.vm.percent+value+$scope.vm.percent:"correctionConceptTerm"==$("#searchType").val()&&(request.correctionConceptTerm=$scope.vm.percent+value+$scope.vm.percent),request}function addCorrection(){ngDialog.openConfirm({template:"/static/businessModeling/errorCorrection/errorCorrectionConceptManageDialog.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){if(1===e){if(0==lengthCheck($scope.vm.key,0,50))return $("#keyAddError").html($scope.vm.keyNullOrBeyondLimit),!1;httpRequestPost("/api/ms/modeling/concept/correction/repeatCheck",{correctionConceptApplicationId:$scope.vm.applicationId,correctionConceptKey:$scope.vm.key},function(data){10002===data.status?layer.confirm("您添加的概念类已经在   ，是否前往编辑？",{btn:["前往","取消"],shade:!1},function(index){layer.close(index),httpRequestPost("/api/ms/modeling/concept/correction/listByAttribute",{correctionConceptApplicationId:$scope.vm.applicationId,correctionConceptKey:$scope.vm.key,index:0,pageSize:1},function(data){$scope.vm.dialogTitle="编辑纠错概念",addCorrectionConceptDialog(singleEditCorrectionConcept,data.data[0]),$scope.vm.key=data.data[0].correctionConceptKey,$scope.vm.term=data.data[0].correctionConceptTerm},function(){})},function(){}):($scope.vm.dialogTitle="增加纠错概念",$scope.vm.term="",addCorrectionConceptDialog(singleAddCorrectionConcept))},function(){})}else $scope.vm.key="",$scope.vm.term=""}})&&$timeout(function(){termSpliterTagEditor(),$("#correctionKey").blur(function(){0==lengthCheck($("#correctionKey").val(),0,50)?$("#keyAddError").html($scope.vm.keyNullOrBeyondLimit):$("#keyAddError").html("")})},100)}function addCorrectionConceptDialog(callback,item){ngDialog.openConfirm({template:"/static/businessModeling/errorCorrection/errorCorrectionConceptManageDialog2.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){if(1===e){if(0==lengthCheck($scope.vm.key,0,50))return $("#keyAddError").html($scope.vm.keyNullOrBeyondLimit),!1;var obj=$("#term").next(),term="";if(obj.find("li").length<=0)return $("#termAddError").html($scope.vm.termNullOrBeyondLimit),!1;if($("#termAddError").html(""),$.each(obj.find("li"),function(index,value){index>0&&$.each($(value).find("div"),function(index1,value1){1==index1&&(term+=$(value1).html()+$scope.vm.termSpliter)})}),term=term.substring(0,term.length-1),$scope.vm.term=term,0==lengthCheck(term,0,500))return $("#termAddError").html($scope.vm.termNullOrBeyondLimit),!1;$("#termAddError").html(""),callback(item)}else $scope.vm.key="",$scope.vm.term=""}})&&$timeout(function(){termSpliterTagEditor(),$("#correctionKeyTwo").blur(function(){0==lengthCheck($("#correctionKeyTwo").val(),0,50)?$("#keyAddError").html($scope.vm.keyNullOrBeyondLimit):$("#keyAddError").html("")})},100)}function deleteCorrection(id){0==angular.element(".ngdialog ").length&&ngDialog.openConfirm({template:"/static/businessModeling/conceptManageDialog.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){1===e&&singleDelCorrectionConcept(id)}})}function batchUpload(){ngDialog.openConfirm({template:"/static/businessModeling/batchUpload.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){loadCorrectionConceptTable($scope.vm.paginationConf.currentPage)}})&&$timeout(function(){initUpload("/api/ms/modeling/concept/correction/batchAdd?applicationId="+$scope.vm.applicationId+"&modifierId="+$scope.vm.modifier)},100)}function singleEditCorrectionConcept(item){assembleCorrectionConceptTerm(),httpRequestPost("/api/ms/modeling/concept/correction/update",{correctionConceptId:item.correctionConceptId,correctionConceptApplicationId:$scope.vm.applicationId,applicationId:$scope.vm.applicationId,correctionConceptKey:$scope.vm.key,correctionConceptModifier:$scope.vm.modifier,correctionConceptTerm:$scope.vm.term},function(data){1==responseView(data)&&loadCorrectionConceptTable($scope.vm.paginationConf.currentPage)})}function singleAddCorrectionConcept(){assembleCorrectionConceptTerm(),httpRequestPost("/api/ms/modeling/concept/correction/add",{correctionConceptApplicationId:$scope.vm.applicationId,applicationId:$scope.vm.applicationId,correctionConceptKey:$scope.vm.key,correctionConceptModifier:$scope.vm.modifier,correctionConceptTerm:$scope.vm.term},function(data){1==responseView(data)&&loadCorrectionConceptTable($scope.vm.paginationConf.currentPage)})}function singleDelCorrectionConcept(id){httpRequestPost("/api/ms/modeling/concept/correction/delete",{correctionConceptId:id},function(data){1==responseView(data)&&loadCorrectionConceptTable($scope.vm.paginationConf.currentPage)})}function termSpliterTagEditor(){var term=$scope.vm.term;if(""==term)$("#term").tagEditor({forceLowercase:!1});else{var terms=term.split($scope.vm.termSpliter);$("#term").tagEditor({initialTags:terms,autocomplete:{delay:0,position:{collision:"flip"},source:terms},forceLowercase:!1})}}function assembleCorrectionConceptTerm(){var obj=$("#term").next(),term="";$.each(obj.find("li"),function(index,value){index>0&&$.each($(value).find("div"),function(index1,value1){1==index1&&(term+=$(value1).html()+$scope.vm.termSpliter)})}),term=term.substring(0,term.length-1),$scope.vm.term=term}function responseView(data){return $scope.vm.key="",$scope.vm.term="",clearSelectAll(),null!=data&&(layer.msg(data.info),data.status==$scope.vm.success)}function downloadTemplate(){downloadFile("/api/ms/knowledgeManage/downloadKnowledgeTemplate","","concept_template.xlsx")}function exportAll(){httpRequestPost("/api/ms/modeling/concept/correction/export",{correctionConceptApplicationId:$scope.vm.applicationId},function(data){if(1==responseView(data))for(var i=0;i<data.exportFileNameList.length;i++)downloadFile("/api/ms/modeling/downloadWithPath",data.filePath,data.exportFileNameList[0])})}$scope.vm={success:1e4,illegal:10003,failed:10004,empty:10005,applicationId:$cookieStore.get("applicationId"),addCorrection:addCorrection,editCorrection:editCorrection,deleteCorrection:deleteCorrection,listData:"",singleDelCorrectionConcept:singleDelCorrectionConcept,singleAddCorrectionConcept:singleAddCorrectionConcept,paginationConf:"",pageSize:5,searchCorrectionConcept:searchCorrectionConcept,searchVal:"",searchType:"correctionConceptKey",timeStart:"",timeEnd:"",key:"",modifier:$cookieStore.get("userId"),term:"",dialogTitle:"",inputSelect:[],inputVal:"",termSpliter:"；",percent:"%",keyNullOrBeyondLimit:"概念类名不能为空或超过长度限制50",termNullOrBeyondLimit:"概念集合不能为空或超过长度限制5000",downloadTemplate:downloadTemplate,exportAll:exportAll,batchUpload:batchUpload,batchDelete:batchDelete},init();var timeout;$scope.$watch("vm.paginationConf.currentPage",function(current){current&&(timeout&&$timeout.cancel(timeout),timeout=$timeout(function(){1==nullCheck($scope.vm.searchVal)||1==nullCheck($scope.vm.timeStart)&&1==nullCheck($scope.vm.timeEnd)?searchCorrectionConcept(current):loadCorrectionConceptTable(current)},100))},!0),$("#selectAll").on("click",function(){var ids=document.getElementsByName("sid"),flag=!1;this.checked&&(flag=!0),$.each(ids,function(index,value){flag?($(value).attr("checked",!0),$(value).prop("checked",!0)):($(value).attr("checked",!1),$(value).prop("checked",!1))})})}]),angular.module("businessModelingModule").controller("factorNewFrameController",["$scope","$state","$stateParams","ngDialog",function($scope,$state,$stateParams,ngDialog){$state.go("factorNewFrame.manage",{userPermission:$stateParams.userPermission}),$scope.vm={}}]),angular.module("businessModelingModule").controller("faqNewFrameController",["$scope","$state","$stateParams","ngDialog",function($scope,$state,$stateParams,ngDialog){$state.go("faqNewFrame.manage",{userPermission:$stateParams.userPermission}),$scope.vm={}}]),angular.module("businessModelingModule").controller("frameworkLibraryController",["$scope","$timeout","$state","$stateParams","$compile","ngDialog","$cookieStore","$interval",function($scope,$timeout,$state,$stateParams,$compile,ngDialog,$cookieStore,$interval){function autoHeightForFrame(){var $win=$(window),winHeight=.75*$win.height();$scope.vm.winHeight=winHeight+5,$(".libraryFt").attr("style","width: 450px;height: "+winHeight+"px;overflow-y: auto;background: #fff;float: left;box-sizing:border-box;"),$(".libraryRth").attr("style","width: 710px;height: "+winHeight+"px;overflow-y: auto;background: #fff;float: right;padding: 30px;box-sizing:border-box;")}function locationForFrame(suggestion){var currentNodeId=suggestion.data,initHeight=0,sum=$(".aside-navs").find("i").length;$.each($(".aside-navs").find("i"),function(index,value){if($(value).attr("data-option")==currentNodeId){var lib=$(".libraryFt"),scrollHeight=0;lib.length>0&&(scrollHeight=lib[0].scrollHeight);var offset=0;return scrollHeight-100>0&&(offset=(initHeight+1)/sum*(scrollHeight-100)),$(".libraryFt").animate({scrollTop:offset+"px"},800),!1}initHeight++})}function locationForFrameFlag(suggestion){var currentNodeId=suggestion.data,flag=!1,sum=$(".aside-navs").find("i").length;return $.each($(".aside-navs").find("i"),function(index,value){if($(value).attr("data-option")==currentNodeId){var lib=$(".libraryFt"),scrollHeight=0;return lib.length>0&&(scrollHeight=lib[0].scrollHeight),sum>=10&&scrollHeight>=$scope.vm.winHeight?flag=!0:sum<10&&(flag=!0),!1}}),flag}function searchNodeForFrame(suggestion){var currentNodeId=suggestion.data,firstNode=$(".aside-navs").find("i").filter(":eq(0)");"0% 0%"==$(firstNode).css("backgroundPosition")?appendTree(firstNode):null==$(firstNode).parent().parent().next()&&appendTree(firstNode),$(firstNode).attr("data-option")==currentNodeId?(clearColor(),$scope.vm.knowledgeBotVal=$(firstNode).next().html(),$scope.vm.botSelectValue=$(firstNode).next().attr("data-option"),$scope.vm.botSelectType=$(firstNode).next().attr("type-option"),$(firstNode).next().attr("style","color:black;font-weight:bold;"),loadFrameLibrary(1,0),$scope.$apply()):recursionForFrame(suggestion,firstNode)}function recursionForFrame(suggestion,node){var list=$(".aside-navs").find("li"),flag=!1;$.each(list,function(index,value){if($(value).attr("data-option")==$(node).attr("data-option")){var currNode=$(value).find("i").filter(":eq(0)");if($(currNode).attr("data-option")==suggestion.data)return clearColor(),$scope.vm.knowledgeBotVal=$(currNode).next().html(),$scope.vm.botSelectValue=$(currNode).next().attr("data-option"),$scope.vm.botSelectType=$(currNode).next().attr("type-option"),$(currNode).next().attr("style","color:black;font-weight:bold;"),loadFrameLibrary(1,0),$scope.$apply(),flag=!0,!1;if(1==flag)return!1;"0% 0%"==$(currNode).css("backgroundPosition")?appendTree(currNode):null==$(currNode).parent().parent().next()&&appendTree(currNode),recursionForFrame(suggestion,currNode)}})}function initBot(){$(".aside-navs").empty(),httpRequestPost("/api/ms/modeling/category/listbycategorypid",{categoryApplicationId:categoryApplicationId,categoryPid:"root"},function(data){for(var html='<ul class="menus show">',i=0;i<data.data.length;i++)html+='<li data-option="'+data.data[i].categoryPid+'"><div class="slide-a"><a class="ellipsis" href="javascript:;" '+categoryDescribeView(data.data[i].categoryDescribe)+"><i "+styleSwitch(data.data[i].categoryTypeId,data.data[i].categoryLeaf,data.data[i].categoryAttributeName)+' data-option="'+data.data[i].categoryId+'"></i><span '+nodeStyleSwitch(data.data[i].categoryAttributeName)+' type-option="'+data.data[i].categoryTypeId+'"attribute-option="'+data.data[i].categoryAttributeName+'" data-option="'+data.data[i].categoryId+'" title="'+data.data[i].categoryName+'">'+subStringWithTail(data.data[i].categoryName,10,"...")+"</span></a></div></li>";html+="</ul>",$(".aside-navs").append(html);var firstNode=$(".aside-navs").find("i").filter(":eq(0)");"0% 0%"==$(firstNode).css("backgroundPosition")?appendTree(firstNode):null==$(firstNode).parent().parent().next()&&appendTree(firstNode)},function(){})}function nodeStyleSwitch(attrType){return"edge"==attrType?"style='color:#ED7D31;'":""}function categoryDescribeView(describeStr){return 1==nullCheck(describeStr)?"title='"+describeStr+"'":""}function clearSelectAll(){$("#selectAll").attr("checked",!1),$("#selectAll").prop("checked",!1)}function batchDelete(){for(var ids=document.getElementsByName("sid"),id_array=[],i=0;i<ids.length;i++)ids[i].checked&&id_array.push(ids[i].value);if(0==id_array.length)return void layer.msg("请选择要删除的记录！");layer.confirm("确认要删除吗？",function(index){layer.close(index);var request=new Object;request.ids=id_array,httpRequestPost("/api/ms/modeling/frame/batchdelete",request,function(data){1==responseView(data)&&loadFrameLibrary(1,0)})})}function requestArrayReset(){$scope.vm.elementAskContentArray=[],$scope.vm.elementAttributeIdArray=[],$scope.vm.elementContentArray=[],$scope.vm.elementFrameIdArray=[],$scope.vm.elementMiningTypeIdArray=[],$scope.vm.elementRelateConceptArray=[],$scope.vm.elementTypeIdArray=[],$scope.vm.elementIdArray=[]}function appendTree(obj){var id=$(obj).attr("data-option"),that=$(obj);that.parent().parent().siblings().length?"0% 0%"==that.css("backgroundPosition")?(that.css("backgroundPosition","0% 100%"),that.parent().parent().next().slideDown()):(that.css("backgroundPosition","0% 0%"),that.parent().parent().next().slideUp()):(that.css("backgroundPosition","0% 100%"),httpRequestPostAsync("/api/ms/modeling/category/listbycategorypid",{categoryApplicationId:categoryApplicationId,categoryPid:id},function(data){if(data.data){for(var html='<ul class="menus">',i=0;i<data.data.length;i++)html+='<li data-option="'+data.data[i].categoryPid+'"><div class="slide-a"><a class="ellipsis" href="javascript:;" '+categoryDescribeView(data.data[i].categoryDescribe)+"><i "+styleSwitch(data.data[i].categoryTypeId,data.data[i].categoryLeaf,data.data[i].categoryAttributeName)+' data-option="'+data.data[i].categoryId+'"></i><span '+nodeStyleSwitch(data.data[i].categoryAttributeName)+' attribute-option="'+data.data[i].categoryAttributeName+'" type-option="'+data.data[i].categoryTypeId+'" data-option="'+data.data[i].categoryId+'" title="'+data.data[i].categoryName+'">'+subStringWithTail(data.data[i].categoryName,10,"...")+"</span></a></div></li>";html+="</ul>",$(html).appendTo(that.parent().parent().parent()),that.parent().parent().next().slideDown()}},function(err){}))}function clearColor(){$.each($(".aside-navs").find("span"),function(index,value){"node"==$(this).attr("attribute-option")?$(this).attr("style",""):"edge"==$(this).attr("attribute-option")&&$(this).attr("style","color:#ED7D31;")})}function styleSwitch(type,leaf,attrType){var styleHidden="display: inline-block;";if(0==leaf&&(styleHidden="display:none;"),"node"==attrType)return"style='"+styleHidden+"position: relative;top: -1px;margin-right: 2px;width: 15px;height: 15px;vertical-align: middle;background-position: left top;background-repeat: no-repeat;background-image: url(../../images/images/aside-nav-icon.png);'";var style='style="'+styleHidden+'position: relative;top: -1px; margin-right: 5px; width: 15px; height: 15px; vertical-align: middle; background-position: left top; background-repeat: no-repeat;background-image:url(../../images/pic-navs-rq.png);"';switch(type){case 161:style='style="'+styleHidden+'position: relative;top: -1px; margin-right: 5px; width: 15px; height: 15px; vertical-align: middle; background-position: left top; background-repeat: no-repeat;background-image:url(../../images/pic-navs-sx.png);"';break;case 160:style='style="'+styleHidden+'position: relative;top: -1px; margin-right: 5px; width: 15px; height: 15px; vertical-align: middle; background-position: left top; background-repeat: no-repeat;background-image:url(../../images/pic-navs-lc.png);"';break;case 162:style='style="'+styleHidden+'position: relative;top: -1px; margin-right: 5px; width: 15px; height: 15px; vertical-align: middle; background-position: left top; background-repeat: no-repeat;background-image:url(../../images/pic-navs-dy.png);"'}return style}function loadFrameLibrary(current,type){$scope.vm.paginationConf={currentPage:current,totalItems:0,pageSize:$scope.vm.pageSize,pagesLength:8},httpRequestPost("/api/ms/modeling/frame/listbyattribute",{frameCategoryId:$scope.vm.botSelectValue,index:(current-1)*$scope.vm.pageSize,pageSize:$scope.vm.pageSize},function(data){data.data?(clearSelectAll(),$scope.vm.listData=data.data,$scope.vm.paginationConf={currentPage:current,totalItems:data.total,pageSize:$scope.vm.pageSize,pagesLength:8}):$scope.vm.listData="",$scope.$apply()},function(err){})}function editFrame(item){$scope.vm.frameTypeId=item.frameTypeId,$scope.vm.frameInfo=JSON.stringify(item);var frameInfo=eval("("+$scope.vm.frameInfo+")");assembleFrame(),10011==$scope.vm.frameTypeId&&updateFaq(),10012==$scope.vm.frameTypeId&&updateConcept(),10013==$scope.vm.frameTypeId&&updateElement()}function deleteFrame(item){var frameId=item.frameId;layer.confirm("确认删除？",{btn:["确认","取消"],shade:.3},function(){httpRequestPost("/api/ms/modeling/frame/delete",{frameId:frameId},function(data){1==responseView(data)&&loadFrameLibrary(1,0)},function(err){})},function(){})}function batchUpload(){var frameType=10011;if("root"==$scope.vm.botSelectValue)return void layer.msg("请选择类目");ngDialog.openConfirm({template:"/static/businessModeling/frameSelectDialog.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){10011==e?(frameType=10011,batchUploadFrame(frameType)):10012==e?(frameType=10012,batchUploadFrame(frameType)):10013==e&&(frameType=10013,batchUploadFrame(frameType))}})}function batchUploadFrame(frameType){ngDialog.openConfirm({template:"/static/businessModeling/batchUpload.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){loadFrameLibrary(1,0)}})&&$timeout(function(){initUpload("/api/ms/modeling/frame/batchAdd?applicationId="+categoryApplicationId+"&modifierId="+categoryModifierId+"&categoryId="+$scope.vm.botSelectValue+"&frameTypeId="+frameType)},100)}function downloadTemplate(){var frameTemplate="frame_faq_template.xlsx";ngDialog.openConfirm({template:"/static/businessModeling/frameSelectDialog.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){10011==e?(frameTemplate="frame_faq_template.xlsx",downloadFile("/api/ms/knowledgeManage/downloadKnowledgeTemplate","",frameTemplate)):10012==e?(frameTemplate="frame_concept_template.xlsx",downloadFile("/api/ms/knowledgeManage/downloadKnowledgeTemplate","",frameTemplate)):10013==e&&(frameTemplate="frame_element_template.xlsx",downloadFile("/api/ms/knowledgeManage/downloadKnowledgeTemplate","",frameTemplate))}})}function exportAll(){var frameType=10011;if("root"==$scope.vm.botSelectValue)return void layer.msg("请选择类目");ngDialog.openConfirm({template:"/static/businessModeling/frameSelectDialog.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){10011==e?(frameType=10011,exportAllDialog(frameType)):10012==e?(frameType=10012,exportAllDialog(frameType)):10013==e&&(frameType=10013,exportAllDialog(frameType))}})}function exportAllDialog(frameType){httpRequestPost("/api/ms/modeling/frame/export",{frameCategoryId:$scope.vm.botSelectValue,frameTypeId:frameType},function(data){1==responseView(data)&&data.exportFileNameList.length>0&&downloadFile("/api/ms/modeling/downloadWithPath",data.filePath,data.exportFileNameList[0])},function(err){})}function searchByFrameTitle(current,type){1==nullCheck($("#keyWords").val())&&httpRequestPost("/api/ms/modeling/frame/listbyattribute",{frameCategoryId:$scope.vm.botSelectValue,frameTitle:"%"+$("#keyWords").val()+"%",index:(current-1)*$scope.vm.pageSize,pageSize:$scope.vm.pageSize},function(data){data.data?(clearSelectAll(),$scope.vm.listData=data.data,$scope.vm.paginationConf={currentPage:current,totalItems:data.total,pageSize:$scope.vm.pageSize,pagesLength:8}):$scope.vm.listData="",$scope.$apply()},function(err){})}function addFrame(){if("root"==$scope.vm.botSelectValue)return void layer.msg("请选择类目");ngDialog.openConfirm({template:"/static/businessModeling/frameworkLibraryDialog.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){if(1===e){if($scope.vm.frameTypeId=$("#frameTypeId").val(),$scope.vm.frameTitle=$("#frameTitle").val(),0==lengthCheck($("#frameTitle").val(),0,50))return $("#frameAddErrorObj").html($scope.vm.frameTitleNullErrorInfo),!1;if(isHtmlLabel($("#frameTitle").val()))return $("#frameAddErrorObj").html($scope.vm.notContainHtmlLabel),!1;if(0==frameTitleRepeatCheck(0,"#frameAddErrorObj"))return!1;10011==$scope.vm.frameTypeId&&addFaq(),10012==$scope.vm.frameTypeId&&addConcept(),10013==$scope.vm.frameTypeId&&addElement()}}})&&$timeout(function(){$("#frameTitle").blur(function(){$scope.vm.frameTypeId=$("#frameTypeId").val(),$scope.vm.frameTitle=$("#frameTitle").val(),0==lengthCheck($("#frameTitle").val(),0,50)?$("#frameAddErrorObj").html($scope.vm.frameTitleNullErrorInfo):isHtmlLabel($("#frameTitle").val())?$("#frameAddErrorObj").html($scope.vm.notContainHtmlLabel):($("#frameAddErrorObj").html(""),frameTitleRepeatCheck(0,"#frameAddErrorObj"))})},100)}function frameTitleRepeatCheck(type,selector){var flag=!1,request=new Object;return request.frameTitle=$scope.vm.frameTitle,request.frameTypeId=$scope.vm.frameTypeId,request.frameCategoryId=$scope.vm.botSelectValue,1==type&&(request.frameId=$scope.vm.frameId),httpRequestPostAsync("/api/ms/modeling/frame/repeatcheck",request,function(data){data&&(1==responseWithoutView(data)?($(selector).html(""),flag=!0):data&&$(selector).html(data.info))},function(err){}),flag}function addFaq(){ngDialog.openConfirm({template:"/static/businessModeling/faqNewFrame.html",width:"500px",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){if(1===e){if(1!=faqValidata(0))return!1;faqAssemble(0),faqRequestAdd()}}})&&$timeout(function(){$("#faqFrameTitle").blur(function(){return $scope.vm.frameTitle=$("#faqFrameTitle").val(),0==lengthCheck($("#faqFrameTitle").val(),0,50)?void $("#faqFrameAddErrorObj").html($scope.vm.frameTitleNullErrorInfo):isHtmlLabel($("#faqFrameTitle").val())?void $("#faqFrameAddErrorObj").html($scope.vm.notContainHtmlLabel):void frameTitleRepeatCheck(0,"#faqFrameAddErrorObj")})},100)}function updateFaq(){ngDialog.openConfirm({template:"/static/businessModeling/updateFaqFrame.html",width:"625px",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){if(1===e){if(1!=faqValidata(1))return!1;faqAssemble(1),faqRequestUpdate()}loadFrameLibrary(1,0)}})&&$timeout(function(){fillFaqUpdatePage(),$("#faqFrameTitle").blur(function(){return $scope.vm.frameTitle=$("#faqFrameTitle").val(),0==lengthCheck($("#faqFrameTitle").val(),0,50)?void $("#faqFrameAddErrorObj").html($scope.vm.frameTitleNullErrorInfo):isHtmlLabel($("#faqFrameTitle").val())?void $("#faqFrameAddErrorObj").html($scope.vm.notContainHtmlLabel):void frameTitleRepeatCheck(1,"#faqFrameAddErrorObj")}),$("#faq_extension").on("click",".del",function(){if(null!=$(this).attr("element-id")){var obj=$(this).parent().parent(),elementId=$(this).attr("element-id");layer.confirm("删除以后不能恢复，确认删除？",{btn:["确认","取消"],shade:!1},function(index){layer.close(index),httpRequestPostAsync("/api/ms/modeling/frame/deleteelementbyid",{elementId:elementId},function(data){1==responseView(data)&&$(obj).remove()},function(err){})},function(){})}})},100)}function fillFaqUpdatePage(){for(var i=0;i<$scope.vm.elementIdArray.length;i++){var html='<div class="framework mb-10"><span class="framework_s text-r">扩展问题：</span><div class=""><input type="text" class="L input-text mr-10" element-id="'+$scope.vm.elementIdArray[i]+'" value="'+$scope.vm.elementContentArray[i]+'" style="width:300px;" disabled="disabled"><a element-id="'+$scope.vm.elementIdArray[i]+'" href="javascript:;" class="del"><img src="../../images/images/delete_img.png"></a></div></div>';$(".exten_problem").append(html)}}function fillConceptUpdatePage(){for(var i=0;i<$scope.vm.elementIdArray.length;i++)if(10025==$scope.vm.elementAttributeIdArray[i])$("#concept_title").val($scope.vm.elementContentArray[i]),$("#concept_title").attr("element-id",$scope.vm.elementIdArray[i]);else{var originStr=$scope.vm.elementContentArray[i],idx1=originStr.indexOf($scope.vm.textAndTagSplit);if(idx1<=0)return;for(var originalText=originStr.substring(0,idx1),tagStr=originStr.substring(idx1+1,originStr.length),tagArr=tagStr.split($scope.vm.conceptSplit),tagHtml='<div class="tag_box">',j=0;j<tagArr.length;j++)tagHtml+='<span class="tag_s">'+tagArr[j]+"</span>";tagHtml+="</div>";var html='<div class="framework mb-10" element-id="'+$scope.vm.elementIdArray[i]+'">   <span class="framework_s text-r mt-7">概念扩展：</span>   <div class="formControlsForConcept" element-id="'+$scope.vm.elementIdArray[i]+'">       <input type="hidden" value="'+originalText+'"/>'+tagHtml+'       <a href="javascript:;" element-id="'+$scope.vm.elementIdArray[i]+'" class="del del-button">           <img src="../../images/images/delete_img.png">       </a>   </div></div>';$("#concept_extension").append(html)}}function faqAssemble(type){requestArrayReset(),$.each($(".exten_problem").find("input").filter(":gt(0)"),function(index,value){$scope.vm.elementAskContentArray[index]=$scope.vm.defaultString,$scope.vm.elementAttributeIdArray[index]=10026,$scope.vm.elementContentArray[index]=$(value).val(),$scope.vm.elementFrameIdArray[index]=$scope.vm.defaultString,$scope.vm.elementMiningTypeIdArray[index]=$scope.vm.defaultInt,$scope.vm.elementRelateConceptArray[index]=$scope.vm.defaultString,$scope.vm.elementTypeIdArray[index]=$scope.vm.defaultInt,1==type&&($(value).attr("element-id")?$scope.vm.elementIdArray[index]=$(value).attr("element-id"):$scope.vm.elementIdArray[index]=$scope.vm.defaultString)})}function assembleFrame(){requestArrayReset();var frameInfo=eval("("+$scope.vm.frameInfo+")");$scope.vm.frameId=frameInfo.frameId,$scope.vm.frameTypeId=frameInfo.frameTypeId,$scope.vm.frameTitle=frameInfo.frameTitle,$scope.vm.frameModifierId=frameInfo.frameModifierId,$scope.vm.frameCategoryId=frameInfo.frameCategoryId,$scope.vm.frameEnableStatusId=frameInfo.frameEnableStatusId;for(var i=0;i<frameInfo.elements.length;i++)$scope.vm.elementAskContentArray[i]=frameInfo.elements[i].elementAskContent,$scope.vm.elementAttributeIdArray[i]=frameInfo.elements[i].elementAttributeId,$scope.vm.elementContentArray[i]=frameInfo.elements[i].elementContent,$scope.vm.elementFrameIdArray[i]=frameInfo.elements[i].elementFrameId,$scope.vm.elementMiningTypeIdArray[i]=frameInfo.elements[i].elementMiningTypeId,$scope.vm.elementRelateConceptArray[i]=frameInfo.elements[i].elementRelateConcept,$scope.vm.elementTypeIdArray[i]=frameInfo.elements[i].elementTypeId,$scope.vm.elementIdArray[i]=frameInfo.elements[i].elementId}function faqValidata(type){return 0==lengthCheck($scope.vm.frameTitle,0,50)?($("#faqFrameAddErrorObj").html($scope.vm.frameTitleNullErrorInfo),!1):isHtmlLabel($scope.vm.frameTitle)?($("#faqFrameAddErrorObj").html($scope.vm.notContainHtmlLabel),!1):0!=frameTitleRepeatCheck(type,"#faqFrameAddErrorObj")&&(0!=$(".exten_problem").find("input").filter(":gt(0)").length||($("#faqExtendQuestionErrorObj").html("至少应该有一个扩展问题"),!1))}function faqRequestAdd(){httpRequestPost("/api/ms/modeling/frame/add",{elementAskContentArray:$scope.vm.elementAskContentArray,elementAttributeIdArray:$scope.vm.elementAttributeIdArray,elementContentArray:$scope.vm.elementContentArray,elementFrameIdArray:$scope.vm.elementFrameIdArray,elementMiningTypeIdArray:$scope.vm.elementMiningTypeIdArray,elementRelateConceptArray:$scope.vm.elementRelateConceptArray,elementTypeIdArray:$scope.vm.elementTypeIdArray,frameCategoryId:$scope.vm.botSelectValue,frameEnableStatusId:$scope.vm.frameEnableStatusId,frameModifierId:categoryModifierId,frameTitle:$scope.vm.frameTitle,frameTypeId:$scope.vm.frameTypeId},function(data){data&&1==responseView(data)&&loadFrameLibrary(1,0)},function(err){})}function faqRequestUpdate(){httpRequestPost("/api/ms/modeling/frame/update",{elementAskContentArray:$scope.vm.elementAskContentArray,elementAttributeIdArray:$scope.vm.elementAttributeIdArray,elementContentArray:$scope.vm.elementContentArray,elementFrameIdArray:$scope.vm.elementFrameIdArray,elementMiningTypeIdArray:$scope.vm.elementMiningTypeIdArray,elementRelateConceptArray:$scope.vm.elementRelateConceptArray,elementTypeIdArray:$scope.vm.elementTypeIdArray,elementIdArray:$scope.vm.elementIdArray,frameCategoryId:$scope.vm.botSelectValue,frameEnableStatusId:$scope.vm.frameEnableStatusId,frameModifierId:categoryModifierId,frameTitle:$scope.vm.frameTitle,frameTypeId:$scope.vm.frameTypeId,frameId:$scope.vm.frameId},function(data){data&&1==responseView(data)&&loadFrameLibrary(1,0)},function(err){})}function addConcept(){ngDialog.openConfirm({template:"/static/businessModeling/conceptNewFrame.html",width:"625px",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){if(1===e){if(1!=conceptValidate(0))return!1;conceptAssemble(0),conceptRequestAdd()}}})&&$timeout(function(){$("#conceptFrameTitle").blur(function(){return $scope.vm.frameTitle=$("#conceptFrameTitle").val(),0==lengthCheck($("#conceptFrameTitle").val(),0,50)?void $("#conceptFrameAddErrorObj").html($scope.vm.frameTitleNullErrorInfo):isHtmlLabel($("#conceptFrameTitle").val())?void $("#conceptFrameAddErrorObj").html($scope.vm.notContainHtmlLabel):void frameTitleRepeatCheck(0,"#conceptFrameAddErrorObj")}),$("#concept_title").blur(function(){0==lengthCheck($("#concept_title").val(),0,50)?$("#conceptTitleErrorObj").html("概念标题为空或超过长度限制50"):isHtmlLabel($("#concept_title").val())?$("#conceptTitleErrorObj").html($scope.vm.notContainHtmlLabel):$("#conceptTitleErrorObj").html("")})},100)}function conceptValidate(type){return 0==lengthCheck($scope.vm.frameTitle,0,50)?($("#conceptFrameAddErrorObj").html($scope.vm.frameTitleNullErrorInfo),!1):isHtmlLabel($scope.vm.frameTitle)?($("#conceptFrameAddErrorObj").html($scope.vm.notContainHtmlLabel),!1):0!=frameTitleRepeatCheck(type,"#conceptFrameAddErrorObj")&&(0!=$(".exten_problem").find("input").filter(":gt(0)").length||($("#conceptExtendQuestionErrorObj").html("至少应该有一个概念扩展"),!1))}function conceptAssemble(type){requestArrayReset(),$.each($("#concept_extension").find(".formControlsForConcept").filter(":gt(0)"),function(index,value){var contentInfo=$(value).find("input").val()+$scope.vm.textAndTagSplit;$.each($(value).find("span"),function(index1,value1){contentInfo+=$(value1).html()+$scope.vm.conceptSplit}),contentInfo.indexOf($scope.vm.conceptSplit)>0&&(contentInfo=contentInfo.substring(0,contentInfo.length-1)),$scope.vm.elementAskContentArray[index]=$scope.vm.defaultString,$scope.vm.elementAttributeIdArray[index]=10026,$scope.vm.elementContentArray[index]=contentInfo,$scope.vm.elementFrameIdArray[index]=$scope.vm.defaultString,$scope.vm.elementMiningTypeIdArray[index]=$scope.vm.defaultInt,$scope.vm.elementRelateConceptArray[index]=$scope.vm.defaultString,$scope.vm.elementTypeIdArray[index]=$scope.vm.defaultInt,1==type&&($(value).attr("element-id")?$scope.vm.elementIdArray[index]=$(value).attr("element-id"):$scope.vm.elementIdArray[index]=$scope.vm.defaultString)})}function conceptRequestAdd(){httpRequestPost("/api/ms/modeling/frame/add",{elementAskContentArray:$scope.vm.elementAskContentArray,elementAttributeIdArray:$scope.vm.elementAttributeIdArray,elementContentArray:$scope.vm.elementContentArray,elementFrameIdArray:$scope.vm.elementFrameIdArray,elementMiningTypeIdArray:$scope.vm.elementMiningTypeIdArray,elementRelateConceptArray:$scope.vm.elementRelateConceptArray,elementTypeIdArray:$scope.vm.elementTypeIdArray,frameCategoryId:$scope.vm.botSelectValue,frameEnableStatusId:$scope.vm.frameEnableStatusId,frameModifierId:categoryModifierId,frameTitle:$scope.vm.frameTitle,frameTypeId:$scope.vm.frameTypeId},function(data){data&&1==responseView(data)&&loadFrameLibrary(1,0)},function(err){})}function updateConcept(){ngDialog.openConfirm({template:"/static/businessModeling/updateConceptFrame.html",width:"625px",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){if(1===e){if(1!=conceptValidate(1))return!1;conceptAssemble(1),conceptRequestUpdate()}}})&&$timeout(function(){fillConceptUpdatePage(),$("#conceptFrameTitle").blur(function(){return $scope.vm.frameTitle=$("#conceptFrameTitle").val(),0==lengthCheck($("#conceptFrameTitle").val(),0,50)?void $("#conceptFrameAddErrorObj").html($scope.vm.frameTitleNullErrorInfo):isHtmlLabel($("#conceptFrameTitle").val())?void $("#conceptFrameAddErrorObj").html($scope.vm.notContainHtmlLabel):void frameTitleRepeatCheck(1,"#conceptFrameAddErrorObj")}),$("#concept_title").blur(function(){0==lengthCheck($("#concept_title").val(),0,50)?$("#conceptTitleErrorObj").html("概念标题为空或超过长度限制50"):isHtmlLabel($("#concept_title").val())?$("#conceptTitleErrorObj").html($scope.vm.notContainHtmlLabel):$("#conceptTitleErrorObj").html("")}),$("#concept_extension").on("click",".del",function(){if(null!=$(this).attr("element-id")){var obj=$(this).parent().parent(),elementId=$(this).attr("element-id");layer.confirm("删除以后不能恢复，确认删除？",{btn:["确认","取消"],shade:!1},function(){httpRequestPost("/api/ms/modeling/frame/deleteelementbyid",{elementId:elementId},function(data){1==responseView(data)&&$(obj).remove()},function(err){})},function(){})}})},100)}function conceptRequestUpdate(){httpRequestPost("/api/ms/modeling/frame/update",{elementAskContentArray:$scope.vm.elementAskContentArray,elementAttributeIdArray:$scope.vm.elementAttributeIdArray,elementContentArray:$scope.vm.elementContentArray,elementFrameIdArray:$scope.vm.elementFrameIdArray,elementMiningTypeIdArray:$scope.vm.elementMiningTypeIdArray,elementRelateConceptArray:$scope.vm.elementRelateConceptArray,elementTypeIdArray:$scope.vm.elementTypeIdArray,elementIdArray:$scope.vm.elementIdArray,frameCategoryId:$scope.vm.botSelectValue,frameEnableStatusId:$scope.vm.frameEnableStatusId,frameModifierId:categoryModifierId,frameTitle:$scope.vm.frameTitle,frameTypeId:$scope.vm.frameTypeId,frameId:$scope.vm.frameId},function(data){1==responseView(data)&&loadFrameLibrary(1,0)},function(err){})}function addElement(){ngDialog.openConfirm({template:"/static/businessModeling/factorNewFrame.html",width:"800px",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){if(1===e){if(1!=elementValidate(0))return!1;elementAssemble(0),elementRequestAdd()}}})&&$timeout(function(){$("#selectAll").click(function(){1==$(this).prop("checked")?$.each($("#add-item").find(".sid"),function(index,value){$(value).prop("checked",!0)}):$.each($("#add-item").find(".sid"),function(index,value){$(value).prop("checked",!1)})}),$("#elementFrameTitle").blur(function(){return $scope.vm.frameTitle=$("#elementFrameTitle").val(),0==lengthCheck($("#elementFrameTitle").val(),0,50)?void $("#elementFrameAddErrorObj").html($scope.vm.frameTitleNullErrorInfo):isHtmlLabel($("#elementFrameTitle").val())?void $("#elementFrameAddErrorObj").html($scope.vm.notContainHtmlLabel):void frameTitleRepeatCheck(0,"#elementFrameAddErrorObj")}),$("#ele-name-tr").mouseenter(function(){$("#ele-name-error").attr("style","display:none;"),$("#ele-name-error").html("")}),$("#ele-asked-tr").mouseenter(function(){$("#ele-asked-error").attr("style","display:none;"),$("#ele-asked-error").html("")}),$("#ele-concept-tr").mouseenter(function(){$("#ele-concept-error").attr("style","display:none;"),$("#ele-concept-error").html("")}),$(".ele-name").blur(function(){return 0==lengthCheck($(".ele-name").val(),0,50)?($("#ele-name-error").html("要素名称不能为空或超过长度限制50"),void $("#ele-name-error").attr("style","display:inline-block;left: 10px;z-index:9999")):isHtmlLabel($(".ele-name").val())?($("#ele-name-error").html($scope.vm.notContainHtmlLabel),void $("#ele-name-error").attr("style","display:inline-block;left: 10px;z-index;")):($("#ele-name-error").html(""),$("#ele-name-error").attr("style","display:none;"),void $.each($("#add-item").find("tr"),function(index,value){if($(".ele-name").val()==$(value).find(".ele-name-add").val())return $("#ele-name-error").html("要素名称不能与已有要素名称重复"),$("#ele-name-error").attr("style","display:inline-block;left: 10px;z-index:9999;"),!0;$("#ele-name-error").html(""),$("#ele-name-error").attr("style","display:none;")}))}),$(".ele-asked").blur(function(){return 0==lengthCheck($(".ele-asked").val(),0,255)?($("#ele-asked-error").html("反问不能为空或超过长度限制255"),void $("#ele-asked-error").attr("style","display:inline-block;left: 10px;z-index:9999;")):isHtmlLabel($(".ele-asked").val())?($("#ele-asked-error").html($scope.vm.notContainHtmlLabel),void $("#ele-asked-error").attr("style","display:inline-block;left: 10px;z-index:9999;")):($("#ele-asked-error").html(""),$("#ele-asked-error").attr("style","display:none;"),void $.each($("#add-item").find("tr"),function(index,value){if($(".ele-asked").val()==$(value).find(".ele-asked-add").val())return $("#ele-asked-error").html("反问不能与已有反问重复"),$("#ele-asked-error").attr("style","display:inline-block;left: 10px;z-index:9999;"),!0;$("#ele-asked-error").html(""),$("#ele-asked-error").attr("style","display:none;")}))}),$(".ele-concept").blur(function(){var relateConceptIds=$(".ele-concept").attr("data-option"),relateConceptVals=$(".ele-concept").val();relateConceptVals=relateConceptVals.substring(0,relateConceptVals.length-1);var sumConceptStr=relateConceptIds+$scope.vm.textAndTagSplit+relateConceptVals;if(0==lengthCheck(sumConceptStr,0,255))return $("#ele-concept-error").html("相关概念不能为空或超过长度限制"),void $("#ele-concept-error").attr("style","display:inline-block;left: 10px;");$("#ele-concept-error").html(""),$("#ele-concept-error").attr("style","display:none;")});var keyword="",keywordarr=$("#ele-concept-autocomplete").val().split(",");keyword=keywordarr[keywordarr.length];var conceptParams={conceptKeyword:keyword,applicationId:categoryApplicationId};$scope.vm.relateConcept=new HashMap,$("#ele-concept-autocomplete").on("keydown",function(event){9===event.keyCode&&$(this).autocomplete("instance").menu.active&&event.preventDefault()}).autocomplete({serviceUrl:"/api/ms/modeling/frame/searchconceptbykeyword",type:"POST",params:conceptParams,paramName:"conceptKeyword",dataType:"json",delimiter:",",transformResult:function(data){var result=new Object,array=[];if(data.data)for(var i=0;i<data.data.length;i++)array[i]={data:data.data[i].id,value:data.data[i].name};return result.suggestions=array,result},onSelect:function(suggestion){$scope.vm.relateConcept.put(suggestion.value,suggestion.data);var selectConceptValue="";if($("#ele-concept-autocomplete").val()!=suggestion.value)for(var terms=splitAuto($("#ele-concept-autocomplete").val()),i=0;i<terms.length;i++)terms[i]!=suggestion.value&&(selectConceptValue+=terms[i]+",");""==selectConceptValue?$("#ele-concept-autocomplete").val(suggestion.value+","):$("#ele-concept-autocomplete").val(selectConceptValue+suggestion.value+",");for(var selectConceptId="",selectedTerms=splitAuto($("#ele-concept-autocomplete").val()),i=0;i<selectedTerms.length;i++)null!=$scope.vm.relateConcept.get(selectedTerms[i])&&(selectConceptId+=$scope.vm.relateConcept.get(selectedTerms[i])+$scope.vm.conceptSplit);selectConceptId=selectConceptId.substring(0,selectConceptId.length-1),$("#ele-concept-autocomplete").attr("data-option",selectConceptId)},onSearchStart:function(){for(var selectConceptId="",selectedTerms=splitAuto($("#ele-concept-autocomplete").val()),i=0;i<selectedTerms.length;i++)null!=$scope.vm.relateConcept.get(selectedTerms[i])&&(selectConceptId+=$scope.vm.relateConcept.get(selectedTerms[i])+$scope.vm.conceptSplit);selectConceptId=selectConceptId.substring(0,selectConceptId.length-1),$("#ele-concept-autocomplete").attr("data-option",selectConceptId)}})},100)}function elementValidate(type){return $scope.vm.frameTitle=$("#elementFrameTitle").val(),0==lengthCheck($("#elementFrameTitle").val(),0,50)?($("#elementFrameAddErrorObj").html($scope.vm.frameTitleNullErrorInfo),!1):isHtmlLabel($("#elementFrameTitle").val())?($("#elementFrameAddErrorObj").html($scope.vm.notContainHtmlLabel),!1):0!=frameTitleRepeatCheck(type,"#elementFrameAddErrorObj")&&(0==$("#add-item").find("tr").length?($("#elementNumberErr").html("至少应该有一个要素"),!1):($("#elementNumberErr").html(""),!0))}function elementAssemble(type){requestArrayReset(),$.each($("#add-item").find("tr"),function(index,value){$scope.vm.elementAskContentArray[index]=$(value).find(".ele-asked-add").val(),$scope.vm.elementAttributeIdArray[index]=$scope.vm.defaultInt,$scope.vm.elementContentArray[index]=$(value).find(".ele-name-add").val(),$scope.vm.elementFrameIdArray[index]=$scope.vm.defaultString,$scope.vm.elementMiningTypeIdArray[index]=$(value).find(".mining-type-add").val(),""==$(value).find(".ele-concept-add").attr("data-option")?$scope.vm.elementRelateConceptArray[index]=$scope.vm.defaultString:$scope.vm.elementRelateConceptArray[index]=$(value).find(".ele-concept-add").attr("data-option"),$scope.vm.elementTypeIdArray[index]=$(value).find(".ele-type-add").val(),1==type&&($(value).attr("element-id")?$scope.vm.elementIdArray[index]=$(value).attr("element-id"):$scope.vm.elementIdArray[index]=$scope.vm.defaultString)})}function elementRequestAdd(){httpRequestPost("/api/ms/modeling/frame/add",{elementAskContentArray:$scope.vm.elementAskContentArray,elementAttributeIdArray:$scope.vm.elementAttributeIdArray,elementContentArray:$scope.vm.elementContentArray,elementFrameIdArray:$scope.vm.elementFrameIdArray,elementMiningTypeIdArray:$scope.vm.elementMiningTypeIdArray,elementRelateConceptArray:$scope.vm.elementRelateConceptArray,elementTypeIdArray:$scope.vm.elementTypeIdArray,frameCategoryId:$scope.vm.botSelectValue,frameEnableStatusId:$scope.vm.frameEnableStatusId,frameModifierId:categoryModifierId,frameTitle:$scope.vm.frameTitle,frameTypeId:$scope.vm.frameTypeId},function(data){data&&1==responseView(data)&&loadFrameLibrary(1,0)},function(err){})}function elementRequestUpdate(){httpRequestPost("/api/ms/modeling/frame/update",{elementAskContentArray:$scope.vm.elementAskContentArray,elementAttributeIdArray:$scope.vm.elementAttributeIdArray,elementContentArray:$scope.vm.elementContentArray,elementFrameIdArray:$scope.vm.elementFrameIdArray,elementMiningTypeIdArray:$scope.vm.elementMiningTypeIdArray,elementRelateConceptArray:$scope.vm.elementRelateConceptArray,elementTypeIdArray:$scope.vm.elementTypeIdArray,elementIdArray:$scope.vm.elementIdArray,frameCategoryId:$scope.vm.botSelectValue,frameEnableStatusId:$scope.vm.frameEnableStatusId,frameModifierId:categoryModifierId,frameTitle:$scope.vm.frameTitle,frameTypeId:$scope.vm.frameTypeId,frameId:$scope.vm.frameId},function(data){data&&1==responseView(data)&&loadFrameLibrary(1,0)},function(err){})}function updateElement(){ngDialog.openConfirm({template:"/static/businessModeling/updateFactorFrame.html",width:"840px",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){1===e&&1==elementValidate(1)&&(elementAssemble(1),elementRequestUpdate())}})&&$timeout(function(){fillElementUpdatePage(),$("#selectAll").click(function(){1==$(this).prop("checked")?$.each($("#add-item").find(".sid"),function(index,value){$(value).prop("checked",!0)}):$.each($("#add-item").find(".sid"),function(index,value){$(value).prop("checked",!1)})}),$("#elementFrameTitle").blur(function(){return $scope.vm.frameTitle=$("#elementFrameTitle").val(),0==lengthCheck($("#elementFrameTitle").val(),0,50)?void $("#elementFrameAddErrorObj").html($scope.vm.frameTitleNullErrorInfo):isHtmlLabel($("#elementFrameTitle").val())?void $("#elementFrameAddErrorObj").html($scope.vm.notContainHtmlLabel):void frameTitleRepeatCheck(1,"#elementFrameAddErrorObj")}),$("#ele-name-tr").mouseenter(function(){$("#ele-name-error").attr("style","display:none;"),$("#ele-name-error").html("")}),$("#ele-asked-tr").mouseenter(function(){$("#ele-asked-error").attr("style","display:none;"),$("#ele-asked-error").html("")}),$("#ele-concept-tr").mouseenter(function(){$("#ele-concept-error").attr("style","display:none;"),$("#ele-concept-error").html("")}),$(".ele-name").blur(function(){return 0==lengthCheck($(".ele-name").val(),0,50)?($("#ele-name-error").html("要素名称不能为空或超过长度限制50"),void $("#ele-name-error").attr("style","display:inline-block;left: 10px;top:30px;z-index:9999;")):isHtmlLabel($(".ele-name").val())?($("#ele-name-error").html($scope.vm.notContainHtmlLabel),void $("#ele-name-error").attr("style","display:inline-block;left: 10px;top:30px;z-index:9999;")):($("#ele-name-error").html(""),$("#ele-name-error").attr("style","display:none;"),void $.each($("#add-item").find("tr"),function(index,value){if($(".ele-name").val()==$(value).find(".ele-name-add").val())return $("#ele-name-error").html("要素名称不能与已有要素名称重复"),$("#ele-name-error").attr("style","display:inline-block;left: 10px;top:30px;z-index:9999;"),!0;$("#ele-name-error").html(""),$("#ele-name-error").attr("style","display:none;")}))}),$(".ele-asked").blur(function(){return 0==lengthCheck($(".ele-asked").val(),0,255)?($("#ele-asked-error").html("反问不能为空或超过长度限制255"),void $("#ele-asked-error").attr("style","display:inline-block;left: 10px;top:30px;z-index:9999")):isHtmlLabel($(".ele-asked").val())?($("#ele-asked-error").html($scope.vm.notContainHtmlLabel),void $("#ele-asked-error").attr("style","display:inline-block;left: 10px;top:30px;z-index:9999")):($("#ele-asked-error").html(""),$("#ele-asked-error").attr("style","display:none;"),void $.each($("#add-item").find("tr"),function(index,value){if($(".ele-asked").val()==$(value).find(".ele-asked-add").val())return $("#ele-asked-error").html("反问不能与已有反问重复"),$("#ele-asked-error").attr("style","display:inline-block;left: 10px;top:30px;z-index:9999;"),!0;$("#ele-asked-error").html(""),$("#ele-asked-error").attr("style","display:none;")}))}),$(".ele-concept").blur(function(){var relateConceptIds=$(".ele-concept").attr("data-option"),relateConceptVals=$(".ele-concept").val();relateConceptVals=relateConceptVals.substring(0,relateConceptVals.length-1);var sumConceptStr=relateConceptIds+$scope.vm.textAndTagSplit+relateConceptVals;if(0==lengthCheck(sumConceptStr,0,255))return $("#ele-concept-error").html("相关概念不能为空或超过长度限制"),void $("#ele-concept-error").attr("style","display:inline-block;left: 710px;");$("#ele-concept-error").html(""),$("#ele-concept-error").attr("style","display:none;")});var keyword="",keywordarr=$("#ele-concept-autocomplete").val().split(",");keyword=keywordarr[keywordarr.length];var conceptParams={conceptKeyword:keyword,applicationId:categoryApplicationId};$scope.vm.relateConcept=new HashMap,$("#ele-concept-autocomplete").on("keydown",function(event){9===event.keyCode&&$(this).autocomplete("instance").menu.active&&event.preventDefault()}).autocomplete({serviceUrl:"/api/ms/modeling/frame/searchconceptbykeyword",type:"POST",params:conceptParams,paramName:"conceptKeyword",dataType:"json",delimiter:",",transformResult:function(data){var result=new Object,array=[];if(data.data)for(var i=0;i<data.data.length;i++)array[i]={data:data.data[i].id,value:data.data[i].name};return result.suggestions=array,result},onSelect:function(suggestion){$scope.vm.relateConcept.put(suggestion.value,suggestion.data);var selectConceptValue="";if($("#ele-concept-autocomplete").val()!=suggestion.value)for(var terms=splitAuto($("#ele-concept-autocomplete").val()),i=0;i<terms.length;i++)terms[i]!=suggestion.value&&(selectConceptValue+=terms[i]+",");""==selectConceptValue?$("#ele-concept-autocomplete").val(suggestion.value+","):$("#ele-concept-autocomplete").val(selectConceptValue+suggestion.value+",");for(var selectConceptId="",selectedTerms=splitAuto($("#ele-concept-autocomplete").val()),i=0;i<selectedTerms.length;i++)null!=$scope.vm.relateConcept.get(selectedTerms[i])&&(selectConceptId+=$scope.vm.relateConcept.get(selectedTerms[i])+$scope.vm.conceptSplit);selectConceptId=selectConceptId.substring(0,selectConceptId.length-1),$("#ele-concept-autocomplete").attr("data-option",selectConceptId)},onSearchStart:function(){for(var selectConceptId="",selectedTerms=splitAuto($("#ele-concept-autocomplete").val()),i=0;i<selectedTerms.length;i++)null!=$scope.vm.relateConcept.get(selectedTerms[i])&&(selectConceptId+=$scope.vm.relateConcept.get(selectedTerms[i])+$scope.vm.conceptSplit);selectConceptId=selectConceptId.substring(0,selectConceptId.length-1),$("#ele-concept-autocomplete").attr("data-option",selectConceptId)}})},100)}function fillElementUpdatePage(){for(var i=0;i<$scope.vm.elementIdArray.length;i++){var originStr=$scope.vm.elementRelateConceptArray[i],conceptValue="";if(originStr.indexOf($scope.vm.textAndTagSplit)>=0){for(var conceptValueArr=originStr.split($scope.vm.conceptSplit),j=0;j<conceptValueArr.length;j++)httpRequestPostAsync("/api/ms/modeling/frame/searchconceptbyid",{conceptId:conceptValueArr[j]},function(data){1e4==data.status&&(conceptValue+=data.conceptWithWeight.name+",")},function(err){});conceptValue=conceptValue.substring(0,conceptValue.length-1)}var html='<tr element-id="'+$scope.vm.elementIdArray[i]+'">   <td><input type="checkbox" class="sid"/></td>   <td><input type="text" style="width: 200px;" class="input_text ele-name-add" disabled="disabled" value="'+$scope.vm.elementContentArray[i]+'"/></td>   <td>       <select class="ele-type-add bd">           <option value=10014>字符串</option>           <option value=10015>数字</option>           <option value=10016>范围</option>       </select>   </td>   <td>       <select class="mining-type-add bd" disabled="disabled">           <option value=10017>NLP</option>       </select>   </td>   <td><input style="width: 200px;" type="text" class="input_text ele-asked-add" value="'+$scope.vm.elementAskContentArray[i]+'" disabled="disabled"/></td>   <td><input style="width: 180px;" type="text" class="input_text ele-concept-add" placeholder="从概念库中选择" value="'+conceptValue+'" data-option="'+originStr+'" disabled="disabled"/></td></tr>';$("#add-item").append(html),$("#add-item").find("tr").filter(":eq("+i+")").find(".ele-type-add").val($scope.vm.elementTypeIdArray[i]),$("#add-item").find("tr").filter(":eq("+i+")").find(".mining-type-add").val($scope.vm.elementMiningTypeIdArray[i])}}function responseView(data){return clearSelectAll(),null!=data&&(layer.msg(data.info),data.status==$scope.vm.success)}function responseWithoutView(data){return null!=data&&data.status==$scope.vm.success}function turnOn(targetValue,targetName){$scope.vm[targetName]=targetValue?0:1}function concept_marking(){$.each($(".exten_problem").find("input").filter(":eq(0)"),function(index,value){if(0==lengthCheck($(value).val(),0,255))return $("#conceptExtendQuestionErrorObj").html("概念扩展不能为空或长度超过255"),!0;if(isHtmlLabel($(value).val()))return $("#conceptExtendQuestionErrorObj").html($scope.vm.notContainHtmlLabel),!0;if($(value).val()==$("#concept_title").val())return $("#conceptExtendQuestionErrorObj").html("概念标题不能与概念扩展重复"),!0;var flag=!1;if($.each($(".exten_problem").find("input").filter(":gt(0)"),function(index1,value1){if($(value).val()==$(value1).val())return $("#conceptExtendQuestionErrorObj").html("不能与已有概念扩展重复"),flag=!0,!0}),flag)return!0;$("#conceptExtendQuestionErrorObj").html("");var arr=[];arr[0]=$(value).val(),httpRequestPost("/api/ms/modeling/frame/batchtag",{extendQuestionList:arr,applicationId:categoryApplicationId},function(data){data&&200==data.status&&data.data.length>0&&null!=data.data[0]&&appendTag(data.data[0],$(value).val()),$.each($(".exten_problem").find("input").filter(":eq(0)"),function(index,value){$(value).val("")})},function(err){$("#conceptExtendQuestionErrorObj").html("打标失败，请正确发布节点后再进行打标操作!")})})}function appendTag(data,originStr){for(var tagHtml='<div class="tag_box">',i=0;i<data.length;i++)for(var j=0;j<data[i].tagList.length;j++)tagHtml+='<span class="tag_s">'+data[i].tagList[j]+"</span>";tagHtml+="</div>";var html='<div class="framework mb-10">   <span class="framework_s mt-7">概念扩展：</span>   <div class="formControlsForConcept">       <input type="hidden" value="'+originStr+'"/>'+tagHtml+'       <a href="javascript:;" class="del-button" onclick="rem_ques(this);">           <img src="../../images/images/delete_img.png">       </a>   </div></div>';$("#concept_extension").append(html),$(".extended_query_txt").val("")}function addEle(){var eleName=$(".ele-name").val();if(0==lengthCheck(eleName,0,50))return $("#ele-name-error").html("要素名称不能为空或超过长度限制50"),void $("#ele-name-error").attr("style","display:inline-block;left: 10px;z-index:9999;");if(isHtmlLabel(eleName))return $("#ele-name-error").html($scope.vm.notContainHtmlLabel),void $("#ele-name-error").attr("style","display:inline-block;left: 10px;z-index:9999;");$("#ele-name-error").html(""),$("#ele-name-error").attr("style","display:none;");var flag1=!1;if($.each($("#add-item").find("tr"),function(index,value){eleName==$(value).find(".ele-name-add").val()&&($("#ele-name-error").html("要素名称不能与已有要素名称重复"),$("#ele-name-error").attr("style","display:inline-block;left: 10px;z-index:9999"),flag1=!0)}),1!=flag1){$("#ele-name-error").html(""),$("#ele-name-error").attr("style","display:none;");var eleType=$(".ele-type").val(),miningType=$(".mining-type").val(),eleAsked=$(".ele-asked").val();if(0==lengthCheck(eleAsked,0,255))return $("#ele-asked-error").html("反问不能为空或超过长度限制255"),void $("#ele-asked-error").attr("style","display:inline-block;left: 10px;z-index:9999;");if(isHtmlLabel(eleAsked))return $("#ele-asked-error").html($scope.vm.notContainHtmlLabel),void $("#ele-asked-error").attr("style","display:inline-block;left: 10px;z-index:9999;");$("#ele-asked-error").html(""),$("#ele-asked-error").attr("style","display:none;");var flag2=!1;if($.each($("#add-item").find("tr"),function(index,value){eleAsked==$(value).find(".ele-asked-add").val()&&($("#ele-asked-error").html("反问不能与已有反问重复"),$("#ele-asked-error").attr("style","display:inline-block;left: 10px;z-index:9999;"),flag2=!0)}),1!=flag2){$("#ele-asked-error").html(""),$("#ele-asked-error").attr("style","display:none;");var relateConceptIds="",relateConceptVals="";if(void 0==$(".ele-concept").attr("data-option")||""==$(".ele-concept").attr("data-option"));else{relateConceptIds=$(".ele-concept").attr("data-option"),relateConceptVals=$(".ele-concept").val(),relateConceptVals=relateConceptVals.substring(0,relateConceptVals.length-1);var sumConceptStr=relateConceptIds+$scope.vm.textAndTagSplit+relateConceptVals;if(0==lengthCheck(sumConceptStr,0,255))return $("#ele-concept-error").html("相关概念不能为空或超过长度限制"),void $("#ele-concept-error").attr("style","display:inline-block;left: 10px;");if($("#ele-concept-error").html(""),$("#ele-concept-error").attr("style","display:none;"),null==relateConceptVals)return;if(""==relateConceptVals)return;if(null==relateConceptIds)return;if(""==relateConceptIds)return}var html='<tr>   <td><input type="checkbox" class="sid"/></td>   <td class="pr"><input type="text" style="width: 200px;" class="input_text ele-name-add" placeholder="地区" value="'+eleName+'" disabled="disabled"/></td>   <td>       <select class="ele-type-add bd">           <option value=10014>字符串</option>           <option value=10015>数字</option>           <option value=10016>范围</option>       </select>   </td>   <td>       <select class="mining-type-add bd" disabled="disabled">           <option value=10017>NLP</option>       </select>   </td>   <td class="pr"><input type="text" style="width: 200px;" class="input_text ele-asked-add" placeholder="" value="'+eleAsked+'" disabled="disabled"/></td>   <td class="pr"><input type="text" style="width: 180px;" class="input_text ele-concept-add" placeholder="从概念库中选择" value="'+relateConceptVals+'" data-option="'+relateConceptIds+'" disabled="disabled"/></td></tr>';$("#add-item").prepend(html),$("#add-item").find("tr").filter(":eq(0)").find(".ele-type-add").val(eleType),$("#add-item").find("tr").filter(":eq(0)").find(".mining-type-add").val(miningType),$(".ele-name").val(""),$(".ele-type").val(10014),$(".mining-type").val(10017),$(".ele-asked").val(""),$(".ele-concept").attr("data-option",""),$(".ele-concept").val("")}}}function delEle(){layer.confirm("确认删除？",{btn:["确认","取消"],shade:!1},function(index){layer.close(index),$.each($("#add-item").find(".sid"),function(index,value){1==$(value).prop("checked")&&(null!=$(value).parent().parent().attr("element-id")&&httpRequestPostAsync("/api/ms/modeling/frame/deleteelementbyid",{elementId:$(value).parent().parent().attr("element-id")},function(data){1==responseView(data)&&loadFrameLibrary(1,0)},function(err){}),$(value).parent().parent().remove())})},function(){})}function splitAuto(val){return val.split(",")}function HashMap(){var length=0,obj=new Object;this.isEmpty=function(){return 0==length},this.containsKey=function(key){return key in obj},this.containsValue=function(value){for(var key in obj)if(obj[key]==value)return!0;return!1},this.put=function(key,value){this.containsKey(key)||length++,obj[key]=value},this.get=function(key){return this.containsKey(key)?obj[key]:null},this.remove=function(key){this.containsKey(key)&&delete obj[key]&&length--},this.values=function(){var _values=new Array;for(var key in obj)_values.push(obj[key]);return _values},this.keySet=function(){var _keys=new Array;for(var key in obj)_keys.push(key);return _keys},this.size=function(){return length},this.clear=function(){length=0,obj=new Object}}$state.go("frameworkLibrary.manage",{userPermission:$stateParams.userPermission}),$scope.vm={success:1e4,illegal:10003,failed:10004,empty:10005,botSelectValue:"root",botRoot:"",knowledgeBotVal:"",botInfo:null,clearColor:clearColor,loadFrameLibrary:loadFrameLibrary,addFrame:addFrame,paginationConf:{currentPage:1,totalItems:0,pageSize:1,pagesLength:8},pageSize:6,frameInfo:null,addFaq:addFaq,addConcept:addConcept,addElement:addElement,updateFaq:updateFaq,updateConcept:updateConcept,updateElement:updateElement,frameTitle:"",frameTypeId:0,elementAskContentArray:[],elementAttributeIdArray:[],elementContentArray:[],elementFrameIdArray:[],elementMiningTypeIdArray:[],elementRelateConceptArray:[],elementTypeIdArray:[],frameCategoryId:"",frameEnableStatusId:1,frameModifierId:"",defaultString:"null",textAndTagSplit:"#",conceptSplit:"；",defaultInt:0,responseView:responseView,turnOn:turnOn,elementIdArray:[],concept_marking:concept_marking,addEle:addEle,delEle:delEle,relateConcept:null,frameTitleNullErrorInfo:"框架标题为空或超过长度限制50",notContainHtmlLabel:"不能包含HTML标签",frameTitleRepeatCheck:frameTitleRepeatCheck,searchNodeForFrame:searchNodeForFrame,recursionForFrame:recursionForFrame,autoHeightForFrame:autoHeightForFrame,locationForFrame:locationForFrame,listData:"",editFrame:editFrame,deleteFrame:deleteFrame,searchByFrameTitle:searchByFrameTitle,downloadTemplate:downloadTemplate,exportAll:exportAll,batchUpload:batchUpload,batchDelete:batchDelete,suggestionValue:"",suggestionData:"",winHeight:0},$scope.categoryAttributeName;var categoryApplicationId=$cookieStore.get("applicationId"),categoryModifierId=$cookieStore.get("userId");autoHeightForFrame();var params={categoryName:$("#category-autocomplete").val(),categoryAttributeName:"node",categoryApplicationId:categoryApplicationId};$("#category-autocomplete").autocomplete({serviceUrl:"/api/ms/modeling/category/searchbycategoryname",type:"POST",params:params,paramName:"categoryName",dataType:"json",transformResult:function(data){var result=new Object,array=[];if(data.data)for(var i=0;i<data.data.length;i++)array[i]={data:data.data[i].categoryId,value:data.data[i].categoryName};return result.suggestions=array,result},onSelect:function(suggestion){searchNodeForFrame(suggestion),$scope.vm.suggestionValue=suggestion.value,$scope.vm.suggestionData=suggestion.data}}),$interval(function(){if(1==nullCheck($scope.vm.suggestionData)){var suggestion=new Object;suggestion.value=$scope.vm.suggestionValue,suggestion.data=$scope.vm.suggestionData,locationForFrameFlag(suggestion)&&(locationForFrame(suggestion),$scope.vm.suggestionValue="",$scope.vm.suggestionData="")}},2e3),initBot(),$(".aside-navs").on("click","span",function(){clearColor(),$scope.vm.knowledgeBotVal=$(this).html(),$scope.vm.botSelectValue=$(this).attr("data-option"),$scope.vm.botSelectType=$(this).attr("type-option");var categoryAttributeName=$(this).attr("attribute-option");"node"==categoryAttributeName?$(this).attr("style","color:black;font-weight:bold;"):"edge"==categoryAttributeName&&$(this).attr("style","color:#ED7D31;font-weight:bold;"),loadFrameLibrary(1,0),$scope.$apply()}),$(".aside-navs").on("click","i",function(){appendTree(this)}),$("#selectAll").on("click",function(){var ids=document.getElementsByName("sid"),flag=!1;this.checked&&(flag=!0),$.each(ids,function(index,value){flag?($(value).attr("checked",!0),$(value).prop("checked",!0)):($(value).attr("checked",!1),$(value).prop("checked",!1))})}),$scope.$watch("vm.paginationConf.currentPage",function(current){current&&(1==nullCheck($("#keyWords").val())?searchByFrameTitle(current,0):loadFrameLibrary(current,0))})}]),angular.module("businessModelingModule").controller("intentionConceptManageController",["$scope","localStorageService","$state","ngDialog","$timeout","$cookieStore",function($scope,localStorageService,$state,ngDialog,$timeout,$cookieStore){function init(){$scope.vm.paginationConf={currentPage:1,totalItems:0,pageSize:0,pagesLength:8}}function loadForceSegmentConceptTable(current){httpRequestPost("/api/ms/modeling/concept/forceSegment/listByAttribute",{forceSegmentConceptApplicationId:$scope.vm.applicationId,index:(current-1)*$scope.vm.pageSize,pageSize:$scope.vm.pageSize},function(data){loadForceSegmentConcept(current,data)},function(){})}function loadForceSegmentConcept(current,data){clearSelectAll(),$scope.vm.listData=data.data,$scope.vm.paginationConf={currentPage:current,totalItems:data.total,pageSize:$scope.vm.pageSize,pagesLength:8},$scope.$apply()}function clearSelectAll(){$("#selectAll").attr("checked",!1),$("#selectAll").prop("checked",!1)}function batchDelete(){for(var ids=document.getElementsByName("sid"),id_array=[],i=0;i<ids.length;i++)ids[i].checked&&id_array.push(ids[i].value);if(0==id_array.length)return void layer.msg("请选择要删除的记录！");layer.confirm("确认要删除吗？",function(index){layer.close(index);var request=new Object;request.ids=id_array,httpRequestPost("/api/ms/modeling/concept/forceSegment/batchDelete",request,function(data){1==responseView(data)&&loadForceSegmentConceptTable($scope.vm.paginationConf.currentPage)})})}function editForceSegment(item){$scope.vm.dialogTitle="编辑强制分词概念",$scope.vm.key=item.forceSegmentConceptKey,$scope.vm.term=item.forceSegmentConceptTerm,addForceSegmentConceptDialog(singleEditForceSegmentConcept,item)}function searchForceSegmentConcept(current){"forceSegmentConceptModifier"==$scope.vm.searchType?searchForceSegmentConceptByUser(current):searchForceSegmentConceptByType(current)}function searchForceSegmentConceptByUser(current){httpRequestPost("/api/ms/modeling/concept/forceSegment/listByModifier",{forceSegmentConceptModifier:$scope.vm.searchVal,forceSegmentConceptApplicationId:$scope.vm.applicationId,index:(current-1)*$scope.vm.pageSize,pageSize:$scope.vm.pageSize},function(data){loadForceSegmentConcept(current,data)},function(){layer.msg("查询没有对应信息")})}function searchForceSegmentConceptByType(current){var request=new Object;if(request.forceSegmentConceptApplicationId=$scope.vm.applicationId,request.index=(current-1)*$scope.vm.pageSize,request.pageSize=$scope.vm.pageSize,"forceSegmentConceptModifyTime"!=$scope.vm.searchType)request=switchForceSegmentConceptSearchType(request,$scope.vm.searchVal);else{if(1!=nullCheck($scope.vm.timeStart)||1!=nullCheck($scope.vm.timeEnd))return void layer.msg("请选择时间段");request.startTimeRequest=$scope.vm.timeStart,request.endTimeRequest=$scope.vm.timeEnd}httpRequestPost("/api/ms/modeling/concept/forceSegment/listByAttribute",request,function(data){loadForceSegmentConcept(current,data)},function(){layer.msg("查询没有对应信息")})}function switchForceSegmentConceptSearchType(request,value){return"forceSegmentConceptKey"==$("#searchType").val()?request.forceSegmentConceptKey=$scope.vm.percent+value+$scope.vm.percent:"forceSegmentConceptTerm"==$("#searchType").val()&&(request.forceSegmentConceptTerm=$scope.vm.percent+value+$scope.vm.percent),request}function addForceSegment(){ngDialog.openConfirm({template:"/static/businessModeling/intention/intentionConceptManageDialog.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){if(1===e){if(0==lengthCheck($scope.vm.key,0,50))return $("#keyAddError").html($scope.vm.keyNullOrBeyondLimit),!1;httpRequestPost("/api/ms/modeling/concept/forceSegment/repeatCheck",{forceSegmentConceptApplicationId:$scope.vm.applicationId,forceSegmentConceptKey:$scope.vm.key},function(data){10002===data.status?layer.confirm("您添加的概念类已经在，是否前往编辑？",{btn:["前往","取消"],shade:!1},function(index){layer.close(index),httpRequestPost("/api/ms/modeling/concept/forceSegment/listByAttribute",{forceSegmentConceptApplicationId:$scope.vm.applicationId,forceSegmentConceptKey:$scope.vm.key,index:0,pageSize:1},function(data){$scope.vm.dialogTitle="编辑强制分词概念",addForceSegmentConceptDialog(singleEditForceSegmentConcept,data.data[0]),$scope.vm.key=data.data[0].forceSegmentConceptKey,$scope.vm.term=data.data[0].forceSegmentConceptTerm},function(){})},function(){}):($scope.vm.dialogTitle="增加强制分词概念",$scope.vm.term="",addForceSegmentConceptDialog(singleAddForceSegmentConcept))},function(){})}else $scope.vm.key="",$scope.vm.term=""}})&&$timeout(function(){termSpliterTagEditor(),$("#forceSegmentKey").blur(function(){0==lengthCheck($("#forceSegmentKey").val(),0,50)?$("#keyAddError").html($scope.vm.keyNullOrBeyondLimit):$("#keyAddError").html("")})},100)}function addForceSegmentConceptDialog(callback,item){ngDialog.openConfirm({template:"/static/businessModeling/intention/intentionConceptManageDialog2.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){if(1===e){if(0==lengthCheck($scope.vm.key,0,50))return $("#keyAddError").html($scope.vm.keyNullOrBeyondLimit),!1;var obj=$("#term").next(),term="";if(obj.find("li").length<=0)return $("#termAddError").html($scope.vm.termNullOrBeyondLimit),!1;if($("#termAddError").html(""),$.each(obj.find("li"),function(index,value){index>0&&$.each($(value).find("div"),function(index1,value1){1==index1&&(term+=$(value1).html()+$scope.vm.termSpliter)})}),term=term.substring(0,term.length-1),$scope.vm.term=term,0==lengthCheck(term,0,500))return $("#termAddError").html($scope.vm.termNullOrBeyondLimit),!1;$("#termAddError").html(""),callback(item)}else $scope.vm.key="",$scope.vm.term=""}})&&$timeout(function(){termSpliterTagEditor(),$("#forceSegmentKeyTwo").blur(function(){0==lengthCheck($("#forceSegmentKeyTwo").val(),0,50)?$("#keyAddError").html($scope.vm.keyNullOrBeyondLimit):$("#keyAddError").html("")})},100)}function deleteForceSegment(id){0==angular.element(".ngdialog ").length&&ngDialog.openConfirm({template:"/static/businessModeling/conceptManageDialog.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){1===e&&singleDelForceSegmentConcept(id)}})}function batchUpload(){ngDialog.openConfirm({template:"/static/businessModeling/batchUpload.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){loadForceSegmentConceptTable($scope.vm.paginationConf.currentPage)}})&&$timeout(function(){initUpload("/api/ms/modeling/concept/forceSegment/batchAdd?applicationId="+$scope.vm.applicationId+"&modifierId="+$scope.vm.modifier)},100)}function singleEditForceSegmentConcept(item){assembleForceSegmentConceptTerm(),httpRequestPost("/api/ms/modeling/concept/forceSegment/update",{forceSegmentConceptId:item.forceSegmentConceptId,forceSegmentConceptApplicationId:$scope.vm.applicationId,applicationId:$scope.vm.applicationId,forceSegmentConceptKey:$scope.vm.key,forceSegmentConceptModifier:$scope.vm.modifier,forceSegmentConceptTerm:$scope.vm.term},function(data){1==responseView(data)&&loadForceSegmentConceptTable($scope.vm.paginationConf.currentPage)})}function singleAddForceSegmentConcept(){assembleForceSegmentConceptTerm(),httpRequestPost("/api/ms/modeling/concept/forceSegment/add",{forceSegmentConceptApplicationId:$scope.vm.applicationId,applicationId:$scope.vm.applicationId,forceSegmentConceptKey:$scope.vm.key,forceSegmentConceptModifier:$scope.vm.modifier,forceSegmentConceptTerm:$scope.vm.term},function(data){1==responseView(data)&&loadForceSegmentConceptTable($scope.vm.paginationConf.currentPage)})}function singleDelForceSegmentConcept(id){httpRequestPost("/api/ms/modeling/concept/forceSegment/delete",{forceSegmentConceptId:id},function(data){1==responseView(data)&&loadForceSegmentConceptTable($scope.vm.paginationConf.currentPage)})}function termSpliterTagEditor(){var term=$scope.vm.term;if(""==term)$("#term").tagEditor({forceLowercase:!1});else{var terms=term.split($scope.vm.termSpliter);$("#term").tagEditor({initialTags:terms,autocomplete:{delay:0,position:{collision:"flip"},source:terms},forceLowercase:!1})}}function assembleForceSegmentConceptTerm(){var obj=$("#term").next(),term="";$.each(obj.find("li"),function(index,value){index>0&&$.each($(value).find("div"),function(index1,value1){1==index1&&(term+=$(value1).html()+$scope.vm.termSpliter)})}),term=term.substring(0,term.length-1),$scope.vm.term=term}function responseView(data){return $scope.vm.key="",$scope.vm.term="",clearSelectAll(),null!=data&&(layer.msg(data.info),data.status==$scope.vm.success)}function downloadTemplate(){downloadFile("/api/ms/knowledgeManage/downloadKnowledgeTemplate","","concept_template.xlsx")}function exportAll(){httpRequestPost("/api/ms/modeling/concept/forceSegment/export",{forceSegmentConceptApplicationId:$scope.vm.applicationId},function(data){if(1==responseView(data))for(var i=0;i<data.exportFileNameList.length;i++)downloadFile("/api/ms/modeling/downloadWithPath",data.filePath,data.exportFileNameList[0])})}$scope.vm={success:1e4,illegal:10003,failed:10004,empty:10005,applicationId:$cookieStore.get("applicationId"),addForceSegment:addForceSegment,editForceSegment:editForceSegment,deleteForceSegment:deleteForceSegment,listData:"",singleDelForceSegmentConcept:singleDelForceSegmentConcept,singleAddForceSegmentConcept:singleAddForceSegmentConcept,paginationConf:"",pageSize:5,searchForceSegmentConcept:searchForceSegmentConcept,searchVal:"",searchType:"forceSegmentConceptKey",timeStart:"",timeEnd:"",key:"",modifier:$cookieStore.get("userId"),term:"",dialogTitle:"",inputSelect:[],inputVal:"",termSpliter:"；",percent:"%",keyNullOrBeyondLimit:"概念类名不能为空或超过长度限制50",termNullOrBeyondLimit:"概念集合不能为空或超过长度限制5000",downloadTemplate:downloadTemplate,exportAll:exportAll,batchUpload:batchUpload,batchDelete:batchDelete},init();var timeout;$scope.$watch("vm.paginationConf.currentPage",function(current){current&&(timeout&&$timeout.cancel(timeout),timeout=$timeout(function(){1==nullCheck($scope.vm.searchVal)||1==nullCheck($scope.vm.timeStart)&&1==nullCheck($scope.vm.timeEnd)?searchForceSegmentConcept(current):loadForceSegmentConceptTable(current)},100))},!0),$("#selectAll").on("click",function(){var ids=document.getElementsByName("sid"),flag=!1;this.checked&&(flag=!0),$.each(ids,function(index,value){flag?($(value).attr("checked",!0),$(value).prop("checked",!0)):($(value).attr("checked",!1),$(value).prop("checked",!1))})})}]),angular.module("businessModelingModule").controller("semanticExpressionConceptManageController",["$scope","localStorageService","$state","ngDialog","$timeout","$cookieStore",function($scope,localStorageService,$state,ngDialog,$timeout,$cookieStore){function init(){$scope.vm.paginationConf={currentPage:1,totalItems:0,pageSize:0,pagesLength:8}}function loadSemanticExpressionConceptTable(current){httpRequestPost("/api/ms/modeling/concept/semanticexpression/listByAttribute",{semanticExpressionConceptApplicationId:$scope.vm.applicationId,index:(current-1)*$scope.vm.pageSize,pageSize:$scope.vm.pageSize},function(data){loadSemanticExpressionConcept(current,data)},function(){})}function loadSemanticExpressionConcept(current,data){clearSelectAll(),$scope.vm.listData=data.data,$scope.vm.paginationConf={currentPage:current,totalItems:data.total,pageSize:$scope.vm.pageSize,pagesLength:8},$scope.$apply()}function clearSelectAll(){$("#selectAll").attr("checked",!1),$("#selectAll").prop("checked",!1)}function batchDelete(){for(var ids=document.getElementsByName("sid"),id_array=[],i=0;i<ids.length;i++)ids[i].checked&&id_array.push(ids[i].value);if(0==id_array.length)return void layer.msg("请选择要删除的记录！");layer.confirm("确认要删除吗？",function(index){layer.close(index);var request=new Object;request.ids=id_array,httpRequestPost("/api/ms/modeling/concept/semanticexpression/batchDelete",request,function(data){1==responseView(data)&&loadSemanticExpressionConceptTable($scope.vm.paginationConf.currentPage)})})}function editSemanticExpression(item){$scope.vm.dialogTitle="编辑语义表达概念",$scope.vm.key=item.semanticExpressionConceptKey,$scope.vm.synonym=item.semanticExpressionSynonymConcept,$scope.vm.term=item.semanticExpressionConceptTerm,addSemanticExpressionConceptDialog(singleEditSemanticExpressionConcept,item)}function searchSemanticExpressionConcept(current){"semanticExpressionConceptModifier"==$scope.vm.searchType?searchSemanticExpressionConceptByUser(current):searchSemanticExpressionConceptByType(current)}function searchSemanticExpressionConceptByUser(current){httpRequestPost("/api/ms/modeling/concept/semanticexpression/listByModifier",{semanticExpressionConceptModifier:$scope.vm.searchVal,semanticExpressionConceptApplicationId:$scope.vm.applicationId,index:(current-1)*$scope.vm.pageSize,pageSize:$scope.vm.pageSize},function(data){loadSemanticExpressionConcept(current,data)},function(){layer.msg("查询没有对应信息")})}function searchSemanticExpressionConceptByType(current){var request=new Object;if(request.semanticExpressionConceptApplicationId=$scope.vm.applicationId,request.index=(current-1)*$scope.vm.pageSize,request.pageSize=$scope.vm.pageSize,"semanticExpressionConceptModifyTime"!=$scope.vm.searchType)request=switchSemanticExpressionConceptSearchType(request,$scope.vm.searchVal);else{if(1!=nullCheck($scope.vm.timeStart)||1!=nullCheck($scope.vm.timeEnd))return void layer.msg("请选择时间段");request.startTimeRequest=$scope.vm.timeStart,request.endTimeRequest=$scope.vm.timeEnd}httpRequestPost("/api/ms/modeling/concept/semanticexpression/listByAttribute",request,function(data){loadSemanticExpressionConcept(current,data)},function(){layer.msg("查询没有对应信息")})}function switchSemanticExpressionConceptSearchType(request,value){return"semanticExpressionConceptKey"==$("#searchType").val()?request.semanticExpressionConceptKey=$scope.vm.percent+value+$scope.vm.percent:"semanticExpressionConceptTerm"==$("#searchType").val()?request.semanticExpressionConceptTerm=$scope.vm.percent+value+$scope.vm.percent:"semanticExpressionSynonymConcept"==$("#searchType").val()&&(request.semanticExpressionSynonymConcept=$scope.vm.percent+value+$scope.vm.percent),request}function addSemanticExpression(){ngDialog.openConfirm({template:"/static/businessModeling/semanticExpression/semanticExpressionConceptManageDialog.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){if(1===e){if(0==lengthCheck($scope.vm.key,0,50))return $("#keyAddError").html($scope.vm.keyNullOrBeyondLimit),!1;httpRequestPost("/api/ms/modeling/concept/semanticexpression/repeatCheck",{semanticExpressionConceptApplicationId:$scope.vm.applicationId,semanticExpressionConceptKey:$scope.vm.key},function(data){10002===data.status?layer.confirm("您添加的概念类已经在，是否前往编辑？",{btn:["前往","取消"],shade:!1},function(index){layer.close(index),httpRequestPost("/api/ms/modeling/concept/semanticexpression/listByAttribute",{semanticExpressionConceptApplicationId:$scope.vm.applicationId,semanticExpressionConceptKey:$scope.vm.key,index:0,pageSize:1},function(data){$scope.vm.dialogTitle="编辑语义表达概念",addSemanticExpressionConceptDialog(singleEditSemanticExpressionConcept,data.data[0]),$scope.vm.key=data.data[0].semanticExpressionConceptKey,$scope.vm.term=data.data[0].semanticExpressionConceptTerm,$scope.vm.synonym=data.data[0].semanticExpressionSynonymConcept},function(){})},function(){}):($scope.vm.dialogTitle="增加语义表达概念",$scope.vm.term="",$scope.vm.synonym="",addSemanticExpressionConceptDialog(singleAddSemanticExpressionConcept))},function(){})}else $scope.vm.key="",$scope.vm.term="",$scope.vm.synonym=""}})&&$timeout(function(){termSpliterTagEditor(),$("#semanticExpressionKey").blur(function(){0==lengthCheck($("#semanticExpressionKey").val(),0,50)?$("#keyAddError").html($scope.vm.keyNullOrBeyondLimit):$("#keyAddError").html("")})},100)}function addSemanticExpressionConceptDialog(callback,item){ngDialog.openConfirm({template:"/static/businessModeling/semanticExpression/semanticExpressionConceptManageDialog2.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){if(1===e){if(0==lengthCheck($scope.vm.key,0,50))return $("#keyAddError").html($scope.vm.keyNullOrBeyondLimit),!1;if(""!=$scope.vm.synonym&&0==lengthCheck($scope.vm.synonym,0,50))return $("#synonymAddError").html($scope.vm.synonymBeyondLimit),!1;var obj=$("#term").next(),term="";if(obj.find("li").length<=0)return $("#termAddError").html($scope.vm.termNullOrBeyondLimit),!1;if($("#termAddError").html(""),$.each(obj.find("li"),function(index,value){index>0&&$.each($(value).find("div"),function(index1,value1){1==index1&&(term+=$(value1).html()+$scope.vm.termSpliter)})}),term=term.substring(0,term.length-1),$scope.vm.term=term,0==lengthCheck(term,0,500))return $("#termAddError").html($scope.vm.termNullOrBeyondLimit),!1;$("#termAddError").html(""),callback(item)}else $scope.vm.key="",$scope.vm.term="",$scope.vm.synonym=""}})&&$timeout(function(){termSpliterTagEditor(),$("#semanticExpressionKeyTwo").blur(function(){0==lengthCheck($("#semanticExpressionKeyTwo").val(),0,50)?$("#keyAddError").html($scope.vm.keyNullOrBeyondLimit):$("#keyAddError").html("")}),$("#semanticExpressionSynonymConcept").blur(function(){1==nullCheck($("#semanticExpressionSynonymConcept").val())&&(0==lengthCheck($("#semanticExpressionSynonymConcept").val(),0,50)?$("#synonymAddError").html($scope.vm.synonymBeyondLimit):$("#synonymAddError").html(""))})},100)}function deleteSemanticExpression(id){ngDialog.openConfirm({template:"/static/businessModeling/conceptManageDialog.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){1===e&&singleDelSemanticExpressionConcept(id)}})}function batchUpload(){ngDialog.openConfirm({template:"/static/businessModeling/batchUpload.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){loadSemanticExpressionConceptTable($scope.vm.paginationConf.currentPage)}})&&$timeout(function(){initUpload("/api/ms/modeling/concept/semanticexpression/batchAdd?applicationId="+$scope.vm.applicationId+"&modifierId="+$scope.vm.modifier)},100)}function singleEditSemanticExpressionConcept(item){assembleSemanticExpressionConceptTerm(),httpRequestPost("/api/ms/modeling/concept/semanticexpression/update",{semanticExpressionConceptId:item.semanticExpressionConceptId,semanticExpressionConceptApplicationId:$scope.vm.applicationId,applicationId:$scope.vm.applicationId,semanticExpressionConceptKey:$scope.vm.key,semanticExpressionSynonymConcept:$scope.vm.synonym,semanticExpressionConceptModifier:$scope.vm.modifier,semanticExpressionConceptTerm:$scope.vm.term},function(data){1==responseView(data)&&loadSemanticExpressionConceptTable($scope.vm.paginationConf.currentPage)})}function singleAddSemanticExpressionConcept(){assembleSemanticExpressionConceptTerm(),httpRequestPost("/api/ms/modeling/concept/semanticexpression/add",{semanticExpressionConceptApplicationId:$scope.vm.applicationId,applicationId:$scope.vm.applicationId,semanticExpressionConceptKey:$scope.vm.key,semanticExpressionSynonymConcept:$scope.vm.synonym,semanticExpressionConceptModifier:$scope.vm.modifier,semanticExpressionConceptTerm:$scope.vm.term},function(data){1==responseView(data)&&loadSemanticExpressionConceptTable($scope.vm.paginationConf.currentPage)})}function singleDelSemanticExpressionConcept(id){httpRequestPost("/api/ms/modeling/concept/semanticexpression/delete",{semanticExpressionConceptId:id},function(data){1==responseView(data)&&loadSemanticExpressionConceptTable($scope.vm.paginationConf.currentPage)})}function termSpliterTagEditor(){var term=$scope.vm.term;if(""==term)$("#term").tagEditor({forceLowercase:!1});else{var terms=term.split($scope.vm.termSpliter);$("#term").tagEditor({initialTags:terms,autocomplete:{delay:0,position:{collision:"flip"},source:terms},forceLowercase:!1})}}function assembleSemanticExpressionConceptTerm(){var obj=$("#term").next(),term="";$.each(obj.find("li"),function(index,value){index>0&&$.each($(value).find("div"),function(index1,value1){1==index1&&(term+=$(value1).html()+$scope.vm.termSpliter)})}),term=term.substring(0,term.length-1),$scope.vm.term=term}function responseView(data){return $scope.vm.key="",$scope.vm.term="",$scope.vm.synonym="",clearSelectAll(),null!=data&&(layer.msg(data.info),data.status==$scope.vm.success)}function downloadTemplate(){downloadFile("/api/ms/knowledgeManage/downloadKnowledgeTemplate","","semantic_expression_concept_template.xlsx")}function exportAll(){httpRequestPost("/api/ms/modeling/concept/semanticexpression/export",{semanticExpressionConceptApplicationId:$scope.vm.applicationId},function(data){if(1==responseView(data))for(var i=0;i<data.exportFileNameList.length;i++)downloadFile("/api/ms/modeling/downloadWithPath",data.filePath,data.exportFileNameList[0])})}$scope.vm={success:1e4,illegal:10003,failed:10004,empty:10005,applicationId:$cookieStore.get("applicationId"),addSemanticExpression:addSemanticExpression,editSemanticExpression:editSemanticExpression,deleteSemanticExpression:deleteSemanticExpression,listData:"",singleDelSemanticExpressionConcept:singleDelSemanticExpressionConcept,singleAddSemanticExpressionConcept:singleAddSemanticExpressionConcept,paginationConf:"",pageSize:5,searchSemanticExpressionConcept:searchSemanticExpressionConcept,searchVal:"",searchType:"semanticExpressionConceptKey",timeStart:"",timeEnd:"",key:"",synonym:"",modifier:$cookieStore.get("userId"),term:"",dialogTitle:"",inputSelect:[],inputVal:"",termSpliter:"；",percent:"%",keyNullOrBeyondLimit:"概念类名不能为空或超过长度限制50",synonymBeyondLimit:"同义概念不能超过长度限制50",termNullOrBeyondLimit:"概念集合不能为空或超过长度限制5000",downloadTemplate:downloadTemplate,exportAll:exportAll,batchUpload:batchUpload,batchDelete:batchDelete},init();var timeout;$scope.$watch("vm.paginationConf.currentPage",function(current){current&&(timeout&&$timeout.cancel(timeout),timeout=$timeout(function(){1==nullCheck($scope.vm.searchVal)||1==nullCheck($scope.vm.timeStart)&&1==nullCheck($scope.vm.timeEnd)?searchSemanticExpressionConcept(current):loadSemanticExpressionConceptTable(current)},100))},!0),$("#selectAll").on("click",function(){var ids=document.getElementsByName("sid"),flag=!1;this.checked&&(flag=!0),$.each(ids,function(index,value){flag?($(value).attr("checked",!0),$(value).prop("checked",!0)):($(value).attr("checked",!1),$(value).prop("checked",!1))})})}]),angular.module("businessModelingModule").controller("sensitiveConceptManageController",["$scope","localStorageService","$state","ngDialog","$timeout","$cookieStore",function($scope,localStorageService,$state,ngDialog,$timeout,$cookieStore){function init(){$scope.vm.paginationConf={currentPage:1,totalItems:0,pageSize:0,pagesLength:8}}function loadSensitiveConceptTable(current){httpRequestPost("/api/ms/modeling/concept/sensitive/listByAttribute",{sensitiveConceptApplicationId:$scope.vm.applicationId,index:(current-1)*$scope.vm.pageSize,pageSize:$scope.vm.pageSize},function(data){loadSensitiveConcept(current,data)},function(){})}function loadSensitiveConcept(current,data){clearSelectAll(),$scope.vm.listData=data.data,$scope.vm.paginationConf={currentPage:current,totalItems:data.total,pageSize:$scope.vm.pageSize,pagesLength:8},$scope.$apply()}function clearSelectAll(){$("#selectAll").attr("checked",!1),$("#selectAll").prop("checked",!1)}function batchDelete(){for(var ids=document.getElementsByName("sid"),id_array=[],i=0;i<ids.length;i++)ids[i].checked&&id_array.push(ids[i].value);if(0==id_array.length)return void layer.msg("请选择要删除的记录！");layer.confirm("确认要删除吗？",function(index){layer.close(index);var request=new Object;request.ids=id_array,httpRequestPost("/api/ms/modeling/concept/sensitive/batchDelete",request,function(data){1==responseView(data)&&loadSensitiveConceptTable($scope.vm.paginationConf.currentPage)})})}function editSensitive(item){$scope.vm.dialogTitle="编辑敏感概念",$scope.vm.key=item.sensitiveConceptKey,$scope.vm.term=item.sensitiveConceptTerm,addSensitiveConceptDialog(singleEditSensitiveConcept,item)}function searchSensitiveConcept(current){"sensitiveConceptModifier"==$scope.vm.searchType?searchSensitiveConceptByUser(current):searchSensitiveConceptByType(current)}function searchSensitiveConceptByUser(current){httpRequestPost("/api/ms/modeling/concept/sensitive/listByModifier",{sensitiveConceptModifier:$scope.vm.searchVal,sensitiveConceptApplicationId:$scope.vm.applicationId,index:(current-1)*$scope.vm.pageSize,pageSize:$scope.vm.pageSize},function(data){loadSensitiveConcept(current,data)},function(){layer.msg("查询没有对应信息")})}function searchSensitiveConceptByType(current){var request=new Object;if(request.sensitiveConceptApplicationId=$scope.vm.applicationId,request.index=(current-1)*$scope.vm.pageSize,request.pageSize=$scope.vm.pageSize,"sensitiveConceptModifyTime"!=$scope.vm.searchType)request=switchSensitiveConceptSearchType(request,$scope.vm.searchVal);else{if(1!=nullCheck($scope.vm.timeStart)||1!=nullCheck($scope.vm.timeEnd))return void layer.msg("请选择时间段");request.startTimeRequest=$scope.vm.timeStart,request.endTimeRequest=$scope.vm.timeEnd}httpRequestPost("/api/ms/modeling/concept/sensitive/listByAttribute",request,function(data){loadSensitiveConcept(current,data)},function(){layer.msg("查询没有对应信息")})}function switchSensitiveConceptSearchType(request,value){return"sensitiveConceptKey"==$("#searchType").val()?request.sensitiveConceptKey=$scope.vm.percent+value+$scope.vm.percent:"sensitiveConceptTerm"==$("#searchType").val()&&(request.sensitiveConceptTerm=$scope.vm.percent+value+$scope.vm.percent),request}function addSensitive(){ngDialog.openConfirm({template:"/static/businessModeling/sensitive/sensitiveConceptManageDialog.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){if(1===e){if(0==lengthCheck($scope.vm.key,0,50))return $("#keyAddError").html($scope.vm.keyNullOrBeyondLimit),!1;httpRequestPost("/api/ms/modeling/concept/sensitive/repeatCheck",{sensitiveConceptApplicationId:$scope.vm.applicationId,sensitiveConceptKey:$scope.vm.key},function(data){10002===data.status?layer.confirm("您添加的概念类已经在，是否前往编辑？",{btn:["前往","取消"],shade:!1},function(index){layer.close(index),httpRequestPost("/api/ms/modeling/concept/sensitive/listByAttribute",{sensitiveConceptApplicationId:$scope.vm.applicationId,sensitiveConceptKey:$scope.vm.key,index:0,pageSize:1},function(data){$scope.vm.dialogTitle="编辑敏感概念",addSensitiveConceptDialog(singleEditSensitiveConcept,data.data[0]),$scope.vm.key=data.data[0].sensitiveConceptKey,$scope.vm.term=data.data[0].sensitiveConceptTerm},function(){})},function(){}):($scope.vm.dialogTitle="增加敏感概念",$scope.vm.term="",addSensitiveConceptDialog(singleAddSensitiveConcept))},function(){})}else $scope.vm.key="",$scope.vm.term=""}})&&$timeout(function(){termSpliterTagEditor(),$("#sensitiveKey").blur(function(){0==lengthCheck($("#sensitiveKey").val(),0,50)?$("#keyAddError").html($scope.vm.keyNullOrBeyondLimit):$("#keyAddError").html("")})},100)}function addSensitiveConceptDialog(callback,item){ngDialog.openConfirm({template:"/static/businessModeling/sensitive/sensitiveConceptManageDialog2.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){if(1===e){if(0==lengthCheck($scope.vm.key,0,50))return $("#keyAddError").html($scope.vm.keyNullOrBeyondLimit),!1;var obj=$("#term").next(),term="";if(obj.find("li").length<=0)return $("#termAddError").html($scope.vm.termNullOrBeyondLimit),!1;if($("#termAddError").html(""),$.each(obj.find("li"),function(index,value){index>0&&$.each($(value).find("div"),function(index1,value1){1==index1&&(term+=$(value1).html()+$scope.vm.termSpliter)})}),term=term.substring(0,term.length-1),$scope.vm.term=term,0==lengthCheck(term,0,500))return $("#termAddError").html($scope.vm.termNullOrBeyondLimit),!1;$("#termAddError").html(""),callback(item)}else $scope.vm.key="",$scope.vm.term=""}})&&$timeout(function(){termSpliterTagEditor(),$("#sensitiveKeyTwo").blur(function(){0==lengthCheck($("#sensitiveKeyTwo").val(),0,50)?$("#keyAddError").html($scope.vm.keyNullOrBeyondLimit):$("#keyAddError").html("")})},100)}function deleteSensitive(id){0==angular.element(".ngdialog ").length&&ngDialog.openConfirm({template:"/static/businessModeling/conceptManageDialog.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){1===e&&singleDelSensitiveConcept(id)}})}function batchUpload(){ngDialog.openConfirm({template:"/static/businessModeling/batchUpload.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){loadSensitiveConceptTable($scope.vm.paginationConf.currentPage)}})&&$timeout(function(){initUpload("/api/ms/modeling/concept/sensitive/batchAdd?applicationId="+$scope.vm.applicationId+"&modifierId="+$scope.vm.modifier)},100)}function singleEditSensitiveConcept(item){assembleSensitiveConceptTerm(),httpRequestPost("/api/ms/modeling/concept/sensitive/update",{sensitiveConceptId:item.sensitiveConceptId,sensitiveConceptApplicationId:$scope.vm.applicationId,applicationId:$scope.vm.applicationId,sensitiveConceptKey:$scope.vm.key,sensitiveConceptModifier:$scope.vm.modifier,sensitiveConceptTerm:$scope.vm.term},function(data){1==responseView(data)&&loadSensitiveConceptTable($scope.vm.paginationConf.currentPage)})}function singleAddSensitiveConcept(){assembleSensitiveConceptTerm(),httpRequestPost("/api/ms/modeling/concept/sensitive/add",{sensitiveConceptApplicationId:$scope.vm.applicationId,applicationId:$scope.vm.applicationId,sensitiveConceptKey:$scope.vm.key,sensitiveConceptModifier:$scope.vm.modifier,sensitiveConceptTerm:$scope.vm.term},function(data){1==responseView(data)&&loadSensitiveConceptTable($scope.vm.paginationConf.currentPage)})}function singleDelSensitiveConcept(id){httpRequestPost("/api/ms/modeling/concept/sensitive/delete",{sensitiveConceptId:id},function(data){1==responseView(data)&&loadSensitiveConceptTable($scope.vm.paginationConf.currentPage)})}function termSpliterTagEditor(){var term=$scope.vm.term;if(""==term)$("#term").tagEditor({forceLowercase:!1});else{var terms=term.split($scope.vm.termSpliter);$("#term").tagEditor({initialTags:terms,autocomplete:{delay:0,position:{collision:"flip"},source:terms},forceLowercase:!1})}}function assembleSensitiveConceptTerm(){var obj=$("#term").next(),term="";$.each(obj.find("li"),function(index,value){index>0&&$.each($(value).find("div"),function(index1,value1){1==index1&&(term+=$(value1).html()+$scope.vm.termSpliter)})}),term=term.substring(0,term.length-1),$scope.vm.term=term}function responseView(data){return $scope.vm.key="",$scope.vm.term="",clearSelectAll(),null!=data&&(layer.msg(data.info),data.status==$scope.vm.success)}function downloadTemplate(){downloadFile("/api/ms/knowledgeManage/downloadKnowledgeTemplate","","concept_template.xlsx")}function exportAll(){httpRequestPost("/api/ms/modeling/concept/sensitive/export",{sensitiveConceptApplicationId:$scope.vm.applicationId},function(data){if(1==responseView(data))for(var i=0;i<data.exportFileNameList.length;i++)downloadFile("/api/ms/modeling/downloadWithPath",data.filePath,data.exportFileNameList[0])})}$scope.vm={success:1e4,illegal:10003,failed:10004,empty:10005,applicationId:$cookieStore.get("applicationId"),addSensitive:addSensitive,editSensitive:editSensitive,deleteSensitive:deleteSensitive,listData:"",singleDelSensitiveConcept:singleDelSensitiveConcept,singleAddSensitiveConcept:singleAddSensitiveConcept,paginationConf:"",pageSize:5,searchSensitiveConcept:searchSensitiveConcept,searchVal:"",searchType:"sensitiveConceptKey",timeStart:"",timeEnd:"",key:"",modifier:$cookieStore.get("userId"),term:"",dialogTitle:"",inputSelect:[],inputVal:"",termSpliter:"；",percent:"%",keyNullOrBeyondLimit:"概念类名不能为空或超过长度限制50",termNullOrBeyondLimit:"概念集合不能为空或超过长度限制5000",downloadTemplate:downloadTemplate,exportAll:exportAll,batchUpload:batchUpload,batchDelete:batchDelete},init();var timeout;$scope.$watch("vm.paginationConf.currentPage",function(current){current&&(timeout&&$timeout.cancel(timeout),timeout=$timeout(function(){1==nullCheck($scope.vm.searchVal)||1==nullCheck($scope.vm.timeStart)&&1==nullCheck($scope.vm.timeEnd)?searchSensitiveConcept(current):loadSensitiveConceptTable(current)},100))},!0),$("#selectAll").on("click",function(){var ids=document.getElementsByName("sid"),flag=!1;this.checked&&(flag=!0),$.each(ids,function(index,value){flag?($(value).attr("checked",!0),$(value).prop("checked",!0)):($(value).attr("checked",!1),$(value).prop("checked",!1))})})}]),angular.module("businessModelingModule").controller("sentimentConceptManageController",["$scope","localStorageService","$state","ngDialog","$timeout","$cookieStore",function($scope,localStorageService,$state,ngDialog,$timeout,$cookieStore){function init(){$scope.vm.paginationConf={currentPage:1,totalItems:0,pageSize:0,pagesLength:8}}function loadSentimentConceptTable(current){httpRequestPost("/api/ms/modeling/concept/poc/sentiment/listByAttribute",{sentimentConceptApplicationId:$scope.vm.applicationId,index:(current-1)*$scope.vm.pageSize,pageSize:$scope.vm.pageSize},function(data){loadSentimentConcept(current,data)},function(){})}function loadSentimentConcept(current,data){clearSelectAll(),$scope.vm.listData=data.data,$scope.vm.paginationConf={currentPage:current,totalItems:data.total,pageSize:$scope.vm.pageSize,pagesLength:8},$scope.$apply()}function editSentiment(item){$scope.vm.dialogTitle="编辑情感概念",$scope.vm.key=item.sentimentConceptKey,$scope.vm.classify=item.sentimentConceptClassify,addSentimentConceptDialog(singleEditSentimentConcept,item)}function searchSentimentConcept(current){"sentimentConceptModifier"==$scope.vm.searchType?searchSentimentConceptByUser(current):searchSentimentConceptByType(current)}function searchSentimentConceptByUser(current){httpRequestPost("/api/ms/modeling/concept/poc/sentiment/listByModifier",{sentimentConceptModifier:$scope.vm.searchVal,sentimentConceptApplicationId:$scope.vm.applicationId,index:(current-1)*$scope.vm.pageSize,pageSize:$scope.vm.pageSize},function(data){loadSentimentConcept(current,data)},function(){layer.msg("查询没有对应信息")})}function searchSentimentConceptByType(current){var request=new Object;if(request.sentimentConceptApplicationId=$scope.vm.applicationId,request.index=(current-1)*$scope.vm.pageSize,request.pageSize=$scope.vm.pageSize,"sentimentConceptModifyTime"!=$scope.vm.searchType)request=switchSentimentConceptSearchType(request,$scope.vm.searchVal);else{if(1!=nullCheck($scope.vm.timeStart)||1!=nullCheck($scope.vm.timeEnd))return void layer.msg("请选择时间段");request.startTimeRequest=$scope.vm.timeStart,request.endTimeRequest=$scope.vm.timeEnd}httpRequestPost("/api/ms/modeling/concept/poc/sentiment/listByAttribute",request,function(data){loadSentimentConcept(current,data)},function(){layer.msg("查询没有对应信息")})}function switchSentimentConceptSearchType(request,value){return"sentimentConceptKey"==$("#searchType").val()?request.sentimentConceptKey=$scope.vm.percent+value+$scope.vm.percent:"sentimentConceptClassify"==$("#searchType").val()?request.sentimentConceptClassify=$("#sentimentConceptClassify").val():"sentimentConceptStrength"==$("#searchType").val()?request.sentimentConceptStrength=value:"sentimentConceptPolar"==$("#searchType").val()&&(request.sentimentConceptPolar=value),request}function addSentiment(){ngDialog.openConfirm({template:"/static/businessModeling/sentiment/sentimentConceptManageDialog.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){if(1===e){if(0==lengthCheck($scope.vm.key,0,50))return $("#keyAddError").html($scope.vm.keyNullOrBeyondLimit),!1;httpRequestPost("/api/ms/modeling/concept/poc/sentiment/repeatCheck",{sentimentConceptApplicationId:$scope.vm.applicationId,sentimentConceptKey:$scope.vm.key},function(data){10002===data.status?layer.confirm("您添加的概念类已经在，是否前往编辑？",{btn:["前往","取消"],shade:!1},function(index){layer.close(index),httpRequestPost("/api/ms/modeling/concept/poc/sentiment/listByAttribute",{sentimentConceptApplicationId:$scope.vm.applicationId,sentimentConceptKey:$scope.vm.key,index:0,pageSize:1},function(data){$scope.vm.dialogTitle="编辑情感概念",addSentimentConceptDialog(singleEditSentimentConcept,data.data[0]),$scope.vm.key=data.data[0].sentimentConceptKey,$scope.vm.classify=data.data[0].sentimentConceptClassify,$scope.vm.strength=data.data[0].sentimentConceptStrength,$scope.vm.polar=data.data[0].sentimentConceptPolar},function(){})},function(){}):($scope.vm.dialogTitle="增加情感概念",$scope.vm.classify="",addSentimentConceptDialog(singleAddSentimentConcept))},function(){})}else $scope.vm.key="",$scope.vm.classify=490,$scope.vm.strength=5,$scope.vm.polar=0}})&&$timeout(function(){$("#sentimentKey").blur(function(){0==lengthCheck($("#sentimentKey").val(),0,50)?$("#keyAddError").html($scope.vm.keyNullOrBeyondLimit):$("#keyAddError").html("")})},100)}function addSentimentConceptDialog(callback,item){ngDialog.openConfirm({template:"/static/businessModeling/sentiment/sentimentConceptManageDialog2.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){if(1===e){if(0==lengthCheck($scope.vm.key,0,50))return $("#keyAddError").html($scope.vm.keyNullOrBeyondLimit),!1;callback(item)}$scope.vm.key="",$scope.vm.classify=490,$scope.vm.strength=5,$scope.vm.polar=0}})&&$timeout(function(){$("#sentimentKeyTwo").blur(function(){0==lengthCheck($("#sentimentKeyTwo").val(),0,50)?$("#keyAddError").html($scope.vm.keyNullOrBeyondLimit):$("#keyAddError").html("")})},100)}function deleteSentiment(id){ngDialog.openConfirm({template:"/static/businessModeling/conceptManageDialog.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){1===e&&singleDelSentimentConcept(id)}})}function singleEditSentimentConcept(item){httpRequestPost("/api/ms/modeling/concept/poc/sentiment/update",{sentimentConceptId:item.sentimentConceptId,sentimentConceptApplicationId:$scope.vm.applicationId,applicationId:$scope.vm.applicationId,sentimentConceptKey:$scope.vm.key,sentimentConceptModifier:$scope.vm.modifier,sentimentConceptClassify:$scope.vm.classify,sentimentConceptStrength:$scope.vm.strength,sentimentConceptPolar:$scope.vm.polar},function(data){1==responseView(data)&&loadSentimentConceptTable($scope.vm.paginationConf.currentPage)})}function singleAddSentimentConcept(){httpRequestPost("/api/ms/modeling/concept/poc/sentiment/add",{sentimentConceptApplicationId:$scope.vm.applicationId,applicationId:$scope.vm.applicationId,sentimentConceptKey:$scope.vm.key,sentimentConceptModifier:$scope.vm.modifier,sentimentConceptClassify:$scope.vm.classify,sentimentConceptStrength:$scope.vm.strength,sentimentConceptPolar:$scope.vm.polar},function(data){1==responseView(data)&&loadSentimentConceptTable($scope.vm.paginationConf.currentPage)})}function singleDelSentimentConcept(id){httpRequestPost("/api/ms/modeling/concept/poc/sentiment/delete",{sentimentConceptId:id},function(data){1==responseView(data)&&loadSentimentConceptTable($scope.vm.paginationConf.currentPage)})}function responseView(data){return null!=data&&(layer.msg(data.info),data.status==$scope.vm.success)}function exportAll(){httpRequestPost("/api/ms/modeling/concept/poc/sentiment/export",{sentimentConceptApplicationId:$scope.vm.applicationId},function(data){if(1==responseView(data))for(var i=0;i<data.exportFileNameList.length;i++)downloadFile("/api/ms/modeling/downloadWithPath",data.filePath,data.exportFileNameList[0])})}function batchUpload(){ngDialog.openConfirm({template:"/static/businessModeling/batchUpload.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){loadSentimentConceptTable($scope.vm.paginationConf.currentPage)}})&&$timeout(function(){initUpload("/api/ms/modeling/concept/poc/sentiment/batchAdd?applicationId="+$scope.vm.applicationId+"&modifierId="+$scope.vm.modifier)},100)}function downloadTemplate(){downloadFile("/api/ms/knowledgeManage/downloadKnowledgeTemplate","","sentiment_concept_template.xlsx")}function clearSelectAll(){$("#selectAll").attr("checked",!1),$("#selectAll").prop("checked",!1)}function batchDelete(){for(var ids=document.getElementsByName("sid"),id_array=[],i=0;i<ids.length;i++)ids[i].checked&&id_array.push(ids[i].value);if(0==id_array.length)return void layer.msg("请选择要删除的记录！",{time:1e3});layer.confirm("确认要删除吗？",function(index){layer.close(index);var request=new Object;request.ids=id_array,httpRequestPost("/api/ms/modeling/concept/poc/sentiment/batchDelete",request,function(data){1==responseView(data)&&loadSentimentConceptTable($scope.vm.paginationConf.currentPage)})})}$scope.vm={success:1e4,illegal:10003,failed:10004,empty:10005,applicationId:$cookieStore.get("applicationId"),addSentiment:addSentiment,editSentiment:editSentiment,deleteSentiment:deleteSentiment,listData:"",singleDelSentimentConcept:singleDelSentimentConcept,singleAddSentimentConcept:singleAddSentimentConcept,paginationConf:"",pageSize:5,searchSentimentConcept:searchSentimentConcept,searchVal:"",searchType:"sentimentConceptKey",timeStart:"",timeEnd:"",key:"",modifier:$cookieStore.get("userId"),dialogTitle:"",inputSelect:[],inputVal:"",termSpliter:"；",percent:"%",keyNullOrBeyondLimit:"概念类名不能为空或超过长度限制50",termNullOrBeyondLimit:"概念集合不能为空或超过长度限制5000",classify:490,strength:5,polar:0,batchUpload:batchUpload,exportAll:exportAll,batchDelete:batchDelete,downloadTemplate:downloadTemplate},init();var timeout;$scope.$watch("vm.paginationConf.currentPage",function(current){current&&(timeout&&$timeout.cancel(timeout),timeout=$timeout(function(){1==nullCheck($("#sentimentConceptClassify").val())||1==nullCheck($scope.vm.searchVal)||1==nullCheck($scope.vm.timeStart)&&1==nullCheck($scope.vm.timeEnd)?searchSentimentConcept(current):loadSentimentConceptTable(current)},100))},!0),$("#selectAll").on("click",function(){var ids=document.getElementsByName("sid"),flag=!1;this.checked&&(flag=!0),$.each(ids,function(index,value){flag?($(value).attr("checked",!0),$(value).prop("checked",!0)):($(value).attr("checked",!1),$(value).prop("checked",!1))})})}]),angular.module("businessModelingModule").controller("synonyConceptManageController",["$scope","localStorageService","$state","ngDialog","$timeout","$cookieStore",function($scope,localStorageService,$state,ngDialog,$timeout,$cookieStore){function init(){$scope.vm.paginationConf={currentPage:1,totalItems:0,pageSize:0,pagesLength:8}}function loadSynonymConceptTable(current){httpRequestPost("/api/ms/modeling/concept/synonym/listByAttribute",{synonymConceptApplicationId:$scope.vm.applicationId,index:(current-1)*$scope.vm.pageSize,pageSize:$scope.vm.pageSize},function(data){loadSynonymConcept(current,data)},function(){})}function loadSynonymConcept(current,data){clearSelectAll(),$scope.vm.listData=data.data,$scope.vm.paginationConf={currentPage:current,totalItems:data.total,pageSize:$scope.vm.pageSize,pagesLength:8},$scope.$apply()}function clearSelectAll(){$("#selectAll").attr("checked",!1),$("#selectAll").prop("checked",!1)}function batchDelete(){for(var ids=document.getElementsByName("sid"),id_array=[],key_array=[],i=0;i<ids.length;i++)ids[i].checked&&(id_array.push(ids[i].value),key_array.push($(ids[i]).attr("synonymkey")));if(0==id_array.length)return void layer.msg("请选择要删除的记录！");layer.confirm("确认要删除吗？",function(index){layer.close(index);var request=new Object;request.synonymConceptModifier=$scope.vm.modifier,request.synonymConceptApplicationId=$scope.vm.applicationId,request.ids=id_array,request.keyArray=key_array,httpRequestPost("/api/ms/modeling/concept/synonym/batchDelete",request,function(data){1==responseView(data)&&loadSynonymConceptTable($scope.vm.paginationConf.currentPage)})})}function editSynonym(item){$scope.vm.dialogTitle="编辑同义概念",$scope.vm.key=item.synonymConceptKey,$scope.vm.oldKey=item.synonymConceptKey,$scope.vm.term=item.synonymConceptTerm,$scope.vm.weight=item.synonymConceptWeight,addSynonymConceptDialog(singleEditSynonymConcept,item)}function searchSynonymConcept(current){"synonymConceptModifier"==$scope.vm.searchType?searchSynonymConceptByUser(current):searchSynonymConceptByType(current)}function searchSynonymConceptByUser(current){httpRequestPost("/api/ms/modeling/concept/synonym/listByModifier",{synonymConceptModifier:$scope.vm.searchVal,synonymConceptApplicationId:$scope.vm.applicationId,index:(current-1)*$scope.vm.pageSize,pageSize:$scope.vm.pageSize},function(data){loadSynonymConcept(current,data)},function(){layer.msg("查询没有对应信息")})}function searchSynonymConceptByType(current){var request=new Object;if(request.synonymConceptApplicationId=$scope.vm.applicationId,request.index=(current-1)*$scope.vm.pageSize,request.pageSize=$scope.vm.pageSize,"synonymConceptModifyTime"!=$scope.vm.searchType)request=switchSynonymConceptSearchType(request,$scope.vm.searchVal);else{if(1!=nullCheck($scope.vm.timeStart)||1!=nullCheck($scope.vm.timeEnd))return void layer.msg("请选择时间段");request.startTimeRequest=$scope.vm.timeStart,request.endTimeRequest=$scope.vm.timeEnd}httpRequestPost("/api/ms/modeling/concept/synonym/listByAttribute",request,function(data){loadSynonymConcept(current,data)},function(){layer.msg("查询没有对应信息")})}function switchSynonymConceptSearchType(request,value){return"synonymConceptKey"==$("#searchType").val()?request.synonymConceptKey=$scope.vm.percent+value+$scope.vm.percent:"synonymConceptWeight"==$("#searchType").val()?request.synonymConceptWeight=$("#synonymConceptWeight").val():"synonymConceptTerm"==$("#searchType").val()&&(request.synonymConceptTerm=$scope.vm.percent+value+$scope.vm.percent),request}function addSynonym(){ngDialog.openConfirm({template:"/static/businessModeling/synony/synonyConceptManageDialog.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){if(1===e){if(0==lengthCheck($scope.vm.key,0,50))return $("#keyAddError").html($scope.vm.keyNullOrBeyondLimit),!1;httpRequestPost("/api/ms/modeling/concept/synonym/repeatCheck",{synonymConceptApplicationId:$scope.vm.applicationId,synonymConceptKey:$scope.vm.key},function(data){10002===data.status?layer.confirm("您添加的概念类已经在，是否前往编辑？",{btn:["前往","取消"],shade:!1},function(index){layer.close(index),httpRequestPost("/api/ms/modeling/concept/synonym/listByAttribute",{synonymConceptApplicationId:$scope.vm.applicationId,synonymConceptKey:$scope.vm.key,index:0,pageSize:1},function(data){$scope.vm.dialogTitle="编辑同义概念",addSynonymConceptDialog(singleEditSynonymConcept,data.data[0]),$scope.vm.key=data.data[0].synonymConceptKey,$scope.vm.term=data.data[0].synonymConceptTerm,$scope.vm.weight=data.data[0].synonymConceptWeight},function(){})},function(){}):($scope.vm.dialogTitle="增加同义概念",$scope.vm.term="",$scope.vm.weight="33",findMining())},function(){})}else $scope.vm.key="",$scope.vm.oldKey="",$scope.vm.term="",$scope.vm.weight=33}})&&$timeout(function(){termSpliterTagEditor(),$("#synonymKey").blur(function(){0==lengthCheck($("#synonymKey").val(),0,50)?$("#keyAddError").html($scope.vm.keyNullOrBeyondLimit):$("#keyAddError").html("")})},100)}function addSynonymConceptDialog(callback,item){ngDialog.openConfirm({template:"/static/businessModeling/synony/synonyConceptManageDialog2.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){if(1===e){if(0==lengthCheck($scope.vm.key,0,50))return $("#keyAddError").html($scope.vm.keyNullOrBeyondLimit),!1;var obj=$("#term").next(),term="";if(obj.find("li").length<=0)return $("#termAddError").html($scope.vm.termNullOrBeyondLimit),!1;if($("#termAddError").html(""),$.each(obj.find("li"),function(index,value){index>0&&$.each($(value).find("div"),function(index1,value1){1==index1&&(term+=$(value1).html()+$scope.vm.termSpliter)})}),term=term.substring(0,term.length-1),$scope.vm.term=term,0==lengthCheck(term,0,500))return $("#termAddError").html($scope.vm.termNullOrBeyondLimit),!1;$("#termAddError").html(""),callback(item)}else $scope.vm.key="",$scope.vm.oldKey="",$scope.vm.term="",$scope.vm.weight=33}})&&$timeout(function(){termSpliterTagEditor(),$("#synonymKeyTwo").blur(function(){0==lengthCheck($("#synonymKeyTwo").val(),0,50)?$("#keyAddError").html($scope.vm.keyNullOrBeyondLimit):$("#keyAddError").html("")})},100)}function findMining(){httpRequestPostParam("/api/ms/modeling/concept/mining/listByConceptKey",{request:"string",question:$scope.vm.key,count:5},function(data){200==data.status?($scope.vm.term=data.data,addSynonymConceptDialog(singleAddSynonymConcept,$scope.vm.term)):addSynonymConceptDialog(singleAddSynonymConcept)})}function deleteSynonym(id){ngDialog.openConfirm({template:"/static/businessModeling/conceptManageDialog.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){1===e&&singleDelSynonymConcept(id)}})}function batchUpload(){ngDialog.openConfirm({template:"/static/businessModeling/batchUpload.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){loadSynonymConceptTable($scope.vm.paginationConf.currentPage)}})&&$timeout(function(){initUpload("/api/ms/modeling/concept/synonym/batchAdd?applicationId="+$scope.vm.applicationId+"&modifierId="+$scope.vm.modifier)},100)}function singleEditSynonymConcept(item){assembleSynonymConceptTerm(),httpRequestPost("/api/ms/modeling/concept/synonym/update",{synonymConceptId:item.synonymConceptId,synonymConceptApplicationId:$scope.vm.applicationId,applicationId:$scope.vm.applicationId,synonymConceptKey:$scope.vm.key,synonymConceptOldKey:$scope.vm.oldKey,synonymConceptModifier:$scope.vm.modifier,synonymConceptTerm:$scope.vm.term,synonymConceptWeight:$scope.vm.weight},function(data){1==responseView(data)&&loadSynonymConceptTable($scope.vm.paginationConf.currentPage)})}function singleAddSynonymConcept(){assembleSynonymConceptTerm(),httpRequestPost("/api/ms/modeling/concept/synonym/add",{synonymConceptApplicationId:$scope.vm.applicationId,applicationId:$scope.vm.applicationId,synonymConceptKey:$scope.vm.key,synonymConceptModifier:$scope.vm.modifier,synonymConceptTerm:$scope.vm.term,synonymConceptWeight:$scope.vm.weight},function(data){1==responseView(data)&&loadSynonymConceptTable($scope.vm.paginationConf.currentPage)})}function singleDelSynonymConcept(id){httpRequestPost("/api/ms/modeling/concept/synonym/delete",{synonymConceptId:id},function(data){1==responseView(data)&&loadSynonymConceptTable($scope.vm.paginationConf.currentPage)})}function termSpliterTagEditor(){var term=$scope.vm.term;if(""==term)$("#term").tagEditor({forceLowercase:!1});else if(term instanceof Array)$("#term").tagEditor({initialTags:term,autocomplete:{delay:0,position:{collision:"flip"},source:term},forceLowercase:!1});else{var terms=term.split($scope.vm.termSpliter);$("#term").tagEditor({initialTags:terms,autocomplete:{delay:0,position:{collision:"flip"},source:terms},forceLowercase:!1})}}function assembleSynonymConceptTerm(){var obj=$("#term").next(),term="";$.each(obj.find("li"),function(index,value){index>0&&$.each($(value).find("div"),function(index1,value1){1==index1&&(term+=$(value1).html()+$scope.vm.termSpliter)})}),term=term.substring(0,term.length-1),$scope.vm.term=term}function responseView(data){return $scope.vm.key="",$scope.vm.oldKey="",$scope.vm.term="",$scope.vm.weight=33,clearSelectAll(),null!=data&&(layer.msg(data.info),data.status==$scope.vm.success)}function downloadTemplate(){downloadFile("/api/ms/knowledgeManage/downloadKnowledgeTemplate","","concept_with_weight_template.xlsx")}function exportAll(){httpRequestPost("/api/ms/modeling/concept/synonym/export",{synonymConceptApplicationId:$scope.vm.applicationId},function(data){if(1==responseView(data))for(var i=0;i<data.exportFileNameList.length;i++)downloadFile("/api/ms/modeling/downloadWithPath",data.filePath,data.exportFileNameList[0])})}$scope.vm={success:1e4,illegal:10003,failed:10004,empty:10005,applicationId:$cookieStore.get("applicationId"),addSynonym:addSynonym,editSynonym:editSynonym,deleteSynonym:deleteSynonym,listData:"",singleDelSynonymConcept:singleDelSynonymConcept,singleAddSynonymConcept:singleAddSynonymConcept,paginationConf:"",pageSize:5,searchSynonymConcept:searchSynonymConcept,searchVal:"",searchType:"synonymConceptKey",timeStart:"",timeEnd:"",key:"",oldKey:"",modifier:$cookieStore.get("userId"),term:"",weight:"33",dialogTitle:"",inputSelect:[],inputVal:"",termSpliter:"；",percent:"%",keyNullOrBeyondLimit:"概念类名不能为空或超过长度限制50",termNullOrBeyondLimit:"概念集合不能为空或超过长度限制5000",downloadTemplate:downloadTemplate,exportAll:exportAll,batchUpload:batchUpload,batchDelete:batchDelete,findMining:findMining},init();var timeout;$scope.$watch("vm.paginationConf.currentPage",function(current){current&&(timeout&&$timeout.cancel(timeout),timeout=$timeout(function(){1==nullCheck($("#synonymConceptWeight").val())||1==nullCheck($scope.vm.searchVal)||1==nullCheck($scope.vm.timeStart)&&1==nullCheck($scope.vm.timeEnd)?searchSynonymConcept(current):loadSynonymConceptTable(current)},100))},!0),$("#selectAll").on("click",function(){var ids=document.getElementsByName("sid"),flag=!1;this.checked&&(flag=!0),$.each(ids,function(index,value){flag?($(value).attr("checked",!0),$(value).prop("checked",!0)):($(value).attr("checked",!1),$(value).prop("checked",!1))})})}]),angular.module("knowledge_static_web").filter("typeFilter",function(){return function(val){return 100==val?"FAQ型聊天知识":"概念型聊天知识"}}),angular.module("knowledge_static_web").filter("faqWeight",function(){return function(val){return 60==val?"普通":"否定"}}),angular.module("deepLearning").controller("acquisitionDetailsController",["$scope","$state","ngDialog","$cookieStore","$stateParams","$timeout",function($scope,$state,ngDialog,$cookieStore,$stateParams,$timeout){function editOrView(data,isEdit){$scope.vm.knowledgeId=data.knowledgeId,$scope.vm.crawlQuestion=data.crawlQuestion,$scope.vm.crawlAnswer=data.crawlAnswer,$scope.vm.knowledgeQuestion=data.knowledgeQuestion,$scope.vm.knowledgeAnswer=data.knowledgeAnswer,$scope.vm.isEdit=isEdit;ngDialog.openConfirm({template:"/static/deepLearning/acquisitionDetailsDialog.html",width:"900px",scope:$scope,closeByNavigation:!1,overlay:!0,closeByDocument:!1,closeByEscape:!0,showClose:!0,preCloseCallback:function(e){1===e&&1==isEdit&&$scope.vm.allowSubmit&&httpRequestPost("/sprider/knowledge/editByKnowledgeId",{knowledgeId:$scope.vm.knowledgeId,knowledgeQuestion:$scope.vm.knowledgeQuestion,knowledgeAnswer:$scope.vm.knowledgeAnswer},function(data){layer.msg(data.info,{time:2e3}),$state.reload()},function(){layer.msg("请求失败",{time:2e3})}),$scope.vm.knowledgeId="",$scope.vm.crawlQuestion="",$scope.vm.crawlAnswer="",$scope.vm.knowledgeQuestion="",$scope.vm.knowledgeAnswer=""}})}function verifyRelease(){return null==$scope.vm.knowledgeId||""==$scope.vm.knowledgeId?(layer.msg("知识序号为空!"),$scope.vm.allowSubmit=0,0):null==$scope.vm.knowledgeQuestion||""==$scope.vm.knowledgeQuestion?(layer.msg("处理后问题不能为空!"),$scope.vm.allowSubmit=0,0):null==$scope.vm.knowledgeAnswer||""==$scope.vm.knowledgeAnswer?(layer.msg("处理后回答不能为空!"),$scope.vm.allowSubmit=0,0):1}function napSearch(){getData(1)}function getData(index){httpRequestPost("/sprider/knowledge/getByRecordId",{index:(index-1)*$scope.vm.pageSize,pageSize:$scope.vm.pageSize,crawlRecordId:$scope.vm.crawlRecordId},function(data){if(200==data.status)return null==data.data.objs||data.data.objs.length<=0?(layer.msg("没有查询到任何数据",{time:2e3}),!1):($scope.vm.listData=data.data.objs,$scope.vm.paginationConf={currentPage:index,totalItems:data.data.total,pageSize:$scope.vm.pageSize,pagesLength:10},$scope.$apply(),!0);layer.msg(data.info,{time:2e3})},function(){layer.msg("请求失败",{time:2e3})})}function del(knowledgeId){ngDialog.openConfirm({template:"/static/admin/deleteDialog.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){1===e&&httpRequestPost("/sprider/knowledge/delByKnowledgeId",{knowledgeId:knowledgeId},function(data){layer.msg(data.info,{time:2e3}),$state.reload()},function(){layer.msg("请求失败",{time:2e3})})}})}$state.go("deepLearning.acquisitionDetails"),$scope.vm={editOrView:editOrView,del:del,napSearch:napSearch,verifyRelease:verifyRelease,crawlRecordId:$stateParams.crawlRecordId,allowSubmit:1,pageSize:10},napSearch();var timeout;$scope.$watch("vm.paginationConf.currentPage",function(current){current&&(timeout&&$timeout.cancel(timeout),timeout=$timeout(function(){getData(current)},100))},!0)}]),angular.module("deepLearning").controller("dataAcquisitionController",["$scope","localStorageService","$state","ngDialog","$stateParams","$cookieStore","$timeout",function($scope,localStorageService,$state,ngDialog,$stateParams,$cookieStore,$timeout){function clearDate(){$scope.vm.crawlStartTime="",$scope.vm.crawlEndTime="",listCrawlRecordData(1)}function listCrawlRecordData(index){httpRequestPost("/sprider/record/getCrawlRecord",{index:(index-1)*$scope.vm.pageSize,pageSize:$scope.vm.pageSize,crawlStartTime:$scope.vm.crawlStartTime,crawlEndTime:$scope.vm.crawlEndTime},function(data){$scope.vm.crawlRecordData=data.data,$scope.vm.dataTotal=data.total,$scope.vm.paginationConf={currentPage:index,totalItems:data.total,pageSize:$scope.vm.pageSize,pagesLength:8},$scope.$apply()},function(){layer.msg("请求失败")})}function exportToChat(crawlRecordId){httpRequestPost("/sprider/record/exportDataToChat",{crawlRecordId:crawlRecordId},function(data){200==data.status?layer.msg("数据导入中，请稍后查看闲聊库！"):layer.msg("数据导入失败")},function(){layer.msg("数据导入失败")})}function newTaskDialog(callback){ngDialog.openConfirm({template:"/static/deepLearning/dataAcquisitionDialog.html",width:"500px",scope:$scope,closeByNavigation:!1,overlay:!0,closeByDocument:!1,closeByEscape:!0,showClose:!0,preCloseCallback:function(e){}})}function getParams(){return{crawlSource:$scope.vm.crawlSource,crawlDate:$scope.vm.crawlDate,crawlCount:$scope.vm.crawlCount}}function checkSave(){var params=getParams();return params.crawlSource?params.crawlDate.length?!!params.crawlCount.length||(layer.msg("采集数量不能为空，请填写"),!1):(layer.msg("采集日期不能为空，请选择时间"),!1):(layer.msg("数据源不能为空，请填写"),!1)}function save(){if(!checkSave())return!1;$scope.vm.data=getParams(),httpRequestPost("/sprider/record/createCrawlRecord",getParams(),function(data){200==data.status?$state.go("deepLearning.dataAcquisition"):layer.msg("新建采集任务失败")},function(err){layer.msg("新建采集任务失败")})}$state.go("deepLearning.dataAcquisition"),$scope.vm={crawlStartTime:"",crawlEndTime:"",crawlRecordData:"",paginationConf:"",pageSize:5,dataTotal:"",listCrawlRecordData:listCrawlRecordData,clearDate:clearDate,save:save,newTask:newTaskDialog,exportToChat:exportToChat},listCrawlRecordData(1);var timeout;$scope.$watch("vm.paginationConf.currentPage",function(current){current&&(timeout&&$timeout.cancel(timeout),timeout=$timeout(function(){listCrawlRecordData(current)},100))},!0)}]),angular.module("deepLearning").controller("deepLearningConController",["$scope","$state","ngDialog","$cookieStore","$stateParams","$interval",function($scope,$state,ngDialog,$cookieStore,$stateParams,$interval){function train(){if(1!=$scope.vm.isDisabled){var cell,activation,regularization,regularizationRate,layers,neurons,learningRate,maxGradient,dropout,batchSize,request=new Object;if(request.name=$scope.vm.name,""==$scope.vm.name||null==$scope.vm.name)return void layer.msg("请选择一个模型！",{time:3e3});request.index=0,request.pageSize=5,httpRequestPost("/sprider/deeplearn/queryByName",request,function(data){if(200==data.status){for(var list=data.data.objs,i=0;i<list.length;i++)cell=list[i].name,activation=list[i].activation,regularization=list[i].regularization,regularizationRate=list[i].regularizationRate,layers=list[i].layers,neurons=list[i].neurons,learningRate=list[i].learningRate,maxGradient=list[i].maxGradient,dropout=list[i].dropout,batchSize=list[i].batchSize;var request=new Object;request.cell=cell,request.activation=activation,request.regularization=regularization,request.regularizationRate=regularizationRate,request.layers=layers,request.neurons=neurons,request.learningRate=learningRate,request.maxGradient=maxGradient,request.dropout=dropout,request.batchSize=batchSize,null==$scope.vm.samples||""==$scope.vm.samples?request.samplesPerEpoch="1024":request.samplesPerEpoch=$scope.vm.samples,null==$scope.vm.epoches||""==$scope.vm.epoches?request.epoches="10":request.epoches=$scope.vm.epoches,null==$scope.vm.checkpoint||""==$scope.vm.checkpoint?request.checkpointInterval="10":request.checkpointInterval=$scope.vm.checkpoint,httpRequestPost("/sprider/deeplearn/deeplearnTrain",request,function(data){200==data.status?1==data.data?layer.msg("已启动深度学习，请不要重复操作！",{time:3e3}):(layer.msg("启动深度学习成功！",{time:3e3}),$scope.vm.isDisabled=!0,$("#train").css("background","#eee"),$scope.vm.trainProcess()):layer.msg("启动训练失败，请联系管理员！",{time:2e3})})}else layer.msg(data.info,{time:2e3})})}}function modelName(){var request=new Object;httpRequestPost("/sprider/deeplearn/query",request,function(data){if(200==data.status)for(var list=data.data.list,i=0;i<list.length;i++){list[i].name}else layer.msg(data.info,{time:2e3})},function(){layer.msg("请求失败",{time:2e3})})}function trainTerminal(){var request=new Object;httpRequestPost("/sprider/deeplearn/deeplearnTrainTerminate",request,function(data){200==data.status?($scope.vm.isDisabled=!1,$("#train").css("background","rgb(82, 159, 246)"),layer.msg(data.info,{time:2e3}),$scope.vm.trainProcess()):layer.msg("终止请求失败",{time:2e3})})}function trainProcess(){var request=new Object;httpRequestPost("/sprider/deeplearn/deeplearnTrainProcess",request,function(data){200==data.status?($scope.vm.showProcess(data),$scope.vm.showAttenuation(data)):layer.msg(data.info,{time:2e3})})}function showProcess(data){$(".charts").each(function(i,item){var all=data.data.progressBarAll,now=100*data.data.progressBarNow,ElapsedTime=data.data.useTime;if("0"==now&&1==$scope.vm.isDisabled){$(".use_time").html(""),$(".use_time").empty();var str="<div>模型构建中，请稍等<span class='dotting'></span></div>";$(".use_time").append(str)}else $(".use_time").html(ElapsedTime);var process=parseInt(now/all);if(0==now&&0==all)var wi=0;else var wi=process;$(item).animate({width:wi+"%"},1e3,function(){$(this).children("d").html(wi+"%")});var checkPoints=data.data.checkPoints,point=checkPoints.split(","),scale=410/all,str="";$("#scale").empty();for(var i=0;i<point.length;i++){str+="<div style='left:"+point[i]*scale+"px;'><em></em><span>"+point[i]+"</span></div>"}$("#scale").append(str)})}function showAttenuation(data){dataX=data.data.x.split(","),dataDian=data.data.date.split(","),echarts.init(document.getElementById("access_echart_div2")).setOption(showCharts(dataX,dataDian))}function showCharts(dataX,dataDian){return{title:{textStyle:{color:"#75777b",fontStyle:"normal",fontWeight:"normal",fontFamily:"sans-serif",fontSize:14},text:"Training Loss"},tooltip:{trigger:"axis"},animation:!1,grid:{left:"3%",right:"10%",bottom:"3%",containLabel:!0},toolbox:{},xAxis:{name:"Epoches",type:"category",boundaryGap:!1,data:dataX},yAxis:{type:"value"},series:[{name:"",type:"line",stack:"总量",data:dataDian}]}}function isDeeplearnTrain(){var request=new Object;httpRequestPost("/sprider/deeplearn/isDeeplearnTrain",request,function(data){200==data.status?1==data.data?($scope.vm.isDisabled=!0,$("#train").css("background","#eee")):$scope.vm.isDisabled=!1:layer.msg("查询训练状态失败",{time:2e3})})}$state.go("deepLearning.deepLearningCon"),$scope.vm={showProcess:showProcess,samples:"",name:"",epoches:"",checkpoint:"",train:train,listName:"",modelName:modelName,trainTerminal:trainTerminal,trainProcess:trainProcess,showAttenuation:showAttenuation,showCharts:showCharts,isDeeplearnTrain:isDeeplearnTrain,isDisabled:"false"},$scope.vm.isDeeplearnTrain(),$scope.vm.trainProcess();var timeout_upd=$interval($scope.vm.trainProcess,5e3);$scope.$on("$destroy",function(){$interval.cancel(timeout_upd)});var dataX=[],dataDian=[],w="410px",h="15px",div=$(".bar_div"),barb=function(){div.each(function(){var width=$(this).attr("w"),barbox='<dl class="barbox" style="width:410px;"><dd class="barline" ><div w="'+width+'" class="charts" style="width:0px"><d></d></div></dd></dl>';$(this).append(barbox)})},amimeat=function(){$(".charts").each(function(i,item){var wi=parseInt($(this).attr("w"));$(item).animate({width:wi+"%"},1e3,function(){$(this).children("d").html(wi+"%")})})},barbCss=function(a,b){$(".barbox").css({height:h,"line-height":h,"text-align":"center",color:"#fff"}),$(".barbox>dd").css({float:"left"}),$(".barline").css({width:w,background:b,height:h,overflow:"hidden",display:"inline",position:"relative","border-radius":"8px"}),$(".barline>d").css({position:"absolute",top:"0px"}),$(".charts").css({background:a,height:h,width:"0px",overflow:"hidden","border-radius":"8px"})};barb(),amimeat(),barbCss("#c23531","#dfdfdf"),function(){var request=new Object;request.index=0,request.pageSize=50,httpRequestPost("/sprider/deeplearn/queryByPage",request,function(data){200==data.status?$scope.$apply(function(){$scope.vm.listName=data.data.objs}):layer.msg(data.info,{time:2e3})})}()}]),angular.module("deepLearning").controller("deepLearningController",["$scope","$state","ngDialog","$cookieStore","$stateParams",function($scope,$state,ngDialog,$cookieStore,$stateParams){$scope.vm={}}]),angular.module("deepLearning").controller("deeplearnConfigController",["$scope","$state","ngDialog","$cookieStore","$stateParams","$timeout",function($scope,$state,ngDialog,$cookieStore,$stateParams,$timeout){function editOrView(data,isEdit){$scope.vm._name=data.name,$scope.vm.cell=data.cell,$scope.vm.activation=data.activation,$scope.vm.regularization=data.regularization,$scope.vm.regularizationRate=data.regularizationRate,$scope.vm.layers=data.layers,$scope.vm.neurons=data.neurons,$scope.vm.learningRate=data.learningRate,$scope.vm.maxGradient=data.maxGradient,$scope.vm.dropout=data.dropout,$scope.vm.batchSize=data.batchSize,$scope.vm.isEdit=isEdit;ngDialog.openConfirm({template:"/static/deepLearning/deeplearnConfigModify.html",width:"600px",scope:$scope,closeByNavigation:!1,overlay:!0,closeByDocument:!1,closeByEscape:!0,showClose:!0,preCloseCallback:function(e){1===e&&1==isEdit&&$scope.vm.allowSubmit&&httpRequestPost("/sprider/deeplearn/modify",getParams(),function(data){layer.msg(data.info,{time:2e3}),$state.reload()},function(){layer.msg("请求失败",{time:2e3})}),$scope.vm._name=null,$scope.vm.cell=null,$scope.vm.activation=null,$scope.vm.regularization=null,$scope.vm.regularizationRate=null,$scope.vm.layers=null,$scope.vm.neurons=null,$scope.vm.learningRate=null,$scope.vm.maxGradient=null,$scope.vm.dropout=null,$scope.vm.batchSize=null}})}function verifyRelease(){return 1}function search(){getData(1)}function getData(index){httpRequestPost("/sprider/deeplearn/queryByPage",{index:(index-1)*$scope.vm.pageSize,pageSize:$scope.vm.pageSize,name:$scope.vm.name},function(data){if(200==data.status)return null==data.data.objs||data.data.objs.length<=0?(layer.msg("没有查询到任何数据",{time:2e3}),!1):($scope.vm.listData=data.data.objs,$scope.vm.paginationConf={currentPage:index,totalItems:data.data.total,pageSize:$scope.vm.pageSize,pagesLength:10},$scope.$apply(),!0);layer.msg(data.info,{time:2e3})},function(err){layer.msg("请求失败",{time:2e3})})}function del(name){ngDialog.openConfirm({template:"/static/admin/deleteDialog.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){1===e&&httpRequestPost("/sprider/deeplearn/del",{name:name},function(data){layer.msg(data.info,{time:2e3}),$state.reload()},function(){layer.msg("请求失败",{time:2e3})})}})}function create(){ngDialog.openConfirm({template:"/static/deepLearning/deeplearnConfigDialog.html",width:"600px",scope:$scope,closeByNavigation:!1,overlay:!0,closeByDocument:!1,closeByEscape:!0,showClose:!0,preCloseCallback:function(e){1===e&&$scope.vm.allowSubmit&&($scope.vm.data=getParams(),httpRequestPost("/sprider/deeplearn/add",getParams(),function(data){layer.msg(data.info,{time:2e3}),$state.reload()},function(err){layer.msg("请求失败",{time:2e3})})),$scope.vm._name=null,$scope.vm.cell=null,$scope.vm.activation=null,$scope.vm.regularization=null,$scope.vm.regularizationRate=null,$scope.vm.layers=null,$scope.vm.neurons=null,$scope.vm.learningRate=null,$scope.vm.maxGradient=null,$scope.vm.dropout=null,$scope.vm.batchSize=null}})}function getParams(){return{name:$scope.vm._name,cell:null==$scope.vm.cell?"RNN":$scope.vm.cell,activation:null==$scope.vm.activation?"ReLu":$scope.vm.activation,regularization:null==$scope.vm.regularization?"l1":$scope.vm.regularization,regularizationRate:null==$scope.vm.regularizationRate?"0":$scope.vm.regularizationRate,layers:null==$scope.vm.layers?"2":$scope.vm.layers,neurons:null==$scope.vm.neurons?"1024":$scope.vm.neurons,learningRate:null==$scope.vm.learningRate?"0.0003":$scope.vm.learningRate,maxGradient:null==$scope.vm.maxGradient?"5.0":$scope.vm.maxGradient,dropout:null==$scope.vm.dropout?"0.5":$scope.vm.dropout,batchSize:null==$scope.vm.batchSize?"64":$scope.vm.batchSize}}$state.go("deepLearning.deeplearnConfig"),$scope.vm={editOrView:editOrView,del:del,search:search,create:create,verifyRelease:verifyRelease,crawlRecordId:$stateParams.crawlRecordId,allowSubmit:1,pageSize:10,cell:"RNN",activation:"ReLu",regularization:"l1"},search();var timeout;$scope.$watch("vm.paginationConf.currentPage",function(current){current&&(timeout&&$timeout.cancel(timeout),timeout=$timeout(function(){getData(current)},100))},!0)}]),angular.module("deepLearning").controller("similarityCalculationController",["$scope","$state","ngDialog","$cookieStore","$stateParams",function($scope,$state,ngDialog,$cookieStore,$stateParams){function getResult(){var words=$scope.vm.words;if(null==$scope.vm.top||void 0==$scope.vm.top||""==$scope.vm.top)var top="10";else var top=$scope.vm.top;var request=new Object;request.words=words,request.top=top,httpRequestPost("/sprider/deeplearn/similarityWords",request,function(data){200==data.status?""==data.data?layer.msg("没有Similar Words",{time:2e3}):$scope.$apply(function(){$scope.vm.result=data.data}):layer.msg("请求失败，请重试或联系管理员！",{time:2e3})})}function similarityCalculation(){var algorithm=$scope.vm.algorithm,embedding=$scope.vm.embedding,sentence1=$scope.vm.sentence1,sentence2=$scope.vm.sentence2,request=new Object;request.algorithm=algorithm,request.embedding=embedding,request.sentence1=sentence1,request.sentence2=sentence2,httpRequestPost("/sprider/deeplearn/similarityCalculation",request,function(data){200==data.status?"4"!=algorithm?showTable(data):showLines(data):layer.msg("请求失败，请重试或联系管理员！",{time:2e3})})}function showLines(data){$("#tableWords").html("");var score="";score+="<em class='bold'>Score: </em><em>"+data.data.score+"</em>",$("#score").empty(),$("#score").append(score);var xWords=data.data.wordHorizontal,yWords=data.data.wordVertical,xWord=xWords.split(","),str="<tr>";str+="<td>Matched Item(Q)</td>",str+="<td style='text-align: left'>";for(var i=0;i<xWord.length;i++)str+=i%2==0?"<span class='p5'>"+xWord[i]+"</span>":"<span style='color:#CD2626' class='p5'>"+xWord[i]+"</span>",str+=" ";str+="</td>",str+="</tr>",str+="<tr>";var yWord=yWords.split(",");str+="<td>Matched Item(A)</td>",str+="<td style='text-align: left'>";for(var i=0;i<yWord.length;i++)str+=i%2==0?"<span class='p5'>"+yWord[i]+"</span>":"<span style='color:#CD2626' class='p5'>"+yWord[i]+"</span>",str+=" ";str+="</td>",str+="</tr>";var xxWords=data.data.wordsXX,yyWords=data.data.wordsYY,xxWordsSplit=xxWords.split(",");str+="<tr>",str+="<td>Unmatched Item(A)</td>",str+="<td style='text-align: left'>";for(var i=0;i<xxWordsSplit.length;i++)str+=i%2==0?"<span class='p5'>"+xxWordsSplit[i]+"</span>":"<span style='color:#CD2626' class='p5'>"+xxWordsSplit[i]+"</span>",str+=" ";str+="</td>",str+="</tr>";var yyWordsSplit=yyWords.split(",");str+="<tr>",str+="<td>Unmatched Item(Q)</td>",str+="<td style='text-align: left'>";for(var i=0;i<yyWordsSplit.length;i++)str+=i%2==0?"<span class='p5'>"+yyWordsSplit[i]+"</span>":"<span style='color:#CD2626' class='p5'>"+yyWordsSplit[i]+"</span>",str+=" ";str+="</td>",str+="</tr>",$("#tableWords").append(str)}function showTable(data){$("#tableWords").html("");var score="";score+="<em class='bold'>Score: </em><em>"+data.data.score+"</em>",$("#score").empty(),$("#score").append(score);var xWords=data.data.wordVertical,yWords=data.data.wordHorizontal,xWord=xWords.split(","),str="<tr>";str+="<td> </td>";for(var i=0;i<xWord.length;i++)str+="<td>"+xWord[i]+"</td>";str+="</tr>";for(var nums=data.data.boxValue,mnums=[],ii=0;ii<nums.length;ii++)for(var num=nums[ii].split(","),jj=0;jj<num.length;jj++)num[jj]<0&&(num[jj]=Math.ceil(num[jj])),mnums.push(num[jj]);for(var max=Math.max.apply(null,mnums),yWord=yWords.split(","),i=0;i<yWord.length;i++){var boxs=data.data.boxValue[i],box=boxs.split(",");str+="<tr>",str+="<td>"+yWord[i]+"</td>";for(var m=0;m<box.length;m++){var fac=Math.round(255-box[m]*Math.floor(255/max));str+="<td class='numdis' style='background-color:rgb("+fac+","+fac+","+fac+")'></td>"}str+="</tr>"}$("#tableWords").append(str)}function change(){var temp=$scope.vm.sentence1;$scope.vm.sentence1=$scope.vm.sentence2,$scope.vm.sentence2=temp}$state.go("deepLearning.similarityCalculation"),$scope.vm={similarityCalculation:similarityCalculation,getResult:getResult,change:change,algorithm:"1",embedding:"1",sentence1:"",sentence2:"",words:"",top:"",result:""}}]),angular.module("functionalTestModule").controller("batchTestController",["$scope","localStorageService","$state","$timeout","$stateParams","ngDialog","$cookieStore","knowledgeAddServer",function($scope,localStorageService,$state,$timeout,$stateParams,ngDialog,$cookieStore,knowledgeAddServer){function getService(){httpRequestPost("/api/application/service/listServiceByApplicationId",{applicationId:APPLICATION_ID},function(data){1e4==data.status?($scope.vm.listService=data.data,$scope.vm.serviceId=data.data[0].serviceId,$scope.$apply()):data.status},function(){})}function searchFile(index){httpRequestPost("/api/application/batchTest/findByValue",{index:(index-1)*$scope.vm.pageSize,pageSize:$scope.vm.pageSize,applicationId:APPLICATION_ID,batchStatusId:$scope.vm.searchType,batchName:$scope.vm.selectInput,channel:$scope.vm.selectInput,batchOperator:$scope.vm.selectInput},function(data){10005==data.status?(layer.msg("查询到记录为空",{time:1e3}),$scope.vm.listData="",$scope.vm.listDataTotal=0,$scope.vm.paginationConf={currentPage:index,totalItems:0,pageSize:0,pagesLength:8}):($scope.vm.listData=data.data.batchTestList,$scope.vm.listDataTotal=data.data.total,$scope.vm.paginationConf={currentPage:index,totalItems:data.data.total,pageSize:$scope.vm.pageSize,pagesLength:8}),$scope.$apply()},function(){})}function jumpD(url,id){$state.go(url,{batchNumberId:id})}function uploadQuestion(callback){}function deleteQuestion(callback){if(0==$scope.vm.deleteIds.length)return void layer.msg("请选择要删除的文件！",{time:1e3});ngDialog.openConfirm({template:"/static/functionalTesting/batchTestDialog.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){1===e&&httpRequestPost("/api/application/batchTest/batchDeleteByIds",{applicationId:APPLICATION_ID,ids:$scope.vm.deleteIds},function(data){10013==data.status?(initBatchTest(),$state.reload(),layer.msg("删除成功",{time:1e3})):layer.msg("删除失败")},function(){})}})}function startUp(id){if($scope.vm.serviceId){$scope.vm.batchNumberId=id;ngDialog.openConfirm({template:"/static/functionalTesting/startUpDialog.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){$scope.vm.channel=""}})}else layer.msg("当前应用下没有发布服务，请发布服务后进行测试")}function start(){var id=$scope.vm.batchNumberId,channelId=angular.copy($scope.vm.channel);if($scope.vm.channel){var name;angular.forEach($scope.vm.channelList,function(item){if(item.channelCode==$scope.vm.channel)return name=item.channelName}),httpRequestPost("/api/application/batchTest/getChannelAndUserName",{batchNumberId:id,userId:$scope.vm.userId,channelName:name,channel:channelId,applicationId:APPLICATION_ID,serviceId:$scope.vm.serviceId},function(data){20002==data.status&&layer.msg(data.data,{time:1e3}),10018==data.status&&(searchFile($scope.vm.paginationConf.currentPage),startTest(id,name,channelId))},function(){},"","",6e4),ngDialog.closeAll()}else layer.msg("选择渠道")}function stopTest(id){httpRequestPost("/api/application/batchTest/startTest",{batchNumberId:id,batchStatusId:21007},function(data){(data.status=1e4)&&searchFile($scope.vm.paginationConf.currentPage)})}function startTest(id,name,channelId){httpRequestPost("/api/application/batchTest/startTest",{batchNumberId:id,userId:$scope.vm.userId,channelName:name,channel:channelId,applicationId:APPLICATION_ID,serviceId:$scope.vm.serviceId},function(data){(data.status=1e4)&&searchFile($scope.vm.paginationConf.currentPage)},function(){},"","",36e5)}function selectAll(){$scope.vm.selectAllCheck?($scope.vm.selectAllCheck=!1,$scope.vm.deleteIds=[]):($scope.vm.selectAllCheck=!0,$scope.vm.deleteIds=[],angular.forEach($scope.vm.listData,function(item){$scope.vm.deleteIds.push(item.batchNumberId)}))}function selectSingle(id){$scope.vm.deleteIds.inArray(id)?($scope.vm.deleteIds.remove(id),$scope.vm.selectAllCheck=!1):$scope.vm.deleteIds.push(id),$scope.vm.deleteIds.length==$scope.vm.listData.length&&($scope.vm.selectAllCheck=!0)}function initBatchTest(){$scope.vm.deleteIds=[],$scope.vm.selectAllCheck=!1}$scope.vm={applicationId:$cookieStore.get("applicationId"),userId:$cookieStore.get("userId"),deleteQuestion:deleteQuestion,uploadQuestion:uploadQuestion,startUp:startUp,start:start,stopTest:stopTest,batchNumberId:"",jumpD:jumpD,pageSize:5,listData:[],listDataTotal:0,paginationConf:"",selectAllCheck:!1,selectAll:selectAll,selectSingle:selectSingle,deleteIds:[],searchFile:searchFile,searchType:0,selectInput:"",upload:!1,listService:[],serviceId:"",channel:"",channelList:[],getService:getService},knowledgeAddServer.getChannels({applicationId:APPLICATION_ID},function(data){data.data&&($scope.vm.channelList=data.data)},function(error){}),getService(),searchFile(1);var timeout;$scope.$watch("vm.paginationConf.currentPage",function(current){current&&(timeout&&$timeout.cancel(timeout),timeout=$timeout(function(){initBatchTest(),searchFile(current)},100))},!0)}]),angular.module("functionalTestModule").controller("functionalTestController",["$scope","localStorageService","$state","$timeout","$stateParams","ngDialog",function($scope,localStorageService,$state,$timeout,$stateParams,ngDialog){$scope.vm={}}]),angular.module("functionalTestModule").controller("participleResultController",["$scope","localStorageService","$state","$timeout","$stateParams","ngDialog","$cookieStore","knowledgeAddServer",function($scope,localStorageService,$state,$timeout,$stateParams,ngDialog,$cookieStore,knowledgeAddServer){$scope.vm={pageSize:5,paginationConf:"",paginationConf1:"",applicationId:$cookieStore.get("applicationId"),userId:$cookieStore.get("userId"),batchNumberId:$stateParams.batchNumberId};var timeout;$scope.$watch("vm.paginationConf.currentPage",function(current){current&&(timeout&&$timeout.cancel(timeout),timeout=$timeout(function(){initBatchTest()},100))},!0)}]),angular.module("functionalTestModule").controller("participleController",["$scope","localStorageService","$state","$timeout","$stateParams","ngDialog","$cookieStore","knowledgeAddServer",function($scope,localStorageService,$state,$timeout,$stateParams,ngDialog,$cookieStore,knowledgeAddServer){function selectAll(){$scope.vm.selectAllCheck?($scope.vm.selectAllCheck=!1,$scope.vm.deleteIds=[]):($scope.vm.selectAllCheck=!0,$scope.vm.deleteIds=[],angular.forEach($scope.vm.listData,function(item){$scope.vm.deleteIds.push(item.batchNumberId)}))}function selectSingle(id){$scope.vm.deleteIds.inArray(id)?($scope.vm.deleteIds.remove(id),$scope.vm.selectAllCheck=!1):$scope.vm.deleteIds.push(id),$scope.vm.deleteIds.length==$scope.vm.listData.length&&($scope.vm.selectAllCheck=!0)}function initBatchTest(){$scope.vm.deleteIds=[],$scope.vm.selectAllCheck=!1}$scope.vm={applicationId:$cookieStore.get("applicationId"),userId:$cookieStore.get("userId"),pageSize:5,listData:[],listDataTotal:0,paginationConf:"",selectAllCheck:!1,selectAll:selectAll,selectSingle:selectSingle,deleteIds:[]};var timeout;$scope.$watch("vm.paginationConf.currentPage",function(current){current&&(timeout&&$timeout.cancel(timeout),timeout=$timeout(function(){initBatchTest()},100))},!0)}]),angular.module("functionalTestModule").controller("questionTestController",["$scope","localStorageService","$state","$timeout","$stateParams","ngDialog","$cookieStore",function($scope,localStorageService,$state,$timeout,$stateParams,ngDialog,$cookieStore){function check(val,matchedWordTagResults){var allLen=matchedWordTagResults.length;return angular.forEach(matchedWordTagResults,function(tag){var len=tag.tagList.length;angular.forEach(tag.tagList,function(value){value==val&&(len-=1)}),len!=tag.tagList.length&&(allLen-=1)}),allLen!=matchedWordTagResults.length}function test(){return $scope.vm.comparisonTextArray=$scope.vm.question.split("\n"),""==$scope.vm.testTitle?void layer.msg("请输入标准问法！"):""==$scope.vm.question?void layer.msg("请输入测试问法！"):""==$scope.vm.question&&""==$scope.vm.testTitle?void layer.msg("请输入标准问法和测试问法！"):void httpRequestPost("api/application/questionTest/passageway",{applicationId:$scope.vm.applicationId,title:$scope.vm.testTitle,comparisonTextArray:$scope.vm.comparisonTextArray},function(data){$scope.vm.show_tit=!0,500==data.data.status&&layer.msg(data.data.data,{time:1e3}),$scope.vm.answerRes=data.data.data,$scope.$apply()},function(){})}function emptyInput(){$scope.vm.testTitle="",$scope.vm.question="",$scope.vm.comparisonTextArray=[],$scope.vm.answerRes="",$scope.vm.show_tit=!1}$scope.vm={testTitle:"",question:"",applicationId:$cookieStore.get("applicationId"),comparisonTextArray:[],asklength:0,answerRes:"",emptyInput:emptyInput,test:test,check:check,show_tit:!1}}]),angular.module("functionalTestModule").controller("sessionTestController",["$scope","localStorageService","$state","$timeout","$stateParams","ngDialog","$cookieStore","knowledgeAddServer",function($scope,localStorageService,$state,$timeout,$stateParams,ngDialog,$cookieStore,knowledgeAddServer){function getService(){httpRequestPost("/api/application/service/listServiceByApplicationId",{applicationId:$scope.vm.applicationId},function(data){1e4==data.status?($scope.vm.listService=data.data,$scope.vm.serviceId=data.data[0].serviceId,$scope.$apply()):data.status},function(){})}function test(){if($scope.vm.serviceId){if(""==$scope.vm.testAsking)return void layer.msg("请输入测试问题!",{time:1e3});if(""==$scope.vm.channel)return void layer.msg("请选择渠道!",{time:1e3});httpRequestPost("/api/application/chatTest/passageway",{applicationId:$scope.vm.applicationId,userId:$scope.vm.userId,content:$scope.vm.testAsking,channel:$scope.vm.channel,dimensionArray:$scope.vm.dimensionArray,serviceId:$scope.vm.serviceId},function(data){500==data.data.status&&layer.msg(data.data.data,{time:1e3}),$scope.vm.result=data.data.data,$scope.vm.question=$scope.vm.testAsking,$scope.$apply()},function(){})}else layer.msg("当前应用下没有发布服务，请发布服务后进行测试",{time:1e3})}function reset(){$scope.vm.testAsking="",$scope.vm.question="",$scope.vm.result="",$scope.vm.channel=$scope.vm.channelList[0].channelCode,$scope.vm.listDimension=angular.copy($scope.vm.listDimensionUpBack),$scope.vm.dimensionArray={id:[],name:[]}}function txtFocus(){$(".chat_text_txta").focus()}$scope.vm={applicationId:$cookieStore.get("applicationId"),userId:(new Date).getTime(),title:"",testAsking:"",listService:[],channel:"",channelList:[],listDimension:[],listDimensionUpBack:"",dimensionArray:[],getService:getService,serviceId:"",test:test,reset:reset,result:"",question:"",txtFocus:txtFocus},knowledgeAddServer.getDimensions({applicationId:$scope.vm.applicationId},function(data){data.data&&($scope.vm.listDimension=data.data,$scope.vm.listDimensionUpBack={id:[],name:[]},angular.forEach(data.data,function(item){$scope.vm.listDimensionUpBack.id.push(item.dimensionId),$scope.vm.listDimensionUpBack.name.push(item.dimensionName)}))},function(error){}),knowledgeAddServer.getChannels({applicationId:$scope.vm.applicationId},function(data){data.data&&($scope.vm.channelList=data.data,$scope.vm.channel=data.data[0].channelCode)},function(error){}),getService(),txtFocus()}]),angular.module("functionalTestModule").controller("testResultController",["$scope","localStorageService","$state","$timeout","$stateParams","ngDialog","$cookieStore","knowledgeAddServer",function($scope,localStorageService,$state,$timeout,$stateParams,ngDialog,$cookieStore,knowledgeAddServer){function exportEasy(){httpRequestPost("/api/application/testResult/exportEasy",{batchNumberId:$stateParams.batchNumberId},function(data){500==data.status||window.open("/api/application/detail/downloadExcel?fileName="+data.data)},function(err){})}function showData(index){httpRequestPost("/api/application/testResult/listBatchFileByPage",{index:(index-1)*$scope.vm.pageSize,pageSize:$scope.vm.pageSize,batchNumberId:$scope.vm.batchNumberId},function(data){if(10005==data.status)return void layer.msg("查询到记录为空",{time:1e3});$scope.vm.listData=data.data.testResultList,$scope.vm.listDataTotal=data.data.total,$scope.vm.paginationConf={currentPage:index,totalItems:data.data.total,pageSize:$scope.vm.pageSize,pagesLength:8},$scope.vm.paginationConf1="",$scope.$apply()},function(){})}function verifyRelease(){if(null==$scope.vm.editTitle||""==$scope.vm.editTitle)return layer.msg("测试问法不能为空",{time:1e3}),$scope.vm.allowSubmit=0,0;if(null==$scope.vm.editKnow||""==$scope.vm.editKnow)return layer.msg("知识标题不能为空",{time:1e3}),$scope.vm.allowSubmit=0,0;if($scope.vm.editTitle.length>50)return layer.msg("测试问法长度不能超过50个字符",{time:1e3}),$scope.vm.allowSubmit=0,0;if($scope.vm.editKnow.length>50)return layer.msg("知识标题长度不能超过50个字符",{time:1e3}),$scope.vm.allowSubmit=0,0;var b=/^[\w+\u4e00-\u9fa5]+$/;return b.test($scope.vm.editTitle)?b.test($scope.vm.editKnow)?1:(layer.msg("知识标题不能包含特殊字符!",{time:1e3}),0):(layer.msg("测试问法不能包含特殊字符!",{time:1e3}),0)}function editQuestion(params){$scope.vm.editTitle=params.possibleKnowledge,$scope.vm.editKnow=params.knowledgeTitle,$scope.vm.editChannel=params.channel;ngDialog.openConfirm({template:"/static/functionalTesting/testResultDialog.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){if(1===e&&$scope.vm.allowSubmit){var channelName;angular.forEach($scope.vm.channelList,function(item){item.channelCode==$scope.vm.editChannel&&(channelName=item.channelName)}),httpRequestPost("/api/application/testResult/updateKnowledge",{possibleKnowledge:$scope.vm.editTitle,knowledgeTitle:$scope.vm.editKnow,channel:$scope.vm.editChannel,testResultId:params.testResultId,batchNumberId:$scope.vm.batchNumberId,channelName:channelName},function(data){10002==data.status?layer.msg("该测试问法已经存在，请重新添加!",{time:1e3}):1e4==data.status?(layer.msg("修改成功",{time:1e3}),showData($scope.vm.paginationConf.currentPage)):data.status,$scope.$apply()},function(){})}}})}function searchFile(index){$scope.vm.paginationConf.totalItems=0,httpRequestPost("/api/application/testResult/searchKnowledge",{index:(index-1)*$scope.vm.pageSize,pageSize:$scope.vm.pageSize,applicationId:$scope.vm.applicationId,batchNumberId:$scope.vm.batchNumberId,answerType:$scope.vm.matchCondition,answerCondition:$scope.vm.answerCondition,possibleKnowledge:$scope.vm.selectInput,knowledgeTitle:$scope.vm.selectInput},function(data){10014==data.status?($scope.vm.listData=data.data.testResultList,$scope.vm.listDataTotal=data.data.total,$scope.vm.paginationConf1={currentPage:index,totalItems:data.data.total,pageSize:$scope.vm.pageSize,pagesLength:8}):10005==data.status&&($scope.vm.listData="",$scope.vm.listDataTotal=0,layer.msg("没有查询到记录!",{time:1e3}),$scope.vm.paginationConf1={currentPage:index,totalItems:0,pageSize:$scope.vm.pageSize,pagesLength:8}),$scope.$apply()},function(){})}function exportExcel(){httpRequestPost("/api/application/testResult/export",{batchNumberId:$stateParams.batchNumberId},function(data){500==data.status||window.open("/api/application/detail/downloadExcel?fileName="+data.data)},function(err){})}function selectAll(){$scope.vm.selectAllCheck?($scope.vm.selectAllCheck=!1,$scope.vm.deleteIds=[]):($scope.vm.selectAllCheck=!0,$scope.vm.deleteIds=[],angular.forEach($scope.vm.listData,function(item){$scope.vm.deleteIds.push(item.testResultId)}))}function selectSingle(id){$scope.vm.deleteIds.inArray(id)?($scope.vm.deleteIds.remove(id),$scope.vm.selectAllCheck=!1):$scope.vm.deleteIds.push(id),$scope.vm.deleteIds.length==$scope.vm.listData.length&&($scope.vm.selectAllCheck=!0)}function batchTest(){$scope.vm.serviceId?httpRequestPost("/api/application/testResult/batchTest",{applicationId:$scope.vm.applicationId,userId:$scope.vm.userId,ids:$scope.vm.deleteIds,serviceId:$scope.vm.serviceId,batchNumberId:$scope.vm.batchNumberId},function(data){20009==data.status&&($scope.vm.selectAllCheck=!1,$state.reload(),layer.msg("测试成功",{time:1e3}))},function(){}):layer.msg("当前应用下没有发布服务，请发布服务后进行测试",{time:1e3})}function testDialog(){if(0==$scope.vm.deleteIds.length)return void layer.msg("请选择要测试的知识！",{time:1e3});ngDialog.openConfirm({template:"/static/functionalTesting/testDialog.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){1==e&&batchTest()}})}function getService(){httpRequestPost("/api/application/service/listServiceByApplicationId",{applicationId:$scope.vm.applicationId},function(data){1e4==data.status?($scope.vm.listService=data.data,$scope.vm.serviceId=data.data[0].serviceId,$scope.$apply()):data.status},function(){})}$scope.vm={editQuestion:editQuestion,pageSize:5,paginationConf:"",paginationConf1:"",applicationId:$cookieStore.get("applicationId"),userId:$cookieStore.get("userId"),batchNumberId:$stateParams.batchNumberId,showData:showData,listData:[],listDataTotal:0,searchFile:searchFile,selectInput:"",matchCondition:"0",answerCondition:"0",selectAllCheck:!1,selectAll:selectAll,selectSingle:selectSingle,batchTest:batchTest,deleteIds:[],testDialog:testDialog,listService:[],serviceId:"",getService:getService,exportExcel:exportExcel,exportEasy:exportEasy,allowSubmit:1,verifyRelease:verifyRelease,editTitle:"",editKnow:"",editChannel:"",channelList:""},knowledgeAddServer.getChannels({applicationId:$scope.vm.applicationId},function(data){data.data&&($scope.vm.channelList=data.data)},function(error){}),showData(1);var timeout;$scope.$watch("vm.paginationConf.currentPage",function(current){current&&(timeout&&$timeout.cancel(timeout),timeout=$timeout(function(){showData(current),searchFile(current)},0))},!0);var timeout;$scope.$watch("vm.paginationConf1.currentPage",function(current){current&&(timeout&&$timeout.cancel(timeout),timeout=$timeout(function(){searchFile(current)},0))},!0),getService()}]),angular.module("functionalTestModule").controller("viewDetailsController",["$scope","localStorageService","$state","$timeout","$stateParams","ngDialog","$cookieStore",function($scope,localStorageService,$state,$timeout,$stateParams,ngDialog,$cookieStore){function getData(index){httpRequestPost("/api/application/detail/getDetailList",{index:(index-1)*$scope.vm.pageSize,pageSize:$scope.vm.pageSize,applicationId:$scope.vm.applicationId,batchNumberId:$stateParams.batchNumberId},function(data){$scope.vm.listData=data.data.detailList,$scope.vm.listDataTotal=data.data.total,$scope.vm.paginationConf={currentPage:index,totalItems:data.data.total,pageSize:$scope.vm.pageSize,pagesLength:8},$scope.$apply()},function(){layer.msg("请求失败",{time:1e3})})}function verifyRelease(){if(null==$scope.vm.possibleKnowledge||""==$scope.vm.possibleKnowledge)return layer.msg("测试问法不能为空!",{time:1e3}),$scope.vm.allowSubmit=0,0;if(null==$scope.vm.knowledgeTitle||""==$scope.vm.knowledgeTitle)return layer.msg("知识标题不能为空!",{time:1e3}),$scope.vm.allowSubmit=0,0;var b=/^[\w+\u4e00-\u9fa5]+$/;return b.test($scope.vm.possibleKnowledge)?b.test($scope.vm.knowledgeTitle)?$scope.vm.possibleKnowledge.length>50?(layer.msg("测试问法长度不能超过50个字符!",{time:1e3}),0):$scope.vm.knowledgeTitle.length>50?(layer.msg("知识标题长度不能超过50个字符!",{icon:2,time:1e3}),0):1:(layer.msg("知识标题不能包含特殊字符!",{time:1e3}),0):(layer.msg("测试问法不能包含特殊字符!",{time:1e3}),0)}function addKnow(){ngDialog.openConfirm({template:"/static/functionalTesting/viewDetailsDialog.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){1===e?($scope.vm.allowSubmit&&httpRequestPost("/api/application/detail/addKnowledge",{applicationId:$scope.vm.applicationId,batchNumberId:$stateParams.batchNumberId,possibleKnowledge:$scope.vm.possibleKnowledge,knowledgeTitle:$scope.vm.knowledgeTitle},function(data){$state.reload(),10012==data.status?layer.msg("该测试问法已经存在，请重新添加!",{time:1e3}):10011==data.status&&layer.msg("添加成功!",{time:1e3})},function(){}),$scope.vm.possibleKnowledge="",$scope.vm.knowledgeTitle=""):($scope.vm.possibleKnowledge="",$scope.vm.knowledgeTitle="")}})}function editKnow(data){$scope.vm.detailId=data.detailId,$scope.vm.possibleKnowledge=data.possibleKnowledge,$scope.vm.knowledgeTitle=data.knowledgeTitle;ngDialog.openConfirm({template:"/static/functionalTesting/viewDetailsEditDialog.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){1===e?$scope.vm.allowSubmit&&httpRequestPost("/api/application/detail/updateKnowledge",{possibleKnowledge:$scope.vm.possibleKnowledge,knowledgeTitle:$scope.vm.knowledgeTitle,detailId:$scope.vm.detailId,batchNumberId:$stateParams.batchNumberId},function(data){10002==data.status?layer.msg("该测试问法已经存在，请重新添加!",{time:1e3}):10018==data.status&&($state.reload(),layer.msg("修改成功!",{time:1e3}))},function(){}):($scope.vm.possibleKnowledge="",$scope.vm.knowledgeTitle="")}})}function deleteKnow(detailId){ngDialog.openConfirm({template:"/static/functionalTesting/batchTestDialog.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){1===e&&httpRequestPost("/api/application/detail/deleteById",{detailId:detailId},function(data){$state.reload(),10013==data.status?layer.msg("删除成功!",{time:1e3}):data.status},function(){})}})}function search(index){httpRequestPost("/api/application/detail/findKnowledge",{index:(index-1)*$scope.vm.pageSize,pageSize:$scope.vm.pageSize,applicationId:$scope.vm.applicationId,batchNumberId:$stateParams.batchNumberId,possibleKnowledge:$scope.vm.value,knowledgeTitle:$scope.vm.value},function(data){10005==data.status&&(layer.msg("查询到记录为空",{time:1e3}),$scope.vm.listData="",$scope.vm.listDataTotal=0,$scope.vm.paginationConf={currentPage:0,totalItems:0,pageSize:$scope.vm.pageSize,pagesLength:8},$scope.$apply()),$scope.vm.listData=data.data.detailList,$scope.vm.listDataTotal=data.data.total,$scope.vm.paginationConf={currentPage:index,totalItems:data.data.total,pageSize:$scope.vm.pageSize,pagesLength:8},$scope.$apply()},function(){})}function exportExcel(){httpRequestPost("/api/application/detail/export",{batchNumberId:$stateParams.batchNumberId},function(data){500==data.status||window.open("/api/application/detail/downloadExcel?fileName="+data.data)},function(err){})}$scope.vm={pageSize:5,batchNumberId:$stateParams.batchNumberId,applicationId:$cookieStore.get("applicationId"),userId:$cookieStore.get("userId"),listData:[],listDataTotal:0,possibleKnowledge:"",knowledgeTitle:"",value:"",allowSubmit:1,getData:getData,addKnow:addKnow,editKnow:editKnow,deleteKnow:deleteKnow,verifyRelease:verifyRelease,search:search,exportExcel:exportExcel},getData(1);var timeout;$scope.$watch("vm.paginationConf.currentPage",function(current){current&&(timeout&&$timeout.cancel(timeout),timeout=$timeout(function(){getData(current)},0))},!0)}]),knowledge_static_web.directive("batchTestOnly",["$parse","ngDialog","$cookieStore","$state","$timeout",function($parse,ngDialog,$cookieStore,$state,$timeout){return{scope:{accept:"=",server:"=",type:"=",isAuto:"=",isUpload:"=",factor:"="},template:'<div class="$container"><span  id="picker" style="">请添加文件</span></div>',link:function(scope,element,attrs){$timeout(function(){var uploader=WebUploader.create({auto:!0,swf:"/bower_components/webuploader-0.1.5/dist/Uploader.swf",formData:{userId:$cookieStore.get("userId"),applicationId:$cookieStore.get("applicationId")},server:scope.server,accept:{title:"file",extensions:"xls,xlsx",mimeTypes:"file/xls,file/xlsx"},pick:{id:"#picker",multiple:!1},resize:!1,chunked:!0,chunkRetry:10,disableGlobalDnd:!0,fileNumLimit:10,fileSizeLimit:209715200,fileSingleSizeLimit:5242880});angular.element(".webuploader-pick").addClass("btn1").css({background:"#3e91e7",lineHeight:"20px"}),uploader.on("fileQueued",function(file){}),uploader.on("error",function(type){switch(type){case"Q_EXCEED_NUM_LIMIT":alert("错误：上传文件数量过多！");break;case"Q_EXCEED_SIZE_LIMIT":alert("错误：文件总大小超出限制！");break;case"F_EXCEED_SIZE":alert("错误：文件大小超出限制！");break;case"Q_TYPE_DENIED":alert("错误：禁止上传该类型文件！");break;case"F_DUPLICATE":alert("错误：请勿重复上传该文件！");break;default:alert("错误代码："+type)}}),uploader.on("uploadProgress",function(file,percentage){var $li=$("#"+file.id),$percent=$li.find(".progress .progress-bar");$percent.length||($percent=$('<div class="progress progress-striped active" style="height: 50px;background: red; width: 200px;"><div class="progress-bar" role="progressbar" style="width: 0%"></div> </div>').appendTo($li).find(".progress-bar")),$li.find("p.state").text("上传中"),$percent.css("width",100*percentage+"%")}),uploader.on("uploadError",function(file){}),uploader.on("uploadSuccess",function(file,response){500==response.status?(scope.isUpload=!1,layer.msg("模板错误")):6e4==response.status?(scope.isUpload=!1,layer.msg("文件内容错误!")):(scope.isUpload=!1,scope.factor=1,$state.reload())}),$(".framework").delegate(".removeItem","click",function(){var self=$(this);uploader.removeFile(uploader.getFile(self.attr("data-id")),!0),self.parent().remove()})},0)}}}]).directive("batchTest",["$parse","ngDialog","$cookieStore","$state","$timeout",function($parse,ngDialog,$cookieStore,$state,$timeout){return{scope:{accept:"=",server:"=",type:"=",isAuto:"=",isUpload:"=",factor:"="},template:'<div class="$container"><ul class="pick-list"></ul><div  id="picker" style="">请添加文件</div><span class=""></span></div>',link:function(scope,element,attrs){$timeout(function(){var uploader=WebUploader.create({auto:!1,swf:"/bower_components/webuploader-0.1.5/dist/Uploader.swf",formData:{userId:$cookieStore.get("userId"),applicationId:$cookieStore.get("applicationId")},server:scope.server,accept:{title:"file",extensions:"xls,xlsx",mimeTypes:"file/xls,file/xlsx"},pick:{id:"#picker",multiple:!0},resize:!1,chunked:!0,chunkRetry:10,disableGlobalDnd:!0,fileNumLimit:10,fileSizeLimit:209715200,fileSingleSizeLimit:5242880});scope.$watch("isUpload",function(isUpload){isUpload&&(uploader.upload(),ngDialog.closeAll(),scope.isUpload=!1)}),uploader.on("fileQueued",function(file){var item=$('<li class="pick-item mb-5 pl-5 pr-5"  style="line-height: 25px;background:#e8ebec;">'+file.name+'<a href="javascript:;" data-id="'+file.id+'" class="R removeItem">X</a></li>');$(".pick-list").append(item)}),uploader.on("error",function(type){switch(type){case"Q_EXCEED_NUM_LIMIT":alert("错误：上传文件数量过多！");break;case"Q_EXCEED_SIZE_LIMIT":alert("错误：文件总大小超出限制！");break;case"F_EXCEED_SIZE":alert("错误：文件大小超出限制！");break;case"Q_TYPE_DENIED":alert("错误：禁止上传该类型文件！");break;case"F_DUPLICATE":alert("错误：请勿重复上传该文件！");break;default:alert("错误代码："+type)}}),uploader.on("uploadProgress",function(file,percentage){var $li=$("#"+file.id),$percent=$li.find(".progress .progress-bar");$percent.length||($percent=$('<div class="progress progress-striped active" style="height: 50px;background: red; width: 200px;"><div class="progress-bar" role="progressbar" style="width: 0%"></div> </div>').appendTo($li).find(".progress-bar")),$li.find("p.state").text("上传中"),$percent.css("width",100*percentage+"%")}),uploader.on("uploadError",function(file){}),uploader.on("uploadSuccess",function(file,response){500==response.status?(scope.isUpload=!1,layer.msg("模板错误")):(scope.isUpload=!1,scope.factor=1,$state.reload())}),$(".framework").delegate(".removeItem","click",function(){var self=$(this);uploader.removeFile(uploader.getFile(self.attr("data-id")),!0),self.parent().remove()})},0)}}}]).directive("batchTestThree",["$parse","ngDialog","$cookieStore","$state","$timeout",function($parse,ngDialog,$cookieStore,$state,$timeout){return{scope:{accept:"=",server:"=",type:"=",isAuto:"=",isUpload:"=",factor:"=",fileName:"="},template:'<div class="$container"><span  id="picker" style="">请添加文件</span></div>',link:function(scope,element,attrs){$timeout(function(){var uploader=WebUploader.create({auto:!0,swf:"/bower_components/webuploader-0.1.5/dist/Uploader.swf",formData:{userId:$cookieStore.get("userId"),applicationId:$cookieStore.get("applicationId")},server:scope.server,accept:{title:"file",extensions:"xls,xlsx",mimeTypes:"file/xls,file/xlsx"},pick:{id:"#picker",multiple:!1},resize:!1,chunked:!0,chunkRetry:10,disableGlobalDnd:!0,fileNumLimit:10,fileSizeLimit:209715200,fileSingleSizeLimit:5242880});angular.element(".webuploader-pick").addClass("btn1").css({background:"#3e91e7",lineHeight:"20px"}),uploader.on("fileQueued",function(file){scope.fileName=file.name}),uploader.on("error",function(type){switch(type){case"Q_EXCEED_NUM_LIMIT":alert("错误：上传文件数量过多！");break;case"Q_EXCEED_SIZE_LIMIT":alert("错误：文件总大小超出限制！");break;case"F_EXCEED_SIZE":alert("错误：文件大小超出限制！");break;case"Q_TYPE_DENIED":alert("错误：禁止上传该类型文件！");break;case"F_DUPLICATE":alert("错误：请勿重复上传该文件！");break;default:alert("错误代码："+type)}}),uploader.on("uploadProgress",function(file,percentage){var $li=$("#"+file.id),$percent=$li.find(".progress .progress-bar");$percent.length||($percent=$('<div class="progress progress-striped active" style="height: 50px;background: red; width: 200px;"><div class="progress-bar" role="progressbar" style="width: 0%"></div> </div>').appendTo($li).find(".progress-bar")),$li.find("p.state").text("上传中"),$percent.css("width",100*percentage+"%")}),uploader.on("uploadError",function(file){}),uploader.on("uploadSuccess",function(file,response){500==response.status?layer.msg("模板错误"):scope.factor=1}),$(".framework").delegate(".removeItem","click",function(){var self=$(this);uploader.removeFile(uploader.getFile(self.attr("data-id")),!0),self.parent().remove()})},0)}}}]),angular.module("knowledge_static_web").filter("floatFilter",function(){return function(val,length){var length=length?length+1:3,val=new String(val),index=val.indexOf(".");return-1!=index?Number(val.substring(0,index+length)):Number(val)}}),angular.module("knowledge_static_web").filter("replaceCode",function(){return function(val){return val=val.replace(/[\[\]]/g,"")}}).filter("replaceCodeCut",function(){return function(val){return val=val.replace(/[\[\]]/g,""),val.length>20&&(val=val.substring(0,20)+"......"),val}}),angular.module("homePage").controller("homePageContentController",["$scope","$location","localStorageService","AuthService","$state","$cookieStore",function($scope,$location,localStorageService,AuthService,$state,$cookieStore){$scope.vm={sceneId:$cookieStore.get("sceneId")}}]),angular.module("homePage").controller("homePageNavController",["$scope","$location","localStorageService","ngDialog","AuthService","$timeout","$cookieStore","$state",function($scope,$location,localStorageService,ngDialog,AuthService,$timeout,$cookieStore,$state){function logApplication(){if(!$scope.vm.sceneId)return!1;$state.go("setting.Infor")}function loginout(){$cookieStore.remove("applicationId"),$cookieStore.remove("sceneId"),$cookieStore.remove("userId"),$cookieStore.remove("userName"),localStorage.removeItem("history"),httpRequestPost("/api/user/userOut",{userId:USER_ID,userLoginName:USER_LOGIN_NAME},function(){}),$state.go("login")}function queryServiceList(){httpRequestPost("/api/application/service/listServiceByPage",{applicationId:$scope.vm.applicationId,index:($scope.SearchPOJO.currentPage-1)*$scope.SearchPOJO.pageSize,pageSize:$scope.SearchPOJO.pageSize},function(resource){200==resource.status&&null!=resource.data&&resource.data.length>0?($scope.paginationConf.totalItems=resource.total,$scope.vm.serviceArray=resource.data,$scope.vm.serviceUrl=resource.data[0].nodeAccessIp,$scope.vm.openServiceConfirm()):layer.msg("无应用服务",{time:1e3})},function(){layer.msg("无法加载服务列表",{time:1e3})})}function openServiceConfirm(){ngDialog.openConfirm({template:"/static/home/homePageDialog.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){1===e&&$scope.vm.jump($scope.vm.serviceUrl)}})}function jump(url){window.open("http://"+url+"/index.html")}function ObjStory(url,name){this.url=url,this.name=name}$scope.url=$location.url(),$scope.urls=$state.current.name,$scope.vm={applicationId:$cookieStore.get("applicationId"),sceneId:$cookieStore.get("sceneId"),loginout:loginout,userName:$cookieStore.get("userName"),logApplication:logApplication,jump:jump,openServiceConfirm:openServiceConfirm,queryServiceList:queryServiceList,serviceUrl:"",serviceUrlList:"",permissionId:$cookieStore.get("permissionId")},"/homePage/define"==$scope.url?document.getElementsByTagName("body")[0].style.cssText="filter:progid:DXImageTransform.Microsoft.AlphaImageLoader(src='../../images/images/index-bg.jpg',sizingMethod='scale');background: url(../../images/images/index-bg.jpg) no-repeat;background-size:100%":"/login"==$scope.url?document.getElementsByTagName("body")[0].style.cssText="background: url(../../images/images/log-bg.jpg) no-repeat;background-size:100%;filter:progid:DXImageTransform.Microsoft.AlphaImageLoader(src='../../images/images/log-bg.jpg',sizingMethod='scale');":document.getElementsByTagName("body")[0].style.cssText="background: #f8f8f8",$cookieStore.get("userId")||$state.go("login"),self.initSearch=function(column){$scope.SearchPOJO||($scope.SearchPOJO=$scope.initSearchPOJO()),$scope.paginationConf={currentPage:$scope.SearchPOJO.currentPage,totalItems:0,pageSize:$scope.SearchPOJO.pageSize,pagesLength:6}},self.initSearch(),$scope.checkShowCrumbs=function(){return!(!$scope.url.toString().indexOf("/homePage/define")>0||!$scope.url.toString().indexOf("/admin/manage")>0||!$scope.url.toString().indexOf("/admin/userManage")>0)},$scope.checkShowClose=function(url){if("homePage.define"==url)return!0},$scope.getParamList=function(){if(localStorage.history){var aa=JSON.parse(window.localStorage.history);aa.use.length>=8&&aa.use.splice(1,1);for(var i=0;i<aa.use.length;i++)aa.use[i].name==$scope.getUrlName($scope.urls)&&aa.use.splice(i,1);"0"!=$scope.getUrlName($scope.urls)&&aa.use.push(new ObjStory($scope.urls,$scope.getUrlName($scope.urls))),window.localStorage.history=JSON.stringify(aa),$scope.crumbs=aa.use}else{var obj={use:[{url:"homePage.define",name:"首页"}]};window.localStorage.history=JSON.stringify(obj)}},$scope.getUrlName=function(url){switch(url){case"relationalCatalog.manage":return"BOT";case"frameworkLibrary.manage":return"框架库";case(url.match(/^conceptManage/)||{}).input:return"概念管理";case(url.match(/^setting/)||{}).input:return"我的应用";case(url.match(/^custServScenaOverview/)||{}).input:return"知识管理";case"functionalTest.questionTest":return"问法测试";case"functionalTest.sessionTest":return"会话测试";case"functionalTest.batchTest":return"批量测试";case"functionalTest.participle":return"分词应用";case"functionalTest.participleResult":return"分词测试结果";case"knowledgeManagement.custOverview":case"knowledgeManagement.markOverview":return"知识总览";case"knowledgeManagement.conceptAdd":return"营销知识新增";case"knowledgeManagement.faqAdd":return"FAQ知识新增";case"knowledgeManagement.singleAddConcept":return"概念知识新增";case"knowledgeManagement.listAdd":return"列表知识新增";case"knowledgeManagement.factorAdd":return"要素知识新增";case"knowledgeManagement.markKnow":return"富文本知识";case"knowledgeManagement.recommendKnow":return"推荐知识新增";case"knowledgeManagement.knowBatchAdditions":return"知识批量新增";case"knowledgeManagement.processKnow":return"流程知识新增";case(url.match(/^gateway/)||{}).input:return"文档加工新增";case"knowledgeManagement.knowledgeAudit":return"知识审核";case"knowledgeManagement.knowledgeAuditFailed":return"知识审核未通过";case"applAnalysis.accessStatistics":return"访问统计";case"applAnalysis.knowledgeRanking":return"知识点排名统计";case"applAnalysis.sessionDetails":return"会话明细统计";case"applAnalysis.satisfactionDegree":return"满意率统计";case"applAnalysis.resolutionStatistics":return"解决率统计";case"applAnalysis.vioceStatistics":return"语音统计";case"applAnalysis.serviceMonitoring":return"服务监控";case"applAnalysis.reinforcementLearn":return"智能学习";case"applAnalysis.newKnowledgeDiscoveryLearn":return"未匹配问题聚类";case"applAnalysis.operationLog":return"操作日志";case"applAnalysis.sessionLog":return"会话日志";case"materialManagement.chatKnowledgeBase":return"聊天知识库";case"materialManagement.pictureLibrary":return"图片库";case"materialManagement.addtemes":return"图文消息库";case"materialManagement.speechLibrary":return"语音库";case"materialManagement.videoLibrary":return"视频库";case"deepLearning.deeplearnConfig":return"模型构建";case"deepLearning.deepLearningCon":return"模型训练";case"deepLearning.similarityCalculation":return"模型测试";case"deepLearning.dataAcquisition":return"自动导入更新";case"admin.manage":return"应用切换";case"admin.roleManage":return"角色管理";default:return 0}},$scope.getParamList(),$scope.closeCrumb=function(index){if($scope.crumbs.splice(index,1),0!=$scope.crumbs.length){var obj={use:$scope.crumbs};window.localStorage.history=JSON.stringify(obj)}else localStorage.removeItem("history")},window.onbeforeunload=function(){localStorage.removeItem("history")}}]),angular.module("homePage").controller("homePageController",["$scope","$location","localStorageService","AuthService","$state",function($scope,$location,localStorageService,AuthService,$state){$state.go("homePage.define")}]),angular.module("knowledgeManagementModule").controller("knowBatchAdditionsController",["$scope","localStorageService","$state","ngDialog","$cookieStore","$timeout","$compile","FileUploader","$stateParams","knowledgeAddServer","$window","$rootScope","$filter",function($scope,localStorageService,$state,ngDialog,$cookieStore,$timeout,$compile,FileUploader,$stateParams,knowledgeAddServer,$window,$rootScope,$filter){function upload(callback){ngDialog.openConfirm({template:"/static/knowledgeManagement/batchAdditions/uploadDialog.html",width:"450px",scope:$scope,closeByNavigation:!1,overlay:!0,closeByDocument:!1,closeByEscape:!0,showClose:!0,preCloseCallback:function(e){}})}function downTemplate(callback){ngDialog.openConfirm({template:"/static/knowledgeManagement/batchAdditions/downTemplateDialog.html",width:"450px",scope:$scope,closeByNavigation:!1,overlay:!0,closeByDocument:!1,closeByEscape:!0,showClose:!0,preCloseCallback:function(e){}})}$scope.vm={downTemplate:downTemplate,upload:upload,fileName:"",templateType:1==SCENE_ID?"190":"192",sceneId:SCENE_ID}}]),angular.module("knowledgeManagementModule").controller("conceptController",["$scope","localStorageService","$state","ngDialog","$cookieStore","$timeout","$compile","FileUploader","knowledgeAddServer","$window","$stateParams","$interval","$filter",function($scope,localStorageService,$state,ngDialog,$cookieStore,$timeout,$compile,FileUploader,knowledgeAddServer,$window,$stateParams,$interval,$filter){function getFrame(id){httpRequestPost("/api/ms/modeling/frame/listbyattribute",{frameCategoryId:id,frameEnableStatusId:1,frameTypeId:10012,index:0,pageSize:999999},function(data){10005!=data.status&&data.data.length&&($scope.vm.frames=$scope.vm.frames.concat(data.data),$scope.$apply())},function(){})}function getExtensionByFrame(id,type){httpRequestPost("/api/ms/modeling/frame/listbyattribute",{frameTypeId:10012,frameId:id,index:0,pageSize:999999},function(data){if(1e4==data.status){var obj={};data.data[0].elements&&angular.forEach(data.data[0].elements,function(item,index){var extensionQuestionList=[],frameQuestionTagList=[];obj={extensionQuestionType:60,extensionQuestionTitle:data.data[0].frameTitle},extensionQuestionList.push(item.elementContent.substring(0,item.elementContent.indexOf("#"))),frameQuestionTagList.push(item.elementContent.substring(item.elementContent.indexOf("#")+1).split("；")),checkExtensionByFrame(extensionQuestionList,frameQuestionTagList,obj)}),$scope.$apply()}},function(error){})}function getBotFullPath(id){httpRequestPost("/api/ms/modeling/category/getcategoryfullname",{categoryId:id},function(data){if(data.status=1e4){var allBot=angular.copy($scope.vm.creatSelectBot.concat($scope.vm.botClassfy)),botResult=$scope.master.isBotRepeat(id,data.categoryFullName.split("/"),"",allBot);$scope.$apply(function(){$scope.vm.knowledgeBotVal=data.categoryFullName,0!=botResult&&($scope.vm.botFullPath=botResult)})}},function(error){})}function knowledgeClassifyCall(){httpRequestPost("/api/ms/knowledgeDocumentation/documentationKnowledgeClassify",{knowledgeId:$scope.vm.docmentation.knowledgeId,knowledgeStatus:3},function(data){data&&200==data.status&&$state.go("back.doc_results_view",{knowDocId:$scope.vm.docmentation.documentationId,knowDocCreateTime:$scope.vm.docmentation.knowDocCreateTime,knowDocUserName:$scope.vm.docmentation.knowDocUserName})})}function openContentConfirm(callback){ngDialog.openConfirm({template:"/static/knowledgeManagement/public-html/knowledge_increase.html",width:"650px",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){1===e?callback():setDialog()}})}function checkExtensionByFrame(extensionQuestionList,frameQuestionTagList,oldWord){var title=extensionQuestionList[0],weight=oldWord.extensionQuestionType,isLocalHasExt=addLocalExtension(title);if(isLocalHasExt)return void $scope.vm.extensionsByFrame.push(isLocalHasExt);httpRequestPost("/api/ms/conceptKnowledge/checkFrameTag",{applicationId:APPLICATION_ID,extensionQuestionList:extensionQuestionList,frameQuestionTagList:frameQuestionTagList},function(data){200==data.status&&$scope.$apply(function(){var allExtension=$scope.vm.extensions.concat($scope.vm.extensionsByFrame,$scope.vm.extensionByTitleTag),result=$scope.master.isExtensionTagRepeat(data.data,allExtension,title,weight);0!=result&&($scope.vm.extensionTitle="",$scope.vm.extensionsByFrame.push(result))})},function(){})}function scanCotentByTitle(title,index){var answerContentList=new Array(title);httpRequestPost("/api/ms/conceptKnowledge/productExtensionQuestion",{applicationId:APPLICATION_ID,title:$scope.vm.title,answerContentList:answerContentList},function(data){200==data.status?($scope.vm.scanContent[index].extensionByContentByTitle=data.data,$scope.$apply()):500==data.status&&layer.msg(data.info)},function(error){})}function getExtension(title,weight,source){var isLocalHasExt=addLocalExtension(title);if(isLocalHasExt)return void(source?$scope.vm.extensionByTitleTag=new Array(isLocalHasExt):$scope.vm.extensions.push(isLocalHasExt));var question=new Array(title),obj={extensionQuestionTitle:$scope.vm.extensionTitle,extensionQuestionType:$scope.vm.extensionWeight};if(title){if(!checkExtensionByTitle(obj))return layer.msg("生成扩展问重复,已阻止添加"),!1;httpRequestPost("/api/ms/conceptKnowledge/checkExtensionQuestion",{applicationId:APPLICATION_ID,extendQuestionList:question},function(data){500==data.status?layer.msg(data.data):10026==data.status?layer.msg("扩展问添加重复，请重新添加"):200==data.status&&$scope.$apply(function(){var allExtension=$scope.vm.extensions.concat($scope.vm.extensionsByFrame,$scope.vm.extensionByTitleTag),result=$scope.master.isExtensionTagRepeat(data.data,allExtension,title,weight);0!=result&&($scope.vm.extensionTitle="",source?$scope.vm.extensionByTitleTag=new Array(result):$scope.vm.extensions.push(result))})},function(error){})}else layer.msg("扩展问不能为空")}function botSelectAdd(){$scope.vm.botFullPath&&($scope.vm.creatSelectBot.push($scope.vm.botFullPath),$scope.vm.frameCategoryId=$scope.vm.botFullPath.classificationId,$scope.vm.botFullPath="",$scope.vm.knowledgeBotVal="")}function knowledgeAdd(data,index){if(!$scope.vm.title)return layer.msg("请先输入知识标题"),!1;if(data){$scope.vm.isEditIndex=index,$scope.vm.newTitle=data.knowledgeContent,$scope.vm.channel=data.channelIdList,angular.forEach($scope.vm.dimensions,function(item){if(data.dimensionIdList.inArray(item.dimensionId)){var obj={};obj.dimensionId=item.dimensionId,obj.dimensionName=item.dimensionName,$scope.vm.dimensionArr.push(obj)}}),$scope.vm.tip=data.knowledgeBeRelatedOn,$scope.vm.question=data.knowledgeRelatedQuestionOn,$scope.vm.tail=data.knowledgeCommonOn,$scope.vm.appointRelativeGroup=null!=data.knowledgeRelevantContentList?data.knowledgeRelevantContentList:[];var callback=function(){var obj={};obj.knowledgeContent=$scope.vm.newTitle,obj.knowledgeContentType=0,obj.channelIdList=$scope.vm.channel,obj.dimensionIdList=$scope.vm.dimensionArr.id,obj.knowledgeRelatedQuestionOn=$scope.vm.question,obj.knowledgeBeRelatedOn=$scope.vm.tip,obj.knowledgeCommonOn=$scope.vm.tail,obj.knowledgeRelevantContentList=$scope.vm.appointRelativeGroup,$scope.vm.scanContent[index]=obj,$scope.vm.isEditIndex=-1,scanCotentByTitle(obj.knowledgeContent,index),setDialog()}}else var callback=saveAddNew;$scope.master.openNgDialog($scope,"/static/knowledgeManagement/public-html/knowledge_increase.html","650px",callback,function(){$scope.vm.isEditIndex=-1,setDialog()}),$timeout(function(){$scope.master.searchAppointAutoTag($scope,".appoint","/api/ms/knowledgeManage/getKnowledgeTitle","appointRelativeList",function(suggestion){}).listener()},2e3)}function extensionEdit(type,item,index){($scope.vm.backupsOfExtension=angular.copy(item),0==angular.element(".ngdialog ").length)&&ngDialog.openConfirm({template:"/static/knowledgeManagement/public-html/extension_edit.html",width:"500px",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){1===e?1==type?$scope.vm.extensionsByFrame[index]=$scope.vm.backupsOfExtension:0==type?$scope.vm.extensions[index]=$scope.vm.backupsOfExtension:2==type&&($scope.vm.extensionByTitleTag[index]=$scope.vm.backupsOfExtension):$scope.vm.backupsOfExtension=""}})}function slideDown(){$scope.vm.slideFlag=!$scope.vm.slideFlag,$(".senior_div").slideToggle()}function getBotAndExtensionByTitle(){getExtension($scope.vm.title,"60",1),$scope.vm.title&&$scope.vm.sourceTitle!=$scope.vm.title?httpRequestPost("/api/ms/conceptKnowledge/checkKnowledgeTitleAndGetAutoClassify",{title:$scope.vm.title,applicationId:APPLICATION_ID,knowledgeId:$scope.vm.knowledgeId},function(data){500==data.status?($scope.vm.titleTip="知识标题重复",$scope.$apply()):200==data.status&&$scope.$apply(function(){$scope.vm.knowledgeTitleTag=data.data.knowledgeTitleTagList,$scope.vm.botClassfy=[];var allBot=angular.copy($scope.vm.creatSelectBot);angular.forEach(data.data.classifyList,function(item){var botResult=$scope.master.isBotRepeat(item.id,item.fullPath,item.type,allBot);0!=botResult&&$scope.vm.botClassfy.push(botResult),$scope.vm.frameCategoryId=item.id})})},function(error){}):$scope.vm.sourceTitle==$scope.vm.title||($scope.vm.titleTip="知识标题不能为空")}function getParams(){var params={applicationId:APPLICATION_ID,userId:USER_ID,sceneId:SCENE_ID,knowledgeTitle:$scope.vm.title,knowledgeType:101,knowledgeExpDateStart:$scope.vm.isTimeTable?$scope.vm.timeStart:"",knowledgeExpDateEnd:$scope.vm.isTimeTable?$scope.vm.timeEnd:"",knowledgeTitleTag:$scope.vm.knowledgeTitleTag,knowledgeUpdater:USER_LOGIN_NAME,knowledgeCreator:USER_LOGIN_NAME,knowledgeOrigin:$scope.vm.knowledgeOrigin};return params.knowledgeContents=$scope.vm.scanContent,params.extensionQuestions=$scope.vm.extensions.concat($scope.vm.extensionsByFrame,$scope.vm.extensionByTitleTag),params.classificationAndKnowledgeList=$scope.vm.botClassfy.concat($scope.vm.creatSelectBot),params}function save(){if(!checkSave())return!1;if(!$scope.vm.limitSave){$timeout.cancel(limitTimer),$scope.vm.limitSave=!0,limitTimer=$timeout(function(){$scope.vm.limitSave=!1},18e4);var api,params=getParams();$scope.vm.knowledgeId?(api="/api/ms/conceptKnowledge/editKnowledge",params.knowledgeId=$scope.vm.knowledgeId):api="/api/ms/conceptKnowledge/addConceptKnowledge",httpRequestPost(api,params,function(data){200==data.status?$scope.vm.docmentation?$scope.vm.knowledgeClassifyCall():""==$stateParams.data?($state.go("knowledgeManagement.custOverview"),layer.msg("新增知识已进入审核列表",{time:2e3})):$stateParams.data&&4==angular.fromJson($stateParams.data).knowledgeBase.statusId?($state.go("knowledgeManagement.custOverview"),layer.msg("编辑知识已进入审核列表",{time:2e3})):$state.go("knowledgeManagement.custOverview"):500==data.status&&(layer.msg("知识保存失败"),$timeout.cancel(limitTimer),$scope.$apply(function(){$scope.vm.limitSave=!1}))},function(err){$timeout.cancel(limitTimer),$scope.$apply(function(){$scope.vm.limitSave=!1})})}}function scan(){if(!checkSave())return!1;var obj={},params=getParams();obj.params=params,obj.editUrl="knowledgeManagement.singleAddConcept",$scope.vm.knowledgeId?(obj.api="/api/ms/conceptKnowledge/editKnowledge",params.knowledgeId=$scope.vm.knowledgeId):obj.api="/api/ms/conceptKnowledge/addConceptKnowledge",obj.params=params,obj.knowledgeType=101,$window.knowledgeScan=obj;var url=$state.href("knowledgeManagement.knowledgeScan");$window.open(url,"_blank")}function setDialog(){$scope.vm.newTitle="",$scope.vm.slideFlag=!1,$scope.vm.channel=[],$scope.vm.dimension=[],$scope.vm.question=1,$scope.vm.tip=1,$scope.vm.tail=1,$scope.vm.appointRelativeGroup=[],$scope.vm.appointRelative="",$scope.vm.dimensionsCopy=angular.copy($scope.vm.dimensions),$scope.vm.dimensionArr=[]}function saveAddNew(){if($scope.vm.newTitle){var index=$scope.vm.scanContent.length;scanCotentByTitle(angular.copy($scope.vm.newTitle),index);var obj={};obj.knowledgeContent=$scope.vm.newTitle,obj.channelIdList=$scope.vm.channel,obj.dimensionIdList=$scope.vm.dimensionArr.id.length?$scope.vm.dimensionArr.id:$scope.vm.dimensionsCopy.id,obj.knowledgeRelatedQuestionOn=$scope.vm.question,obj.knowledgeBeRelatedOn=$scope.vm.tip,obj.knowledgeCommonOn=$scope.vm.tail,obj.knowledgeRelevantContentList=$scope.vm.appointRelativeGroup,$scope.vm.scanContent.push(obj),setDialog()}else setDialog()}function checkExtensionByTitle(item){var result,arr=$scope.vm.extensionByTitleTag.concat($scope.vm.extensions);if(arr.length){var len=arr.length;angular.forEach(arr,function(val){val.extensionQuestionTitle==item.extensionQuestionTitle&&val.extensionQuestionType==item.extensionQuestionType&&(len-=1,result=!1),len==arr.length&&(result=!0)})}else result=!0;return result}function checkSave(){var params=getParams();return params.knowledgeTitle?params.classificationAndKnowledgeList.length?$scope.$parent.master.isTitleHasTag($scope.vm.title,$scope.vm.extensions.concat($scope.vm.extensionsByFrame,$scope.vm.extensionByTitleTag))?params.knowledgeContents.length?!!params.classificationAndKnowledgeList.length||void layer.msg("分类知识Bot不能为空"):(layer.msg("知识内容不能为空，请点击新增填写"),!1):(layer.msg("知识意图未打标"),!1):(layer.msg("知识类目不能为空，请选择分类"),!1):(layer.msg("知识标题不能为空，请填写"),!1)}function increaseCheck(){$scope.vm.dimensionArr.id.length||($scope.vm.dimensionArr=angular.copy($scope.vm.dimensionsCopy)),$scope.vm.newTitle||$scope.vm.channel.length?$scope.vm.newTitle?$scope.vm.channel.length?checkChannelDimension($scope.vm.channel,$scope.vm.dimensionArr.id)||ngDialog.closeAll(1):layer.msg("请选择渠道后保存"):layer.msg("请填写知识内容后保存"):layer.msg("请填写知识内容,并选择渠道后保存")}function selectChannel(channelId){$scope.vm.channel.inArray(channelId)?$scope.vm.channel.remove(channelId):$scope.vm.channel.push(channelId)}function checkChannelDimension(channel,dimension){var isRepeat=!1;return angular.forEach($scope.vm.scanContent,function(item,contentIndex){$scope.vm.isEditIndex!=contentIndex&&angular.forEach(item.channelIdList,function(v){angular.forEach(channel,function(val,indexChannel){val==v&&angular.forEach(item.dimensionIdList,function(value){angular.forEach(dimension,function(key,indexDimension){if(key==value){var channelTip;angular.forEach($scope.vm.channels,function(all){all.channelCode==v&&(channelTip=all.channelName)}),layer.msg("重复添加渠道 "+channelTip+" 维度 "+$scope.vm.dimensionArr.name[indexDimension]),isRepeat=!0}})})})})}),isRepeat}function backUpExt(item){$scope.vm.extensionDeleted.inArray(item)||$scope.vm.extensionDeleted.push(item)}function addLocalExtension(title){var result=!1;return $scope.vm.extensionDeleted&&angular.forEach($scope.vm.extensionDeleted,function(item,index){title==item.extensionQuestionTitle&&(result=item,$scope.vm.extensionDeleted.splice(index,1))}),result}function showTip(){$(".shadow_div").show(),$(".step_div").show(),$("#step_one").show().siblings().hide()}function hideTip(){$(".shadow_div").hide(),$(".step_div").hide()}function prevDiv(e){var obj=e.srcElement?e.srcElement:e.target;$(obj).parent().parent().parent().prev()&&($(obj).parent().parent().parent().hide(),$(obj).parent().parent().parent().prev().show(),$("html, body").animate({scrollTop:$(obj).parent().parent().parent().prev().offset().top-20},500))}function nextDiv(e){var obj=e.srcElement?e.srcElement:e.target;$(obj).parent().parent().parent().next()&&($(obj).parent().parent().parent().hide(),$(obj).parent().parent().parent().next().show(),$("html, body").animate({scrollTop:$(obj).parent().parent().parent().next().offset().top-20},500))}if($scope.vm={knowledgeId:"",knowledgeOrigin:120,frames:[],frameId:"",knowledgeAdd:knowledgeAdd,botRoot:"",knowledgeClassifyCall:knowledgeClassifyCall,openContentConfirm:openContentConfirm,knowledgeBotVal:"",botSelectAdd:botSelectAdd,frameCategoryId:"",title:"",titleTip:"",timeStart:"",timeEnd:"",isTimeTable:!1,getBotAndExtensionByTitle:getBotAndExtensionByTitle,botClassfy:[],creatSelectBot:[],extensionTitle:"",extensionWeight:60,getExtension:getExtension,extensions:[],extensionsByFrame:[],extensionByTitleTag:[],extensionEdit:extensionEdit,scanContent:[],save:save,scan:scan,newTitle:"",channel:[],channels:[],channelArr:[],selectChannel:selectChannel,dimension:"",dimensions:[],dimensionArr:[],dimensionsCopy:[],checkChannelDimension:checkChannelDimension,slideDown:slideDown,slideFlag:!1,question:1,tip:1,tail:1,knowledgeTitleTag:[],appointRelative:"",appointRelativeList:[],appointRelativeGroup:[],replaceType:0,enterEvent:enterEvent,dialogExtension:[],limitSave:!1,isEditIndex:-1,rmExtensionBackup:[],showTip:showTip,hideTip:hideTip,prevDiv:prevDiv,nextDiv:nextDiv,increaseCheck:increaseCheck,backupsOfExtension:"",sourceTitle:"",backUpExt:backUpExt,extensionDeleted:[]},$scope.master.getDimensions($scope,["dimensions","dimensionsCopy"]),$scope.master.getChannels($scope,["channels"]),$stateParams.data&&angular.fromJson($stateParams.data).knowledgeBase){var data=angular.fromJson($stateParams.data);$scope.vm.title=data.knowledgeBase.knowledgeTitle,$scope.vm.sourceTitle=data.knowledgeBase.knowledgeTitle,$scope.vm.knowledgeTitleTag=data.knowledgeBase.knowledgeTitleTag,$scope.vm.knowledgeId=data.knowledgeBase.knowledgeId,$scope.vm.knowledgeOrigin=data.knowledgeBase.knowledgeOrigin,(data.knowledgeBase.knowledgeExpDateStart||data.knowledgeBase.knowledgeExpDateEnd)&&($scope.vm.isTimeTable=!0),$scope.vm.timeStart=$filter("date")(data.knowledgeBase.knowledgeExpDateStart,"yyyy-MM-dd"),$scope.vm.timeEnd=$filter("date")(data.knowledgeBase.knowledgeExpDateEnd,"yyyy-MM-dd"),$scope.vm.creatSelectBot=data.knowledgeBase.classificationAndKnowledgeList,$scope.vm.extensionsByFrame=data.extensionQuestions,angular.forEach(data.extensionQuestions,function(item){}),angular.forEach(data.knowledgeContents,function(item){var obj={};obj.knowledgeContent=item.knowledgeContent,obj.channelIdList=item.channelIdList,obj.dimensionIdList=item.dimensionIdList,obj.knowledgeRelatedQuestionOn=item.knowledgeRelatedQuestionOn,obj.knowledgeBeRelatedOn=item.knowledgeBeRelatedOn,obj.knowledgeCommonOn=item.knowledgeCommonOn,obj.knowledgeRelevantContentList=item.knowledgeRelevantContentList,$scope.vm.scanContent.push(obj)})}else $stateParams.data&&angular.fromJson($stateParams.data).docmentation&&($scope.vm.docmentation=angular.fromJson($stateParams.data).docmentation,$scope.vm.title=$scope.vm.docmentation.documentationTitle,$scope.vm.newTitle=$scope.vm.docmentation.documentationContext,$scope.vm.knowledgeOrigin=122,$timeout(function(){$scope.vm.openContentConfirm(saveAddNew)},0));$stateParams.knowledgeTitle&&($scope.vm.title=$stateParams.knowledgeTitle),$scope.$watch("vm.frameCategoryId",function(val,old){val&&val!=old&&getFrame(val)}),$scope.$watch("vm.frameId",function(val,old){val&&val!=old&&getExtensionByFrame(val)}),$scope.master.botTreeOperate($scope,"/api/ms/modeling/category/listbycategorypid","/api/ms/modeling/category/listbycategorypid",getBotFullPath),$scope.master.searchBotAutoTag(".botTagAuto","/api/ms/modeling/category/searchbycategoryname",function(suggestion){$scope.$apply(function(){var allBot=angular.copy($scope.vm.botClassfy.concat($scope.vm.creatSelectBot)),botResult=$scope.master.isBotRepeat(suggestion.data,suggestion.value.split("/"),suggestion.type,allBot);$scope.vm.knowledgeBotVal=suggestion.value,0!=botResult&&($scope.vm.botFullPath=botResult)})});var limitTimer}]),angular.module("knowledgeManagementModule").controller("analyseTaskController",["$scope","$location","$routeParams","$interval","$timeout","ngDialog","KnowDocService","TemplateService","TipService","$state",function($scope,$location,$routeParams,$interval,$timeout,ngDialog,KnowDocService,TemplateService,TipService,$state){function queryTemplate(){TemplateService.queryTemplate.save({index:($scope.temPaginationConf.currentPage-1)*$scope.temPaginationConf.pageSize,pageSize:$scope.temPaginationConf.pageSize,requestId:"string"},function(resource){200==resource.status&&($scope.vm.templates=resource.data.objs,$scope.temPaginationConf.totalItems=resource.data.total)})}function queryKnowDocList(){KnowDocService.queryKnowDocList.save({index:($scope.paginationConf.currentPage-1)*$scope.paginationConf.pageSize,pageSize:$scope.paginationConf.pageSize,documentationName:$scope.paginationConf.searchName,documentationCreateTime:$scope.paginationConf.startTime,documentationModifyTime:$scope.paginationConf.endTime,documentationCreater:$scope.paginationConf.userName,requestId:"string"},function(resource){200==resource.status&&($scope.vm.knowDocs=resource.data.objs,$scope.paginationConf.totalItems=resource.data.total)})}function deleteKnowDoc(knowDocId){KnowDocService.deleteKnowDoc.save({documentationId:knowDocId},function(resource){200==resource.status&&(TipService.setMessage("删除成功!","success"),$state.reload())})}$scope.vm={searchName:"",templates:"",knowDocs:"",queryKnowDocList:queryKnowDocList,queryTemplate:queryTemplate,deleteKnowDoc:deleteKnowDoc,templateId:""},$scope.paginationConf={currentPage:1,totalItems:0,pageSize:10,pagesLength:6,searchName:"",startTime:"",endTime:"",userName:""},$scope.temPaginationConf={currentPage:1,totalItems:0,pageSize:5,pagesLength:6};var timeout;$scope.$watch("paginationConf",function(){timeout&&$timeout.cancel(timeout),timeout=$timeout(function(){queryKnowDocList()},350)},!0);var timeout3;$scope.$watch("temPaginationConf",function(SearchPOJO){timeout3&&$timeout.cancel(timeout3),timeout=$timeout(function(){queryTemplate()},350)},!0)}]),angular.module("knowledgeManagementModule").controller("backController",["$scope","$location","$interval","$timeout","$state",function($scope,$location,$interval,$timeout,$state){$state.go("back.gateway")}]),angular.module("knowledgeManagementModule").controller("createTemController",["$scope","$location","$stateParams","$interval","$timeout","ngDialog","TemplateService","localStorageService","$state","TipService",function($scope,$location,$stateParams,$interval,$timeout,ngDialog,TemplateService,localStorageService,$state,TipService){function queryTemplateById(){TemplateService.queryTemplateById.save({index:0,pageSize:1,templateId:$scope.vm.templateId},function(resource){if(200==resource.status&&resource.data){$scope.vm.temName=resource.data.objs[0].templateName;var filePath=resource.data.objs[0].templateUrl,filename=filePath.substring(filePath.lastIndexOf("//")+2,filePath.length);$scope.vm.fileName=filename}})}function queryRules(){TemplateService.queryRules.save({templateId:$scope.vm.templateId},function(resource){200==resource.status&&resource.data&&($scope.vm.rules=resource.data.objs)})}function addRule(){$scope.vm.rules?(0==$scope.vm.rules.length?$scope.vm.rules.push({level:0}):$scope.vm.rules.push({level:$scope.vm.rules[$scope.vm.rules.length-1].level+1}),$(".proce_result ").trigger("click")):layer.msg("请先上传模板或选定模板")}function deleteRule(ruleId){ruleId&&TemplateService.deleteRule.save({ruleId:ruleId},function(resource){200==resource.status?(TipService.setMessage("删除成功!","success"),queryRules()):TipService.setMessage("删除失败!","err")})}function resetRule(index){var rule=$scope.vm.rules[index];rule&&!rule.id&&$scope.vm.rules.splice(index,1)}$scope.vm={temName:"",temType:"WORD",temNameChecked:!1,fileName:"未选择文件",isTempUpToolsShow:!$stateParams.temId,progress:0,templateId:$stateParams.temId?$stateParams.temId:"",rules:"",addRule:addRule,deleteRule:deleteRule,resetRule:resetRule};var timeout;$scope.$watch("vm.templateId",function(temId){temId&&(timeout&&$timeout.cancel(timeout),timeout=$timeout(function(){$scope.vm.isTempUpToolsShow=!1,queryTemplateById(),queryRules()},350))},!0);var timeout2;$scope.$watch("vm.temName",function(temName){temName&&""!=temName&&(timeout2&&$timeout.cancel(timeout2),timeout2=$timeout(function(){TemplateService.checkTemName.save({templateName:$scope.vm.temName},function(resource){200==resource.status&&0==resource.data.objs.length?$scope.vm.temNameChecked=!0:$scope.vm.temNameChecked=!1})},350))},!0),$scope.backT=function(){history.back()}}]),angular.module("knowledgeManagementModule").controller("doc_results_viewController",["$scope","DetailService","localStorageService","$state","$stateParams","$timeout","ngDialog","$cookieStore",function($scope,DetailService,localStorageService,$state,$stateParams,$timeout,ngDialog,$cookieStore){function refreshFn(){$scope.queryDocKnowItems()}function knowIgnoreAllConfirm(){ngDialog.openConfirm({template:"/static/knowledgeManagement/document_know_process/doc_results_viewDialog.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){1===e&&$scope.ignoreDocKnowAll()}})}function knowIgnoreConfirm(knowledgeId){ngDialog.openConfirm({template:"/static/knowledgeManagement/document_know_process/doc_results_viewDialog2.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){1===e&&$scope.ignoreDocKnow(knowledgeId)}})}function addKnowClass(knowledgeId,knowledgeTitle,knowledgeContent){if(2==$cookieStore.get("sceneId"))$state.go("knowledgeManagement.conceptAdd",{data:angular.toJson({docmentation:{documentationId:$scope.knowDocId,knowDocCreateTime:$scope.knowDocCreateTime,knowDocUserName:$scope.knowDocUserName,knowledgeId:knowledgeId,documentationTitle:knowledgeTitle,documentationContext:knowledgeContent}})});else{ngDialog.openConfirm({template:"/static/knowledgeManagement/document_know_process/doc_results_viewDialog_add.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){1===e&&$state.go($scope.vm.stateUrlVal,{data:angular.toJson({docmentation:{documentationId:$scope.knowDocId,knowDocCreateTime:$scope.knowDocCreateTime,knowDocUserName:$scope.knowDocUserName,knowledgeId:knowledgeId,documentationTitle:knowledgeTitle,documentationContext:knowledgeContent}})})}})}}var self=this;null!=$stateParams.knowDocId&&$state.go("back.doc_results_view"),$scope.knowDocId=$stateParams.knowDocId,$scope.knowDocCreateTime=$stateParams.knowDocCreateTime,$scope.knowDocUserName=$stateParams.knowDocUserName,$scope.vm={knowIgnoreAllConfirm:knowIgnoreAllConfirm,knowIgnoreConfirm:knowIgnoreConfirm,addKnowClass:addKnowClass,refreshFn:refreshFn,stateUrlVal:"knowledgeManagement.faqAdd",stateUrl:[{value:"knowledgeManagement.faqAdd",name:"FAQ知识"},{value:"knowledgeManagement.singleAddConcept",name:"概念型知识"}]},$scope.ignoreDocKnow=function(knowledgeId){DetailService.ignoreDocKnow.save({knowledgeId:knowledgeId,requestId:"string"},function(resource){200==resource.status&&$scope.vm.refreshFn()},function(){})},$scope.ignoreDocKnowAll=function(){DetailService.ignoreDocKnowAll.save({documentationId:$scope.knowDocId,requestId:"string"},function(resource){200==resource.status&&$scope.vm.refreshFn()},function(){})},self.initSearch=function(column){$scope.SearchPOJO||($scope.SearchPOJO=$scope.initSearchPOJO()),$scope.paginationConf={currentPage:$scope.SearchPOJO.currentPage,totalItems:0,pageSize:$scope.SearchPOJO.pageSize,pagesLength:6}},self.initSearch(),$scope.queryDocKnowItems=function(){$scope.knowDocId&&DetailService.queryDocKnowItems.save({documentationId:$scope.knowDocId,knowledgeStatus:0,index:($scope.SearchPOJO.currentPage-1)*$scope.SearchPOJO.pageSize,pageSize:$scope.SearchPOJO.pageSize,requestId:"string"},function(resource){200==resource.status&&($scope.paginationConf.totalItems=resource.data.total,$scope.knowItems=resource.data.objs)},function(){})};var timeout3;$scope.$watch("SearchPOJO",function(SearchPOJO){timeout3&&$timeout.cancel(timeout3),timeout3=$timeout(function(){$scope.queryDocKnowItems()},350)},!0)}]),angular.module("knowledgeManagementModule").controller("docSelectController",["$scope","$location","$stateParams","$interval","$timeout","ngDialog","TemplateService","localStorageService","$state","$sce","$cookieStore",function($scope,$location,$stateParams,$interval,$timeout,ngDialog,TemplateService,localStorageService,$state,$sce,$cookieStore){function queryRole(){TemplateService.queryRuleById.save({ruleId:$scope.vm.roleId},function(re){if(200==re.status){var data=re.data;$scope.vm.titleText=data.inputText,$scope.vm.extractRegTxt=data.extractReg,$scope.vm.checkModel=data.model,$scope.vm.returnRole=data,generateRule()}})}function queryTemplateContent(){TemplateService.queryTemplateContent.save({index:0,pageSize:1,templateId:$scope.vm.temId},function(re){200==re.status&&$scope.notEmpty(re.data)&&re.data.length>0&&($scope.vm.queryTemContent=$sce.trustAsHtml(re.data))})}function generateRule(){if(!$scope.vm.titleText||""==$scope.vm.titleText)return void layer.msg("请填写匹配标题");TemplateService.generateRule.save({templateId:$scope.vm.temId,level:$scope.vm.level,text:$scope.vm.titleText},function(re){if(200==re.status&&re.data.objs.length>0){$scope.vm.rules=re.data.objs;for(var i=0;i<$scope.vm.rules.length;i++){var rule=$scope.vm.rules[i];$scope.vm.returnRole&&$scope.vm.returnRole.firstLineIndent==rule.firstLineIndent&&$scope.vm.returnRole.fontAlignment==rule.fontAlignment&&$scope.vm.returnRole.selectText==rule.lineWord&&($scope.vm.checkedRuleIndex=i)}getSimilarText()}})}function getSimilarText(){if(void 0!=$scope.vm.rules&&void 0!=$scope.vm.checkedRuleIndex&&void 0!=$scope.vm.rules[$scope.vm.checkedRuleIndex]?$scope.vm.checkedRule=$scope.vm.rules[$scope.vm.checkedRuleIndex]:$scope.vm.checkedRule=void 0,!$scope.vm.checkedRule||""==$scope.vm.checkedRule)return void layer.msg("请选择匹配标题");TemplateService.getSimilarText.save({lineWord:$scope.vm.checkedRule.lineWord,firstLineIndent:$scope.vm.checkedRule.firstLineIndent,fontAlignment:$scope.vm.checkedRule.fontAlignment,level:$scope.vm.checkedRule.level,model:$scope.vm.checkedRule.model,numFmt:$scope.vm.checkedRule.numFmt,numLevelText:$scope.vm.checkedRule.numLevelText,style:$scope.vm.checkedRule.style,templateId:$scope.vm.checkedRule.templateId},function(re){200==re.status&&(re.data.objs.length>0?$scope.vm.strs=re.data.objs:layer.msg("未能抽取到匹配内容"))})}function saveWordRule(){if(void 0!=$scope.vm.rules&&void 0!=$scope.vm.checkedRuleIndex&&void 0!=$scope.vm.rules[$scope.vm.checkedRuleIndex]?$scope.vm.checkedRule=$scope.vm.rules[$scope.vm.checkedRuleIndex]:$scope.vm.checkedRule=void 0,!$scope.vm.checkedRule)return void layer.msg("请选择要保存的规则");var params={lineWord:$scope.vm.checkedRule.lineWord,firstLineIndent:$scope.vm.checkedRule.firstLineIndent,fontAlignment:$scope.vm.checkedRule.fontAlignment,level:$scope.vm.checkedRule.level,model:$scope.vm.checkModel,numFmt:$scope.vm.checkedRule.numFmt,numLevelText:$scope.vm.checkedRule.numLevelText,style:$scope.vm.checkedRule.style,templateId:$scope.vm.checkedRule.templateId,extractReg:$scope.vm.extractRegTxt,inputText:$scope.vm.titleText,selectText:$scope.vm.checkedRule.lineWord,ruleId:$scope.vm.roleId,templateCreater:USER_NAME,templateUpdater:USER_NAME,requestId:"String"};$scope.vm.roleId&&null!=$scope.vm.roleId&&""!=$scope.vm.roleId?TemplateService.updateWordRule.save(params,function(re){200==re.status&&$state.go("back.createTemplate",{isGo:!0,temId:$scope.vm.temId})}):TemplateService.addWordRule.save(params,function(re){200==re.status&&$state.go("back.createTemplate",{isGo:!0,temId:$scope.vm.temId})})}$scope.vm={roleId:$stateParams.roleId,temId:$stateParams.temId,level:$stateParams.level,checkModel:1,checkedRule:{},queryRole:queryRole,queryTemplateContent:queryTemplateContent,queryTemContent:"",titleText:"",returnRole:"",extractRegTxt:"",checkedRuleIndex:0,getSimilarText:getSimilarText,strs:"",saveWordRule:saveWordRule,rules:"",generateRule:generateRule},queryTemplateContent(),null!=$scope.vm.roleId&&""!=$scope.vm.roleId&&queryRole()}]),angular.module("knowledgeManagementModule").controller("temController",["$scope","$location","$routeParams","$interval","$timeout","ngDialog","TemplateService","TipService","$state",function($scope,$location,$routeParams,$interval,$timeout,ngDialog,TemplateService,TipService,$state){function queryTemplate(){TemplateService.queryTemplate.save({index:($scope.paginationConf.currentPage-1)*$scope.paginationConf.pageSize,pageSize:$scope.paginationConf.pageSize,requestId:"string",templateName:$scope.paginationConf.searchName},function(resource){200==resource.status&&($scope.templates=resource.data.objs,$scope.paginationConf.totalItems=resource.data.total)})}function deleteTemplate(temId){TemplateService.deleteTemplate.save({templateId:temId},function(resource){200==resource.status&&(TipService.setMessage("删除成功!","success"),queryTemplate())})}$scope.vm={searchName:"",deleteTemplate:deleteTemplate,queryTemplate:queryTemplate},$scope.paginationConf={currentPage:1,totalItems:0,pageSize:10,pagesLength:6,searchName:""};var timeout;$scope.$watch("paginationConf",function(){timeout&&$timeout.cancel(timeout),timeout=$timeout(function(){queryTemplate()},350)},!0)}]),angular.module("knowledgeManagementModule").controller("knowledgeEssentialController",["$scope","localStorageService","$state","ngDialog","$cookieStore","$timeout","$compile","FileUploader","knowledgeAddServer","$window","$stateParams","$interval","$rootScope","$filter",function($scope,localStorageService,$state,ngDialog,$cookieStore,$timeout,$compile,FileUploader,knowledgeAddServer,$window,$stateParams,$interval,$rootScope,$filter){function init(){$scope.vm.tableList={data:{listTable:new Array(new Array("答案"))}},$scope.vm.listTableType=[];var newType={};newType.elementName="答案",newType.elementType="字符串",newType.technology=null,newType.elementAsk="",newType.relatedQuestions=null,$scope.vm.listTableType.push(newType),$scope.vm.tableList.data.listTableType=$scope.vm.listTableType}function tableChange(row,col,val){$scope.vm.tableList.data.listTable[row][col]=val}function tableRemove(type){switch(type){case 1:0==$scope.vm.tableRow?layer.msg("不可删除第一行"):null==$scope.vm.tableRow?layer.msg("请先选择要删除的行"):($scope.vm.tableList.data.listTable.splice($scope.vm.tableRow,1),$scope.vm.tableRow=null);break;case 2:0==$scope.vm.tableColumn?layer.msg("不可删除第一列"):null==$scope.vm.tableRow?layer.msg("请先选择要删除的列"):(angular.forEach($scope.vm.tableList.data.listTable,function(item,tableRow){angular.forEach(item,function(val,index){index==$scope.vm.tableColumn&&$scope.vm.tableList.data.listTable[tableRow].splice(index,1)})}),$scope.vm.tableList.data.listTableType.splice($scope.vm.tableColumn,1),$scope.vm.tableColumn=null)}}function addRow(){for(var len=$scope.vm.tableList.data.listTable[0].length,arr=new Array(len),i=0;i<len;i++)arr[i]=null;$scope.vm.tableList.data.listTable.push(arr)}function tableSaveCheck(){$scope.vm.factorName?$scope.vm.elementAsk?ngDialog.closeAll(1):layer.msg("请填写反问后保存"):layer.msg("请填写要素名称后保存")}function addList(row,column){0==angular.element(".ngdialog ").length&&ngDialog.openConfirm({template:"/static/knowledgeManagement/factor/factorDialog.html",width:"695px",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){if(1===e){angular.forEach($scope.vm.tableList.data.listTable,function(item,index){0==index?$scope.vm.tableList.data.listTable[index].push($scope.vm.factorName):$scope.vm.tableList.data.listTable[index].push(null)});var newType={elementName:$scope.vm.factorName,elementType:$scope.vm.tableType,technology:$scope.vm.gorithm,elementAsk:$scope.vm.elementAsk,relatedQuestions:null};$scope.vm.tableList.data.listTableType.push(newType),setDialogNew()}else setDialogNew()}})}function editList(row,column){$scope.vm.factorName=$scope.vm.tableList.data.listTableType[column].elementName,$scope.vm.tableType=$scope.vm.tableList.data.listTableType[column].elementType,$scope.vm.gorithm=$scope.vm.tableList.data.listTableType[column].technology,$scope.vm.elementAsk=$scope.vm.tableList.data.listTableType[column].elementAsk;ngDialog.openConfirm({template:"/static/knowledgeManagement/factor/factorDialog.html",width:"695px",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){1===e?($scope.vm.tableList.data.listTableType[column].elementName=$scope.vm.factorName,$scope.vm.tableList.data.listTableType[column].elementType=$scope.vm.tableType,$scope.vm.tableList.data.listTableType[column].technology=$scope.vm.gorithm,$scope.vm.tableList.data.listTableType[column].elementAsk=$scope.vm.elementAsk,$scope.vm.tableList.data.listTable[0][column]=$scope.vm.factorName,setDialogNew()):setDialogNew()}})}function getTableParams(){if($scope.vm.tableList.data){var tabelData=angular.copy($scope.vm.tableList.data),params={},ask=[],items=[];return angular.forEach(tabelData.listTableType,function(item,index){if(index>0){var obj={};obj.name=item.elementName,obj.value=item.elementAsk,ask.push(obj)}}),angular.forEach(tabelData.listTable,function(item,icon){if(icon>0){var row={};row.name=item[0],row.slots=[],angular.forEach(tabelData.listTableType,function(val,cur){if(cur>0){var slot={};slot.name=val.elementName,slot.value=tabelData.listTable[icon][cur],slot.type=val.elementType,slot.algorithm=val.technology,row.slots.push(slot)}}),items.push(row)}}),params.asks=ask,params.items=items,JSON.stringify(params)}return!1}function setDialogNew(){$scope.vm.factorName=null,$scope.vm.tableType="字符串",$scope.vm.gorithm=["NLP"],$scope.vm.elementAsk=null}function getFrame(id){httpRequestPost("/api/ms/modeling/frame/listbyattribute",{frameCategoryId:id,frameEnableStatusId:1,frameTypeId:10013,index:0,pageSize:32767},function(data){10005!=data.status&&data.data.length&&($scope.vm.frames=$scope.vm.frames.concat(data.data),$scope.$apply())},function(){})}function getTableListByFrame(id,type){httpRequestPost("/api/ms/modeling/frame/listbyattribute",{frameTypeId:10013,frameId:id,index:0,pageSize:32767},function(data){1e4==data.status&&data.data[0].elements&&$.each(data.data[0].elements,function(index,value){for(var i=0;i<$scope.vm.tableList.data.listTable[0].length;i++)if($scope.vm.tableList.data.listTable[0][i]!=value.elementContent){for(var i=0;i<$scope.vm.tableList.data.listTable.length-1;i++)$scope.vm.tableList.data.listTable[i+1].push("");$scope.vm.tableList.data.listTable[0].push(value.elementContent);var newType={};newType.elementName=value.elementContent,newType.elementType=switchContentType(value.elementTypeId);var miningTypeArr=[];miningTypeArr.push(switchMiningType(value.elementMiningTypeId)),newType.technology=miningTypeArr,newType.elementAsk=value.elementAskContent,newType.relatedQuestions=value.elementRelateConcept,$scope.vm.tableList.data.listTableType.push(newType),$scope.$apply()}})},function(){})}function switchMiningType(type){return"NLP"}function switchContentType(type){var returnStr="字符串";switch(type){case 10014:returnStr="字符串";break;case 10015:returnStr="日期";break;case 10016:returnStr="范围"}return returnStr}function getBotFullPath(id){httpRequestPost("/api/ms/modeling/category/getcategoryfullname",{categoryId:id},function(data){if(data.status=1e4){var allBot=angular.copy($scope.vm.creatSelectBot.concat($scope.vm.botClassfy)),botResult=$scope.master.isBotRepeat(id,data.categoryFullName.split("/"),"",allBot);$scope.$apply(function(){$scope.vm.knowledgeBotVal=data.categoryFullName,0!=botResult&&($scope.vm.botFullPath=botResult)})}},function(){})}function getExtension(title,weight,source){var isLocalHasExt=addLocalExtension(title);if(isLocalHasExt)return void(source?$scope.vm.extensionByTitleTag=new Array(isLocalHasExt):$scope.vm.extensions.push(isLocalHasExt));var question=new Array(title),obj={extensionQuestionTitle:title,extensionQuestionType:weight};if($scope.vm.extensionTitle||source){if(!chackTitleAndextEnsionQuestion($scope.vm.title,$scope.vm.extensionTitle))return void layer.msg("扩展问和标题重复请重新输入扩展问");if(!checkExtensionByTitle(obj))return layer.msg("扩展问重复,,已阻止添加"),!1;httpRequestPost("/api/ms/elementKnowledgeAdd/checkDistribute",{applicationId:APPLICATION_ID,extendQuestionList:question},function(data){500==data.status?layer.msg(data.data):10026==data.status?layer.msg("扩展问添加重复，请重新添加"):200==data.status&&$scope.$apply(function(){var allExtension=$scope.vm.extensions,result=$scope.master.isExtensionTagRepeat(data.data,allExtension,title,weight);0!=result&&($scope.vm.extensionTitle="",source?$scope.vm.extensionByTitleTag=new Array(result):$scope.vm.extensions.push(result))})},function(error){})}else layer.msg("扩展问不能为空")}function botSelectAdd(){$scope.vm.botFullPath&&($scope.vm.creatSelectBot.push($scope.vm.botFullPath),$scope.vm.frameCategoryId=$scope.vm.botFullPath.classificationId,$scope.vm.botFullPath=null,$scope.vm.knowledgeBotVal="",$(".icon-jj").eq(0).css("backgroundPosition","0% 0%"))}function extensionEdit(type,item,index){($scope.vm.backupsOfExtension=angular.copy(item),0==angular.element(".ngdialog ").length)&&ngDialog.openConfirm({template:"/static/knowledgeManagement/public-html/extension_edit.html",width:"500px",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){1===e?0==type?$scope.vm.extensions[index]=$scope.vm.backupsOfExtension:2==type&&($scope.vm.extensionByTitleTag[index]=$scope.vm.backupsOfExtension):$scope.vm.backupsOfExtension=""}})}function slideDown(){$scope.vm.slideFlag=!$scope.vm.slideFlag,$(".senior_div").slideToggle(),$scope.vm.slideFlag&&$(".senior_div").css("overflow","visible")}function chackTitleAndextEnsionQuestion(title,ensionQuestionTitle){return""!=title?title!=ensionQuestionTitle:""!=ensionQuestionTitle?ensionQuestionTitle!=title:void 0}function getBotAndExtensionByTitle(){$scope.vm.title&&$scope.vm.sourceTitle!=$scope.vm.title?(getExtension($scope.vm.title,"60",1),httpRequestPost("/api/ms/elementKnowledgeAdd/byTitleGetClassify",{title:$scope.vm.title,applicationId:APPLICATION_ID,knowledgeId:$scope.vm.knowledgeId},function(data){500==data.status?($scope.vm.titleTip="知识标题重复",$scope.$apply()):10002==data.status?($scope.vm.titleTip=data.info,$scope.$apply()):200==data.status&&$scope.$apply(function(){$scope.vm.knowledgeTitleTag=data.data.knowledgeTitleTagList,$scope.vm.botClassfy=[];var allBot=angular.copy($scope.vm.creatSelectBot);angular.forEach(data.data.classifyList,function(item){var botResult=$scope.master.isBotRepeat(item.id,item.fullPath,item.type,allBot);0!=botResult&&$scope.vm.botClassfy.push(botResult),$scope.vm.frameCategoryId=item.id})})},function(error){})):$scope.vm.sourceTitle==$scope.vm.title?getExtension($scope.vm.title,"60",1):$scope.vm.titleTip="知识标题不能为空"}function getParams(){var params={applicationId:APPLICATION_ID,knowledgeId:$scope.vm.knowledgeId,userId:USER_ID,sceneId:SCENE_ID,knowledgeType:103,knowledgeTitle:$scope.vm.title,knowledgeExpDateStart:$scope.vm.isTimeTable?$scope.vm.timeStart:null,knowledgeExpDateEnd:$scope.vm.isTimeTable?$scope.vm.timeEnd:null,knowledgeTitleTag:$scope.vm.knowledgeTitleTag,knowledgeUpdater:USER_LOGIN_NAME,knowledgeCreator:USER_LOGIN_NAME,knowledgeOrigin:$scope.vm.knowledgeOrigin},obj=(angular.copy($scope.vm.newTitle),{});return obj.knowledgeContent=getTableParams(),obj.channelIdList=$scope.vm.channel,null==$scope.vm.dimensionArr||0==$scope.vm.dimensionArr.length||$scope.vm.dimensionArr.id.length?($scope.vm.dimensionArr=[],obj.dimensionIdList=[]):($scope.vm.dimensionArr=angular.copy($scope.vm.dimensionsCopy),obj.dimensionIdList=$scope.vm.dimensionArr.id.length?$scope.vm.dimensionArr.id:$scope.vm.dimensionsCopy.id),obj.knowledgeRelatedQuestionOn=$scope.vm.question,obj.knowledgeBeRelatedOn=$scope.vm.tip,obj.knowledgeCommonOn=$scope.vm.tail,obj.knowledgeRelevantContentList=$scope.vm.appointRelativeGroup,$scope.vm.scanContent=new Array(obj),params.knowledgeContents=angular.copy($scope.vm.scanContent),params.extensionQuestions=$scope.vm.extensions.concat($scope.vm.extensionByTitleTag),params.classificationAndKnowledgeList=$scope.vm.botClassfy.concat($scope.vm.creatSelectBot),params}function save(){if(!checkSave())return!1;if(!$scope.vm.limitSave){$timeout.cancel(limitTimer),$scope.vm.limitSave=!0,limitTimer=$timeout(function(){$scope.vm.limitSave=!1},18e4),$scope.vm.data=getParams();var api=$scope.vm.knowledgeId?"/api/ms/elementKnowledgeAdd/editElementKnowledge":"/api/ms/elementKnowledgeAdd/addElementKnowledge";httpRequestPost(api,getParams(),function(data){200==data.status?""==$stateParams.data?($state.go("knowledgeManagement.custOverview"),layer.msg("新增知识已进入审核列表",{time:2e3})):$stateParams.data&&4==angular.fromJson($stateParams.data).knowledgeBase.statusId?($state.go("knowledgeManagement.custOverview"),layer.msg("编辑知识已进入审核列表",{time:2e3})):$state.go("knowledgeManagement.custOverview"):500==data.status&&(layer.msg("知识保存失败"),$timeout.cancel(limitTimer),$scope.$apply(function(){$scope.vm.limitSave=!1}))},function(err){$timeout.cancel(limitTimer),$scope.$apply(function(){$scope.vm.limitSave=!1})})}}function scan(){if(!checkSave())return!1;var obj={},params=getParams();obj.params=params,obj.editUrl="knowledgeManagement.factorAdd",obj.knowledgeType=103,obj.knowledgeId=$scope.vm.knowledgeId,$scope.vm.knowledgeId?(obj.api="/api/ms/elementKnowledgeAdd/editElementKnowledge",params.knowledgeId=$scope.vm.knowledgeId):obj.api="/api/ms/elementKnowledgeAdd/addElementKnowledge",$window.knowledgeScan=obj;var url=$state.href("knowledgeManagement.knowledgeScan");$window.open(url,"_blank")}function selectChannel(channelId){$scope.vm.channel.inArray(channelId)?$scope.vm.channel.remove(channelId):$scope.vm.channel.push(channelId)}function checkExtensionByTitle(item){var result,arr=$scope.vm.extensionByTitleTag.concat($scope.vm.extensions);if(arr.length){var len=arr.length;angular.forEach(arr,function(val){val.extensionQuestionTitle==item.extensionQuestionTitle&&val.extensionQuestionType==item.extensionQuestionType&&(len-=1,result=!1),len==arr.length&&(result=!0)})}else result=!0;return result}function checkSave(){var params=getParams(),isTableHasNull=!1;return $scope.vm.tableList.data.listTable[0].length<=1||$scope.vm.tableList.data.listTable.length<=1?isTableHasNull=!0:angular.forEach($scope.vm.tableList.data.listTable,function(item,index){angular.forEach(item,function(val){null!=val&&""!=val||(isTableHasNull=!0)})}),params.knowledgeTitle?params.classificationAndKnowledgeList.length?$scope.$parent.master.isTitleHasTag($scope.vm.title,$scope.vm.extensions.concat($scope.vm.extensionByTitleTag))?params.knowledgeContents[0].channelIdList.length?!isTableHasNull||(layer.msg("请完善表格知识"),!1):(layer.msg("渠道不能为空"),!1):(layer.msg("知识意图未打标"),!1):(layer.msg("知识类目不能为空，请选择分类"),!1):(layer.msg("知识标题不能为空，请填写"),!1)}function backUpExt(item){$scope.vm.extensionDeleted.inArray(item)||$scope.vm.extensionDeleted.push(item)}function addLocalExtension(title){var result=!1;return $scope.vm.extensionDeleted&&angular.forEach($scope.vm.extensionDeleted,function(item,index){title==item.extensionQuestionTitle&&(result=item,$scope.vm.extensionDeleted.splice(index,1))}),result}function showTip(){$(".shadow_div").show(),$(".step_div").show(),$("#step_one").show().siblings().hide()}function hideTip(){$(".shadow_div").hide(),$(".step_div").hide()}function prevDiv(e){var obj=e.srcElement?e.srcElement:e.target;$(obj).parent().parent().parent().prev()&&($(obj).parent().parent().parent().hide(),$(obj).parent().parent().parent().prev().show(),$("html, body").animate({scrollTop:$(obj).parent().parent().parent().prev().offset().top-20},500))}function nextDiv(e){var obj=e.srcElement?e.srcElement:e.target;$(obj).parent().parent().parent().next()&&($(obj).parent().parent().parent().hide(),$(obj).parent().parent().parent().next().show(),$("html, body").animate({scrollTop:$(obj).parent().parent().parent().next().offset().top-20},500))}if($scope.vm={knowledgeId:"",knowledgeOrigin:120,frames:[],frameId:"",botRoot:"",knowledgeBotVal:"",botSelectAdd:botSelectAdd,frameCategoryId:"",title:"",titleTip:"",timeStart:"",timeEnd:"",isTimeTable:!1,getBotAndExtensionByTitle:getBotAndExtensionByTitle,botClassfy:[],creatSelectBot:[],extensionTitle:"",extensionWeight:60,getExtension:getExtension,extensions:[],extensionByTitleTag:[],extensionEdit:extensionEdit,botFullPath:"",scanContent:[],save:save,scan:scan,newTitle:"",channel:[],channels:[],channelArr:[],selectChannel:selectChannel,dimension:"",dimensions:[],dimensionArr:[],dimensionsCopy:[],slideDown:slideDown,slideFlag:!1,question:1,tip:1,tail:1,knowledgeTitleTag:[],appointRelative:"",appointRelativeList:[],appointRelativeGroup:[],replaceType:0,enterEvent:enterEvent,addList:addList,editList:editList,tableRow:null,tableColumn:null,tableChange:tableChange,tableRemove:tableRemove,addRow:addRow,gorithm:["NLP"],tableType:"字符串",factorName:null,reQuestion:null,tableList:"",listTableType:"",data:"",column:"",tableSaveCheck:tableSaveCheck,limitSave:!1,rmExtensionBackup:[],showTip:showTip,hideTip:hideTip,prevDiv:prevDiv,nextDiv:nextDiv,isDecorateSimple:!1,backupsOfExtension:"",sourceTitle:"",backUpExt:backUpExt,extensionDeleted:[]},$scope.master.getDimensions($scope,["dimensions","dimensionsCopy"]),$scope.master.getChannels($scope,["channels"]),$stateParams.data&&angular.fromJson($stateParams.data).knowledgeBase){var data=angular.fromJson($stateParams.data);$scope.vm.title=data.knowledgeBase.knowledgeTitle,$scope.vm.sourceTitle=data.knowledgeBase.knowledgeTitle,$scope.vm.knowledgeTitleTag=data.knowledgeBase.knowledgeTitleTag,(data.knowledgeBase.knowledgeExpDateStart||data.knowledgeBase.knowledgeExpDateEnd)&&($scope.vm.isTimeTable=!0),$scope.vm.timeStart=$filter("date")(data.knowledgeBase.knowledgeExpDateStart,"yyyy-MM-dd"),$scope.vm.timeEnd=$filter("date")(data.knowledgeBase.knowledgeExpDateEnd,"yyyy-MM-dd"),$scope.vm.creatSelectBot=data.knowledgeBase.classificationAndKnowledgeList,$scope.vm.knowledgeId=data.knowledgeBase.knowledgeId,$scope.vm.knowledgeOrigin=data.knowledgeBase.knowledgeOrigin,$scope.vm.extensions=data.extensionQuestions,angular.forEach(data.knowledgeContents,function(item){var obj={};$scope.vm.tableList={},$scope.vm.tableList.data=item.knowledgeContent,obj.channelIdList=item.channelIdList,obj.dimensionIdList=item.dimensionIdList,$scope.vm.channel=item.channelIdList,$scope.vm.dimensionArr=[];var getDimension=$interval(function(){$scope.vm.dimensions&&($interval.cancel(getDimension),angular.forEach($scope.vm.dimensions,function(val){if(item.dimensionIdList.inArray(val.dimensionId)){var obj={};obj.dimensionName=val.dimensionName,obj.dimensionId=val.dimensionId,$scope.vm.dimensionArr.push(obj)}}))},100);$scope.vm.question=item.knowledgeRelatedQuestionOn,$scope.vm.tip=item.knowledgeBeRelatedOn,$scope.vm.tail=item.knowledgeCommonOn,$scope.vm.appointRelativeGroup=null!=item.knowledgeRelevantContentList?item.knowledgeRelevantContentList:[]})}else init();$stateParams.knowledgeTitle&&($scope.vm.title=$stateParams.knowledgeTitle),$scope.$watch("vm.frameCategoryId",function(val,old){val&&val!=old&&getFrame(val)}),$scope.$watch("vm.frameId",function(val,old){val&&val!=old&&getTableListByFrame(val)}),$scope.master.botTreeOperate($scope,"/api/ms/modeling/category/listbycategorypid","/api/ms/modeling/category/listbycategorypid",getBotFullPath),$scope.master.searchBotAutoTag(".botTagAuto","/api/ms/modeling/category/searchbycategoryname",function(suggestion){$scope.$apply(function(){var allBot=angular.copy($scope.vm.botClassfy.concat($scope.vm.creatSelectBot)),botResult=$scope.master.isBotRepeat(suggestion.data,suggestion.value.split("/"),suggestion.type,allBot);$scope.vm.knowledgeBotVal=suggestion.value,0!=botResult&&($scope.vm.botFullPath=botResult)})});var limitTimer;$timeout(function(){$scope.master.searchAppointAutoTag($scope,".appoint","/api/ms/knowledgeManage/getKnowledgeTitle","appointRelativeList",function(suggestion){}).listener()},1e3)}]),angular.module("knowledgeManagementModule").controller("knowManaFaqController",["$scope","localStorageService","$state","ngDialog","$cookieStore","$timeout","$compile","FileUploader","$stateParams","knowledgeAddServer","$window","$rootScope","$filter","myService","$location",function($scope,localStorageService,$state,ngDialog,$cookieStore,$timeout,$compile,FileUploader,$stateParams,knowledgeAddServer,$window,$rootScope,$filter,myService,$location){function getFrame(id){httpRequestPost("/api/ms/modeling/frame/listbyattribute",{frameCategoryId:id,frameEnableStatusId:1,frameTypeId:10011,index:0,pageSize:999999},function(data){10005!=data.status&&data.data.length&&($scope.vm.frames=$scope.vm.frames.concat(data.data),$scope.$apply())},function(){})}function getExtensionByFrame(id,type){httpRequestPost("/api/ms/modeling/frame/listbyattribute",{frameTypeId:10011,frameId:id,index:0,pageSize:999999},function(data){1e4==data.status&&(data.data[0].elements&&angular.forEach(data.data[0].elements,function(item){var isLocalHasExt=addLocalExtension(item.elementContent);if(isLocalHasExt)return void(type?($scope.vm.extensionsByFrame.pop(),$scope.vm.extensionsByFrame.push(isLocalHasExt)):$scope.vm.extensionsByFrame.push(isLocalHasExt));var obj={};obj.extensionQuestionTitle=item.elementContent,obj.extensionQuestionType=60,obj.source=data.data[0].frameTitle,type?($scope.vm.extensionsByFrame.pop(),$scope.vm.extensionsByFrame.push(obj)):$scope.vm.extensionsByFrame.push(obj)}),$scope.$apply())},function(){})}function getBotFullPath(id){httpRequestPost("/api/ms/modeling/category/getcategoryfullname",{categoryId:id},function(data){if(data.status=1e4){var allBot=angular.copy($scope.vm.botClassfy.concat($scope.vm.creatSelectBot)),botResult=$scope.master.isBotRepeat(id,data.categoryFullName.split("/"),"",allBot);$scope.$apply(function(){$scope.vm.knowledgeBotVal=data.categoryFullName,0!=botResult&&($scope.vm.botFullPath=botResult)})}},function(error){})}function getExtension(title,weight){var isLocalHasExt=addLocalExtension(title);if(isLocalHasExt)return void $scope.vm.extensions.push(isLocalHasExt);var obj={extensionQuestionTitle:title,extensionQuestionType:weight};if(title){if(!checkExtension(obj,$scope.vm.extensions))return layer.msg('根据"'+title+'"生成扩展问重复,已阻止添加'),!1;httpRequestPost("/api/ms/faqKnowledge/checkExtensionQuestion",{applicationId:APPLICATION_ID,title:title},function(data){500==data.status?(layer.msg('根据"'+title+'"生成扩展问重复'),$scope.vm.extensionTitle=""):200==data.status&&($scope.vm.extensionTitle="",$scope.vm.extensions.push(obj),$scope.$apply())},function(error){})}else layer.msg("扩展问不能为空")}function botSelectAdd(){$scope.vm.botFullPath&&($scope.vm.creatSelectBot.push($scope.vm.botFullPath),$scope.vm.frameCategoryId=$scope.vm.botFullPath.classificationId,$scope.vm.botFullPath=null,$scope.vm.knowledgeBotVal="")}function replace(id){0==angular.element(".ngdialog").length&&ngDialog.openConfirm({template:"/static/knowledgeManagement/faq/replace.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){1===e?getExtensionByFrame(id,1):0===e&&getExtensionByFrame(id,0)}})}function knowledgeAdd(data,index){var dia=angular.element(".ngdialog ");if(data){$scope.vm.isEditIndex=index,$scope.vm.newTitle=data.knowledgeContent,$scope.vm.channel=data.channelIdList,angular.forEach($scope.vm.dimensions,function(item){if(data.dimensionIdList.inArray(item.dimensionId)){var obj={dimensionId:item.dimensionId,dimensionName:item.dimensionName};$scope.vm.dimensionArr.push(obj)}}),$scope.vm.tip=data.knowledgeBeRelatedOn,$scope.vm.question=data.knowledgeRelatedQuestionOn,$scope.vm.tail=data.knowledgeCommonOn,$scope.vm.appointRelativeGroup=null==data.knowledgeRelevantContentList?[]:data.knowledgeRelevantContentList;var callback=function(){var obj={};obj.knowledgeContent=$scope.vm.newTitle,obj.knowledgeContentType=0,obj.channelIdList=$scope.vm.channel,obj.dimensionIdList=$scope.vm.dimensionArr.id,obj.knowledgeRelatedQuestionOn=$scope.vm.question,obj.knowledgeBeRelatedOn=$scope.vm.tip,obj.knowledgeCommonOn=$scope.vm.tail,obj.knowledgeRelevantContentList=$scope.vm.appointRelativeGroup,$scope.vm.scanContent[index]=obj,$scope.vm.isEditIndex=-1,setDialog()}}else var callback=saveAddNew;0==dia.length&&($timeout(function(){$scope.master.searchAppointAutoTag($scope,".appoint","/api/ms/knowledgeManage/getKnowledgeTitle","appointRelativeList",function(suggestion){}).listener()},2e3),$scope.vm.openContentConfirm(callback))}function openContentConfirm(callback){ngDialog.openConfirm({template:"/static/knowledgeManagement/public-html/knowledge_increase.html",width:"650px",scope:$scope,closeByNavigation:!1,overlay:!0,closeByDocument:!1,closeByEscape:!0,showClose:!0,preCloseCallback:function(e){1===e?callback():($scope.vm.isEditIndex=-1,setDialog())}})}function slideDown(){$scope.vm.slideFlag=!$scope.vm.slideFlag,$(".senior_div").slideToggle()}function getCreatBot(){$scope.vm.title?httpRequestPost("/api/ms/faqKnowledge/findClasssByKnowledgeTitle",{title:$scope.vm.title,applicationId:APPLICATION_ID,knowledgeId:$scope.vm.knowledgeId},function(data){500==data.status?$scope.vm.sourceTitle!=$scope.vm.title&&($scope.vm.titleTip="知识标题重复",$scope.title="",$scope.$apply()):$scope.$apply(function(){$scope.vm.botClassfy=[];var allBot=angular.copy($scope.vm.creatSelectBot);angular.forEach(data.data,function(item){var botResult=$scope.master.isBotRepeat(item.id,item.fullPath,item.type,allBot);0!=botResult&&$scope.vm.botClassfy.push(botResult),$scope.vm.frameCategoryId=item.id})})},function(err){}):$scope.vm.titleTip="知识标题不能为空"}function getParams(){var params={applicationId:APPLICATION_ID,knowledgeId:$scope.vm.knowledgeId,knowledgeTitle:$scope.vm.title,knowledgeExpDateStart:$scope.vm.isTimeTable?$scope.vm.timeStart:null,knowledgeExpDateEnd:$scope.vm.isTimeTable?$scope.vm.timeEnd:null,knowledgeUpdater:USER_LOGIN_NAME,knowledgeCreator:USER_LOGIN_NAME,knowledgeType:100,knowledgeOrigin:$scope.vm.knowledgeOrigin};return params.knowledgeContents=$scope.vm.scanContent,params.extensionQuestions=$scope.vm.extensions.concat($scope.vm.extensionsByFrame),params.classificationAndKnowledgeList=angular.copy($scope.vm.botClassfy.concat($scope.vm.creatSelectBot)),params}function save(){if(!checkSave())return!1;if(!$scope.vm.limitSave){$timeout.cancel(limitTimer),$scope.vm.limitSave=!0,limitTimer=$timeout(function(){$scope.vm.limitSave=!1},18e4),$scope.vm.data=getParams();var api=$scope.vm.knowledgeId?"/api/ms/faqKnowledge/editFAQKnowledge":"/api/ms/faqKnowledge/addFAQKnowledge";httpRequestPost(api,getParams(),function(data){200==data.status?$scope.vm.docmentation?$scope.vm.knowledgeClassifyCall():""==$stateParams.data?($state.go("knowledgeManagement.custOverview"),layer.msg("新增知识已进入审核列表",{time:2e3})):$stateParams.data&&4==angular.fromJson($stateParams.data).knowledgeBase.statusId?($state.go("knowledgeManagement.custOverview"),layer.msg("编辑知识已进入审核列表",{time:2e3})):$state.go("knowledgeManagement.custOverview"):500==data.status&&(layer.msg("知识保存失败"),$timeout.cancel(limitTimer),$scope.$apply(function(){$scope.vm.limitSave=!1}))},function(err){$timeout.cancel(limitTimer),$scope.$apply(function(){$scope.vm.limitSave=!1})})}}function knowledgeClassifyCall(){httpRequestPost("/api/ms/knowledgeDocumentation/documentationKnowledgeClassify",{knowledgeId:$scope.vm.docmentation.knowledgeId,knowledgeStatus:2},function(data){data&&200==data.status&&$state.go("back.doc_results_view",{knowDocId:$scope.vm.docmentation.documentationId,knowDocCreateTime:$scope.vm.docmentation.knowDocCreateTime,knowDocUserName:$scope.vm.docmentation.knowDocUserName})})}function scan(){if(!checkSave())return!1;var obj={},params=getParams();obj.params=params,obj.editUrl="knowledgeManagement.faqAdd",obj.api="/api/ms/faqKnowledge/addFAQKnowledge",$scope.vm.knowledgeId?(obj.api="/api/ms/faqKnowledge/editFAQKnowledge",params.knowledgeId=$scope.vm.knowledgeId):obj.api="/api/ms/faqKnowledge/addFAQKnowledge",obj.knowledgeType=101,obj.knowledgeId=$scope.vm.knowledgeId,$window.knowledgeScan=obj;var url=$state.href("knowledgeManagement.knowledgeScan");$window.open(url,"_blank")}function removeAppointRelative(item){$scope.vm.appointRelativeGroup.remove(item)}function setDialog(){$scope.vm.newTitle="",$scope.vm.channel=[],$scope.vm.dimension=[],$scope.vm.question=1,$scope.vm.tip=1,$scope.vm.tail=1,$scope.vm.appointRelativeGroup=[],$scope.vm.appointRelative="",$scope.vm.dimensionsCopy=angular.copy($scope.vm.dimensions),$scope.vm.dimensionArr=[]}function saveAddNew(){if($scope.vm.newTitle){var obj={};obj.knowledgeContent=$scope.vm.newTitle,obj.knowledgeContentType=0,obj.channelIdList=$scope.vm.channel,obj.dimensionIdList=$scope.vm.dimensionArr.id,obj.knowledgeRelatedQuestionOn=$scope.vm.question,obj.knowledgeBeRelatedOn=$scope.vm.tip,obj.knowledgeCommonOn=$scope.vm.tail,obj.knowledgeRelevantContentList=$scope.vm.appointRelativeGroup,$scope.vm.scanContent.push(obj),setDialog()}else setDialog()}function checkExtension(item,arr){if(0==arr.length)return!0;var len=arr.length;return angular.forEach(arr,function(val){val.extensionQuestionTitle==item.extensionQuestionTitle&&val.extensionQuestionType==item.extensionQuestionType&&(len-=1)}),!(len<arr.length)}function checkSave(){var params=getParams();return""!=$scope.vm.titleTip?(layer.msg($scope.vm.titleTip),!1):params.knowledgeTitle?params.classificationAndKnowledgeList.length?!!params.knowledgeContents.length||(layer.msg("知识内容不能为空，请点击新增填写"),!1):(layer.msg("知识类目不能为空，请选择分类"),!1):(layer.msg("知识标题不能为空，请填写"),!1)}function increaseCheck(){$scope.vm.dimensionArr.id.length||($scope.vm.dimensionArr=angular.copy($scope.vm.dimensionsCopy)),$scope.vm.newTitle||$scope.vm.channel.length?$scope.vm.newTitle?$scope.vm.channel.length?checkChannelDimension($scope.vm.channel,$scope.vm.dimensionArr.id)||ngDialog.closeAll(1):layer.msg("请选择渠道后保存"):layer.msg("请填写知识内容后保存"):layer.msg("请填写知识内容,并选择渠道后保存")}function selectChannel(channelId,e){e.srcElement?e.srcElement:e.target;$scope.vm.channel.inArray(channelId)?$scope.vm.channel.remove(channelId):$scope.vm.channel.push(channelId)}function checkChannelDimension(channel,dimension){var isRepeat=!1;return angular.forEach($scope.vm.scanContent,function(item,contentIndex){$scope.vm.isEditIndex!=contentIndex&&angular.forEach(item.channelIdList,function(v){angular.forEach(channel,function(val,indexChannel){val==v&&angular.forEach(item.dimensionIdList,function(value){angular.forEach(dimension,function(key,indexDimension){if(key==value){var channelTip;angular.forEach($scope.vm.channels,function(all){all.channelCode==v&&(channelTip=all.channelName)}),layer.msg("重复添加渠道 "+channelTip+" 维度 "+$scope.vm.dimensionArr.name[indexDimension]),isRepeat=!0}})})})})}),isRepeat}function backUpExt(item){$scope.vm.extensionDeleted.inArray(item)||$scope.vm.extensionDeleted.push(item)}function addLocalExtension(title){var result=!1;return $scope.vm.extensionDeleted&&angular.forEach($scope.vm.extensionDeleted,function(item,index){title==item.extensionQuestionTitle&&(result=item,$scope.vm.extensionDeleted.splice(index,1))}),result}function addAppoint(item,arr){-1==arr.indexOf(item)&&arr.push(item),$scope.vm.appointRelative=null,$scope.vm.appointRelativeList=[]}function showTip(){$(".shadow_div").show(),$(".step_div").show(),$("#step_one").show().siblings().hide()}function hideTip(){$(".shadow_div").hide(),$(".step_div").hide()}function prevDiv(e){var obj=e.srcElement?e.srcElement:e.target;$(obj).parent().parent().parent().prev()&&($(obj).parent().parent().parent().hide(),$(obj).parent().parent().parent().prev().show(),$("html, body").animate({scrollTop:$(obj).parent().parent().parent().prev().offset().top-20},500))}function nextDiv(e){var obj=e.srcElement?e.srcElement:e.target;$(obj).parent().parent().parent().next()&&($(obj).parent().parent().parent().hide(),$(obj).parent().parent().parent().next().show(),$("html, body").animate({scrollTop:$(obj).parent().parent().parent().next().offset().top-20},500))}if($scope.vm={knowledgeId:"",knowledgeOrigin:120,frames:[],frameId:"",knowledgeAdd:knowledgeAdd,knowledgeClassifyCall:knowledgeClassifyCall,openContentConfirm:openContentConfirm,botRoot:"",knowledgeBotVal:"",botFullPath:null,botSelectAdd:botSelectAdd,frameCategoryId:"",title:"",titleTip:"",isTitleRepeat:!0,timeStart:"",timeEnd:"",isTimeTable:!1,getCreatBot:getCreatBot,botClassfy:[],creatSelectBot:[],getExtension:getExtension,extensionTitle:"",extensionWeight:60,extensions:[],extensionsByFrame:[],scanContent:[],save:save,scan:scan,newTitle:"",channel:[],channels:[],selectChannel:selectChannel,dimension:"",dimensions:[],dimensionArr:[],dimensionsCopy:[],checkChannelDimension:checkChannelDimension,slideDown:slideDown,slideFlag:!1,question:1,tip:1,tail:1,appointRelative:"",appointRelativeList:[],appointRelativeGroup:[],addAppoint:addAppoint,removeAppointRelative:removeAppointRelative,replaceType:0,enterEvent:enterEvent,limitSave:!1,isEditIndex:-1,rmExtensionBackup:[],showTip:showTip,hideTip:hideTip,prevDiv:prevDiv,nextDiv:nextDiv,increaseCheck:increaseCheck,isChannelSelect:!0,sourceTitle:"",backUpExt:backUpExt,extensionDeleted:[]},$scope.master.getDimensions($scope,["dimensions","dimensionsCopy"]),$scope.master.getChannels($scope,["channels"]),$stateParams.data&&angular.fromJson($stateParams.data).knowledgeBase){var data=angular.fromJson($stateParams.data);$scope.vm.title=data.knowledgeBase.knowledgeTitle,$scope.vm.sourceTitle=data.knowledgeBase.knowledgeTitle,(data.knowledgeBase.knowledgeExpDateStart||data.knowledgeBase.knowledgeExpDateEnd)&&($scope.vm.isTimeTable=!0),$scope.vm.timeStart=$filter("date")(data.knowledgeBase.knowledgeExpDateStart,"yyyy-MM-dd"),$scope.vm.timeEnd=$filter("date")(data.knowledgeBase.knowledgeExpDateEnd,"yyyy-MM-dd"),$scope.vm.creatSelectBot=data.knowledgeBase.classificationAndKnowledgeList,$scope.vm.knowledgeId=data.knowledgeBase.knowledgeId,$scope.vm.knowledgeOrigin=data.knowledgeBase.knowledgeOrigin,$scope.vm.extensionsByFrame=data.extensionQuestions,angular.forEach(data.knowledgeContents,function(item){var obj={};obj.knowledgeContent=item.knowledgeContent,obj.channelIdList=item.channelIdList,obj.dimensionIdList=item.dimensionIdList,obj.knowledgeRelatedQuestionOn=item.knowledgeRelatedQuestionOn,obj.knowledgeBeRelatedOn=item.knowledgeBeRelatedOn,obj.knowledgeCommonOn=item.knowledgeCommonOn,obj.knowledgeRelevantContentList=item.knowledgeRelevantContentList,$scope.vm.scanContent.push(obj)})}else $stateParams.data&&angular.fromJson($stateParams.data).docmentation&&($scope.vm.docmentation=angular.fromJson($stateParams.data).docmentation,$scope.vm.title=$scope.vm.docmentation.documentationTitle,$scope.vm.newTitle=$scope.vm.docmentation.documentationContext,$scope.vm.knowledgeOrigin=122,$timeout(function(){$scope.vm.openContentConfirm(saveAddNew)},0));$stateParams.knowledgeTitle&&($scope.vm.title=$stateParams.knowledgeTitle),$scope.$watch("vm.frameCategoryId",function(val,old){val&&val!=old&&getFrame(val)}),$scope.$watch("vm.frameId",function(val,old){if(val&&val!=old)if($scope.vm.extensionsByFrame.length){var frame;if(angular.forEach($scope.vm.frames,function(item){if(item.frameId==val)return frame=item.frameTitle,!0}),frame==$scope.vm.extensionsByFrame[0].source)return!1;replace(val)}else getExtensionByFrame(val)}),$scope.master.botTreeOperate($scope,"/api/ms/modeling/category/listbycategorypid","/api/ms/modeling/category/listbycategorypid",getBotFullPath),$scope.master.searchBotAutoTag(".botTagAuto","/api/ms/modeling/category/searchbycategoryname",function(suggestion){$scope.$apply(function(){var allBot=angular.copy($scope.vm.botClassfy.concat($scope.vm.creatSelectBot)),botResult=$scope.master.isBotRepeat(suggestion.data,suggestion.value.split("/"),suggestion.type,allBot);$scope.vm.knowledgeBotVal=suggestion.value,0!=botResult&&($scope.vm.botFullPath=botResult)})});var limitTimer}]),angular.module("knowledgeManagementModule").controller("historyViewController",["$scope","localStorageService","$state","ngDialog","$cookieStore","$timeout","$compile","FileUploader","knowledgeAddServer","$window","$stateParams","$interval","$filter","$animate",function($scope,localStorageService,$state,ngDialog,$cookieStore,$timeout,$compile,FileUploader,knowledgeAddServer,$window,$stateParams,$interval,$filter,$animate){$scope.vm={findUploadRecord:"/api/ms/uploadRecord/findUploadRecordList",downRecord:"/api/ms/uploadRecord/downFile",deleteRecord:"/api/ms/uploadRecord/deleteRecord",uploadRecordList:null,uploadName:null,uploadType:null,uploadTimeMin:null,uploadTimeMax:null,finishTimeMin:null,finishTimeMax:null},self.initSearch=function(column){$scope.SearchPOJO||($scope.SearchPOJO=$scope.initSearchPOJO()),$scope.paginationConf={currentPage:$scope.SearchPOJO.currentPage,totalItems:0,pageSize:$scope.SearchPOJO.pageSize,pagesLength:5}},self.initSearch();var timeout;$scope.$watch("SearchPOJO",function(current){current&&(timeout&&$timeout.cancel(timeout),timeout=$timeout(function(){$scope.findUploadRecord()},350))},!0),$scope.findUploadRecord=function(){httpRequestPost($scope.vm.findUploadRecord,{requestId:"string",applicationId:APPLICATION_ID,index:($scope.SearchPOJO.currentPage-1)*$scope.SearchPOJO.pageSize,pageSize:$scope.SearchPOJO.pageSize},function(data){200==data.status&&($scope.vm.uploadRecordList=data.data,$scope.$apply())},function(err){})},$scope.downRecordFile=function(uploadId){var urlParams="?applicationId="+APPLICATION_ID+"&uploadId="+uploadId,url=$scope.vm.downRecord+urlParams;$window.open(url,"_blank")},$scope.deleteRecord=function(uploadId){httpRequestPostParam($scope.vm.deleteRecord,{requestId:"string",uploadId:uploadId},function(data){200==data.status&&$scope.findUploadRecord()},function(err){})}}]),angular.module("knowledgeManagementModule").controller("custPreviewController",["$scope","localStorageService","$state","$stateParams","ngDialog","$cookieStore","knowledgeAddServer","$window","$http","myService",function($scope,localStorageService,$state,$stateParams,ngDialog,$cookieStore,knowledgeAddServer,$window,$http,myService){function goBack(){window.history.back()}function edit(){$state.go(editUrl,{data:angular.toJson($scope.vm.listData)})}if($stateParams.knowledgeId&&$stateParams.knowledgeType){$scope.vm={knowledgeId:$stateParams.knowledgeId,knowledgeType:parseInt($stateParams.knowledgeType),listData:null,edit:edit,goBack:goBack},knowledgeAddServer.getDimensions({applicationId:APPLICATION_ID},function(data){data.data&&($scope.vm.dimensions=data.data)},function(error){}),knowledgeAddServer.getChannels({applicationId:APPLICATION_ID},function(data){data.data&&($scope.vm.channels=data.data)},function(error){});var editUrl,api;switch($scope.vm.knowledgeType){case 100:editUrl="knowledgeManagement.faqAdd",api="/api/ms/faqKnowledge/getKnowledge";break;case 101:editUrl="knowledgeManagement.singleAddConcept",api="/api/ms/conceptKnowledge/getKnowledge";break;case 102:editUrl="knowledgeManagement.listAdd",api="/api/ms/conceptKnowledge/getKnowledge";break;case 103:editUrl="knowledgeManagement.factorAdd",api="/api/ms/elementKnowledgeAdd/findElementKnowledgeByKnowledgeId";break;case 106:editUrl="knowledgeManagement.markKnow",api="api/ms/richtextKnowledge/getKnowledge";break;case 107:editUrl="knowledgeManagement.recommendKnow",api="/api/ms/recommendMarketingKnowledge/getKnowledge"}!function(){knowledgeAddServer.getDataServer(api,{knowledgeId:$scope.vm.knowledgeId,applicationId:APPLICATION_ID},function(data){if(103==$scope.vm.knowledgeType){var data=data.data,table=data.knowledgeContents[0].knowledgeTable;data.knowledgeContents[0].knowledgeContent=table,delete data.knowledgeContents[0].knowledgeTable,$scope.vm.listData=data}else if(107==$scope.vm.knowledgeType){var data=data.data,tableCon=data.knowledgeContents[0].knowledgeContent,table=data.knowledgeContents[0].knowledgeTable;data.knowledgeContents[0].knowledgeContent=table,data.knowledgeContents[0].knowledgeContentTrue=tableCon,delete data.knowledgeContents[0].knowledgeTable,$scope.vm.listData=data,httpRequestPost("/api/ms/modeling/category/getcategoryfullname",{categoryId:data.extensionQuestions[0].extensionQuestionTitle},function(response){(response.status=1e4)&&$scope.$apply(function(){$scope.vm.listData.extensionQuestions[0].extensionQuestionName=response.categoryFullName})})}else $scope.vm.listData=data.data},function(){})}()}else;}]),angular.module("knowledgeManagementModule").controller("custPreviewRecycle",["$scope","localStorageService","$state","$stateParams","ngDialog","$cookieStore","knowledgeAddServer","$window","$http","myService","$timeout",function($scope,localStorageService,$state,$stateParams,ngDialog,$cookieStore,knowledgeAddServer,$window,$http,myService,$timeout){function searchKnowledgeList(index){httpRequestPost("/api/ms/knowledgeManage/overView/recycleKnowledgeList",{applicationId:APPLICATION_ID,index:(index-1)*$scope.vm.paginationConf.pageSize,pageSize:$scope.vm.paginationConf.pageSize,knowledgeTitle:$scope.vm.knowledgeTitle},function(data){$scope.$apply(function(){$scope.vm.recycleKnowledgeList=data.data,$scope.vm.total=data.data.total,$scope.vm.paginationConf.currentPage=index,$scope.vm.paginationConf.totalItems=data.data.total,$scope.vm.paginationConf.numberOfPages=data.data.total/$scope.vm.paginationConf.pageSize})})}function deleteOne(knowledgeId){layer.confirm("确认删除该条知识？",{btn:["确定","取消"]},function(){httpRequestPost("/api/ms/knowledgeManage/deleteKnowledge",{knowledgeIds:knowledgeId},function(data){200==data.status?(layer.msg("删除成功"),searchKnowledgeList(1)):500==data.status&&layer.msg("删除失败")},function(err){})},function(){})}function deleteAll(){if(!$scope.vm.knowledgeIds||0===$scope.vm.knowledgeIds.length)return void layer.msg("请选择删除知识",{time:800});layer.confirm("是否删除当前选中知识？",{btn:["确定","取消"]},function(){httpRequestPost("/api/ms/knowledgeManage/deleteKnowledge",{knowledgeIds:$scope.vm.knowledgeIds},function(data){$state.reload(),layer.msg("刪除成功",{time:1e3})},function(){layer.msg("刪除失败",{time:1e3})})},function(){})}function reductionOne(knowledgeId){layer.confirm("确认还原该知识？",{btn:["确定","取消"]},function(){httpRequestPost("/api/ms/knowledgeManage/restoreKnowledge",{knowledgeIds:knowledgeId},function(data){200==data.status?(layer.msg("还原成功"),searchKnowledgeList(1)):500==data.status&&layer.msg("还原失败")},function(err){})},function(){})}function reductionAll(knowledgeId){if(!$scope.vm.knowledgeIds||0===$scope.vm.knowledgeIds.length)return void layer.msg("请选择还原的知识",{time:1e3});layer.confirm("是否还原当前选中知识？",{btn:["确定","取消"]},function(){httpRequestPost("/api/ms//knowledgeManage/restoreKnowledge",{knowledgeIds:$scope.vm.knowledgeIds},function(data){$state.reload(),layer.msg("还原成功",{time:1e3})},function(){layer.msg("还原失败",{time:1e3})})},function(){})}function selectAll(){$scope.vm.isSelectAll?($scope.vm.isSelectAll=!1,$scope.vm.knowledgeIds=[]):($scope.vm.isSelectAll=!0,$scope.vm.knowledgeIds=[],angular.forEach($scope.vm.recycleKnowledgeList.objs,function(val){$scope.vm.knowledgeIds.push(val.knowledgeId)}))}function selectSingle(id){$scope.vm.knowledgeIds.inArray(id)?($scope.vm.knowledgeIds.remove(id),$scope.vm.isSelectAll=!1):$scope.vm.knowledgeIds.push(id),$scope.vm.knowledgeIds.length==$scope.vm.recycleKnowledgeList.objs.length&&($scope.vm.isSelectAll=!0)}$scope.vm={searchKnowledgeList:searchKnowledgeList,deleteOne:deleteOne,deleteAll:deleteAll,reductionOne:reductionOne,reductionAll:reductionAll,isSelectAll:!1,selectAll:selectAll,selectSingle:selectSingle,paginationConf:{pageSize:5,pagesLength:10},knowledgeTitle:"",recycleKnowledgeList:"",knowledgeIds:[],list:"",total:""},searchKnowledgeList(1);var timeout;$scope.$watch("vm.paginationConf.currentPage",function(current){current&&(timeout&&$timeout.cancel(timeout),timeout=$timeout(function(){searchKnowledgeList(current)},100))},!0)}]),angular.module("knowledgeManagementModule").controller("custOverviewController",["$scope","localStorageService","$state","$stateParams","ngDialog","$timeout","$cookieStore","$window","$rootScope",function($scope,localStorageService,$state,$stateParams,ngDialog,$timeout,$cookieStore,$window,$rootScope){function jumpToNewKonwledge(id){var addUrl=null;switch(id){case"100":addUrl="knowledgeManagement.faqAdd";break;case"101":addUrl="knowledgeManagement.singleAddConcept";break;case"102":addUrl="knowledgeManagement.listAdd";break;case"103":addUrl="knowledgeManagement.factorAdd";break;case"106":addUrl="knowledgeManagement.markKnow";break;case"107":addUrl="knowledgeManagement.recommendKnow";break;case"108":addUrl="knowledgeManagement.processKnow"}addUrl&&($state.go(addUrl),$scope.vm.newKnowledge="false")}function napSearch(type){getData(1),getNewNumber(),type&&$timeout(function(){$scope.vm.paramsReset()},500),$scope.vm.heighSarch=!1}function scan(item){var obj={};obj.applicationId=APPLICATION_ID,obj.knowledgeId=item.knowledgeId,obj.knowledgeType=item.knowledgeType,$window.knowledgeScan=obj;var url=$state.href("custKnowledgePreview.manage");$window.open(url,"_blank")}function getSourceType(val){$scope.vm.sourceType=val}function getUpdateTimeType(val){$scope.vm.updateTimeType=val}function exportExcel(){var scenceId=$scope.vm.sceneIds.length?$scope.vm.sceneIds:[],urlParams="?applicationId="+APPLICATION_ID+"&sceneIds="+scenceId+"&knowledgeTitle="+$scope.vm.knowledgeTitle+"&knowledgeContent="+$scope.vm.knowledgeContent+"&knowledgeCreator="+$scope.vm.knowledgeCreator+"&knowledgeExpDateEnd="+$scope.vm.knowledgeExpDateEnd+"&knowledgeExpDateStart="+$scope.vm.knowledgeExpDateStart+"&sourceType="+$scope.vm.sourceType+"&updateTimeType="+$scope.vm.updateTimeType,url="/api/ms/knowledgeManage/exportExcel"+urlParams;$window.open(url,"_blank")}function recycleBin(){$state.go("knowledgeManagement.recycleBin")}function getData(index){httpRequestPost("/api/ms/knowledgeManage/overView/searchList",{applicationId:APPLICATION_ID,index:(index-1)*$scope.vm.pageSize,pageSize:$scope.vm.pageSize,sceneIds:$scope.vm.sceneIds.length?$scope.vm.sceneIds:null,knowledgeTitle:$scope.vm.knowledgeTitle,knowledgeContent:$scope.vm.knowledgeContent,knowledgeUpdate:$scope.vm.knowledgeCreator,knowledgeExpDateEnd:$scope.vm.knowledgeExpDateEnd,knowledgeExpDateStart:$scope.vm.knowledgeExpDateStart,knowledgeOrigin:$scope.vm.sourceType,updateTimeType:$scope.vm.updateTimeType,knowledgeType:$scope.vm.knowledgeType,knowledgeExtensionQuestion:$scope.vm.searchExtension},function(data){return $scope.vm.isSelectAll=!1,$scope.vm.knowledgeIds=[],$scope.vm.listData=data.data.objs,$scope.vm.knowledgeTotal=data.data.total,$scope.vm.paginationConf={currentPage:index,totalItems:data.data.total,pageSize:$scope.vm.pageSize,pagesLength:10},$scope.$apply(),!0},function(err){})}function keySearch(e){var srcObj=e.srcElement?e.srcElement:e.target;13==(window.e?e.keyCode:e.which)&&(srcObj.blur(),napSearch(),srcObj.blur())}function paramsReset(){$scope.vm.knowledgeType="",$scope.vm.searchExtension="",$scope.vm.sceneIds=[],$scope.vm.knowledgeTitle=null,$scope.vm.knowledgeContent=null,$scope.vm.knowledgeUpdate=null,$scope.vm.knowledgeCreator=null,$scope.vm.knowledgeExpDateEnd=null,$scope.vm.knowledgeExpDateStart=null,$scope.vm.sourceType=0,$scope.vm.updateTimeType=0}function delData(){if(!$scope.vm.knowledgeIds||0===$scope.vm.knowledgeIds.length)return void layer.msg("请选择删除知识",{time:800});layer.confirm("是否删除当前选中知识？",{btn:["确定","取消"]},function(){httpRequestPost("/api/ms/knowledgeManage/recycleKnowledge",{knowledgeIds:$scope.vm.knowledgeIds},function(data){$state.reload(),layer.msg("刪除成功",{time:1e3})},function(){layer.msg("刪除失败",{time:1e3})})},function(){})}function selectAll(items){$scope.vm.isSelectAll?($scope.vm.isSelectAll=!1,$scope.vm.knowledgeIds=[]):($scope.vm.isSelectAll=!0,$scope.vm.knowledgeIds=[],angular.forEach(items,function(val){$scope.vm.knowledgeIds.push(val.knowledgeId)}))}function addDelIds(id,arr){arr.inArray(id)?(arr.remove(id),$scope.vm.isSelectAll=!1):arr.push(id)}function getNewNumber(){httpRequestPost(" /api/ms/knowledgeManage/overView/searchTotalAndToday",{applicationId:APPLICATION_ID,sceneIds:$scope.vm.sceneIds.length?$scope.vm.sceneIds:null,knowledgeTitle:$scope.vm.knowledgeTitle,knowledgeContent:$scope.vm.knowledgeContent,knowledgeUpdate:$scope.vm.knowledgeCreator,knowledgeExpDateEnd:$scope.vm.knowledgeExpDateEnd,knowledgeExpDateStart:$scope.vm.knowledgeExpDateStart,sourceType:$scope.vm.sourceType},function(data){return $scope.vm.newNumber=data.data.total,!0},function(err){})}$scope.vm={applicationName:$cookieStore.get("applicationName"),creatBot:[],frameCategoryId:"",botRoot:null,type:!0,listData:[],exportExcel:exportExcel,recycleBin:recycleBin,getData:getData,delData:delData,knowledgeTotal:null,newNumber:null,getNewNumber:getNewNumber,knowledgeIds:[],addDelIds:addDelIds,pageSize:5,sceneIds:[],knowledgeTitle:null,knowledgeContent:null,knowledgeCreator:null,knowledgeExpDateEnd:null,knowledgeExpDateStart:null,sourceType:0,updateTimeType:0,keySearch:keySearch,napSearch:napSearch,getSourceType:getSourceType,getUpdateTimeType:getUpdateTimeType,scan:scan,heighSarch:!1,knowledgeType:"",searchExtension:"",newKnowledge:"false",jumpToNewKonwledge:jumpToNewKonwledge,isSelectAll:!1,selectAll:selectAll,selectedBot:[],paramsReset:paramsReset},napSearch(!1),$scope.$watch("vm.heighSarch",function(val){val?angular.element(".advanced_search").slideDown():angular.element(".advanced_search").slideUp()});var timeout;$scope.$watch("vm.paginationConf.currentPage",function(current){current&&(timeout&&$timeout.cancel(timeout),timeout=$timeout(function(){getData(current)},100))},!0),$("body").on("click",function(e){e=event||window.event;var srcObj=e.srcElement?e.srcElement:e.target;$(srcObj).closest(".aside-nav").hasClass("aside-nav")?e.stopPropagation():($(".aside-nav").find(".type1").children("ul").slideUp(),$timeout(function(){$(".aside-nav").find(".type1").children("a").find(".icon-jj").css("backgroundPosition","0% 0%")},50))}),function(){httpRequestPost("/api/ms/modeling/category/listbycategorypid",{categoryApplicationId:APPLICATION_ID,categoryPid:"root"},function(data){$scope.vm.botRoot=data.data,$scope.$apply()},function(){})}(),$(".aside-nav").on("click","a",function(e){$scope.vm.paramsReset();var srcObj=e.srcElement?e.srcElement:e.target;if("I"!=srcObj.tagName){$(this).parent().hasClass("type1")||($(".botPathactiveMouse").removeClass("botPathactiveMouse"),$(".botPathactiveClick").removeClass("botPathactiveClick"),$(this).addClass("botPathactiveClick")),$(srcObj).closest("li").siblings().each(function(index,item){$(item).find("ul").hide().find(".icon-jj ").css("backgroundPosition","0% 0%")}),$(srcObj).closest("ul.menu_1").parent().siblings().each(function(index,item){$(item).find("ul.pas-menu_1").hide()});var id=angular.element(this).find("span").attr("data-option-id");$scope.vm.sceneIds.push(id),httpRequestPost("/api/ms/modeling/category/getcategoryfullname",{categoryId:id},function(data){$scope.vm.selectedBot=data.categoryFullName.split("/")},function(){}),httpRequestPost("/api/ms/modeling/category/listbycategorypid",{categoryApplicationId:APPLICATION_ID,categoryPid:id},function(data){angular.forEach(data.data,function(item){$scope.vm.sceneIds.push(item.categoryId)}),napSearch()},function(){}),$scope.$apply()}}),$(".aside-nav").on("click",".ngBotAdd",function(){var id=$(this).attr("data-option-id"),that=$(this),isEdg=that.hasClass("icon-ngJj");if(that.parent().hasClass("type1"))return!1;that.closest("ul").hasClass("pas-menu_1")||that.parent().parent().parent().siblings().each(function(index,item){$(item).find("ul").hide()}),that.parent().siblings().length?isEdg?(that.parent().next().slideToggle(),that.closest("li").siblings().each(function(index,item){$(item).find("ul").hide().find(".icon-jj ").css("backgroundPosition","0% 0%")}),that.closest("ul.menu_1").parent().siblings().each(function(index,item){$(item).find("ul.pas-menu_1").hide()})):"0% 0%"==that.css("backgroundPosition")?(that.css("backgroundPosition","0% 100%"),that.parent().next().slideDown()):(that.css("backgroundPosition","0% 0%"),that.parent().next().slideUp()):(isEdg?(that.closest("li").siblings().each(function(index,item){$(item).find("ul").hide().find(".icon-jj ").css("backgroundPosition","0% 0%")}),that.parent().parent().css("overflow","visible"),that.closest("ul.menu_1").parent().siblings().each(function(index,item){$(item).find("ul.pas-menu_1").hide()})):that.css("backgroundPosition","0% 100%"),httpRequestPost("/api/ms/modeling/category/listbycategorypid",{categoryApplicationId:APPLICATION_ID,categoryPid:id},function(data){if(data.data){var itemClassName=isEdg?"pas-menu_1":"menu_1",leafClassName=isEdg?"icon-jj":"icon-ngJj",html='<ul class="'+itemClassName+'" style="overflow:visible;">';angular.forEach(data.data,function(item){var typeClass;0==item.categoryLeaf&&"edge"!=item.categoryAttributeName?typeClass="bot-noBg":0!=item.categoryLeaf&&"edge"==item.categoryAttributeName?typeClass="bot-edge":0!=item.categoryLeaf&&"node"==item.categoryAttributeName&&(typeClass="icon-jj");var backImage;switch(item.categoryTypeId){case 160:backImage=" bot-divide";break;case 161:backImage=" bot-process";break;case 162:backImage=" bot-attr";break;case 163:backImage=" bot-default"}html+='<li data-option-id="'+item.categoryId+'" class="slide-a"><a class="ellipsis bg50" href="javascript:;"><i class="'+leafClassName+" "+backImage+" "+typeClass+' ngBotAdd" data-option-id="'+item.categoryId+'"></i><span data-option-id="'+item.categoryId+'">'+item.categoryName+"</span></a></li>"}),html+="</ul>",$(html).appendTo(that.parent().parent()),$timeout(function(){that.parents().next().slideDown()},50)}},function(err){}))}),$(".aside-nav").on("mouseenter",".ellipsis",function(){var self=$(this);if(self.parent().hasClass("type1"))return!1;self.hasClass("botPathactiveClick")||$(this).addClass("botPathactiveMouse")}),$(".aside-nav").on("mouseout",".ellipsis",function(){var self=$(this);if(self.parent().hasClass("type1"))return!1;self.hasClass("botPathactiveClick")||self.removeClass("botPathactiveMouse")})}]),angular.module("knowledgeManagementModule").controller("markPreviewController",["$scope","localStorageService","$state","$stateParams","ngDialog","$cookieStore","knowledgeAddServer","$window",function($scope,localStorageService,$state,$stateParams,ngDialog,$cookieStore,knowledgeAddServer,$window){function edit(){$state.go("knowledgeManagement.conceptAdd",{data:$scope.vm.listData})}function getData(){httpRequestPost("/api/ms/conceptKnowledge/getKnowledge",{knowledgeId:$scope.vm.knowledgeId,applicationId:APPLICATION_ID},function(data){$scope.vm.listData=data.data,$scope.$apply()},function(){})}if($stateParams.knowledgeId){$window.opener.knowledgeScan;$scope.vm={knowledgeId:$stateParams.knowledgeId,knowledgeType:$stateParams.knowledgeType,listData:null,edit:edit},knowledgeAddServer.getDimensions({applicationId:APPLICATION_ID},function(data){data.data&&($scope.vm.dimensions=data.data)},function(error){}),knowledgeAddServer.getChannels({applicationId:APPLICATION_ID},function(data){data.data&&($scope.vm.channels=data.data)},function(error){}),getData()}else $state.go("knowledgeManagement.markOverview")}]),angular.module("knowledgeManagementModule").controller("markOverviewController",["$scope","localStorageService","$state","$stateParams","ngDialog","$timeout","$cookieStore","$window",function($scope,localStorageService,$state,$stateParams,ngDialog,$timeout,$cookieStore,$window){function exportExcel(){var scenceId=$scope.vm.sceneIds.length?$scope.vm.sceneIds:[],urlParams="?applicationId="+APPLICATION_ID+"&sceneIds="+scenceId+"&knowledgeTitle="+$scope.vm.knowledgeTitle+"&knowledgeContent="+$scope.vm.knowledgeContent+"&knowledgeCreator="+$scope.vm.knowledgeCreator+"&knowledgeExpDateEnd="+$scope.vm.knowledgeExpDateEnd+"&knowledgeExpDateStart="+$scope.vm.knowledgeExpDateStart+"&sourceType="+$scope.vm.sourceType+"&updateTimeType="+$scope.vm.updateTimeType,url="/api/ms/knowledgeManage/exportExcel"+urlParams;$window.open(url,"_blank")}function napSearch(type){getData(1),getNewNumber(),type&&$timeout(function(){$scope.vm.paramsReset()},500),$scope.vm.heighSarch=!1}function scan(item){var obj={};obj.applicationId=APPLICATION_ID,obj.knowledgeId=item.knowledgeId,obj.knowledgeType="104",$window.knowledgeScan=obj;var url=$state.href("markKnowledgePreview.manage");$window.open(url,"_blank")}function getSourceType(val){$scope.vm.sourceType=val}function getUpdateTimeType(val){$scope.vm.updateTimeType=val}function getData(index){httpRequestPost("/api/ms/knowledgeManage/overView/searchList",{applicationId:APPLICATION_ID,index:(index-1)*$scope.vm.pageSize,pageSize:$scope.vm.pageSize,sceneIds:$scope.vm.sceneIds.length?$scope.vm.sceneIds:null,knowledgeTitle:$scope.vm.knowledgeTitle,knowledgeContent:$scope.vm.knowledgeContent,knowledgeCreator:$scope.vm.knowledgeCreator,knowledgeExpDateEnd:$scope.vm.knowledgeExpDateEnd,knowledgeExpDateStart:$scope.vm.knowledgeExpDateStart,sourceType:$scope.vm.sourceType,updateTimeType:$scope.vm.updateTimeType},function(data){return $scope.vm.isSelectAll=!1,$scope.vm.knowledgeIds=[],$scope.vm.listData=data.data.objs,$scope.vm.knowledgeTotal=data.data.total,$scope.vm.paginationConf={currentPage:index,totalItems:data.data.total,pageSize:$scope.vm.pageSize,pagesLength:10},$scope.$apply(),!0},function(){})}function keySearch(e){var srcObj=e.srcElement?e.srcElement:e.target;13==(window.e?e.keyCode:e.which)&&(srcObj.blur(),napSearch(),srcObj.blur())}function paramsReset(){$scope.vm.sceneIds=[],$scope.vm.knowledgeTitle=null,$scope.vm.knowledgeContent=null,$scope.vm.knowledgeCreator=null,$scope.vm.knowledgeExpDateEnd=null,$scope.vm.knowledgeExpDateStart=null,$scope.vm.sourceType=0,$scope.vm.updateTimeType=0}function selectAll(items){$scope.vm.isSelectAll?($scope.vm.isSelectAll=!1,$scope.vm.knowledgeIds=[]):($scope.vm.isSelectAll=!0,$scope.vm.knowledgeIds=[],angular.forEach(items,function(val){$scope.vm.knowledgeIds.push(val.knowledgeId)}))}function addDelIds(id,arr){arr.inArray(id)?(arr.remove(id),$scope.vm.isSelectAll=!1):arr.push(id)}function delData(){$scope.vm.knowledgeIds&&0!==$scope.vm.knowledgeIds.length?layer.confirm("是否删除当前选中知识？",{btn:["确定","取消"]},function(){httpRequestPost("/api/ms/knowledgeManage/deleteKnowledge",{knowledgeIds:$scope.vm.knowledgeIds},function(data){$state.reload(),layer.msg("刪除成功",{time:1e3})},function(){layer.msg("刪除失败",{time:1e3})})},function(){}):layer.msg("请选择删除知识",{time:800})}function getNewNumber(){httpRequestPost(" /api/ms/knowledgeManage/overView/searchTotalAndToday",{applicationId:APPLICATION_ID,sceneIds:$scope.vm.sceneIds.length?$scope.vm.sceneIds:null,knowledgeTitle:$scope.vm.knowledgeTitle,knowledgeContent:$scope.vm.knowledgeContent,knowledgeCreator:$scope.vm.knowledgeCreator,knowledgeExpDateEnd:$scope.vm.knowledgeExpDateEnd,knowledgeExpDateStart:$scope.vm.knowledgeExpDateStart,sourceType:$scope.vm.sourceType},function(data){return $scope.vm.newNumber=data.data.total,!0},function(){layer.msg("查找今日新增条数失败")})}$scope.vm={applicationName:$cookieStore.get("applicationName"),exportExcel:exportExcel,creatBot:[],frameCategoryId:"",botRoot:null,type:!0,listData:[],getData:getData,delData:delData,knowledgeTotal:null,newNumber:null,getNewNumber:getNewNumber,knowledgeIds:[],addDelIds:addDelIds,pageSize:5,sceneIds:[],knowledgeTitle:null,knowledgeContent:null,knowledgeCreator:null,knowledgeExpDateEnd:null,knowledgeExpDateStart:null,sourceType:0,updateTimeType:0,keySearch:keySearch,napSearch:napSearch,getSourceType:getSourceType,getUpdateTimeType:getUpdateTimeType,scan:scan,heighSarch:!1,selectAll:selectAll,isSelectAll:!1,paramsReset:paramsReset},napSearch(!1),$scope.$watch("vm.heighSarch",function(val){val?angular.element(".advanced_search").slideDown():angular.element(".advanced_search").slideUp()}),getData(1);var timeout;$scope.$watch("vm.paginationConf.currentPage",function(current){current&&(timeout&&$timeout.cancel(timeout),timeout=$timeout(function(){getData(current)},100))},!0),$("body").on("click",function(e){e=event||window.event;var srcObj=e.srcElement?e.srcElement:e.target;$(srcObj).closest(".aside-nav").hasClass("aside-nav")?e.stopPropagation():($(".aside-nav").find(".type1").children("ul").slideUp(),$timeout(function(){$(".aside-nav").find(".type1").children("a").find(".icon-jj").css("backgroundPosition","0% 0%")},50))}),function(){httpRequestPost("/api/ms/modeling/category/listbycategorypid",{categoryApplicationId:APPLICATION_ID,categoryPid:"root"},function(data){$scope.vm.botRoot=data.data,$scope.$apply()},function(){})}(),$(".aside-nav").on("click","a",function(e){if($scope.vm.paramsReset(),"I"!=(e.srcElement?e.srcElement:e.target).tagName){$(this).parent().hasClass("type1")||($(".botPathactiveMouse").removeClass("botPathactiveMouse"),$(".botPathactiveClick").removeClass("botPathactiveClick"),$(this).addClass("botPathactiveClick"));var id=angular.element(this).find("span").attr("data-option-id");$scope.vm.sceneIds.push(id),httpRequestPost("/api/ms/modeling/category/getcategoryfullname",{categoryId:id},function(data){$scope.vm.selectedBot=data.categoryFullName.split("/")},function(){}),httpRequestPost("/api/ms/modeling/category/listbycategorypid",{categoryApplicationId:APPLICATION_ID,categoryPid:id},function(data){angular.forEach(data.data,function(item){$scope.vm.sceneIds.push(item.categoryId)}),napSearch()},function(){}),$scope.$apply()}}),$(".aside-nav").on("click",".ngBotAdd",function(){var id=$(this).attr("data-option-id"),that=$(this),isEdg=that.hasClass("icon-ngJj");if(that.parent().hasClass("type1"))return!1;that.closest("ul").hasClass("pas-menu_1")||that.parent().parent().parent().siblings().each(function(index,item){$(item).find("ul").hide()}),that.parent().siblings().length?isEdg?(that.parent().next().slideToggle(),that.closest("li").siblings().each(function(index,item){$(item).find("ul").hide().find(".icon-jj ").css("backgroundPosition","0% 0%")}),that.closest("ul.menu_1").parent().siblings().each(function(index,item){$(item).find("ul.pas-menu_1").hide()})):"0% 0%"==that.css("backgroundPosition")?(that.css("backgroundPosition","0% 100%"),that.parent().next().slideDown()):(that.css("backgroundPosition","0% 0%"),that.parent().next().slideUp()):(isEdg?(that.closest("li").siblings().each(function(index,item){$(item).find("ul").hide().find(".icon-jj ").css("backgroundPosition","0% 0%")}),that.closest("ul.menu_1").parent().siblings().each(function(index,item){$(item).find("ul.pas-menu_1").hide()})):that.css("backgroundPosition","0% 100%"),httpRequestPost("/api/ms/modeling/category/listbycategorypid",{categoryApplicationId:APPLICATION_ID,categoryPid:id},function(data){if(data.data){var itemClassName=isEdg?"pas-menu_1":"menu_1",leafClassName=isEdg?"icon-jj":"icon-ngJj",html='<ul class="'+itemClassName+'">';angular.forEach(data.data,function(item){var typeClass;0==item.categoryLeaf&&"edge"!=item.categoryAttributeName?typeClass="bot-noBg":0!=item.categoryLeaf&&"edge"==item.categoryAttributeName?typeClass="bot-edge":0!=item.categoryLeaf&&"node"==item.categoryAttributeName&&(typeClass="icon-jj");var backImage;switch(item.categoryTypeId){case 160:backImage=" bot-divide";break;case 161:backImage=" bot-process";break;case 162:backImage=" bot-attr";break;case 163:backImage=" bot-default"}html+='<li data-option-id="'+item.categoryId+'" class="slide-a"><a class="ellipsis bg50" href="javascript:;"><i class="'+leafClassName+" "+backImage+" "+typeClass+' ngBotAdd" data-option-id="'+item.categoryId+'"></i><span data-option-id="'+item.categoryId+'">'+item.categoryName+"</span></a></li>"}),html+="</ul>",$(html).appendTo(that.parent().parent()),$timeout(function(){that.parents().next().slideDown()},50)}},function(err){}))}),$(".aside-nav").on("mouseenter",".ellipsis",function(){var self=$(this);if(self.parent().hasClass("type1"))return!1;self.hasClass("botPathactiveClick")||$(this).addClass("botPathactiveMouse")}),$(".aside-nav").on("mouseout",".ellipsis",function(){var self=$(this);if(self.parent().hasClass("type1"))return!1;self.hasClass("botPathactiveClick")||self.removeClass("botPathactiveMouse")})}]),angular.module("knowledgeManagementModule").controller("knowledgeAuditController",["$scope","localStorageService","$state","$stateParams","ngDialog","$cookieStore","knowledgeAddServer","$window","$http","myService","$timeout",function($scope,localStorageService,$state,$stateParams,ngDialog,$cookieStore,knowledgeAddServer,$window,$http,myService,$timeout){function searchKnowledgeList(index){httpRequestPost("/api/ms/knowledgeManage/overView/pendingAuditKnowledgeList",{index:(index-1)*$scope.vm.paginationConf.pageSize,pageSize:$scope.vm.paginationConf.pageSize,knowledgeTitle:$scope.vm.knowledgeTitle,statusId:3},function(data){$scope.$apply(function(){$scope.vm.knowledgeList=data.data,$scope.vm.total=data.data.total,$scope.vm.paginationConf.currentPage=index,$scope.vm.paginationConf.totalItems=data.data.total,$scope.vm.paginationConf.numberOfPages=data.data.total/$scope.vm.paginationConf.pageSize})})}function auditPassedOrNopass(statusId){if(""==$scope.vm.reason&&4==statusId)return layer.msg("请填写不通过理由！！！"),!1;httpRequestPost("/api/ms/knowledgeManage/overView/auditPassed",{statusId:statusId,reason:$scope.vm.reason,knowledgeIds:[$scope.vm.knowledgeId],knowledgeUpdate:USER_LOGIN_NAME},function(data){200==data.status&&1==statusId?(layer.msg("审核成功,请在知识总览查看",{time:2e3}),$state.reload()):200==data.status&&4==statusId&&(layer.msg(data.info),$state.reload())})}function selectAll(){$scope.vm.isSelectAll?($scope.vm.isSelectAll=!1,$scope.vm.knowledgeIds=[]):($scope.vm.isSelectAll=!0,$scope.vm.knowledgeIds=[],angular.forEach($scope.vm.knowledgeList.objs,function(val){$scope.vm.knowledgeIds.push(val.knowledgeId)}))}function selectSingle(id){$scope.vm.knowledgeIds.inArray(id)?($scope.vm.knowledgeIds.remove(id),$scope.vm.isSelectAll=!1):$scope.vm.knowledgeIds.push(id),$scope.vm.knowledgeIds.length==$scope.vm.knowledgeList.objs.length&&($scope.vm.isSelectAll=!0)}function auditPass(){if(!$scope.vm.knowledgeIds||0===$scope.vm.knowledgeIds.length)return void layer.msg("请选择审核知识",{time:800});layer.confirm("是否审核当前选中知识？",{btn:["确定","取消"]},function(){httpRequestPost("/api/ms/knowledgeManage/overView/auditPassed",{statusId:1,reason:$scope.vm.reason,knowledgeIds:$scope.vm.knowledgeIds,knowledgeUpdate:USER_LOGIN_NAME},function(data){$state.reload(),layer.msg("审核成功,请在知识总览查看",{time:2e3})},function(){layer.msg("审核失败",{time:1e3})})},function(){})}function auditNopass(){if(!$scope.vm.knowledgeIds||0===$scope.vm.knowledgeIds.length)return layer.msg("请选择审核知识",{time:800}),!1;ngDialog.openConfirm({template:"/static/knowledgeManagement/knowledgeAudit/auditNopass.html",width:"650px",scope:$scope,closeByNavigation:!1,overlay:!0,closeByDocument:!1,closeByEscape:!0,showClose:!0,preCloseCallback:function(e){if(3==e){if(""==$scope.vm.reason)return layer.msg("请填写不通过理由！！！"),!1;httpRequestPost("/api/ms/knowledgeManage/overView/auditPassed",{statusId:4,reason:$scope.vm.reason,knowledgeIds:$scope.vm.knowledgeIds,knowledgeUpdate:USER_LOGIN_NAME},function(data){200==data.status&&(layer.msg(data.info),$state.reload())})}}})}function auditDetails(knowledgeType,knowledgeId,statusId){if($scope.vm.knowledgeType=parseInt(knowledgeType),$scope.vm.knowledgeId=knowledgeId,$scope.vm.statusId=statusId,"108"==$scope.vm.knowledgeType)$state.go("knowledgeManagement.auditProcessKnow",{knowledgeId:$scope.vm.knowledgeId,knowledgeType:$scope.vm.statusId});else{detailsMessage();ngDialog.openConfirm({template:"/static/knowledgeManagement/knowledgeAudit/custPreview.html",width:"650px",scope:$scope,closeByNavigation:!1,overlay:!0,closeByDocument:!1,closeByEscape:!0,showClose:!0,preCloseCallback:function(e){if(1==e)auditPassedOrNopass(1);else if(0==e){if(""==$scope.vm.reason)return layer.msg("请填写不通过理由！！！"),!1;auditPassedOrNopass(4)}}})}}function detailsMessage(){knowledgeAddServer.getDimensions({applicationId:APPLICATION_ID},function(data){data.data&&($scope.vm.dimensions=data.data)},function(error){}),knowledgeAddServer.getChannels({applicationId:APPLICATION_ID},function(data){data.data&&($scope.vm.channels=data.data)},function(error){});var api;switch($scope.vm.knowledgeType){case 100:"knowledgeManagement.faqAdd",api="/api/ms/faqKnowledge/getKnowledge";break;case 101:"knowledgeManagement.singleAddConcept",api="/api/ms/conceptKnowledge/getKnowledge";break;case 102:"knowledgeManagement.listAdd",api="/api/ms/conceptKnowledge/getKnowledge";break;case 103:"knowledgeManagement.factorAdd",api="/api/ms/elementKnowledgeAdd/findElementKnowledgeByKnowledgeId";break;case 106:"knowledgeManagement.markKnow",api="api/ms/richtextKnowledge/getKnowledge";break;case 107:"knowledgeManagement.recommendKnow",api="/api/ms/recommendMarketingKnowledge/getKnowledge";break;case 108:api="knowledgeManagement.processKnow"}!function(){knowledgeAddServer.getDataServer(api,{knowledgeId:$scope.vm.knowledgeId,applicationId:APPLICATION_ID},function(data){if(103==$scope.vm.knowledgeType){var data=data.data,table=data.knowledgeContents[0].knowledgeTable;data.knowledgeContents[0].knowledgeContent=table,delete data.knowledgeContents[0].knowledgeTable,$scope.vm.listData=data}else if(107==$scope.vm.knowledgeType){var data=data.data,tableCon=data.knowledgeContents[0].knowledgeContent,table=data.knowledgeContents[0].knowledgeTable;data.knowledgeContents[0].knowledgeContent=table,data.knowledgeContents[0].knowledgeContentTrue=tableCon,delete data.knowledgeContents[0].knowledgeTable,$scope.vm.listData=data,httpRequestPost("/api/ms/modeling/category/getcategoryfullname",{categoryId:data.extensionQuestions[0].extensionQuestionTitle},function(response){(response.status=1e4)&&$scope.$apply(function(){$scope.vm.listData.extensionQuestions[0].extensionQuestionName=response.categoryFullName})})}else $scope.vm.listData=data.data},function(){})}()}$scope.vm={searchKnowledgeList:searchKnowledgeList,auditDetails:auditDetails,isSelectAll:!1,selectAll:selectAll,selectSingle:selectSingle,auditPass:auditPass,auditNopass:auditNopass,auditPassedOrNopass:auditPassedOrNopass,paginationConf:{pageSize:5,pagesLength:10},knowledgeTitle:"",knowledgeList:"",knowledgeIds:[],list:"",total:"",knowledgeType:"",knowledgeId:"",dimensions:"",channels:"",reason:""},searchKnowledgeList(1);var timeout;$scope.$watch("vm.paginationConf.currentPage",function(current){current&&(timeout&&$timeout.cancel(timeout),timeout=$timeout(function(){searchKnowledgeList(current)},100))},!0)}]),angular.module("knowledgeManagementModule").controller("knowledgeAuditFailedController",["$scope","localStorageService","$state","$stateParams","ngDialog","$cookieStore","knowledgeAddServer","$window","$http","myService","$timeout",function($scope,localStorageService,$state,$stateParams,ngDialog,$cookieStore,knowledgeAddServer,$window,$http,myService,$timeout){function searchKnowledgeList(index){httpRequestPost("/api/ms/knowledgeManage/overView/pendingAuditKnowledgeList",{index:(index-1)*$scope.vm.paginationConf.pageSize,pageSize:$scope.vm.paginationConf.pageSize,knowledgeTitle:$scope.vm.knowledgeTitle,knowledgeCreator:USER_LOGIN_NAME,statusId:4},function(data){$scope.$apply(function(){$scope.vm.knowledgeList=data.data,$scope.vm.total=data.data.total,$scope.vm.paginationConf.currentPage=index,$scope.vm.paginationConf.totalItems=data.data.total,$scope.vm.paginationConf.numberOfPages=data.data.total/$scope.vm.paginationConf.pageSize})})}function auditDetails(){$scope.vm.knowledgeType=103,$scope.vm.knowledgeId=0x61611c029801000,detailsMessage();ngDialog.openConfirm({template:"/static/knowledgeManagement/knowledgeAudit/custPreview.html",width:"650px",scope:$scope,closeByNavigation:!1,overlay:!0,closeByDocument:!1,closeByEscape:!0,showClose:!0,preCloseCallback:function(e){detailsMessage()}})}function selectAll(){$scope.vm.isSelectAll?($scope.vm.isSelectAll=!1,$scope.vm.knowledgeIds=[]):($scope.vm.isSelectAll=!0,$scope.vm.knowledgeIds=[],angular.forEach($scope.vm.knowledgeList.objs,function(val){$scope.vm.knowledgeIds.push(val.knowledgeId)}))}function selectSingle(id){$scope.vm.knowledgeIds.inArray(id)?($scope.vm.knowledgeIds.remove(id),$scope.vm.isSelectAll=!1):$scope.vm.knowledgeIds.push(id),$scope.vm.knowledgeIds.length==$scope.vm.knowledgeList.objs.length&&($scope.vm.isSelectAll=!0)}function deleteOne(knowledgeIds){layer.confirm("是否删除当前选中知识？",{btn:["确定","取消"]},function(){httpRequestPost("/api/ms/knowledgeManage/deleteKnowledge",{knowledgeIds:knowledgeIds},function(data){$state.reload(),layer.msg("刪除成功",{time:1e3})},function(){layer.msg("刪除失败",{time:1e3})})},function(){})}function delData(){if(!$scope.vm.knowledgeIds||0===$scope.vm.knowledgeIds.length)return void layer.msg("请选择删除知识",{time:800});layer.confirm("是否删除当前选中知识？",{btn:["确定","取消"]},function(){httpRequestPost("/api/ms/knowledgeManage/deleteKnowledge",{knowledgeIds:$scope.vm.knowledgeIds},function(data){$state.reload(),layer.msg("刪除成功",{time:1e3})},function(){layer.msg("刪除失败",{time:1e3})})},function(){})}$scope.vm={searchKnowledgeList:searchKnowledgeList,auditDetails:auditDetails,isSelectAll:!1,selectAll:selectAll,selectSingle:selectSingle,deleteOne:deleteOne,delData:delData,paginationConf:{pageSize:5,pagesLength:10},knowledgeTitle:"",knowledgeList:"",knowledgeIds:[],list:"",total:"",knowledgeType:"",knowledgeId:"",dimensions:"",channels:""},searchKnowledgeList(1);var timeout;$scope.$watch("vm.paginationConf.currentPage",function(current){current&&(timeout&&$timeout.cancel(timeout),timeout=$timeout(function(){searchKnowledgeList(current)},100))},!0)}]),angular.module("knowledgeManagementModule").controller("knowledgeScanController",["$scope","localStorageService","$state","$stateParams","ngDialog","$cookieStore","$location","$rootScope","knowledgeAddServer","$window",function($scope,localStorageService,$state,$stateParams,ngDialog,$cookieStore,$location,$rootScope,knowledgeAddServer,$window){function save(){httpRequestPost(knowledgeScan.api,$scope.vm.knowledgeData,function(data){200==data.status?""==$stateParams.data?($state.go("knowledgeManagement.custOverview"),layer.msg("新增知识已进入审核列表",{time:2e3})):$stateParams.data&&4==angular.fromJson($stateParams.data).knowledgeBase.statusId?($state.go("knowledgeManagement.custOverview"),layer.msg("编辑知识已进入审核列表",{time:2e3})):$state.go("knowledgeManagement.custOverview"):10002==data.status&&layer.msg(" 添加知识标题重复,请返回修改 ")},function(err){})}var knowledgeScan=$window.opener.knowledgeScan;$scope.vm={knowledgeType:knowledgeScan.params.knowledgeType,listData:null,knowledgeData:knowledgeScan.params,dimensions:"",channels:"",editUrl:knowledgeScan.editUrl,save:save,tableData:103==knowledgeScan.knowledgeType||107==knowledgeScan.knowledgeType?JSON.parse(knowledgeScan.params.knowledgeContents[0].knowledgeContent):""},$scope.master.getDimensions($scope,["dimensions"]),$scope.master.getChannels($scope,["channels"])}]),angular.module("knowledgeManagementModule").controller("knowManaListController",["$scope","localStorageService","$state","ngDialog","$cookieStore","$timeout","$compile","FileUploader","knowledgeAddServer","$window","$stateParams","$interval","$filter","$animate",function($scope,localStorageService,$state,ngDialog,$cookieStore,$timeout,$compile,FileUploader,knowledgeAddServer,$window,$stateParams,$interval,$filter,$animate){function getFrame(id){httpRequestPost("/api/ms/modeling/frame/listbyattribute",{frameCategoryId:id,frameEnableStatusId:1,frameTypeId:10012,index:0,pageSize:999999},function(data){10005!=data.status&&data.data.length&&($scope.vm.frames=$scope.vm.frames.concat(data.data),$scope.$apply())},function(){})}function getExtensionByFrame(id,type){httpRequestPost("/api/ms/modeling/frame/listbyattribute",{frameTypeId:10012,frameId:id,index:0,pageSize:999999},function(data){if(1e4==data.status){var obj={};data.data[0].elements&&angular.forEach(data.data[0].elements,function(item,index){var extensionQuestionList=[],frameQuestionTagList=[];obj={extensionQuestionType:60,extensionQuestionTitle:data.data[0].frameTitle},extensionQuestionList.push(item.elementContent.substring(0,item.elementContent.indexOf("#"))),frameQuestionTagList.push(item.elementContent.substring(item.elementContent.indexOf("#")+1).split("；")),checkExtensionByFrame(extensionQuestionList,frameQuestionTagList,obj)}),$scope.$apply()}})}function getBotFullPath(id){httpRequestPost("/api/ms/modeling/category/getcategoryfullname",{categoryId:id},function(data){if(data.status=1e4){var allBot=angular.copy($scope.vm.creatSelectBot.concat($scope.vm.botClassfy)),botResult=$scope.master.isBotRepeat(id,data.categoryFullName.split("/"),"",allBot);$scope.$apply(function(){$scope.vm.knowledgeBotVal=data.categoryFullName,0!=botResult&&($scope.vm.botFullPath=botResult)})}})}function checkExtensionByFrame(extensionQuestionList,frameQuestionTagList,oldWord){var title=extensionQuestionList[0],weight=oldWord.extensionQuestionType,isLocalHasExt=addLocalExtension(title);if(isLocalHasExt)return void $scope.vm.extensionsByFrame.push(isLocalHasExt);httpRequestPost("/api/ms/listKnowledge/checkFrameTag",{applicationId:APPLICATION_ID,extensionQuestionList:extensionQuestionList,frameQuestionTagList:frameQuestionTagList},function(data){200==data.status&&$scope.$apply(function(){var allExtension=$scope.vm.extensions.concat($scope.vm.extensionsByFrame,$scope.vm.extensionByTitleTag),result=$scope.master.isExtensionTagRepeat(data.data,allExtension,title,weight);1!=result&&($scope.vm.extensionTitle="",$scope.vm.extensionsByFrame.push(result))})})}function getExtension(title,weight,source){var isLocalHasExt=addLocalExtension(title);if(isLocalHasExt)return void(source?$scope.vm.extensionByTitleTag=new Array(isLocalHasExt):$scope.vm.extensions.push(isLocalHasExt));var question=new Array(title),obj={extensionQuestionTitle:$scope.vm.extensionTitle,extensionQuestionType:$scope.vm.extensionWeight};if(title){if(!checkExtensionByTitle(obj))return layer.msg("生成扩展问重复,已阻止添加"),!1;httpRequestPost("/api/ms/listKnowledge/checkExtensionQuestion",{applicationId:APPLICATION_ID,extendQuestionList:question},function(data){500==data.status?layer.msg(data.data):10026==data.status?layer.msg("扩展问添加重复，请重新添加"):200==data.status&&$scope.$apply(function(){var allExtension=$scope.vm.extensions.concat($scope.vm.extensionsByFrame,$scope.vm.extensionByTitleTag),result=$scope.master.isExtensionTagRepeat(data.data,allExtension,title,weight);1!=result&&($scope.vm.extensionTitle="",source?$scope.vm.extensionByTitleTag=new Array(result):$scope.vm.extensions.push(result))})},function(){})}else layer.msg("扩展问不能为空")}function botSelectAdd(){$scope.vm.botFullPath&&($scope.vm.creatSelectBot.push($scope.vm.botFullPath),$scope.vm.frameCategoryId=$scope.vm.botFullPath.classificationId,$scope.vm.botFullPath="",$scope.vm.knowledgeBotVal="")}function extensionEdit(type,item,index){($scope.vm.backupsOfExtension=angular.copy(item),0==angular.element(".ngdialog ").length)&&ngDialog.openConfirm({template:"/static/knowledgeManagement/public-html/extension_edit.html",width:"500px",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){1===e?1==type?$scope.vm.extensionsByFrame[index]=$scope.vm.backupsOfExtension:0==type?$scope.vm.extensions[index]=$scope.vm.backupsOfExtension:2==type&&($scope.vm.extensionByTitleTag[index]=$scope.vm.backupsOfExtension):$scope.vm.backupsOfExtension=""}})}function slideDown(){$scope.vm.slideFlag=!$scope.vm.slideFlag,$(".senior_div").slideToggle(),$scope.vm.slideFlag&&$(".senior_div").css("overflow","visible")}function getBotAndExtensionByTitle(){getExtension($scope.vm.title,"60",1),$scope.vm.title&&$scope.vm.sourceTitle!=$scope.vm.title?httpRequestPost("/api/ms/listKnowledge/checkKnowledgeTitleAndGetAutoClassify",{title:$scope.vm.title,applicationId:APPLICATION_ID,knowledgeId:$scope.vm.knowledgeId},function(data){500==data.status?($scope.vm.titleTip="知识标题重复",$scope.$apply()):200==data.status&&$scope.$apply(function(){$scope.vm.knowledgeTitleTag=data.data.knowledgeTitleTagList,$scope.vm.botClassfy=[];var allBot=angular.copy($scope.vm.creatSelectBot);angular.forEach(data.data.classifyList,function(item){var botResult=$scope.master.isBotRepeat(item.id,item.fullPath,item.type,allBot);0!=botResult&&$scope.vm.botClassfy.push(botResult),$scope.vm.frameCategoryId=item.id})})}):$scope.vm.sourceTitle==$scope.vm.title?getExtension($scope.vm.title,"60",1):$scope.vm.titleTip="知识标题不能为空"}function getParams(){var params={applicationId:APPLICATION_ID,userId:USER_ID,sceneId:SCENE_ID,knowledgeType:102,knowledgeTitle:$scope.vm.title,knowledgeExpDateStart:$scope.vm.isTimeTable?$scope.vm.timeStart:"",knowledgeExpDateEnd:$scope.vm.isTimeTable?$scope.vm.timeEnd:"",knowledgeTitleTag:$scope.vm.knowledgeTitleTag,knowledgeUpdater:USER_LOGIN_NAME,knowledgeCreator:USER_LOGIN_NAME,knowledgeOrigin:$scope.vm.knowledgeOrigin},obj={};return obj.knowledgeContent=$scope.vm.newTitle,obj.knowledgeContentNegative=$scope.vm.knowledgeContentNegative,obj.channelIdList=$scope.vm.channel,$scope.vm.dimensionArr.id.length||($scope.vm.dimensionArr=angular.copy($scope.vm.dimensionsCopy)),obj.dimensionIdList=$scope.vm.dimensionArr.id.length?$scope.vm.dimensionArr.id:$scope.vm.dimensionsCopy.id,obj.knowledgeRelatedQuestionOn=$scope.vm.question,obj.knowledgeBeRelatedOn=$scope.vm.tip,obj.knowledgeCommonOn=$scope.vm.tail,obj.knowledgeRelevantContentList=$scope.vm.appointRelativeGroup,$scope.vm.scanContent=[],$scope.vm.scanContent.push(obj),params.knowledgeContents=$scope.vm.scanContent,params.extensionQuestions=$scope.vm.extensions.concat($scope.vm.extensionsByFrame,$scope.vm.extensionByTitleTag),params.classificationAndKnowledgeList=$scope.vm.botClassfy.concat($scope.vm.creatSelectBot),params}function save(){if(!checkSave())return!1;if(!$scope.vm.limitSave){$timeout.cancel(limitTimer),$scope.vm.limitSave=!0,limitTimer=$timeout(function(){$scope.vm.limitSave=!1},18e4);var api,params=getParams();$scope.vm.knowledgeId?(api="/api/ms/listKnowledge/editKnowledge",params.knowledgeId=$scope.vm.knowledgeId):api="/api/ms/listKnowledge/addListKnowledge",httpRequestPost(api,params,function(data){200==data.status?""==$stateParams.data?($state.go("knowledgeManagement.custOverview"),layer.msg("新增知识已进入审核列表",{time:2e3})):$stateParams.data&&4==angular.fromJson($stateParams.data).knowledgeBase.statusId?($state.go("knowledgeManagement.custOverview"),layer.msg("编辑知识已进入审核列表",{time:2e3})):$state.go("knowledgeManagement.custOverview"):500==data.status&&(layer.msg("知识保存失败"),$timeout.cancel(limitTimer),$scope.$apply(function(){$scope.vm.limitSave=!1}))},function(err){$timeout.cancel(limitTimer),$scope.$apply(function(){$scope.vm.limitSave=!1})})}}function scan(){if(!checkSave())return!1;var obj={},params=getParams();obj.params=params,obj.knowledgeType=102,obj.knowledgeId=$scope.vm.knowledgeId,$scope.vm.knowledgeId?(obj.api="/api/ms/listKnowledge/editKnowledge",params.knowledgeId=$scope.vm.knowledgeId):obj.api="/api/ms/listKnowledge/addListKnowledge",obj.editUrl="knowledgeManagement.listAdd",$window.knowledgeScan=obj;var url=$state.href("knowledgeManagement.knowledgeScan");$window.open(url,"_blank")}function selectChannel(channelId){$scope.vm.channel.inArray(channelId)?$scope.vm.channel.remove(channelId):$scope.vm.channel.push(channelId)}function backUpExt(item){$scope.vm.extensionDeleted.inArray(item)||$scope.vm.extensionDeleted.push(item)}function addLocalExtension(title){var result=!1;return $scope.vm.extensionDeleted&&angular.forEach($scope.vm.extensionDeleted,function(item,index){title==item.extensionQuestionTitle&&(result=item,$scope.vm.extensionDeleted.splice(index,1))}),result}function checkExtensionByTitle(item){var result,arr=$scope.vm.extensionByTitleTag.concat($scope.vm.extensions);if(arr.length){var len=arr.length;angular.forEach(arr,function(val){val.extensionQuestionTitle==item.extensionQuestionTitle&&val.extensionQuestionType==item.extensionQuestionType&&(len-=1,result=!1),len==arr.length&&(result=!0)})}else result=!0;return result}function checkSave(){var params=getParams();return params.knowledgeTitle?params.classificationAndKnowledgeList.length?$scope.$parent.master.isTitleHasTag($scope.vm.title,$scope.vm.extensions.concat($scope.vm.extensionsByFrame,$scope.vm.extensionByTitleTag))?params.knowledgeContents[0].knowledgeContent&&params.knowledgeContents[0].knowledgeContentNegative?!!params.knowledgeContents[0].channelIdList.length||(layer.msg("渠道不能为空"),!1):(layer.msg("知识内容信息不完整，请增填写完整"),!1):(layer.msg("知识意图未打标"),!1):(layer.msg("知识类目不能为空，请选择分类"),!1):(layer.msg("知识标题不能为空，请填写"),!1)}function showTip(){$(".shadow_div").show(),$(".step_div").show(),$("#step_one").show().siblings().hide()}function hideTip(){$(".shadow_div").hide(),$(".step_div").hide()}function prevDiv(e){var obj=e.srcElement?e.srcElement:e.target;$(obj).parent().parent().parent().prev()&&($(obj).parent().parent().parent().hide(),$(obj).parent().parent().parent().prev().show(),$("html, body").animate({scrollTop:$(obj).parent().parent().parent().prev().offset().top-20},500))}function nextDiv(e){var obj=e.srcElement?e.srcElement:e.target;$(obj).parent().parent().parent().next()&&($(obj).parent().parent().parent().hide(),$(obj).parent().parent().parent().next().show(),$("html, body").animate({scrollTop:$(obj).parent().parent().parent().next().offset().top-20},500))}if($scope.vm={knowledgeId:"",knowledgeOrigin:120,frames:[],frameId:"",botRoot:"",knowledgeBotVal:"",botSelectAdd:botSelectAdd,frameCategoryId:"",title:"",titleTip:"",timeStart:"",timeEnd:"",isTimeTable:!1,getBotAndExtensionByTitle:getBotAndExtensionByTitle,botClassfy:[],creatSelectBot:[],extensionTitle:"",extensionWeight:60,getExtension:getExtension,extensions:[],extensionsByFrame:[],extensionByTitleTag:[],extensionEdit:extensionEdit,scanContent:[],save:save,scan:scan,newTitle:"",knowledgeContentNegative:"",channel:[],channels:[],channelArr:[],selectChannel:selectChannel,dimension:"",dimensions:[],dimensionArr:[],dimensionsCopy:[],slideDown:slideDown,slideFlag:!1,question:1,tip:1,tail:1,knowledgeTitleTag:[],appointRelative:"",appointRelativeList:[],appointRelativeGroup:[],replaceType:0,enterEvent:enterEvent,dialogExtension:[],limitSave:!1,rmExtensionBackup:[],showTip:showTip,hideTip:hideTip,prevDiv:prevDiv,nextDiv:nextDiv,isDecorateSimple:!1,backupsOfExtension:"",sourceTitle:"",backUpExt:backUpExt,extensionDeleted:[]},$scope.master.getDimensions($scope,["dimensions","dimensionsCopy"]),$scope.master.getChannels($scope,["channels"]),$stateParams.data&&angular.fromJson($stateParams.data).knowledgeBase){var data=angular.fromJson($stateParams.data);$scope.vm.title=data.knowledgeBase.knowledgeTitle,$scope.vm.sourceTitle=data.knowledgeBase.knowledgeTitle,$scope.vm.knowledgeTitleTag=data.knowledgeBase.knowledgeTitleTag,(data.knowledgeBase.knowledgeExpDateStart||data.knowledgeBase.knowledgeExpDateEnd)&&($scope.vm.isTimeTable=!0),$scope.vm.timeStart=$filter("date")(data.knowledgeBase.knowledgeExpDateStart,"yyyy-MM-dd"),$scope.vm.timeEnd=$filter("date")(data.knowledgeBase.knowledgeExpDateEnd,"yyyy-MM-dd"),$scope.vm.creatSelectBot=data.knowledgeBase.classificationAndKnowledgeList,$scope.vm.knowledgeId=data.knowledgeBase.knowledgeId,$scope.vm.knowledgeOrigin=data.knowledgeBase.knowledgeOrigin,$scope.vm.extensionsByFrame=data.extensionQuestions,angular.forEach(data.knowledgeContents,function(item){$scope.vm.newTitle=item.knowledgeContent,$scope.vm.knowledgeContentNegative=item.knowledgeContentNegative,$scope.vm.channel=item.channelIdList,$scope.vm.dimensionArr=[];var getDimension=$interval(function(){$scope.vm.dimensions&&($interval.cancel(getDimension),angular.forEach($scope.vm.dimensions,function(val){if(item.dimensionIdList.inArray(val.dimensionId)){var obj={};obj.dimensionName=val.dimensionName,obj.dimensionId=val.dimensionId,$scope.vm.dimensionArr.push(obj)}}))},100);$scope.vm.question=item.knowledgeRelatedQuestionOn,$scope.vm.tip=item.knowledgeBeRelatedOn,$scope.vm.tail=item.knowledgeCommonOn,$scope.vm.appointRelativeGroup=null!=item.knowledgeRelevantContentList?item.knowledgeRelevantContentList:[]})}$stateParams.knowledgeTitle&&($scope.vm.title=$stateParams.knowledgeTitle),$scope.$watch("vm.frameCategoryId",function(val,old){val&&val!=old&&getFrame(val)}),$scope.$watch("vm.frameId",function(val,old){val&&val!=old&&getExtensionByFrame(val)}),$scope.master.botTreeOperate($scope,"/api/ms/modeling/category/listbycategorypid","/api/ms/modeling/category/listbycategorypid",getBotFullPath),$scope.master.searchBotAutoTag(".botTagAuto","/api/ms/modeling/category/searchbycategoryname",function(suggestion){$scope.$apply(function(){var allBot=angular.copy($scope.vm.botClassfy.concat($scope.vm.creatSelectBot)),botResult=$scope.master.isBotRepeat(suggestion.data,suggestion.value.split("/"),suggestion.type,allBot);$scope.vm.knowledgeBotVal=suggestion.value,0!=botResult&&($scope.vm.botFullPath=botResult)})});var limitTimer;$timeout(function(){$scope.master.searchAppointAutoTag($scope,".appoint","/api/ms/knowledgeManage/getKnowledgeTitle","appointRelativeList",function(suggestion){}).listener()},2e3)}]),angular.module("knowledgeManagementModule").controller("knowledgeManagementController",["$scope","localStorageService","$state",function($scope,localStorageService,$state){$scope.vm={userName:"",password:""}}]),angular.module("knowledgeManagementModule").controller("newConceptController",["$scope","localStorageService","$state","ngDialog","$cookieStore","$timeout","$compile","FileUploader","knowledgeAddServer","$window","$interval","$stateParams","$filter",function($scope,localStorageService,$state,ngDialog,$cookieStore,$timeout,$compile,FileUploader,knowledgeAddServer,$window,$interval,$stateParams,$filter){function selelectTitle(title){$scope.vm.factorTitle=title,$scope.vm.getFactorByTitle=[]}function getDetailByTitle(title){httpRequestPost("/api/ms/marketingKnowledge/getKnowledgeTitle",{title:title,applicationId:APPLICATION_ID},function(data){$scope.vm.getFactorByTitle=data.data,title==data.data[0]&&1==data.data.length&&($scope.vm.getFactorByTitle=[]),$scope.$apply()},function(){})}function getFrame(id){httpRequestPost("/api/ms/modeling/frame/listbyattribute",{frameCategoryId:id,frameEnableStatusId:1,frameTypeId:10012,index:0,pageSize:999999},function(data){10005!=data.status&&data.data.length&&($scope.vm.frames=$scope.vm.frames.concat(data.data),$scope.$apply())},function(){})}function getExtensionByFrame(id,type){httpRequestPost("/api/ms/modeling/frame/listbyattribute",{frameTypeId:10012,frameId:id,index:0,pageSize:999999},function(data){if(1e4==data.status){var obj={};data.data[0].elements&&angular.forEach(data.data[0].elements,function(item,index){var extensionQuestionList=[],frameQuestionTagList=[];obj.extensionQuestionType=60,obj.extensionQuestionTitle=data.data[0].frameTitle,extensionQuestionList.push(item.elementContent.substring(0,item.elementContent.indexOf("#"))),frameQuestionTagList.push(item.elementContent.substring(item.elementContent.indexOf("#")+1).split("；")),checkExtensionByFrame(extensionQuestionList,frameQuestionTagList,obj)}),$scope.$apply()}},function(){})}function getBotFullPath(id){httpRequestPost("/api/ms/modeling/category/getcategoryfullname",{categoryId:id},function(data){if(data.status=1e4){var len=$scope.vm.creatSelectBot.length,obj={};if(len){if(angular.forEach($scope.vm.creatSelectBot,function(item){item.classificationId!=id&&(len-=1)}),0!=len)return layer.msg("添加分类重复"),!1;obj.className=data.categoryFullName.split("/"),obj.classificationId=id,obj.classificationType=1}else obj.className=data.categoryFullName.split("/"),obj.classificationId=id;$scope.vm.knowledgeBotVal=obj.className.join("/"),$scope.vm.botFullPath=obj,$scope.$apply()}},function(){})}function checkExtensionByFrame(extensionQuestionList,frameQuestionTagList,oldWord){var title=extensionQuestionList[0],weight=oldWord.extensionQuestionType;httpRequestPost("/api/ms/marketingKnowledge/checkFrameTag",{applicationId:APPLICATION_ID,extensionQuestionList:extensionQuestionList,frameQuestionTagList:frameQuestionTagList},function(data){if(200==data.status){var allExtension=$scope.vm.extensions.concat($scope.vm.extensionsByFrame,$scope.vm.extensionByTitleTag);if(isTagRepeat(data.data,allExtension,title));else{var enten={};enten.extensionQuestionTitle=title,enten.extensionQuestionType=weight,enten.wholeDecorateTagList=[{wholeDecorateTagNameList:[],wholeDecorateTagType:"36"},{wholeDecorateTagNameList:[],wholeDecorateTagType:"37"},{wholeDecorateTagNameList:[],wholeDecorateTagType:"38"}],enten.extensionQuestionTagList=[],angular.forEach(data.data,function(tagList){angular.forEach(tagList.extensionQuestionTagList,function(item){var tagTem={exist:item.exist,tagClass:item.tagClass,tagName:item.tagName,tagType:item.tagType};enten.extensionQuestionTagList.push(tagTem)})}),$scope.vm.extensionsByFrame.push(enten),$scope.$apply()}}},function(){})}function getExtension(title){var question=new Array(title),obj={extensionQuestionTitle:title,extensionQuestionType:angular.copy($scope.vm.factor)};if(title){if(!checkExtensionByTitle(obj))return layer.msg("生成扩展问重复,已阻止添加"),!1;httpRequestPost("/api/ms/marketingKnowledge/checkExtensionQuestion",{applicationId:APPLICATION_ID,extendQuestionList:question},function(data){if(500==data.status)layer.msg(data.data);else if(10026==data.status)layer.msg("扩展问添加重复，请重新添加");else if(11006==data.status)layer.msg("扩展问生成失败");else if(200==data.status){var allExtension=$scope.vm.extensions.concat($scope.vm.extensionsByFrame,$scope.vm.extensionByTitleTag);if(isTagRepeat(data.data,allExtension,title));else{$scope.vm.extensionTitle="";var enten={};enten.extensionQuestionTitle=title,enten.extensionQuestionType=weight,enten.wholeDecorateTagList=[{wholeDecorateTagNameList:[],wholeDecorateTagType:"36"},{wholeDecorateTagNameList:[],wholeDecorateTagType:"37"},{wholeDecorateTagNameList:[],wholeDecorateTagType:"38"}],enten.extensionQuestionTagList=[],angular.forEach(data.data,function(tagList){angular.forEach(tagList.extensionQuestionTagList,function(item){var tagTem={exist:item.exist,tagClass:item.tagClass,tagName:item.tagName,tagType:item.tagType};enten.extensionQuestionTagList.push(tagTem)})}),$scope.vm.extensions.push(enten)}$scope.vm.extensionTitle="",$scope.$apply()}},function(){})}else layer.msg("扩展问不能为空")}function isTagRepeat(current,allExtension,title){var current=angular.copy(current),isRepeat=!1,tag=[];return angular.forEach(current,function(tagList){angular.forEach(tagList.extensionQuestionTagList,function(item){item.exist&&tag.push(item.tagName)})}),angular.forEach(allExtension,function(extension){var tagLen=0,itemTag=[];if(angular.forEach(extension.extensionQuestionTagList,function(item){item.exist&&itemTag.push(item.tagName),tag.inArray(item.tagName)&&item.exist&&(tagLen+=1)}),tagLen==itemTag.length&&tag.length==itemTag.length)return layer.msg('根据"'+title+'"生成扩展问重复,已阻止添加'),isRepeat=!0}),isRepeat}function knowledgeBot(ev){$timeout(function(){angular.element(".rootClassfy").slideToggle()},50)}function getBotRoot(){httpRequestPost("/api/ms/modeling/category/listbycategorypid",{categoryApplicationId:APPLICATION_ID,title:$scope.vm.title,categoryPid:"root"},function(data){$scope.vm.botRoot=data.data},function(){})}function botSelectAdd(){$scope.vm.botFullPath&&($scope.vm.creatSelectBot.push($scope.vm.botFullPath),$scope.vm.frameCategoryId=$scope.vm.botFullPath.classificationId,$scope.vm.botFullPath=null,$scope.vm.knowledgeBotVal="")}function knowledgeClassifyCall(){httpRequestPost("/api/ms/knowledgeDocumentation/documentationKnowledgeClassify",{knowledgeId:$scope.vm.docmentation.knowledgeId,knowledgeStatus:4},function(data){data&&200==data.status&&$state.go("back.doc_results_view",{knowDocId:$scope.vm.docmentation.documentationId,knowDocCreateTime:$scope.vm.docmentation.knowDocCreateTime,knowDocUserName:$scope.vm.docmentation.knowDocUserName})})}function openContentConfirm(callback){ngDialog.openConfirm({width:"521px",template:"/static/knowledgeManagement/public-html/knowledge_increase.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){1===e?callback():setDialog()}})}function knowledgeAdd(data,index){if(!$scope.vm.title)return layer.msg("请先输入营销知识标题"),!1;var dia=angular.element(".ngdialog ");if(data){$scope.vm.isEditIndex=index,$scope.vm.newTitle=data.knowledgeContent,$scope.vm.channel=data.channelIdList,angular.forEach($scope.vm.dimensions,function(item){if(data.dimensionIdList.inArray(item.dimensionId)){var obj={dimensionId:item.dimensionId,dimensionName:item.dimensionName};$scope.vm.dimensionArr.push(obj)}}),$scope.vm.tip=data.knowledgeBeRelatedOn,$scope.vm.question=data.knowledgeRelatedQuestionOn,$scope.vm.tail=data.knowledgeCommonOn,$scope.vm.appointRelativeGroup=null==data.knowledgeRelevantContentList?[]:data.knowledgeRelevantContentList;var callback=function(){var obj={};obj.knowledgeContent=$scope.vm.newTitle,obj.knowledgeContentType=0,obj.channelIdList=$scope.vm.channel,obj.dimensionIdList=$scope.vm.dimensionArr.id,obj.knowledgeRelatedQuestionOn=$scope.vm.question,obj.knowledgeBeRelatedOn=$scope.vm.tip,obj.knowledgeCommonOn=$scope.vm.tail,obj.knowledgeRelevantContentList=$scope.vm.appointRelativeGroup,$scope.vm.scanContent[index]=obj,$scope.vm.isEditIndex=-1,setDialog()}}else var callback=saveAddNew;if(0==dia.length){ngDialog.openConfirm({width:"521px",template:"/static/knowledgeManagement/public-html/knowledge_increase.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){1===e?callback():($scope.vm.isEditIndex=-1,setDialog())}})}}function extensionEdit(type,item,index){($scope.vm.backupsOfExtension=angular.copy(item),0==angular.element(".ngdialog ").length)&&ngDialog.openConfirm({template:"/static/knowledgeManagement/public-html/extension_edit.html",width:"500px",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){1===e?1==type?$scope.vm.extensionsByFrame[index]=$scope.vm.backupsOfExtension:0==type?$scope.vm.extensions[index]=$scope.vm.backupsOfExtension:2==type&&($scope.vm.extensionByTitleTag[index]=$scope.vm.backupsOfExtension):$scope.vm.backupsOfExtension=""}})}function slideDown(){$scope.vm.slideFlag=!$scope.vm.slideFlag,$(".senior_div").slideToggle()}function getBotAndExtensionByTitle(){$scope.vm.title?httpRequestPost("/api/ms/marketingKnowledge/checkKnowledgeTitleAndGetAutoClassify",{title:$scope.vm.title,applicationId:APPLICATION_ID},function(data){500==data.status?($scope.vm.titleTip="知识标题重复",$scope.$apply()):200==data.status&&$scope.$apply(function(){$scope.vm.knowledgeTitleTag=data.data.knowledgeTitleTagList,$scope.vm.botClassfy=[],angular.forEach(data.data.classifyList,function(item){var obj={className:item.fullPath,classificationId:item.id,classificationType:item.type};$scope.vm.botClassfy.push(obj),$scope.vm.frameCategoryId=item.id})})}):$scope.vm.titleTip="知识标题不能为空"}function getParams(){var params={};return params={applicationId:APPLICATION_ID,userId:USER_ID,sceneId:SCENE_ID,knowledgeTitle:$scope.vm.title,knowledgeExpDateStart:$scope.vm.isTimeTable?$scope.vm.timeStart:null,knowledgeExpDateEnd:$scope.vm.isTimeTable?$scope.vm.timeEnd:null,knowledgeTitleTag:$scope.vm.knowledgeTitleTag,knowledgeUpdater:USER_LOGIN_NAME,knowledgeCreator:USER_LOGIN_NAME,knowledgeOrigin:$scope.vm.knowledgeOrigin},params.knowledgeContents=$scope.vm.scanContent,params.extensionQuestions=$scope.vm.extensions.concat($scope.vm.extensionsByFrame,$scope.vm.extensionByTitleTag),params.classificationAndKnowledgeList=$scope.vm.botClassfy.concat($scope.vm.creatSelectBot),params}function save(){if(!checkSave())return!1;if(!$scope.vm.limitSave){$timeout.cancel(limitTimer),$scope.vm.limitSave=!0,limitTimer=$timeout(function(){$scope.vm.limitSave=!1},18e4);var api,params=getParams();$scope.vm.knowledgeId?(api="/api/ms/marketingKnowledge/editKnowledge",params.knowledgeId=$scope.vm.knowledgeId):api="/api/ms/marketingKnowledge/addMarketingKnowledge",httpRequestPost(api,params,function(data){200==data.status?$scope.vm.docmentation?$scope.vm.knowledgeClassifyCall():""==$stateParams.data?($state.go("knowledgeManagement.custOverview"),layer.msg("新增知识已进入审核列表",{time:2e3})):$stateParams.data&&4==angular.fromJson($stateParams.data).knowledgeBase.statusId?($state.go("knowledgeManagement.custOverview"),layer.msg("编辑知识已进入审核列表",{time:2e3})):$state.go("knowledgeManagement.custOverview"):500==data.status&&(layer.msg("知识保存失败"),$timeout.cancel(limitTimer),$scope.$apply(function(){$scope.vm.limitSave=!1}))},function(err){$timeout.cancel(limitTimer),$scope.$apply(function(){$scope.vm.limitSave=!1})})}}function scan(){if(!checkSave())return!1;var obj={},params=getParams();obj.params=params,obj.editUrl="knowledgeManagement.ConceptAdd",$scope.vm.knowledgeId?(obj.api="marketingKnowledge/editMarketingKnowledge",params.knowledgeId=$scope.vm.knowledgeId):obj.api="/api/ms/marketingKnowledge/addMarketingKnowledge",obj.params=params,obj.knowledgeType=104,$window.knowledgeScan=obj;var url=$state.href("knowledgeManagement.knowledgeScan");$window.open(url,"_blank")}function setDialog(){$scope.vm.newTitle="",$scope.vm.channel=[],$scope.vm.dimension=[],$scope.vm.question=1,$scope.vm.tip=1,$scope.vm.tail=1,$scope.vm.appointRelativeGroup=[],$scope.vm.appointRelative="",$scope.vm.dimensionsCopy=angular.copy($scope.vm.dimensions),$scope.vm.dimensionArr=[]}function saveAddNew(){if($scope.vm.newTitle){var obj=(angular.copy($scope.vm.newTitle),$scope.vm.scanContent.length,{});obj.knowledgeContent=$scope.vm.newTitle,obj.channelIdList=$scope.vm.channel,obj.dimensionIdList=$scope.vm.dimensionArr.id.length?$scope.vm.dimensionArr.id:$scope.vm.dimensionsCopy.id,obj.knowledgeRelatedQuestionOn=$scope.vm.question,obj.knowledgeBeRelatedOn=$scope.vm.tip,obj.knowledgeCommonOn=$scope.vm.tail,obj.knowledgeRelevantContentList=$scope.vm.appointRelativeGroup,$scope.vm.scanContent.push(obj),setDialog()}else setDialog()}function checkExtensionByTitle(item){var result,arr=$scope.vm.extensionByTitleTag.concat($scope.vm.extensions);if(arr.length){var len=arr.length;angular.forEach(arr,function(val){val.extensionQuestionTitle==item.extensionQuestionTitle&&val.extensionQuestionType==item.extensionQuestionType&&(len-=1,result=!1),len==arr.length&&(result=!0)})}else result=!0;return result}function checkSave(){var params=getParams();return params.knowledgeTitle?params.classificationAndKnowledgeList.length?$scope.$parent.master.isTitleHasTag($scope.vm.title,$scope.vm.extensions.concat($scope.vm.extensionsByFrame,$scope.vm.extensionByTitleTag))?params.knowledgeContents.length?!!params.classificationAndKnowledgeList.length||(layer.msg("分类知识Bot不能为空"),!1):(layer.msg("知识内容不能为空，请点击新增填写"),!1):(layer.msg("知识意图未打标"),!1):(layer.msg("知识类目不能为空，请选择分类"),!1):(layer.msg("知识标题不能为空，请填写"),!1)}function increaseCheck(){$scope.vm.dimensionArr.id.length||($scope.vm.dimensionArr=angular.copy($scope.vm.dimensionsCopy)),$scope.vm.newTitle||$scope.vm.channel.length?$scope.vm.newTitle?$scope.vm.channel.length?checkChannelDimension($scope.vm.channel,$scope.vm.dimensionArr.id)||ngDialog.closeAll(1):layer.msg("请选择渠道后保存"):layer.msg("请填写知识内容后保存"):layer.msg("请填写知识内容,并选择渠道后保存")}function selectChannel(channelId){$scope.vm.channel.inArray(channelId)?$scope.vm.channel.remove(channelId):$scope.vm.channel.push(channelId)}function checkChannelDimension(channel,dimension){var isRepeat=!1;return angular.forEach($scope.vm.scanContent,function(item,contentIndex){$scope.vm.isEditIndex!=contentIndex&&angular.forEach(item.channelIdList,function(v){angular.forEach(channel,function(val,indexChannel){val==v&&angular.forEach(item.dimensionIdList,function(value){angular.forEach(dimension,function(key,indexDimension){if(key==value){var channelTip;angular.forEach($scope.vm.channels,function(all){all.channelCode==v&&(channelTip=all.channelName)}),layer.msg("重复添加渠道 "+channelTip+" 维度 "+$scope.vm.dimensionArr.name[indexDimension]),isRepeat=!0}})})})})}),isRepeat}function addAppoint(item,arr){-1==arr.indexOf(item)&&arr.push(item),$scope.vm.appointRelative=null,$scope.vm.appointRelativeList=[]}function getAppointRelative(title){httpRequestPost("/api/ms/marketingKnowledge/getKnowledgeTitle",{title:title},function(data){200==data.status&&($scope.vm.appointRelativeList=data.data,$scope.$apply())},function(err){})}function showTip(){$(".shadow_div").show(),$(".step_div").show(),$("#step_one").show().siblings().hide()}function hideTip(){$(".shadow_div").hide(),$(".step_div").hide()}function prevDiv(e){var obj=e.srcElement?e.srcElement:e.target;$(obj).parent().parent().parent().prev()&&($(obj).parent().parent().parent().hide(),$(obj).parent().parent().parent().prev().show(),$("html, body").animate({scrollTop:$(obj).parent().parent().parent().prev().offset().top-20},500))}function nextDiv(e){var obj=e.srcElement?e.srcElement:e.target;$(obj).parent().parent().parent().next()&&($(obj).parent().parent().parent().hide(),$(obj).parent().parent().parent().next().show(),$("html, body").animate({scrollTop:$(obj).parent().parent().parent().next().offset().top-20},500))}if($scope.vm={knowledgeId:"",knowledgeOrigin:120,frames:[],frameId:"",knowledgeAdd:knowledgeAdd,knowledgeClassifyCall:knowledgeClassifyCall,openContentConfirm:openContentConfirm,botRoot:"",knowledgeBot:knowledgeBot,knowledgeBotVal:"",botSelectAdd:botSelectAdd,frameCategoryId:"",title:"",titleTip:"",timeStart:"",timeEnd:"",isTimeTable:!1,getBotAndExtensionByTitle:getBotAndExtensionByTitle,botClassfy:[],creatSelectBot:[],extensionTitle:"",extensionWeight:60,getExtension:getExtension,extensions:[],extensionsByFrame:[],extensionByTitleTag:[],extensionEdit:extensionEdit,scanContent:[],save:save,scan:scan,newTitle:"",channel:[],channels:[],channelArr:[],selectChannel:selectChannel,dimension:"",dimensions:[],dimensionArr:[],dimensionsCopy:[],checkChannelDimension:checkChannelDimension,slideDown:slideDown,slideFlag:!1,question:1,tip:1,tail:1,knowledgeTitleTag:[],appointRelative:"",appointRelativeList:[],addAppoint:addAppoint,appointRelativeGroup:[],replaceType:0,enterEvent:enterEvent,factor:62,factorTitle:"",getDetailByTitle:getDetailByTitle,getFactorByTitle:[],selelectTitle:selelectTitle,extensionByContentTitle:[],limitSave:!1,isEditIndex:-1,increaseCheck:increaseCheck,backupsOfExtension:"",showTip:showTip,hideTip:hideTip,prevDiv:prevDiv,nextDiv:nextDiv},$scope.master.getDimensions($scope,["dimensions","dimensionsCopy"]),$scope.master.getChannels($scope,["channels"]),$stateParams.data&&angular.fromJson($stateParams.data).knowledgeBase){var data=$stateParams.data;$scope.vm.title=data.knowledgeBase.knowledgeTitle,$scope.vm.knowledgeTitleTag=data.knowledgeBase.knowledgeTitleTag,$scope.vm.knowledgeId=data.knowledgeBase.knowledgeId,$scope.vm.knowledgeOrigin=data.knowledgeBase.knowledgeOrigin,(data.knowledgeBase.knowledgeExpDateStart||data.knowledgeBase.knowledgeExpDateEnd)&&($scope.vm.isTimeTable=!0),$scope.vm.timeStart=$filter("date")(data.knowledgeBase.knowledgeExpDateStart,"yyyy-MM-dd"),$scope.vm.timeEnd=$filter("date")(data.knowledgeBase.knowledgeExpDateEnd,"yyyy-MM-dd"),$scope.vm.creatSelectBot=data.knowledgeBase.classificationAndKnowledgeList,$scope.vm.extensionsByFrame=data.extensionQuestions,angular.forEach(data.extensionQuestions,function(item){}),angular.forEach(data.knowledgeContents,function(item){var obj={};obj.knowledgeContent=item.knowledgeContent,obj.channelIdList=item.channelIdList,obj.dimensionIdList=item.dimensionIdList,obj.knowledgeRelatedQuestionOn=item.knowledgeRelatedQuestionOn,obj.knowledgeBeRelatedOn=item.knowledgeBeRelatedOn,obj.knowledgeCommonOn=item.knowledgeCommonOn,obj.knowledgeRelevantContentList=item.knowledgeRelevantContentList,$scope.vm.scanContent.push(obj)})}else $stateParams.data&&angular.fromJson($stateParams.data).docmentation&&($scope.vm.docmentation=angular.fromJson($stateParams.data).docmentation,$scope.vm.title=$scope.vm.docmentation.documentationTitle,$scope.vm.newTitle=$scope.vm.docmentation.documentationContext,$scope.vm.openContentConfirm(saveAddNew));$stateParams.knowledgeTitle&&($scope.vm.title=$stateParams.knowledgeTitle);var timer;"Chrome"==myBrowser()?angular.element(".factorInput").on({compositionend:function(value){var val=angular.element(".factorInput").val();$scope.vm.factorTitle=val,$timeout.cancel(timer),timer=$timeout(function(){getDetailByTitle(val)},300)}}):$scope.$watch("vm.factorTitle",function(title){""!=title&&62==$scope.vm.factor&&title!=$scope.vm.getFactorByTitle[0]&&($timeout.cancel(timer),timer=$timeout(function(){getDetailByTitle(title)},300))},!0),$scope.$watch("vm.frameCategoryId",function(val,old){val&&val!=old&&getFrame(val)}),$scope.$watch("vm.frameId",function(val,old){val&&val!=old&&getExtensionByFrame(val)}),getBotRoot(),$(".aside-navs").on("click","span",function(){var pre=$(this).prev();angular.element(".icon-jj").css("backgroundPosition","0% 0%"),getBotFullPath(pre.attr("data-option")),angular.element(".rootClassfy,.menus").slideToggle(),$scope.$apply()}),$(".aside-navs").on("click","i",function(){var id=$(this).attr("data-option"),that=$(this);that.parent().parent().siblings().length?"0% 0%"==that.css("backgroundPosition")?(that.css("backgroundPosition","0% 100%"),that.parent().parent().next().slideDown()):(that.css("backgroundPosition","0% 0%"),that.parent().parent().next().slideUp()):(that.css("backgroundPosition","0% 100%"),httpRequestPost("/api/ms/modeling/category/listbycategorypid",{categoryApplicationId:APPLICATION_ID,categoryPid:id},function(data){if(data.data){for(var html='<ul class="menus">',i=0;i<data.data.length;i++){var typeClass;0==data.data[i].categoryLeaf?typeClass="bot-leaf":0!=data.data[i].categoryLeaf&&"edge"==data.data[i].categoryAttributeName?typeClass="bot-edge":0!=data.data[i].categoryLeaf&&"node"==data.data[i].categoryAttributeName&&(typeClass="icon-jj");var backImage;switch(data.data[i].categoryTypeId){case 160:backImage=" bot-divide";break;case 161:backImage=" bot-process";break;case 162:backImage=" bot-attr";break;case 163:backImage=" bot-default"}html+='<li><div class="slide-a"> <a class="ellipsis" href="javascript:;">',html+='<i class="'+typeClass+backImage+'" data-option="'+data.data[i].categoryId+'"></i>',html+="<span>"+data.data[i].categoryName+"</span></a></div></li>"}html+="</ul>",$(html).appendTo(that.parent().parent().parent()),that.parent().parent().next().slideDown()}},function(err){}))});var limitTimer;$scope.$watch("vm.appointRelative",function(title){title&&$timeout(getAppointRelative(title),300)})}]),angular.module("knowledgeManagementModule").controller("markKnowController",["$scope","localStorageService","$state","ngDialog","$cookieStore","$timeout","$compile","FileUploader","knowledgeAddServer","$window","$stateParams","$interval","$filter",function($scope,localStorageService,$state,ngDialog,$cookieStore,$timeout,$compile,FileUploader,knowledgeAddServer,$window,$stateParams,$interval,$filter){function getFrame(id){httpRequestPost("/api/ms/modeling/frame/listbyattribute",{frameCategoryId:id,frameEnableStatusId:1,frameTypeId:10012,index:0,pageSize:999999},function(data){10005!=data.status&&data.data.length&&($scope.vm.frames=$scope.vm.frames.concat(data.data),$scope.$apply())},function(){})}function getExtensionByFrame(id,type){httpRequestPost("/api/ms/modeling/frame/listbyattribute",{frameTypeId:10012,frameId:id,index:0,pageSize:999999},function(data){if(1e4==data.status){var obj={};data.data[0].elements&&angular.forEach(data.data[0].elements,function(item,index){var extensionQuestionList=[],frameQuestionTagList=[];obj={extensionQuestionType:60,extensionQuestionTitle:data.data[0].frameTitle},extensionQuestionList.push(item.elementContent.substring(0,item.elementContent.indexOf("#"))),frameQuestionTagList.push(item.elementContent.substring(item.elementContent.indexOf("#")+1).split("；")),checkExtensionByFrame(extensionQuestionList,frameQuestionTagList,obj)}),$scope.$apply()}},function(error){})}function getBotFullPath(id){httpRequestPost("/api/ms/modeling/category/getcategoryfullname",{categoryId:id},function(data){if(data.status=1e4){var allBot=angular.copy($scope.vm.creatSelectBot.concat($scope.vm.botClassfy)),botResult=$scope.master.isBotRepeat(id,data.categoryFullName.split("/"),"",allBot);$scope.$apply(function(){$scope.vm.knowledgeBotVal=data.categoryFullName,0!=botResult&&($scope.vm.botFullPath=botResult)})}},function(error){})}function openContentConfirm(callback){ngDialog.openConfirm({template:"/static/knowledgeManagement/public-html/knowledge_increase.html",width:"650px",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){1===e?callback():setDialog()}})}function checkExtensionByFrame(extensionQuestionList,frameQuestionTagList,oldWord){var title=extensionQuestionList[0],weight=oldWord.extensionQuestionType,isLocalHasExt=addLocalExtension(title);if(isLocalHasExt)return void $scope.vm.extensionsByFrame.push(isLocalHasExt);httpRequestPost("/api/ms/richtextKnowledge/checkFrameTag",{applicationId:APPLICATION_ID,extensionQuestionList:extensionQuestionList,frameQuestionTagList:frameQuestionTagList},function(data){200==data.status&&$scope.$apply(function(){var allExtension=$scope.vm.extensions.concat($scope.vm.extensionsByFrame,$scope.vm.extensionByTitleTag),result=$scope.master.isExtensionTagRepeat(data.data,allExtension,title,weight);1!=result&&($scope.vm.extensionTitle="",$scope.vm.extensionsByFrame.push(result))})},function(){})}function getExtension(title,weight,source){var isLocalHasExt=addLocalExtension(title);if(isLocalHasExt)return void(source?$scope.vm.extensionByTitleTag=new Array(isLocalHasExt):$scope.vm.extensions.push(isLocalHasExt));var question=new Array(title),obj={extensionQuestionTitle:$scope.vm.extensionTitle,extensionQuestionType:$scope.vm.extensionWeight};if(title){if(!checkExtensionByTitle(obj))return layer.msg("生成扩展问重复,已阻止添加"),!1;httpRequestPost("/api/ms/richtextKnowledge/checkExtensionQuestion",{applicationId:APPLICATION_ID,extendQuestionList:question},function(data){500==data.status?layer.msg(data.data):10026==data.status?layer.msg("扩展问添加重复，请重新添加"):200==data.status&&$scope.$apply(function(){var allExtension=$scope.vm.extensions.concat($scope.vm.extensionsByFrame,$scope.vm.extensionByTitleTag),result=$scope.master.isExtensionTagRepeat(data.data,allExtension,title,weight);1!=result&&($scope.vm.extensionTitle="",source?$scope.vm.extensionByTitleTag=new Array(result):$scope.vm.extensions.push(result))})},function(error,e,er){})}else layer.msg("扩展问不能为空")}function botSelectAdd(){$scope.vm.botFullPath&&($scope.vm.creatSelectBot.push($scope.vm.botFullPath),$scope.vm.frameCategoryId=$scope.vm.botFullPath.classificationId,$scope.vm.botFullPath="",$scope.vm.knowledgeBotVal="")}function knowledgeAdd(data,index){if(!$scope.vm.title)return layer.msg("请先输入知识标题"),!1;var dia=angular.element(".ngdialog ");if($timeout(function(){$scope.master.searchAppointAutoTag($scope,".appoint","/api/ms/knowledgeManage/getKnowledgeTitle","appointRelativeList",function(suggestion){}).listener()},2e3),data){switch(data.knowledgeContentNegative){case"111":$scope.vm.imgSelected={name:data.knowledgeContent,url:data.knowledgeContent};break;case"112":$scope.vm.voiceSelected={name:data.knowledgeContent,url:data.knowledgeContent};break;case"113":$timeout(function(){$("#emotion-container").html(data.knowledgeContent)},100)}$scope.vm.contentType=data.knowledgeContentNegative,$scope.vm.isEditIndex=index,$scope.vm.channel=data.channelIdList,angular.forEach($scope.vm.dimensions,function(item){if(data.dimensionIdList.inArray(item.dimensionId)){var obj={dimensionId:item.dimensionId,dimensionName:item.dimensionName};$scope.vm.dimensionArr.push(obj)}}),$scope.vm.tip=data.knowledgeBeRelatedOn,$scope.vm.question=data.knowledgeRelatedQuestionOn,$scope.vm.tail=data.knowledgeCommonOn,$scope.vm.appointRelativeGroup=null!=data.knowledgeRelevantContentList?data.knowledgeRelevantContentList:[]}if(0==dia.length)var isDialog=(ngDialog.openConfirm({template:"/static/knowledgeManagement/public-html/markKnow_increase.html",width:"650px",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){1===e?addNewOrEditKnow(index):$scope.vm.isEditIndex=-1,setDialog()}}),$interval(function(){var intervaler;if(angular.element(".ngdialog ")){$interval.cancel(isDialog);var qqFaceWatcher=$scope.$watch("vm.contentType",function(val){113==val?($timeout(function(){$(".emotion").qqFace({id:"facebox",assign:"emotinon-backup",path:"/libs/qqFace/arclist/"}),intervaler=$interval(function(){var val=$("#emotinon-backup").val();if(val){var html=$("#emotion-container").html()+$filter("emotion")(val);$("#emotion-container").html(html),$("#emotinon-backup").val("")}},500)}),qqFaceWatcher()):$interval.cancel(intervaler)})}},10))}function extensionEdit(type,item,index){($scope.vm.backupsOfExtension=angular.copy(item),0==angular.element(".ngdialog ").length)&&ngDialog.openConfirm({template:"/static/knowledgeManagement/public-html/extension_edit.html",width:"500px",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){1===e?1==type?$scope.vm.extensionsByFrame[index]=$scope.vm.backupsOfExtension:0==type?$scope.vm.extensions[index]=$scope.vm.backupsOfExtension:2==type&&($scope.vm.extensionByTitleTag[index]=$scope.vm.backupsOfExtension):$scope.vm.backupsOfExtension=""}})}function slideDown(){$scope.vm.slideFlag=!$scope.vm.slideFlag,$(".senior_div").slideToggle()}function getBotAndExtensionByTitle(){getExtension($scope.vm.title,"60",1),$scope.vm.title&&$scope.vm.sourceTitle!=$scope.vm.title?httpRequestPost("/api/ms/richtextKnowledge/checkKnowledgeTitleAndGetAutoClassify",{title:$scope.vm.title,applicationId:APPLICATION_ID,knowledgeId:$scope.vm.knowledgeId},function(data){500==data.status?($scope.vm.titleTip="知识标题重复",$scope.$apply()):200==data.status&&$scope.$apply(function(){$scope.vm.knowledgeTitleTag=data.data.knowledgeTitleTagList,$scope.vm.botClassfy=[];var allBot=angular.copy($scope.vm.creatSelectBot);angular.forEach(data.data.classifyList,function(item){var botResult=$scope.master.isBotRepeat(item.id,item.fullPath,item.type,allBot);0!=botResult&&$scope.vm.botClassfy.push(botResult),$scope.vm.frameCategoryId=item.id})})},function(error){}):$scope.vm.sourceTitle==$scope.vm.title?getExtension($scope.vm.title,"60",1):$scope.vm.titleTip="知识标题不能为空"}function getParams(){var params={applicationId:APPLICATION_ID,userId:USER_ID,sceneId:SCENE_ID,knowledgeTitle:$scope.vm.title,knowledgeType:106,knowledgeExpDateStart:$scope.vm.isTimeTable?$scope.vm.timeStart:"",knowledgeExpDateEnd:$scope.vm.isTimeTable?$scope.vm.timeEnd:"",knowledgeTitleTag:$scope.vm.knowledgeTitleTag,knowledgeUpdater:USER_LOGIN_NAME,knowledgeCreator:USER_LOGIN_NAME,knowledgeOrigin:$scope.vm.knowledgeOrigin},content=angular.copy($scope.vm.scanContent);return angular.forEach(content,function(item,index){if(113==item.knowledgeContentNegative){var html=angular.copy(item.knowledgeContent);content[index].knowledgeContent=$filter("faceToString")(html).replace(/<div>/,"\n").replace(/<div>/g,"").replace(/<\/div>/g,"\n").replace(/<br>/g,"\n")}}),params.knowledgeContents=content,params.extensionQuestions=$scope.vm.extensions.concat($scope.vm.extensionsByFrame,$scope.vm.extensionByTitleTag),params.classificationAndKnowledgeList=$scope.vm.botClassfy.concat($scope.vm.creatSelectBot),params}function save(){if(!checkSave())return!1;if(!$scope.vm.limitSave){$timeout.cancel(limitTimer),$scope.vm.limitSave=!0,limitTimer=$timeout(function(){$scope.vm.limitSave=!1},18e4);var api,params=getParams();$scope.vm.knowledgeId?(api="/api/ms/richtextKnowledge/editKnowledge",params.knowledgeId=$scope.vm.knowledgeId):api="/api/ms/richtextKnowledge/addKnowledge",httpRequestPost(api,params,function(data){200==data.status?""==$stateParams.data?($state.go("knowledgeManagement.custOverview"),layer.msg("新增知识已进入审核列表",{time:2e3})):$stateParams.data&&4==angular.fromJson($stateParams.data).knowledgeBase.statusId?($state.go("knowledgeManagement.custOverview"),layer.msg("编辑知识已进入审核列表",{time:2e3})):$state.go("knowledgeManagement.custOverview"):500==data.status&&(layer.msg("知识保存失败"),$timeout.cancel(limitTimer),$scope.$apply(function(){$scope.vm.limitSave=!1}))},function(err){$timeout.cancel(limitTimer),$scope.$apply(function(){$scope.vm.limitSave=!1})})}}function scan(){if(!checkSave())return!1;var obj={},params=getParams();obj.params=params,obj.editUrl="knowledgeManagement.markKnow",$scope.vm.knowledgeId?(obj.api="/api/ms/richtextKnowledge/editKnowledge",params.knowledgeId=$scope.vm.knowledgeId):obj.api="/api/ms/richtextKnowledge/addKnowledge",obj.params=params,obj.knowledgeType=106,$window.knowledgeScan=obj;var url=$state.href("knowledgeManagement.knowledgeScan");$window.open(url,"_blank")}function removeAppointRelative(item){$scope.vm.appointRelativeGroup.remove(item)}function setDialog(){$scope.vm.contentType=113,$scope.vm.imgSelected="",$scope.vm.voiceSelected="",$scope.vm.slideFlag=!1,$scope.vm.channel=[],$scope.vm.dimension=[],$scope.vm.question=1,$scope.vm.tip=1,$scope.vm.tail=1,$scope.vm.appointRelativeGroup=[],$scope.vm.appointRelative="",$scope.vm.dimensionsCopy=angular.copy($scope.vm.dimensions),$scope.vm.dimensionArr=[]}function addNewOrEditKnow(index){if(isNewKnowledgeTitle()){var knowledgeContent;111==$scope.vm.contentType?knowledgeContent=$scope.vm.imgSelected.url:112==$scope.vm.contentType?knowledgeContent=$scope.vm.voiceSelected.url:113==$scope.vm.contentType&&(knowledgeContent=$("#emotion-container").html()),$scope.vm.dimensionArr.id.length||($scope.vm.dimensionArr=angular.copy($scope.vm.dimensionsCopy));var parameter={knowledgeContent:knowledgeContent,channelIdList:$scope.vm.channel,knowledgeContentNegative:$scope.vm.contentType.toString(),dimensionIdList:$scope.vm.dimensionArr.id.length?$scope.vm.dimensionArr.id:$scope.vm.dimensionsCopy.id,knowledgeRelatedQuestionOn:$scope.vm.question,knowledgeBeRelatedOn:$scope.vm.tip,knowledgeCommonOn:$scope.vm.tail,knowledgeRelevantContentList:$scope.vm.appointRelativeGroup};index>=0?$scope.vm.scanContent[index]=parameter:$scope.vm.scanContent.push(parameter)}}function checkExtensionByTitle(item){var result,arr=$scope.vm.extensionByTitleTag.concat($scope.vm.extensions);if(arr.length){var len=arr.length;angular.forEach(arr,function(val){val.extensionQuestionTitle==item.extensionQuestionTitle&&val.extensionQuestionType==item.extensionQuestionType&&(len-=1,result=!1),len==arr.length&&(result=!0)})}else result=!0;return result}function checkSave(){var params=getParams();return params.knowledgeTitle?params.classificationAndKnowledgeList.length?$scope.$parent.master.isTitleHasTag($scope.vm.title,$scope.vm.extensions.concat($scope.vm.extensionsByFrame,$scope.vm.extensionByTitleTag))?params.knowledgeContents.length?!!params.classificationAndKnowledgeList.length||void layer.msg("分类知识Bot不能为空"):(layer.msg("知识内容不能为空，请点击新增填写"),!1):(layer.msg("知识意图未打标"),!1):(layer.msg("知识类目不能为空，请选择分类"),!1):(layer.msg("知识标题不能为空，请填写"),!1)}function increaseCheck(){$scope.vm.dimensionArr.id.length||($scope.vm.dimensionArr=angular.copy($scope.vm.dimensionsCopy)),isNewKnowledgeTitle()||$scope.vm.channel.length?isNewKnowledgeTitle()?$scope.vm.channel.length?checkChannelDimension($scope.vm.channel,$scope.vm.dimensionArr.id)||ngDialog.closeAll(1):layer.msg("请选择渠道后保存"):layer.msg("请填写知识内容后保存"):layer.msg("请填写知识内容,并选择渠道后保存")}function selectChannel(channelId){$scope.vm.channel.inArray(channelId)?$scope.vm.channel.remove(channelId):$scope.vm.channel.push(channelId)}function checkChannelDimension(channel,dimension){var isRepeat=!1;return angular.forEach($scope.vm.scanContent,function(item,contentIndex){$scope.vm.isEditIndex!=contentIndex&&angular.forEach(item.channelIdList,function(v){angular.forEach(channel,function(val,indexChannel){val==v&&angular.forEach(item.dimensionIdList,function(value){angular.forEach(dimension,function(key,indexDimension){if(key==value){var channelTip;angular.forEach($scope.vm.channels,function(all){all.channelCode==v&&(channelTip=all.channelName)}),layer.msg("重复添加渠道 "+channelTip+" 维度 "+$scope.vm.dimensionArr.name[indexDimension]),isRepeat=!0}})})})})}),isRepeat}function selectMultimedia(){ngDialog.openConfirm({template:"/static/knowledgeManagement/public-html/selectImage.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){}})}function addMultimedia(item){111==$scope.vm.contentType?$scope.vm.imgSelected={url:item.pictureUrl,id:item.pictureId,name:item.pictureName}:112==$scope.vm.contentType&&($scope.vm.voiceSelected={url:item.videoUrl,id:item.videoId,name:item.videoName}),ngDialog.close(ngDialog.latestID)}function getPicList(index){httpRequestPost("/api/ms/picture/queryPicture",{index:(index-1)*$scope.vm.imgPaginationConf.pageSize,pageSize:$scope.vm.imgPaginationConf.pageSize},function(data){200==data.status&&$scope.$apply(function(){$scope.vm.imageList=data.data.objs,$scope.vm.imgPaginationConf.currentPage=index,$scope.vm.imgPaginationConf.totalItems=data.data.total})},function(err){})}function getVoiceList(index){httpRequestPost("/api/ms/videoManage/queryVideo",{index:(index-1)*$scope.vm.voicePaginationConf.pageSize,pageSize:$scope.vm.voicePaginationConf.pageSize},function(data){200==data.status&&$scope.$apply(function(){$scope.vm.voiceList=data.data.objs,$scope.vm.voicePaginationConf.currentPage=index,$scope.vm.voicePaginationConf.totalItems=data.data.total})},function(err){})}function isNewKnowledgeTitle(){var isPass=!0;return 111==$scope.vm.contentType&&!$scope.vm.imgSelected.url||112==$scope.vm.contentType&&!$scope.vm.voiceSelected.name?isPass=!1:113!=$scope.vm.contentType||$("#emotion-container").html()||(isPass=!1),isPass}function addLint(){ngDialog.openConfirm({template:"/static/knowledgeManagement/markKnow/addLink.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){if(1===e){var aLink="<a href='"+$scope.vm.newLink+"' target='_blank'>"+$scope.vm.newLink+"</a>",html=$("#emotion-container").html()+aLink;$("#emotion-container").html(html)}$scope.vm.newLink=""}})}function isNewLinkAble(val){/^http(s)?:\/\/([\w-]+\.)+[\w-]+(\/[\w- .\/?%&=]*)?$/i.test(val)?ngDialog.close(ngDialog.latestID,1):layer.msg("请输入正确的链接地址")}function backUpExt(item){$scope.vm.extensionDeleted.inArray(item)||$scope.vm.extensionDeleted.push(item)}function addLocalExtension(title){var result=!1;return $scope.vm.extensionDeleted&&angular.forEach($scope.vm.extensionDeleted,function(item,index){title==item.extensionQuestionTitle&&(result=item,$scope.vm.extensionDeleted.splice(index,1))}),result}function showTip(){$(".shadow_div").show(),$(".step_div").show(),$("#step_one").show().siblings().hide()}function hideTip(){$(".shadow_div").hide(),$(".step_div").hide()}function prevDiv(e){var obj=e.srcElement?e.srcElement:e.target;$(obj).parent().parent().parent().prev()&&($(obj).parent().parent().parent().hide(),$(obj).parent().parent().parent().prev().show(),$("html, body").animate({scrollTop:$(obj).parent().parent().parent().prev().offset().top-20},500))}function nextDiv(e){var obj=e.srcElement?e.srcElement:e.target;$(obj).parent().parent().parent().next()&&($(obj).parent().parent().parent().hide(),$(obj).parent().parent().parent().next().show(),$("html, body").animate({scrollTop:$(obj).parent().parent().parent().next().offset().top-20},500))}if($scope.vm={knowledgeId:"",knowledgeOrigin:120,frames:[],frameId:"",knowledgeAdd:knowledgeAdd,botRoot:"",openContentConfirm:openContentConfirm,knowledgeBotVal:"",botSelectAdd:botSelectAdd,frameCategoryId:"",title:"",titleTip:"",timeStart:"",timeEnd:"",isTimeTable:!1,getBotAndExtensionByTitle:getBotAndExtensionByTitle,botClassfy:[],creatSelectBot:[],extensionTitle:"",extensionWeight:60,getExtension:getExtension,extensions:[],extensionsByFrame:[],extensionByTitleTag:[],extensionEdit:extensionEdit,scanContent:[],save:save,scan:scan,newTitle:"",channel:[],channels:[],channelArr:[],selectChannel:selectChannel,dimension:"",dimensions:[],dimensionArr:[],dimensionsCopy:[],checkChannelDimension:checkChannelDimension,slideDown:slideDown,slideFlag:!1,question:1,tip:1,tail:1,knowledgeTitleTag:[],appointRelative:"",appointRelativeList:[],removeAppointRelative:removeAppointRelative,appointRelativeGroup:[],replaceType:0,enterEvent:enterEvent,dialogExtension:[],limitSave:!1,isEditIndex:-1,contentType:113,imgPaginationConf:{pageSize:8,pagesLength:10},voicePaginationConf:{pageSize:8,pagesLength:10},getPicList:getPicList,selectMultimedia:selectMultimedia,imageList:[],addMultimedia:addMultimedia,imgSelected:"",voiceList:"",getVoiceList:getVoiceList,voiceSelected:"",qqFaceText:"",rmExtensionBackup:[],addLint:addLint,isNewLinkAble:isNewLinkAble,newLint:"",showTip:showTip,hideTip:hideTip,prevDiv:prevDiv,nextDiv:nextDiv,increaseCheck:increaseCheck,backupsOfExtension:"",sourceTitle:"",backUpExt:backUpExt,extensionDeleted:[]},$scope.master.getDimensions($scope,["dimensions","dimensionsCopy"]),$scope.master.getChannels($scope,["channels"]),$stateParams.data&&angular.fromJson($stateParams.data).knowledgeBase){var data=angular.fromJson($stateParams.data);$scope.vm.title=data.knowledgeBase.knowledgeTitle,$scope.vm.sourceTitle=data.knowledgeBase.knowledgeTitle,$scope.vm.knowledgeTitleTag=data.knowledgeBase.knowledgeTitleTag,$scope.vm.knowledgeId=data.knowledgeBase.knowledgeId,$scope.vm.knowledgeOrigin=data.knowledgeBase.knowledgeOrigin,(data.knowledgeBase.knowledgeExpDateStart||data.knowledgeBase.knowledgeExpDateEnd)&&($scope.vm.isTimeTable=!0),$scope.vm.timeStart=$filter("date")(data.knowledgeBase.knowledgeExpDateStart,"yyyy-MM-dd"),$scope.vm.timeEnd=$filter("date")(data.knowledgeBase.knowledgeExpDateEnd,"yyyy-MM-dd"),$scope.vm.creatSelectBot=data.knowledgeBase.classificationAndKnowledgeList,$scope.vm.extensionsByFrame=data.extensionQuestions,angular.forEach(data.extensionQuestions,function(item){}),angular.forEach(data.knowledgeContents,function(item){var obj={};obj.knowledgeContentNegative=item.knowledgeContentNegative,113==item.knowledgeContentNegative?obj.knowledgeContent=$filter("emotion")(item.knowledgeContent):obj.knowledgeContent=item.knowledgeContent,obj.channelIdList=item.channelIdList,obj.dimensionIdList=item.dimensionIdList,obj.knowledgeRelatedQuestionOn=item.knowledgeRelatedQuestionOn,obj.knowledgeBeRelatedOn=item.knowledgeBeRelatedOn,obj.knowledgeCommonOn=item.knowledgeCommonOn,obj.knowledgeRelevantContentList=item.knowledgeRelevantContentList,$scope.vm.scanContent.push(obj)})}$scope.$watch("vm.frameCategoryId",function(val,old){val&&val!=old&&getFrame(val)}),$scope.$watch("vm.frameId",function(val,old){val&&val!=old&&getExtensionByFrame(val)}),$scope.master.botTreeOperate($scope,"/api/ms/modeling/category/listbycategorypid","/api/ms/modeling/category/listbycategorypid",getBotFullPath),$scope.master.searchBotAutoTag(".botTagAuto","/api/ms/modeling/category/searchbycategoryname",function(suggestion){$scope.$apply(function(){var allBot=angular.copy($scope.vm.botClassfy.concat($scope.vm.creatSelectBot)),botResult=$scope.master.isBotRepeat(suggestion.data,suggestion.value.split("/"),suggestion.type,allBot);$scope.vm.knowledgeBotVal=suggestion.value,0!=botResult&&($scope.vm.botFullPath=botResult)})});var limitTimer;getPicList(1),getVoiceList(1);var picTimer;$scope.$watch("vm.imgPaginationConf.currentPage",function(current){current&&(picTimer&&$timeout.cancel(picTimer),picTimer=$timeout(function(){getPicList(current)},100))},!0);var voiceTimer;$scope.$watch("vm.voicePaginationConf.currentPage",function(current){current&&(voiceTimer&&$timeout.cancel(voiceTimer),voiceTimer=$timeout(function(){getVoiceList(current)},100))},!0)}]),angular.module("knowledgeManagementModule").controller("processKnowController",["$scope","$http","localStorageService","$state","ngDialog","$cookieStore","$timeout","$compile","FileUploader","knowledgeAddServer","$window","$stateParams","$interval","$rootScope","$filter",function($scope,$http,localStorageService,$state,ngDialog,$cookieStore,$timeout,$compile,FileUploader,knowledgeAddServer,$window,$stateParams,$interval,$rootScope,$filter){function deleteNode(index,num,type){var layerDialog=layer.confirm("是否要删除？",{btn:["确定","取消"]},function(){$scope.$apply(function(){$scope.vm.flowKnowledgeContentList.splice(index,num)}),bindingNodeChange(type,index),layer.close(layerDialog)},function(){})}function inputBlur(){$timeout(function(){3==$scope.vm.triggerCondition&&($scope.vm.triggerCondition=0)},200)}function bindingNodeChange(type,index){var nodeLen=$scope.vm.flowKnowledgeContentList.length;if(1==nodeLen)angular.forEach($scope.vm.flowKnowledgeContentList[0].contentSubsequentList,function(item,cur){$scope.vm.flowKnowledgeContentList[0].contentSubsequentList[cur].nodeNo=null});else if(nodeLen>=2)if(0==type)angular.forEach($scope.vm.flowKnowledgeContentList,function(process,processCur){angular.forEach(process.contentSubsequentList,function(item,itemCur){if(null==item.nodeNo)return!0;var nodeNumber=null,number=parseInt(item.nodeNo);number>index?nodeNumber=number-1:number<index&&(nodeNumber=number),$scope.vm.flowKnowledgeContentList[processCur].contentSubsequentList[itemCur].nodeNo=nodeNumber})});else if(1==type)angular.forEach($scope.vm.flowKnowledgeContentList,function(process,processCur){angular.forEach(process.contentSubsequentList,function(item,itemCur){if(null==item.nodeNo)return!0;var number=parseInt(item.nodeNo);number>=index&&($scope.vm.flowKnowledgeContentList[processCur].contentSubsequentList[itemCur].nodeNo=number+1)})});else if(2==type){var movingIndex=index,movedIndex=index-1;angular.forEach($scope.vm.flowKnowledgeContentList,function(process,processCur){angular.forEach(process.contentSubsequentList,function(item,itemCur){if(null==item.nodeNo)return!0;var number=parseInt(item.nodeNo);number==movingIndex?$scope.vm.flowKnowledgeContentList[processCur].contentSubsequentList[itemCur].nodeNo=movedIndex:number==movedIndex&&($scope.vm.flowKnowledgeContentList[processCur].contentSubsequentList[itemCur].nodeNo=movingIndex)})})}else if(3==type){var movingIndex=index,movedIndex=index+1;angular.forEach($scope.vm.flowKnowledgeContentList,function(process,processCur){angular.forEach(process.contentSubsequentList,function(item,itemCur){if(null==item.nodeNo)return!0;var number=parseInt(item.nodeNo);number==movingIndex?$scope.vm.flowKnowledgeContentList[processCur].contentSubsequentList[itemCur].nodeNo=movedIndex:number==movedIndex&&($scope.vm.flowKnowledgeContentList[processCur].contentSubsequentList[itemCur].nodeNo=movingIndex)})})}}function moveUp(index){var temp=angular.copy($scope.vm.flowKnowledgeContentList[index]);$scope.vm.flowKnowledgeContentList.splice(index,1),$scope.vm.flowKnowledgeContentList.insert(index-1,temp),bindingNodeChange(2,index)}function moveDown(index){var temp=angular.copy($scope.vm.flowKnowledgeContentList[index]);$scope.vm.flowKnowledgeContentList.splice(index,1),$scope.vm.flowKnowledgeContentList.insert(index+1,temp),bindingNodeChange(3,index)}function newNode(index){resetParams(),$(".right_popup_div").show(),$(".arrow").removeClass("act"),$scope.vm.newIndex=index}function getFactorContent(id){$scope.vm.factorContent=[],$http.get("api/ms/knowledgeManage/getKnowledgeContent/"+id).then(function(response){angular.forEach(angular.fromJson(response.data.data[0].knowledgeContent).items,function(item,index){$scope.vm.factorContent.push({answer:item.name,nodeNo:null})})})}function addNewKnow(){var api=$scope.vm.knowledgeId?"api/ms/flowKnowledge/edit":"/api/ms/flowKnowledge/add";angular.forEach($scope.vm.flowKnowledgeContentList,function(item,index){$scope.vm.flowKnowledgeContentList[index].nodeNo=index});var params={applicationId:APPLICATION_ID,knowledgeTitle:$scope.vm.flowKnowledgeContentList[0].nodeName,knowledgeCreator:USER_LOGIN_NAME,flowKnowledgeContentList:$scope.vm.flowKnowledgeContentList,userId:USER_ID};$scope.vm.knowledgeId&&(params.knowledgeId=$scope.vm.knowledgeId),httpRequestPost(api,params,function(response){200==response.status?""==$scope.vm.statusId?(layer.msg("新增知识已进入审核列表",{time:2e3}),$state.go("knowledgeManagement.custOverview")):4==$scope.vm.statusId?(layer.msg("编辑知识已进入审核列表",{time:2e3}),$state.go("knowledgeManagement.custOverview")):$state.go("knowledgeManagement.custOverview"):500==response.status&&layer.msg(response.data)})}function storeNewProcess(editIndex){if(!$scope.vm.nodeName)return layer.msg("请输入节点名称");var isRepeat,curIndex;if(angular.forEach($scope.vm.flowKnowledgeContentList,function(item,index){if($scope.vm.nodeName==item.nodeName&&editIndex!=index)return isRepeat=!0,layer.msg("节点名称重复")}),!isRepeat){var strikeValue="",triggerKnowledge="",contentSubsequentList=[],strikeNumber=1,triggerValueOfTitle="",triggerKnowledgeOfTitle="",triggerType=3;1==$scope.vm.triggerCondition&&$scope.vm.strikeValue.id&&$scope.vm.strikeValue.name?(triggerType=1,strikeNumber=$scope.vm.strikeNumber,strikeValue=$scope.vm.strikeValue.id,triggerValueOfTitle=$scope.vm.strikeValue.name):2==$scope.vm.triggerCondition&&$scope.vm.triggerKnowTitle.id&&$scope.vm.triggerKnowTitle.name&&(triggerType=2,strikeNumber=1,strikeValue=$scope.vm.triggerKnowTitle.id,triggerValueOfTitle=$scope.vm.triggerKnowTitle.name),$scope.vm.triggerKnowledge.name&&$scope.vm.triggerKnowledge.id&&(triggerKnowledgeOfTitle=$scope.vm.triggerKnowledge.name,triggerKnowledge=$scope.vm.triggerKnowledge.id),0==$scope.vm.actionType?contentSubsequentList.push({answer:"等待用户输入",nodeNo:null}):1==$scope.vm.actionType?contentSubsequentList=$scope.vm.factorContent:2==$scope.vm.actionType&&(contentSubsequentList=$scope.vm.knowJump),curIndex=null!=$scope.vm.newIndex?$scope.vm.newIndex:$scope.vm.flowKnowledgeContentList.length;var storeParams={nodeName:$scope.vm.nodeName,triggerType:triggerType,triggerValue:strikeValue,triggerValueOfTitle:triggerValueOfTitle,triggerNum:strikeNumber,triggerKnowledge:triggerKnowledge,triggerKnowledgeOfTitle:triggerKnowledgeOfTitle,actionType:$scope.vm.actionType,contentSubsequentList:contentSubsequentList},storeParamsCopy=angular.copy(storeParams);null!=editIndex?$scope.vm.flowKnowledgeContentList[editIndex]=storeParamsCopy:($scope.vm.flowKnowledgeContentList.splice(curIndex,0,storeParamsCopy),bindingNodeChange(1,curIndex)),resetParams(),$(".right_popup_div").hide(),$(".arrow").removeClass("act")}}function selectKnowTitle(know,title){103==know.knowledgeType?($scope.vm.isFactorKnow=!0,getFactorContent(know.knowledgeId)):$scope.vm.isFactorKnow=!1,$scope.vm[title]={id:know.knowledgeId,name:know.knowledgeTitle},$scope.vm.recommendKnow=[]}function editNode(item,index){$scope.vm.relatedIndex=index,$scope.vm.isEditIndex=index,1==item.triggerType?($scope.vm.triggerCondition=1,$scope.vm.strikeValue={id:item.triggerValue,name:item.triggerValueOfTitle},$scope.vm.triggerKnowTitle={id:"",name:""}):2==item.triggerType?($scope.vm.triggerCondition=2,$scope.vm.strikeValue={id:"",name:""},$scope.vm.triggerKnowTitle={id:item.triggerValue,name:item.triggerValueOfTitle}):3==item.triggerType&&($scope.vm.triggerCondition=0,$scope.vm.triggerKnowTitle={id:"",name:""},$scope.vm.strikeValue={id:"",name:""}),$scope.vm.triggerKnowledge={id:item.triggerKnowledge,name:item.triggerKnowledgeOfTitle},1==item.actionType?($scope.vm.isFactorKnow=!0,$scope.vm.factorContent=item.contentSubsequentList):2==item.actionType?($scope.vm.isFactorKnow=!1,$scope.vm.knowJump=item.contentSubsequentList):$scope.vm.isFactorKnow=!1,$scope.vm.nodeName=item.nodeName,$scope.vm.strikeNumber=item.triggerNum,$scope.vm.triggerCondition=item.triggerType,$scope.vm.triggerType=item.triggerType,$scope.vm.actionType=item.actionType}function resetParams(){$scope.vm.relatedIndex=null,$scope.vm.isEditIndex=null,$scope.vm.newIndex=null,$scope.vm.selectNodeVal="",$scope.vm.isFactorKnow=!1,$scope.vm.triggerKnowledge="",$scope.vm.triggerKnowTitle="",$scope.vm.actionType=0,$scope.vm.triggerCondition=0,$scope.vm.nodeName="",$scope.vm.strikeNumber="",$scope.vm.botVal="",$scope.vm.factorContent=[],$scope.vm.knowJump=[{answer:"",nodeNo:null}],$scope.vm.strikeValue="",$scope.vm.triggerKnowTitle="",$scope.vm.triggerKnowledge="",$("#knowTitle").val("")}function removeAutoList(){$timeout(function(){$scope.vm.recommendKnow=[]},200)}function openSelectNodeDialog(type,index,num){1==type||$scope.vm.factorContent,$scope.vm.selectNodeVal=index&&null!=num?num:0;ngDialog.openConfirm({template:"/static/knowledgeManagement/processKnow/select_node.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){1===e&&(1==type?$scope.vm.knowJump[0].nodeNo=$scope.vm.selectNodeVal:$scope.vm.factorContent[index].nodeNo=$scope.vm.selectNodeVal)}})}function auditPassedOrNopass(statusId){if(""==$scope.vm.reason&&4==statusId)return layer.msg("请填写不通过理由！！！"),!1;httpRequestPost("/api/ms/knowledgeManage/overView/auditPassed",{statusId:statusId,reason:$scope.vm.reason,knowledgeIds:[$scope.vm.knowledgeId],knowledgeUpdater:USER_NAME},function(data){200==data.status&&1==statusId?(layer.msg("审核成功,请在知识总览查看",{time:2e3}),$state.reload(),window.history.go(-1)):200==data.status&&4==statusId&&(layer.msg(data.info),$state.reload(),window.history.go(-1))})}$scope.vm={knowledgeId:$stateParams.knowledgeId?$stateParams.knowledgeId:"",statusId:$stateParams.statusId?$stateParams.statusId:"",selectNodeVal:"",recommendKnow:[],flowKnowledgeContentList:[],isFactorKnow:!1,newIndex:null,isEditIndex:null,botRoot:"",disabled:{background:"#eee"},relatedIndex:null,triggerKnowledge:"",triggerKnowTitle:"",actionType:0,triggerCondition:0,nodeName:"",strikeNumber:"",botVal:"",factorContent:[],knowJump:[{answer:"",nodeNo:null}],removeAutoList:removeAutoList,openSelectNodeDialog:openSelectNodeDialog,moveUp:moveUp,moveDown:moveDown,storeNewProcess:storeNewProcess,addNewKnow:addNewKnow,selectKnowTitle:selectKnowTitle,editNode:editNode,resetParams:resetParams,bindingNodeChange:bindingNodeChange,newNode:newNode,inputBlur:inputBlur,deleteNode:deleteNode,auditPassedOrNopass:auditPassedOrNopass,reason:""},function(id){id?$http.get("api/ms/flowKnowledge/"+id).then(function(response){var data=response.data.data,list=data.flowKnowledgeContentList;angular.forEach(list,function(item,index){1==item.triggerType?(list[index].triggerValueOfTitle=item.className.join(",").replace(/\,/g,"/"),list[index].triggerKnowledgeOfTitle=null!=item.knowledge?item.knowledge.knowledgeTitle:""):2==item.triggerType?(list[index].triggerValueOfTitle=item.knowledge.knowledgeTitle,list[index].triggerKnowledgeOfTitle=""):3==item.triggerType&&(list[index].triggerValueOfTitle="",list[index].triggerKnowledgeOfTitle=item.knowledge.knowledgeTitle),$scope.vm.flowKnowledgeContentList=list}),$(".right_popup_div").hide(),$(".arrow").removeClass("act")}):($(".right_popup_div").show(),$(".arrow").removeClass("act"))}($scope.vm.knowledgeId),$(".trigger_know_title_key,.robot_key_words").bind("input focus",function(){var keyWords=$(this).val();httpRequestPost("/api/ms/knowledgeManage/getKnowledgeTitle",{applicationId:APPLICATION_ID,title:keyWords},function(response){200==response.status&&$scope.$apply(function(){$scope.vm.recommendKnow=response.data})},function(error){})}),$scope.master.botTreeOperate($scope,"/api/ms/modeling/category/listbycategorypid","/api/ms/modeling/category/listbycategorypid",function(id){httpRequestPost("/api/ms/modeling/category/getcategoryfullname",{categoryId:id},function(data){(data.status=1e4)&&$scope.$apply(function(){$scope.vm.strikeValue={id:id,name:data.categoryFullName}})})},"",".strikeRootClassfy")}]),angular.module("knowledgeManagementModule").controller("recommendKnowController",["$scope","localStorageService","$state","ngDialog","$cookieStore","$timeout","$compile","FileUploader","knowledgeAddServer","$window","$stateParams","$interval","$rootScope","$filter",function($scope,localStorageService,$state,ngDialog,$cookieStore,$timeout,$compile,FileUploader,knowledgeAddServer,$window,$stateParams,$interval,$rootScope,$filter){function init(){$scope.vm.tableList={data:{listTable:new Array(new Array("答案"))}},$scope.vm.listTableType=[];var newType={};newType.elementName="答案",newType.elementType="字符串",newType.technology=null,newType.elementAsk="",newType.relatedQuestions=null,$scope.vm.listTableType.push(newType),$scope.vm.tableList.data.listTableType=$scope.vm.listTableType}function tableChange(row,col,val){$scope.vm.tableList.data.listTable[row][col]=val}function tableRemove(type){switch(type){case 1:0==$scope.vm.tableRow?layer.msg("不可删除第一行"):null==$scope.vm.tableRow?layer.msg("请先选择要删除的行"):($scope.vm.tableList.data.listTable.splice($scope.vm.tableRow,1),$scope.vm.tableRow=null);break;case 2:0==$scope.vm.tableColumn?layer.msg("不可删除第一列"):null==$scope.vm.tableRow?layer.msg("请先选择要删除的列"):(angular.forEach($scope.vm.tableList.data.listTable,function(item,tableRow){angular.forEach(item,function(val,index){index==$scope.vm.tableColumn&&$scope.vm.tableList.data.listTable[tableRow].splice(index,1)})}),$scope.vm.tableList.data.listTableType.splice($scope.vm.tableColumn,1),$scope.vm.tableColumn=null)}}function addRow(){var len=$scope.vm.tableList.data.listTable[0].length,arr=new Array(len);$scope.vm.tableList.data.listTable.push(arr)}function tableSaveCheck(){$scope.vm.factorName?$scope.vm.elementAsk?ngDialog.closeAll(1):layer.msg("请填写反问后保存"):layer.msg("请填写要素名称后保存")}function pro_name(row,column){($scope.vm.connectKnowCopy=angular.copy($scope.vm.connectKnow),0==$scope.vm.connectKnowCopy.length&&angular.forEach($scope.vm.tableList.data.listTable,function(item,index){index>0&&(null!=item[0]?$scope.vm.connectKnowCopy.push({appoint:{relatedTitle:"",relatedId:""},item:item[0]}):$scope.vm.connectKnowCopy.push({appoint:{relatedTitle:"",relatedId:""},item:""}))}),0==angular.element(".ngdialog ").length)&&ngDialog.openConfirm({template:"/static/knowledgeManagement/recommendKnow/recommendDialog2.html",width:"695px",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){1===e&&(angular.forEach($scope.vm.connectKnowCopy,function(item,index){item.appoint.relatedTitle||($scope.vm.connectKnowCopy[index].appoint.relatedId="")}),$scope.vm.connectKnow=angular.copy($scope.vm.connectKnowCopy))}})}function addList(row,column){0==angular.element(".ngdialog ").length&&ngDialog.openConfirm({template:"/static/knowledgeManagement/recommendKnow/recommendDialog.html",width:"695px",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){if(1===e){angular.forEach($scope.vm.tableList.data.listTable,function(item,index){0==index?$scope.vm.tableList.data.listTable[index].push($scope.vm.factorName):$scope.vm.tableList.data.listTable[index].push(null)});var newType={elementName:$scope.vm.factorName,elementType:$scope.vm.tableType,technology:$scope.vm.gorithm,elementAsk:$scope.vm.elementAsk,relatedQuestions:null};$scope.vm.tableList.data.listTableType.push(newType),setDialogNew()}else setDialogNew()}})}function editList(row,column){$scope.vm.factorName=$scope.vm.tableList.data.listTableType[column].elementName,$scope.vm.tableType=$scope.vm.tableList.data.listTableType[column].elementType,$scope.vm.gorithm=$scope.vm.tableList.data.listTableType[column].technology,$scope.vm.elementAsk=$scope.vm.tableList.data.listTableType[column].elementAsk;ngDialog.openConfirm({template:"/static/knowledgeManagement/recommendKnow/recommendDialog.html",width:"695px",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){1===e?($scope.vm.tableList.data.listTableType[column].elementName=$scope.vm.factorName,$scope.vm.tableList.data.listTableType[column].elementType=$scope.vm.tableType,$scope.vm.tableList.data.listTableType[column].technology=$scope.vm.gorithm,$scope.vm.tableList.data.listTableType[column].elementAsk=$scope.vm.elementAsk,$scope.vm.tableList.data.listTable[0][column]=$scope.vm.factorName,setDialogNew()):setDialogNew()}})}function getTableParams(){if($scope.vm.tableList.data){var tabelData=angular.copy($scope.vm.tableList.data),params={},ask=[],items=[];return angular.forEach(tabelData.listTableType,function(item,index){if(index>0){var obj={name:item.elementName,value:item.elementAsk};ask.push(obj)}}),angular.forEach(tabelData.listTable,function(item,icon){if(icon>0){var row={};if(row.name=item[0],0!=$scope.vm.connectKnow.length){var isExit=void 0!=$scope.vm.connectKnow[icon-1]&&void 0!=$scope.vm.connectKnow[icon-1].appoint;row.relatedTitle=isExit?$scope.vm.connectKnow[icon-1].appoint.relatedTitle:"",row.relatedId=isExit?$scope.vm.connectKnow[icon-1].appoint.relatedId:""}else row.relatedTitle="",row.relatedId="";row.slots=[],angular.forEach(tabelData.listTableType,function(val,cur){if(cur>0){var slot={};slot.name=val.elementName,slot.value=tabelData.listTable[icon][cur],slot.type=val.elementType,slot.algorithm=val.technology,row.slots.push(slot)}}),items.push(row)}}),params.asks=ask,params.items=items,JSON.stringify(params)}return!1}function setDialogNew(){$scope.vm.factorName=null,$scope.vm.tableType="字符串",$scope.vm.gorithm=["NLP"],$scope.vm.elementAsk=null}function getFrame(id){httpRequestPost("/api/ms/modeling/frame/listbyattribute",{frameCategoryId:id,frameEnableStatusId:1,frameTypeId:10013,index:0,pageSize:32767},function(data){10005!=data.status&&data.data.length&&($scope.vm.frames=$scope.vm.frames.concat(data.data),$scope.$apply())},function(){})}function getTableListByFrame(id,type){httpRequestPost("/api/ms/modeling/frame/listbyattribute",{frameTypeId:10013,frameId:id,index:0,pageSize:32767},function(data){1e4==data.status&&data.data[0].elements&&$.each(data.data[0].elements,function(index,value){for(var addFlag=!0,i=0;i<$scope.vm.tableList.data.listTable[0].length;i++)$scope.vm.tableList.data.listTable[0][i]==value.elementContent&&(addFlag=!1);if(1==addFlag){$scope.vm.tableList.data.listTable[0].push(value.elementContent);var newType={};newType.elementName=value.elementContent,newType.elementType=switchContentType(value.elementTypeId);var miningTypeArr=[];miningTypeArr.push(switchMiningType(value.elementMiningTypeId)),newType.technology=miningTypeArr,newType.elementAsk=value.elementAskContent,newType.relatedQuestions=value.elementRelateConcept,$scope.vm.tableList.data.listTableType.push(newType),$scope.$apply()}})},function(){})}function switchMiningType(type){return""}function switchContentType(type){var returnStr="字符串";switch(type){case 10014:returnStr="字符串";break;case 10015:returnStr="日期";break;case 10016:returnStr="范围"}return returnStr}function getBotFullPath(id){httpRequestPost("/api/ms/modeling/category/getcategoryfullname",{categoryId:id},function(data){if(data.status=1e4){var allBot=angular.copy($scope.vm.creatSelectBot.concat($scope.vm.botClassfy)),botResult=$scope.master.isBotRepeat(id,data.categoryFullName.split("/"),"",allBot);$scope.$apply(function(){$scope.vm.knowledgeBotVal=data.categoryFullName,0!=botResult&&($scope.vm.botFullPath=botResult)})}},function(){})}function botSelectAdd(){$scope.vm.botFullPath&&($scope.vm.creatSelectBot.push($scope.vm.botFullPath),$scope.vm.frameCategoryId=$scope.vm.botFullPath.classificationId,$scope.vm.botFullPath=null,$scope.vm.knowledgeBotVal="",$(".icon-jj").eq(0).css("backgroundPosition","0% 0%"))}function slideDown(){$scope.vm.slideFlag=!$scope.vm.slideFlag,$(".senior_div").slideToggle(),$scope.vm.slideFlag&&$(".senior_div").css("overflow","visible")}function getParams(){var params={applicationId:APPLICATION_ID,knowledgeId:$scope.vm.knowledgeId,userId:USER_ID,sceneId:SCENE_ID,knowledgeType:107,knowledgeTitle:$scope.vm.title,knowledgeExpDateStart:$scope.vm.isTimeTable?$scope.vm.timeStart:null,knowledgeExpDateEnd:$scope.vm.isTimeTable?$scope.vm.timeEnd:null,knowledgeUpdater:USER_LOGIN_NAME,knowledgeCreator:USER_LOGIN_NAME,knowledgeOrigin:$scope.vm.knowledgeOrigin},obj={};return obj.knowledgeContent=getTableParams(),obj.channelIdList=$scope.vm.channel,$scope.vm.dimensionArr.id.length||($scope.vm.dimensionArr=angular.copy($scope.vm.dimensionsCopy)),obj.dimensionIdList=$scope.vm.dimensionArr.id.length?$scope.vm.dimensionArr.id:$scope.vm.dimensionsCopy.id,obj.knowledgeRelatedQuestionOn=$scope.vm.question,obj.knowledgeBeRelatedOn=$scope.vm.tip,obj.knowledgeCommonOn=$scope.vm.tail,$scope.vm.scanContent=new Array(obj),params.knowledgeContents=angular.copy($scope.vm.scanContent),params.extensionQuestions=new Array({extensionQuestionTitle:$scope.vm.strikeValue.id,extensionQuestionType:$scope.vm.strikeNumber,extensionQuestionName:$scope.vm.strikeValue.name}),params.classificationAndKnowledgeList=$scope.vm.botClassfy.concat($scope.vm.creatSelectBot),params}function save(){checkSave(function(){if(!$scope.vm.limitSave){$timeout.cancel(limitTimer),$scope.vm.limitSave=!0,limitTimer=$timeout(function(){$scope.vm.limitSave=!1},18e4),$scope.vm.data=getParams();var api=$scope.vm.knowledgeId?"/api/ms/recommendMarketingKnowledge/editKnowledge":"/api/ms/recommendMarketingKnowledge/addKnowledge";httpRequestPost(api,getParams(),function(data){200==data.status?""==$stateParams.data?($state.go("knowledgeManagement.custOverview"),layer.msg("新增知识已进入审核列表",{time:2e3})):$stateParams.data&&4==angular.fromJson($stateParams.data).knowledgeBase.statusId?($state.go("knowledgeManagement.custOverview"),layer.msg("编辑知识已进入审核列表",{time:2e3})):$state.go("knowledgeManagement.custOverview"):500==data.status&&(layer.msg(data.data),$timeout.cancel(limitTimer),$scope.$apply(function(){$scope.vm.limitSave=!1}))},function(err){$timeout.cancel(limitTimer),$scope.$apply(function(){$scope.vm.limitSave=!1})})}})}function scan(){checkSave(function(){var obj={},params=getParams();obj.params=params,obj.editUrl="knowledgeManagement.recommendKnow",obj.knowledgeType=107,obj.knowledgeId=$scope.vm.knowledgeId,$scope.vm.knowledgeId?(obj.api="/api/ms/recommendMarketingKnowledge/editKnowledge",params.knowledgeId=$scope.vm.knowledgeId):obj.api="/api/ms/recommendMarketingKnowledge/addKnowledge",$window.knowledgeScan=obj;var url=$state.href("knowledgeManagement.knowledgeScan");$window.open(url,"_blank")})}function selectChannel(channelId){$scope.vm.channel.inArray(channelId)?$scope.vm.channel.remove(channelId):$scope.vm.channel.push(channelId)}function checkSave(callBack){var params=getParams();if(params.knowledgeTitle){var isBotStrikeRepeat=!1;if(angular.forEach(params.classificationAndKnowledgeList,function(item,index){if(params.extensionQuestions[0].extensionQuestionName==item.className.join("/"))return isBotStrikeRepeat=!0,void layer.msg("触发要素与BOT路径有重复请,返回修改")}),!params.classificationAndKnowledgeList.length)return layer.msg("知识类目不能为空，请选择分类"),!1;if(isBotStrikeRepeat);else{if(!params.knowledgeContents[0].channelIdList.length)return layer.msg("渠道不能为空"),!1;if($scope.vm.tableList.data.listTable[0].length<=1||$scope.vm.tableList.data.listTable.length<=1)return layer.msg("请完善表格知识"),!1;callBack()}}else layer.msg("知识标题不能为空，请填写")}function addAppoint(item,arr){-1==arr.indexOf(item)&&arr.push(item),$scope.vm.appointRelative=null,$scope.vm.appointRelativeList=[]}function getAppointRelative(title){httpRequestPost("/api/ms/recommendMarketingKnowledge/getKnowledgeTitle",{title:title},function(data){200==data.status&&($scope.vm.appointRelativeList=data.data,$scope.$apply())},function(err){})}function bind(e,cur){e=e||window.event;var srcObj=e.srcElement?e.srcElement:e.target;new Array("103");$(srcObj).on("input",function(){var val=$(srcObj).val();httpRequestPostParam("api/ms/recommendMarketingKnowledge/findKnowledgeTitle",{applicationId:APPLICATION_ID,knowledgeTitle:val,knowledgeTypeList:"103"},function(data){if(200==data.status&&data.data.length>0){var html="";angular.forEach(data.data,function(item){html+="<li data-option='"+item.knowledgeId+"'>"+item.knowledgeTitle+"</li>"}),$(srcObj).next().html(html),$(srcObj).next().on("click","li",function(){var title=$(this).html(),id=$(this).attr("data-option");$scope.$apply(function(){$scope.vm.connectKnowCopy[cur].appoint.relatedTitle=title,$scope.vm.connectKnowCopy[cur].appoint.relatedId=id}),$(srcObj).next().html("")}),$(srcObj).on("blur",function(){$timeout(function(){$(srcObj).next().html("")},200)})}},function(){})})}function isAppointKnowRight(){var result=!0;angular.forEach($scope.vm.connectKnowCopy,function(item,index){if(item.item){var indexTitle=$scope.vm.allRelateTitle.name.indexOf(item.appoint.relatedTitle),indexId=$scope.vm.allRelateTitle.id.indexOf(item.appoint.relatedId);item.appoint.relatedTitle&&!item.appoint.relatedId?-1!=indexTitle&&-1==indexId?$scope.vm.connectKnowCopy[index].appoint.relatedId=$scope.vm.allRelateTitle.id[indexTitle]:(result=!1,layer.msg('请重新选择 "'+item.item+'" 的相关知识',{time:2e3})):item.appoint.relatedTitle?-1!=indexTitle&&-1!=indexId&&indexTitle==indexId||(result=!1,layer.msg('请重新选择 "'+item.item+'" 的相关知识',{time:2e3})):($scope.vm.connectKnowCopy[index].appoint.relatedId="",$scope.vm.connectKnowCopy[index].appoint.relatedTitle="")}else $scope.vm.connectKnowCopy[index].appoint.relatedId="",$scope.vm.connectKnowCopy[index].appoint.relatedTitle=""}),result&&ngDialog.closeAll(1)}if($scope.vm={knowledgeId:"",knowledgeOrigin:120,frames:[],frameId:"",botRoot:"",knowledgeBotVal:"",botSelectAdd:botSelectAdd,frameCategoryId:"",title:"",titleTip:"",timeStart:"",timeEnd:"",isTimeTable:!1,botClassfy:[],creatSelectBot:[],extensionTitle:"",extensionWeight:60,extensions:[],extensionByTitleTag:[],botFullPath:"",scanContent:[],save:save,scan:scan,newTitle:"",channel:[],channels:[],channelArr:[],selectChannel:selectChannel,dimension:"",dimensions:[],dimensionArr:[],dimensionsCopy:[],slideDown:slideDown,slideFlag:!1,question:1,tip:1,tail:1,appointRelative:"",appointRelativeList:[],addAppoint:addAppoint,replaceType:0,enterEvent:enterEvent,pro_name:pro_name,addList:addList,editList:editList,tableRow:null,tableColumn:null,tableChange:tableChange,tableRemove:tableRemove,addRow:addRow,gorithm:"",tableType:"字符串",factorName:null,reQuestion:null,tableList:"",listTableType:"",data:"",column:"",tableSaveCheck:tableSaveCheck,limitSave:!1,rmExtensionBackup:[],strikeNumber:1,strikeValue:{},connectKnow:[],connectKnowCopy:[],bind:bind,isAppointKnowRight:isAppointKnowRight,allRelateTitle:{},isDecorateSimple:!1,backupsOfExtension:""},$scope.master.getDimensions($scope,["dimensions","dimensionsCopy"]),$scope.master.getChannels($scope,["channels"]),$stateParams.data&&angular.fromJson($stateParams.data).knowledgeBase){var data=angular.fromJson($stateParams.data);$scope.vm.title=data.knowledgeBase.knowledgeTitle,(data.knowledgeBase.knowledgeExpDateStart||data.knowledgeBase.knowledgeExpDateEnd)&&($scope.vm.isTimeTable=!0),$scope.vm.timeStart=$filter("date")(data.knowledgeBase.knowledgeExpDateStart,"yyyy-MM-dd"),$scope.vm.timeEnd=$filter("date")(data.knowledgeBase.knowledgeExpDateEnd,"yyyy-MM-dd"),$scope.vm.creatSelectBot=data.knowledgeBase.classificationAndKnowledgeList,$scope.vm.knowledgeId=data.knowledgeBase.knowledgeId,$scope.vm.knowledgeOrigin=data.knowledgeBase.knowledgeOrigin,httpRequestPost("/api/ms/modeling/category/getcategoryfullname",{categoryId:data.extensionQuestions[0].extensionQuestionTitle},function(resonse){(resonse.status=1e4)&&($scope.vm.strikeValue={id:data.extensionQuestions[0].extensionQuestionTitle,name:resonse.categoryFullName})}),$scope.vm.strikeNumber=data.extensionQuestions?data.extensionQuestions[0].extensionQuestionType:"",angular.forEach(data.knowledgeContents,function(item){var obj={},trueValue=angular.fromJson(item.knowledgeContentTrue).items;$scope.vm.tableList={},$scope.vm.tableList.data=item.knowledgeContent,$scope.vm.connectKnow=[],angular.forEach(trueValue,function(tag,cure){0!=cure&&($scope.vm.tableList.data.listTableType[cure].technology=tag.slots[0].algorithm),$scope.vm.connectKnow.push({appoint:{relatedTitle:tag.relatedTitle?tag.relatedTitle:"",relatedId:tag.relatedId?tag.relatedId:""},item:tag.name})}),obj.channelIdList=item.channelIdList,obj.dimensionIdList=item.dimensionIdList,$scope.vm.channel=item.channelIdList,$scope.vm.dimensionArr=[];var getDimension=$interval(function(){$scope.vm.dimensions&&($interval.cancel(getDimension),angular.forEach($scope.vm.dimensions,function(val){if(item.dimensionIdList.inArray(val.dimensionId)){var obj={};obj.dimensionName=val.dimensionName,obj.dimensionId=val.dimensionId,$scope.vm.dimensionArr.push(obj)}}))},100);$scope.vm.question=item.knowledgeRelatedQuestionOn,$scope.vm.tip=item.knowledgeBeRelatedOn,$scope.vm.tail=item.knowledgeCommonOn})}else init();$stateParams.knowledgeTitle&&($scope.vm.title=$stateParams.knowledgeTitle),$scope.$watch("vm.frameCategoryId",function(val,old){val&&val!=old&&getFrame(val)}),$scope.$watch("vm.frameId",function(val,old){val&&val!=old&&getTableListByFrame(val)}),$scope.master.botTreeOperate($scope,"/api/ms/modeling/category/listbycategorypid","/api/ms/modeling/category/listbycategorypid",getBotFullPath,"",".originRootClassfy"),$scope.master.searchBotAutoTag(".originBotAuto","/api/ms/modeling/category/searchbycategoryname",function(suggestion){$scope.$apply(function(){var allBot=angular.copy($scope.vm.botClassfy.concat($scope.vm.creatSelectBot)),botResult=$scope.master.isBotRepeat(suggestion.data,suggestion.value.split("/"),suggestion.type,allBot);$scope.vm.knowledgeBotVal=suggestion.value,0!=botResult&&($scope.vm.botFullPath=botResult)})}),$scope.master.botTreeOperate($scope,"/api/ms/modeling/category/listbycategorypid","/api/ms/modeling/category/listbycategorypid",function(id){httpRequestPost("/api/ms/modeling/category/getcategoryfullname",{categoryId:id},function(data){(data.status=1e4)&&$scope.$apply(function(){$scope.vm.strikeValue={id:id,name:data.categoryFullName}})})},"",".strikeRootClassfy");var limitTimer;$scope.$watch("vm.appointRelative",function(title){title&&$timeout(getAppointRelative(title),300)}),function(){$scope.vm.allRelateTitle={id:[],name:[]},httpRequestPostParam("api/ms/recommendMarketingKnowledge/findKnowledgeTitle",{applicationId:APPLICATION_ID,knowledgeTitle:"",knowledgeTypeList:"103"},function(data){200==data.status&&data.data.length>0&&angular.forEach(data.data,function(item_all,index_all){$scope.vm.allRelateTitle.name.push(item_all.knowledgeTitle),$scope.vm.allRelateTitle.id.push(item_all.knowledgeId)})})}()}]),knowledge_static_web.directive("autoComplete",function($compile,$timeout,$interval){return{scope:{source:"=",result:"=",width:"="},template:'<div class="miles-autoBar"><div class="miles-container" style="height: auto;"><div class="miles-resultItem L" ng-if="result.name" ng-repeat="val in result.name track by $index"><i class="miles-remove" ng-click="removeItem($index,val)">x</i><span>{{val}}</span></div><input class="miles-autoInput L"  id="input" name="input" style="width:100%;" ng-focus="flag=true" type="text"/></div><label for="input"><ul ng-if="source.name&&source.name.length" class="miles-dropDown" ng-show="flag"><li class="miles-item" ng-repeat="item in source.name track by $index" ng-click="addItem($index,item)">{{item}}</li></ul></label></div>',replace:!0,link:function($scope,elem,attr,ctrl){$scope.search=" ",$scope.flag=!1;var result={};result.id=[],result.name=[];var source={};source.id=[],source.name=[];var timer=$interval(function(){$scope.source&&($interval.cancel(timer),angular.forEach($scope.source,function(item){source.name.push(item.dimensionName),source.id.push(item.dimensionId),$scope.source=source}),$scope.result&&$scope.source.name&&(angular.forEach($scope.result,function(item){$scope.source.name.remove(item.dimensionName),$scope.source.id.remove(item.dimensionId),result.name.push(item.dimensionName),result.id.push(item.dimensionId)}),$scope.result=result),$scope.addItem=function(index,item){$scope.result.name.push(item),$scope.result.id.push($scope.source.id[index]),$scope.source.name.splice(index,1),$scope.source.id.splice(index,1),$("#input").val("")},$scope.removeItem=function(index,item){$scope.source.name.push(item),$scope.source.id.push($scope.result.id[index]),$scope.result.name.splice(index,1),$scope.result.id.splice(index,1),$("#input").val("")},$(document).on("click",function(event){var event=event||window.event;"miles-autoInput L"!=$(event.target).attr("class")?$scope.$apply(function(){$scope.flag=!1}):($scope.flag=!0,angular.element(elem).find(".miles-autoInput").focus()),$("#input").val("")}))},100)}}}).directive("tagAutoComplete",function($compile,$timeout,$interval){return{restrict:"AE",scope:{source:"=",result:"=",width:"="},template:"<input >",replace:!0,link:function($scope,elem,attr,ctrl){$timeout(function(){$(elem).tagEditor({initialTags:$scope.result,forceLowercase:!1,onChange:function(field,editor,tags){$scope.result=tags},beforeTagSave:function(field,editor,tags,tag,val){},beforeTagDelete:function(field,editor,tags,val){}})},0)}}}),knowledge_static_web.directive("emotion",function(){return{restrict:"EA",scope:{title:"=expanderTitle",value:"="},template:'<div class="b_box" ng-click="toggle()" ng-class="value?\'open1\':\'close1\'" style="float:left;margin-right:10px;"><div class="s_box"  ng-class="value?\'open2\':\'close2\'"></div></div>',link:function(scope,element,attrs){$(".emotion").qqFace({id:"facebox",assign:"emotion-container",path:"app/libs/qqFace/arclist/"})}}}),knowledge_static_web.directive("gatewayMenu",function(){return{restrict:"AE",scope:{},link:function($scope,elem,attrs){elem.click(function(){$(".popup_span").show(),"file"==attrs.gatewayMenu?$(".import_from_txt").css("visibility","visible"):"single"==attrs.gatewayMenu?$(".add_single_popup").css("visibility","visible"):"adapter"==attrs.gatewayMenu&&$(".jr_Agent").show()})}}}),knowledge_static_web.directive("plupload",["$timeout","$cookieStore","$state",function($timeout,$cookieStore,$state){return{restrict:"A",link:function($scope,iElm,iAttrs,controller){var uploader=new plupload.Uploader({runtimes:"html4,html5,flash,silverlight",browse_button:"pickfiles",url:"noturl",multi_selection:!0,filters:{max_file_size:"10mb",mime_types:[{title:"Know File",extensions:"docx"}]},flash_swf_url:"/plupload/Moxie.swf",silverlight_xap_url:"/plupload/Moxie.xap",init:{PostInit:function(){$("#uploadfiles").click(function(){var params={templateId:$scope.targetId,requestId:"String",userName:USER_LOGIN_NAME};return 1!=$scope.processMethod||$scope.targetId&&null!=$scope.targetId?(uploader.setOption("multipart_params",params),uploader.setOption("url","/api/ms/knowledgeDocumentation/createDocumentation"),uploader.start(),!1):void layer.msg("请选择加工模板")}),$("#reset").click(function(){if(uploader.files.length>0)for(var i=uploader.files.length;i>0;i--)uploader.removeFile(uploader.files[i-1]);$scope.$apply($scope.resetUploadPOJO())})},FilesAdded:function(up,files){plupload.each(files,function(file){file.name.length>=24?(layer.msg("文件名称过长,请返回修改"),up.removeFile(file)):$("#file_container").append('<div class="file_con" id="'+file.id+'"style="overflow:hidden;padding: 0px;"><span  class="name">'+file.name+'</span><b class="progress" style="font-size: 14px;line-height: 33px;margin-left: 15px; height: inherit; width: 40px;">0%</b><span class="size"> ('+plupload.formatSize(file.size)+") </span></div>")})},FilesRemoved:function(up,files){plupload.each(files,function(file){up.files.length<=0&&$("#file_container").html("")})},UploadProgress:function(up,file){$("#"+file.id).find("b").html("<span>"+file.percent+"%</span>")},Error:function(up,err){},UploadComplete:function(uploader,files){},FileUploaded:function(uploader,files,res){$state.reload(),$("#file_container").html(""),$(".template_inpt").val(""),200==res.status&&($(".popup_wrap").hide(),$(".popup_span").hide(),$(".import_from_txt").css("visibility","hidden"),$(".add_single_popup").css("visibility","hidden"))}}});uploader.init()}}}]),knowledge_static_web.directive("tempPlupload",["$timeout","$location","$state",function($timeout,$location,$state){return{restrict:"A",link:function($scope,iElm,iAttrs,controller){var uploader=new plupload.Uploader({runtimes:"html4,html5,flash,silverlight",browse_button:"tempickfile",url:"/api/ms/template/createTemplate",max_file_count:10,multi_selection:!1,filters:{max_file_size:"10mb",mime_types:[{title:"Know File",extensions:"docx"}]},flash_swf_url:"/plupload/Moxie.swf",silverlight_xap_url:"/plupload/Moxie.xap",init:{PostInit:function(){$("#temupload").on("click",function(){return null!=$scope.vm.temName&&""!=$scope.vm.temName&&$scope.vm.temName?$scope.vm.temName.length>20?void layer.msg("模板名称不能大于20字"):$scope.vm.temNameChecked?uploader.files.length<=0?void layer.msg("请选择上传文件"):(uploader.setOption("multipart_params",{type:$scope.vm.temType,templateName:$scope.vm.temName,requestId:"String",userId:USER_LOGIN_NAME}),uploader.start(),!1):void layer.msg("模板名校验失败"):void layer.msg("请输入模板名称")}),$("#temreset").on("click",function(){if(uploader.files.length>0)for(var i=uploader.files.length;i>0;i--)uploader.removeFile(uploader.files[i-1])})},FilesAdded:function(up,files){plupload.each(files,function(file){file.name.length>=24?(layer.msg("文件名称过长,请返回修改"),up.removeFile(file)):($scope.$apply(function(){$scope.vm.fileName=file.name}),up.files.length>1&&up.removeFile(file))})},FilesRemoved:function(up,files){plupload.each(files,function(file){up.files.length<=0&&$scope.$apply(function(){$scope.vm.fileName="未选择文件"})})},UploadProgress:function(up,file){$scope.$apply(function(){$scope.vm.progress=file.percent})},Error:function(up,err){$scope.$apply(function(){$scope.vm.progress=0}),uploader.init()},UploadComplete:function(uploader,files){},FileUploaded:function(uploader,files,res){if(200==res.status){var response=JSON.parse(res.response.replace(/<.*?>/gi,""));200==response.status?(layer.msg("模板文件上传成功，请添加规则"),$location.$$absUrl=$location.$$absUrl+response.data.templateId,$scope.$apply(function(){$scope.vm.isTempUpToolsShow=!1,$scope.vm.templateId=response.data.templateId,$scope.storeParams($scope.temId)})):($scope.$apply(function(){$scope.vm.progress=0}),uploader.removeFile(uploader.files[0]),layer.msg("模板文件上传失败,请重新选择文件"))}}}});uploader.init()}}}]),knowledge_static_web.directive("advanceMenu",function(){return{restrict:"AE",scope:{},link:function($scope,elem,attrs){elem.click(function(e){var e=e||window.event;e.stopPropagation(),$(".advan_search_div").is(":hidden")?($(".advan_search_div").show(),$(".advan_search").addClass("on")):($(".advan_search_div").hide(),$(".advan_search").removeClass("on"))})}}}),knowledge_static_web.directive("advansearchdiv",function(){return{restrict:"AE",scope:{},link:function($scope,elem,attrs){elem.click(function(e){var e=e||window.event;$(this).show(),e.stopPropagation()}),$(document).click(function(){elem.hide()})}}}),knowledge_static_web.directive("templateInput",function(){return{restrict:"AE",link:function($scope,elem,attrs){elem.click(function(e){var ev=e||window.event;$(".template_con").show(),ev.stopPropagation()}),$(document).click(function(){$(".template_con").hide()})}}}),knowledge_static_web.directive("templateCon",function(){return{restrict:"AE",link:function($scope,elem,attrs){elem.click(function(e){(e||window.event).stopPropagation()}),$scope.$on("onRenderFinish",function(event){$(".template_con tbody tr").click(function(){var value=$(this).find("td").eq(1).html(),id=$(this).find("td").eq(3).html();$(".template_inpt").val(value),$scope.$parent.targetId=$scope.targetId=id,$(this).parents(".template_con").hide()})})}}}),knowledge_static_web.directive("closeMenu",function(){return{restrict:"AE",scope:{},link:function($scope,elem,attrs){elem.click(function(){$(".popup_wrap").hide(),$(".popup_span").hide(),$(".import_from_txt").css("visibility","hidden"),$(".add_single_popup").css("visibility","hidden")})}}}),knowledge_static_web.directive("processMethodMenu",function(){return{restrict:"AE",link:function($scope,elem,attrs){attrs.processMethodMenu;elem.click(function(){0==$scope.processMethod?($("#modelSelect").show(),$("#modelAdd").show(),$scope.queryTemplate()):($("#modelSelect").hide(),$("#modelAdd").hide())})}}}),knowledge_static_web.directive("mouldShowMenu",function(){return{restrict:"AE",scope:{},link:function($scope,elem,attrs){elem.change(function(){"模板加工"==$(this).val()&&$(this).next().show()})}}}),knowledge_static_web.directive("onOff",function(){return{restrict:"AE",scope:{updateAdStatus:"&upfunction"},link:function($scope,elem,attrs){elem.click(function(){$(this).hasClass("on_off_active")?$(this).removeClass("on_off_active"):$(this).addClass("on_off_active"),$scope.updateAdStatus()})}}}),knowledge_static_web.directive("dropDownMenuByZtree",function(){return{restrict:"AE",scope:{},link:function($scope,elem,attrs){function beforeClick(treeId,treeNode){return $.fn.zTree.getZTreeObj(treeDemo).checkNode(treeNode,!treeNode.checked,null,!0),!1}function onCheck(e,treeId,treeNode){function getParentNodes(node,allNode){if(null!=node){allNode+="->"+node.name;getParentNodes(node.getParentNode(),allNode)}else curLocation=allNode}var zTree=$.fn.zTree.getZTreeObj(treeDemo),nodes=zTree.getCheckedNodes(!0),selectLocation="";if(null!=nodes&&void 0!=nodes&&nodes.length>0)for(var m=0;m<nodes.length;m++){var curLocation="",allNode=nodes[m].name,node=nodes[m].getParentNode();getParentNodes(node,allNode);for(var location="",nodeArrs=curLocation.split("->"),i=nodeArrs.length-1;i>=0;i--)location+=nodeArrs[i]+"->";location=location.substring(0,location.lastIndexOf("->")),selectLocation+=location+","}else selectLocation="",$scope.$parent.classifyId="";selectLocation.length>0&&(selectLocation=selectLocation.substring(0,selectLocation.length-1)),""!=$.trim(selectLocation)&&null!=selectLocation&&($scope.$parent.classifyId=selectLocation);for(var v="",i=0,l=nodes.length;i<l;i++)v+=nodes[i].name+",";v.length>0&&(v=v.substring(0,v.length-1)),$("#"+citySel).attr("value",v)}function hideMenu(){$("#"+menuContent).fadeOut("fast"),$("body").unbind("mousedown",onBodyDown)}function onBodyDown(event){"menuBtn"==event.target.id||event.target.id==citySel||event.target.id==menuContent||$(event.target).parents("#"+menuContent).length>0||hideMenu()}var setting={check:{enable:!0,chkboxType:{Y:"",N:""}},view:{dblClickExpand:!1},data:{simpleData:{enable:!0}},callback:{beforeClick:beforeClick,onCheck:onCheck}},split=attrs.dropDownMenuByZtree,arr=split.split(","),citySel=arr[0],menuContent=arr[1],treeDemo=arr[2];elem.click(function(){$("#"+menuContent).css({left:"130px",top:"143px"}).slideDown("fast"),$("body").bind("mousedown",onBodyDown)}),$scope.$emit("menu",attrs.value),$scope.$on("menuData",function(event,data){$.fn.zTree.init($("#"+treeDemo),setting,data)})}}}),knowledge_static_web.directive("loginInput",function(){return{restrict:"AE",link:function(scope,elem,attrs){elem.on("focus",function(e){$(this).parents(".login-fItem").addClass("focus")}).on("blur",function(){$(this).parents(".login-fItem").removeClass("focus")})}}}).directive("switch",function(){return{restrict:"EA",scope:{title:"=expanderTitle",value:"="},template:'<div class="b_box" ng-click="toggle()" ng-class="value?\'open1\':\'close1\'" style="float:left;margin-right:10px;"><div class="s_box"  ng-class="value?\'open2\':\'close2\'"></div></div>',link:function(scope,element,attrs){scope.toggle=function(){scope.value=scope.value?0:1}}}}).directive("switchTurn",function(){return{restrict:"EA",scope:{title:"=expanderTitle",value:"="},template:'<div class="b_box" ng-click="toggle()" ng-class="value==10001?\'open1\':\'close1\'" style="float:left;margin-right:10px;"><div class="s_box"  ng-class="value==10001?\'open2\':\'close2\'"></div></div>',link:function(scope,element,attrs){scope.toggle=function(){scope.value=10001==scope.value?10002:10001}}}}),knowledge_static_web.directive("isOperationShow",function(){return{restrict:"AE",link:function(scope,elem,attrs){elem.mouseover(function(){$(this).children("ul").show()}),elem.mouseleave(function(){$(this).children("ul").stop().hide()})}}}).directive("isArrowShow",function(){return{restrict:"AE",link:function(scope,elem,attrs){elem.click(function(){"0"==attrs.isArrowShow?($(".right_popup_div").hide(),$(".arrow").removeClass("act")):"1"==attrs.isArrowShow?($(".right_popup_div").show(),$(".arrow").addClass("act")):"2"==attrs.isArrowShow&&($(".right_popup_div").is(":hidden")?($(".right_popup_div").show(),$(".arrow").addClass("act")):($(".right_popup_div").hide(),$(".arrow").removeClass("act")))})}}}),knowledge_static_web.directive("strikeNum",function(){return{restrict:"EA",require:"^ngModel",link:function(scope,element,attr,ngModelController){function isNumber(oNum){return!!oNum&&!!/^\d+$/.test(oNum)}var num=attr.strikeNum?attr.strikeNum:5;scope.$watch("vm.strikeNumber",function(val,oldVal){val<1?scope.vm.strikeNumber=1:val>num?scope.vm.strikeNumber=num:isNumber(val)||(scope.vm.strikeNumber=parseInt(val))})}}}),knowledge_static_web.directive("myUpload",function(FileUploader){var helper={getType:function(name){return"|"+name.slice(name.lastIndexOf(".")+1)+"|"},isImage:function(type,closeMsg){return-1!=="|jpg|png|jpeg|bmp|gif|".indexOf(type.toLowerCase())||(closeMsg?void 0:(layer.alert("请确定文件格式为|jpg|png|jpeg|bmp|gif|",{icon:7}),!1))},isDoc:function(type,closeMsg){return-1!=="|doc|docx|txt|".indexOf(type.toLowerCase())||(closeMsg?void 0:(layer.alert("请确定文件格式为|doc|docx|txt|",{icon:7}),!1))},isVideo:function(type,closeMsg){return-1!=="|rm|rmvb|avi|mp4|3gp|".indexOf(type.toLowerCase())||(closeMsg?void 0:(layer.alert("请确定文件格式为|rm|rmvb|avi|mp4|3gp|",{icon:7}),!1))},isMp3:function(type,closeMsg){return-1!=="|mp3|".indexOf(type.toLowerCase())||(closeMsg?void 0:(layer.alert("请确定文件格式为|mp3|",{icon:7}),!1))},isZip:function(type,closeMsg){return-1!=="|zip|rar|".indexOf(type.toLowerCase())||(closeMsg?void 0:(layer.alert("请确定文件格式为|zip|rar|",{icon:7}),!1))},uploadImgCheckedPx:function(f,w,h,msg,callback){if(w&&h){var reader=new FileReader;reader.onload=function(e){var img=null;img=document.createElement("img"),document.body.appendChild(img),img.style.visibility="hidden",img.src=this.result;var imgwidth=img.naturalWidth,imgheight=img.naturalHeight;imgwidth!=w||imgheight!=h?(document.body.removeChild(img),msg?msg+=">":msg="",layer.confirm(msg+"尺寸建议"+w+"x"+h+"，确定上传吗？",{btn:["确定","取消"],cancel:function(){callback&&callback(!1)}},function(index){layer.close(index),callback&&callback(!0)},function(){callback&&callback(!1)})):callback&&callback(!0)},f&&reader.readAsDataURL(f)}else callback&&callback(!0)}};return{restrict:"E",replace:!0,scope:{filters:"@filters",response:"=response",size:"=size",callback:"@callback",width:"@width",height:"@height",msg:"@msg"},template:'<input type="file"  nv-file-select="" uploader="uploader" filters="{{filters}}" />',link:function(scope,element,attributes){element.bind("change",function(changeEvent){scope.$apply(function(){scope.selectedFile=changeEvent.target.files[0];var type=helper.getType(scope.selectedFile.name);helper.isImage(type,!0)?helper.uploadImgCheckedPx(scope.selectedFile,scope.width,scope.height,scope.msg,function(state){state?scope.uploader.uploadAll():scope.uploader.clearQueue()}):scope.uploader.uploadAll()})})},controller:function($scope){var uploader=$scope.uploader=new FileUploader({url:"/api/application/application/uploadHead",autoUpload:!0,removeAfterUpload:!0,queueLimit:1}),showMsg=function(itemSize,maxSize){return itemSize/1024>=maxSize?(layer.alert("文件大小必须小于"+maxSize.toFixed(0)+"KB",{icon:7}),!1):($scope.size=itemSize,!0)};uploader.filters.push({name:"imageFilter",fn:function(item,options){if(!showMsg(item.size,4096))return!1;var type=helper.getType(item.name);return helper.isImage(type)&&this.queue.length<5}},{name:"docFilter",fn:function(item,options){if(!showMsg(item.size,3072))return!1;var type=helper.getType(item.name);return helper.isDoc(type)}},{name:"videoFilter",fn:function(item,options){if(!showMsg(item.size,204800))return!1;var type=helper.getType(item.name);return helper.isVideo(type)}},{name:"mp3Filter",fn:function(item,options){if(!showMsg(item.size,20480))return!1;var type=helper.getType(item.name);return helper.isMp3(type)}},{name:"zipFilter",fn:function(item,options){if(!showMsg(item.size,20480))return!1;var type=helper.getType(item.name);return helper.isZip(type)}}),uploader.onWhenAddingFileFailed=function(item,filter,options){},uploader.onAfterAddingFile=function(fileItem){},uploader.onAfterAddingAll=function(addedFileItems){},uploader.onBeforeUploadItem=function(item){},uploader.onProgressItem=function(fileItem,progress){},uploader.onProgressAll=function(progress){},uploader.onSuccessItem=function(fileItem,response,status,headers){-1==response.indexOf("error")?($scope.response=response,$scope.callback&&$scope.$emit($scope.callback,response)):layer.alert(response,{icon:2})},uploader.onErrorItem=function(fileItem,response,status,headers){},uploader.onCancelItem=function(fileItem,response,status,headers){},uploader.onCompleteItem=function(fileItem,response,status,headers){},uploader.onCompleteAll=function(){}}}}),knowledge_static_web.directive("uploaderFactor",["$parse",function($parse){return{restrict:"EA",scope:{accept:"=",server:"=",type:"=",isAuto:"=",selectBtn:"=",tableList:"="},template:'<span  id="picker" style="float:left">上传线下编辑场景知识</span><span class="f-14 pl-10" style="float:left;margin-top: 5px;">请先<a href="/api/ms/elementKnowledgeAdd/download?fileName=factor_template.xlsx"  class="c-primary">下载模板</a>进行填写</span>',link:function(scope,element,attrs){var uploader=(angular.copy(scope.server),WebUploader.create({auto:!0,swf:"/bower_components/webuploader-0.1.5/dist/Uploader.swf",server:"/api/ms/elementKnowledgeAdd/upload",pick:"#picker"}));uploader.on("fileQueued",function(file){}),uploader.on("uploadProgress",function(file,percentage){var $li=$("#"+file.id),$percent=$li.find(".progress .progress-bar");$percent.length||($percent=$('<div class="progress progress-striped active" style="height: 50px;background: red; width: 200px;"><div class="progress-bar" role="progressbar" style="width: 0%"></div> </div>').appendTo($li).find(".progress-bar")),$li.find("p.state").text("上传中"),$percent.css("width",100*percentage+"%")}),uploader.on("uploadError",function(file){}),uploader.on("uploadSuccess",function(file,response){500==response.status?layer.msg("模板错误"):(scope.tableList=response,scope.$apply())})}}}]).directive("uploaderHandle2",["$parse",function($parse){return{restrict:"EA",scope:{accept:"=",server:"=",type:"=",isAuto:"=",selectBtn:"="},template:'<div id="uploader" class="wu-example upWrapper"><div id="thelist" class="uploader-list upList"></div><div class="btns"><div id="picker">上传线下编辑场景知识</div><button id="ctlBtn" clas="btn btn-default">开始上传</button></div></div>',link:function(scope,element,attrs){angular.element("#thelist"),WebUploader.create({auto:!0,swf:"/bower_components/webuploader-0.1.5/dist/Uploader.swf",formData:{title:"is Image  ====   uploader"},server:"/api/application/application/uploadHead",accept:{title:"file",extensions:"xls,xlsx",mimeTypes:"file/*"},pick:"#picker",resize:!1,chunked:!0,chunkRetry:10,thread:100,disableGlobalDnd:!0,fileNumLimit:300,fileSizeLimit:209715200,fileSingleSizeLimit:52428800})}}}]),knowledge_static_web.directive("uploaderHandle3",["$parse","$cookieStore",function($parse,$cookieStore){return{restrict:"EA",scope:{accept:"=",server:"=",type:"=",isAuto:"=",selectBtn:"=",tableList:"=",userId:"=",applicationId:"="},template:'<button  id="picker">选择文件</button>',link:function(scope,element,attrs){var userId=scope.userId,applicationId=scope.applicationId,uploader=(angular.copy(scope.server),WebUploader.create({auto:!0,swf:"/bower_components/webuploader-0.1.5/dist/Uploader.swf",formData:{userId:userId,applicationId:applicationId,userName:$cookieStore.get("userName")},server:"/api/ms/chatKnowledge/upload",pick:"#picker"}));uploader.on("fileQueued",function(file){}),uploader.on("uploadProgress",function(file,percentage){var $li=$("#"+file.id),$percent=$li.find(".progress .progress-bar");$percent.length||($percent=$('<div class="progress progress-striped active" style="height: 50px;background: red; width: 200px;"><div class="progress-bar" role="progressbar" style="width: 0%"></div> </div>').appendTo($li).find(".progress-bar")),$li.find("p.state").text("上传中"),$percent.css("width",100*percentage+"%")}),uploader.on("uploadError",function(file){}),uploader.on("uploadSuccess",function(file,response){500==response.status?layer.msg("模板错误"):10001==response.status?layer.msg("导入失败"):layer.msg("导入成功")})}}}]).directive("knowBatchUp",["$parse","ngDialog","$cookieStore","$state","$timeout","$interval",function($parse,ngDialog,$cookieStore,$state,$timeout,$interval){return{scope:{accept:"=",server:"@",type:"=",isAuto:"=",templateType:"=",fileName:"="},template:'<div style="overflow: hidden"><span style="float: left" id="picker">选择文件</span><span style=" margin-left: 10px; float: left; color:#fff;line-height: 22px;" class="btn1 btn_green"  ng-click="upload()">上传</span></div>',link:function(scope,element,attrs){$timeout(function(){var uploader=WebUploader.create({auto:!1,swf:"/bower_components/webuploader-0.1.5/dist/Uploader.swf",formData:{userId:USER_ID,applicationId:APPLICATION_ID},server:scope.server,accept:{title:"file",extensions:"xls,xlsx",mimeTypes:"file/*"},pick:{id:"#picker",multiple:!1},resize:!1,chunked:!0,chunkRetry:10,thread:100,disableGlobalDnd:!0,fileNumLimit:2,fileSizeLimit:209715200,fileSingleSizeLimit:5242880});scope.upload=function(){uploader.options.formData.templateType=scope.templateType,uploader.upload()},uploader.on("beforeFileQueued",function(file){uploader.reset()}),uploader.on("fileQueued",function(file){scope.$apply(function(){scope.fileName=file.name})}),uploader.on("error",function(type){switch(type){case"Q_EXCEED_NUM_LIMIT":layer.msg("错误：上传文件数量过多！");break;case"Q_EXCEED_SIZE_LIMIT":layer.msg("错误：文件总大小超出限制！");break;case"F_EXCEED_SIZE":layer.msg("错误：文件大小超出限制！");break;case"Q_TYPE_DENIED":layer.msg("错误：禁止上传该类型文件！");break;case"F_DUPLICATE":layer.msg("错误：请勿重复上传该文件！");break;default:layer.msg("错误代码："+type)}}),uploader.on("uploadProgress",function(file,percentage){}),uploader.on("uploadError",function(file,reason){layer.msg("请检查"+reason)}),uploader.on("uploadSuccess",function(file,response){500==response.status?layer.msg("模板错误"):10001==response.status?layer.msg("导入失败"):layer.msg("导入成功")})},0)}}}]),angular.module("knowledge_static_web").filter("channel",function(){return function(value,params){var result;return angular.forEach(params,function(item){value==item.channelCode&&(result=item.channelName)}),result}}).filter("dimension",function(){return function(value,params){var result;return angular.forEach(params,function(item){value==item.dimensionId&&(result=item.dimensionName)}),result}}),angular.module("knowledge_static_web").filter("channel",function(){return function(value,params){var result;return angular.forEach(params,function(item){value==item.channelCode&&(result=item.channelName)}),result}}),angular.module("knowledge_static_web").filter("dimension",function(){return function(value,params){var result;return angular.forEach(params,function(item){value==item.dimensionId&&(result=item.dimensionName)}),result}}),angular.module("knowledge_static_web").filter("classType",function(){return function(value){switch(value){case 40:return"敏感概念";case 41:return"停用概念";case 42:return"纠错概念";case 43:return"同义概念";case 44:return"集合概念";case 45:return"业务概念";case 46:return"强制分词概念";case 47:return"语义表达式概念"}}}),angular.module("knowledge_static_web").filter("emotion",function(){return function(str){return str=str.replace(/\n/g,"<br/>"),str=str.replace(/\[em_([0-9]*)\]/g,'<img src="/libs/qqFace/arclist/$1.gif" border="0" />')}}).filter("faceToString",function(){return function(face){var regex=new RegExp('<img src="/libs/qqFace/arclist/([0-9]*).gif" border="0">',"g");return face=face.replace(regex,"[em_$1]")}}).filter("toHtml",["$sce",function($sce){return function(text){return $sce.trustAsHtml(text)}}]),angular.module("knowledge_static_web").filter("numberToWord",function(){return function(number){var array=["一","二","三","四","五","六","七","八","九","十"],result=null;return""!=number&&angular.forEach(array,function(item,index){index==number-1&&(result=item)}),result}}),angular.module("knowledge_static_web").filter("showBotTitle",function(){return function(value,title){var result;return title?result=title:httpRequestPostAsync("/api/ms/modeling/category/getcategoryfullname",{categoryId:value},function(response){result=response.categoryFullName}),result}}).filter("showNodeName",function($timeout){return function(nodeNo,arr){var result=null;return null!=nodeNo&&(nodeNo=parseInt(nodeNo),result=arr[nodeNo].nodeName),result}}),angular.module("knowledgeManagementModule").factory("KnowDocService",["$resource",function($resource){var knowDocService={};return knowDocService.queryKnowDocList=$resource("/api/ms/knowledgeDocumentation/queryDocumentationList",{},{}),knowDocService.queryDetailByDocId=$resource("/api/ms/knowledgeDocumentation/selectDocumentationKnowledge",{},{}),knowDocService.deleteKnowDoc=$resource("/api/ms/knowledgeDocumentation/deleteDocumentation",{},{}),knowDocService}]).factory("DetailService",["$resource",function($resource){var detailService={};return detailService.queryKnowDocByDocId=$resource("/api/ms/knowledgeDocumentation/selectDocumentationById",{},{}),detailService.queryDocKnowItems=$resource("api/ms/knowledgeDocumentation/selectDocumentationKnowledgeList",{},{}),detailService.ignoreDocKnowAll=$resource("api/ms/knowledgeDocumentation/ignoreDocumentationKnowledgeAll",{},{}),detailService.ignoreDocKnow=$resource("api/ms/knowledgeDocumentation/ignoreDocumentationKnowledge",{},{}),detailService}]).factory("TemplateService",["$resource",function($resource){var templateService={};return templateService.queryTemplate=$resource("/api/ms/template/queryTemplate",{},{}),templateService.deleteTemplate=$resource("/api/ms/template/deleteTemplate",{},{}),templateService.queryRules=$resource("/api/ms/templateRule/queryAllRule",{},{}),templateService.queryTemplateById=$resource("/api/ms/template/queryTemplate",{},{}),templateService.generateRule=$resource("/api/ms/templateRule/getJuniorText",{},{}),templateService.getSimilarText=$resource("/api/ms/templateRule/getSimilarText",{},{}),templateService.optimizeText=$resource("/api/ms/templateRule/optimizeText",{},{}),templateService.queryTemplateContent=$resource("/api/ms/template/previewKnowDoc",{},{}),templateService.addWordRule=$resource("/api/ms/templateRule/addWordRule",{},{}),templateService.updateWordRule=$resource("/api/ms/templateRule/updateWordRule",{},{}),templateService.checkTemName=$resource("/api/ms/template/searchByTemplateName",{},{}),templateService.deleteRule=$resource("/api/ms/templateRule/deleteWordRule",{},{}),templateService.queryRuleById=$resource("/api/ms/templateRule/queryRuleById",{},{}),templateService}]),angular.module("knowledgeManagementModule").service("knowledgeAddServer",knowledgeAddServer),knowledgeAddServer.$injector=["$resource"],knowledge_static_web.factory("myService",function(){function set(data){savedData=data}function get(){return savedData}var savedData={};return{set:set,get:get}}),angular.module("loginModule").controller("loginController",["$scope","$location","localStorageService","$state","$cookieStore",function($scope,$location,localStorageService,$state,$cookieStore){function keyLogin(e){var srcObj=e.srcElement?e.srcElement:e.target;13==(window.event?e.keyCode:e.which)&&(srcObj.blur(),login(),srcObj.focus())}function randomNumberChange(){$scope.vm.randomNumber=randomNumber(4)}function login(){0==$scope.vm.randomNumberValue.length?(layer.msg("验证码不能为空"),setRandomNumber()):$scope.vm.randomNumberValue!=$scope.vm.randomNumber?(layer.msg("验证码错误"),setRandomNumber()):""==$scope.vm.userName?(layer.msg("用户名不能为空"),setRandomNumber()):""==$scope.vm.password?(layer.msg("密码不能为空"),setRandomNumber()):httpRequestPost("/api/user/userLogin",{userLoginName:$scope.vm.userName,userPassword:$scope.vm.password},function(data){10006==data.status?($cookieStore.put("userId",data.data.userId),$cookieStore.put("userLoginName",$scope.vm.userName),$cookieStore.put("userName",data.data.userName),$cookieStore.put("permissionId",data.data.permissionId),$state.go("admin")):10007==data.status?(setRandomNumber(),layer.msg("用户名或密码错误")):10002==data.status&&(setRandomNumber(),layer.msg("该用户已停用!"))},function(err){setRandomNumber(),layer.msg("登陆失败")})}function setRandomNumber(){$scope.vm.randomNumberValue="",$scope.vm.randomNumber=randomNumber(4)}function randomNumber(number){for(var rnd="",i=0;i<number;i++)rnd+=Math.floor(10*Math.random());return rnd}$scope.vm={userName:"",password:"",randomNumber:randomNumber(4),randomNumberValue:"",randomNumberChange:randomNumberChange,login:login,keyLogin:keyLogin},document.getElementsByTagName("body")[0].style.cssText="background: url(../../images/images/log-bg.jpg) repeat"}]),angular.module("materialManagement").controller("addTwMesController",["$scope","$state","ngDialog","$cookieStore","$stateParams","$timeout",function($scope,$state,ngDialog,$cookieStore,$stateParams,$timeout){function selectMat(){ngDialog.openConfirm({template:"/static/materialManagement/pictureLibrary/selectImage2.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){}})}$state.go("materialManagement.addtemes"),$scope.vm={title:"",author:"",selectMat:selectMat}}]),angular.module("materialManagement").controller("conceptChatController",["$scope","$state","ngDialog","$stateParams","$cookieStore",function($scope,$state,ngDialog,$stateParams,$cookieStore){function addExtension(){0==$scope.vm.extendedQuestion.length||""==$scope.vm.extendedQuestion?layer.msg("扩展不能为空"):checkRepeat($scope.vm.extendedQuestion,$scope.vm.extendedQuestionArr,"chatQuestionContent")?layer.msg("扩展问题重复，请重新输入"):httpRequestPost("/api/ms/chatKnowledge/checkConceCptChatQuestion",{chatQuestionContent:$scope.vm.extendedQuestion,applicationId:APPLICATION_ID},function(data){if(200==data.status){var obj={};obj.chatQuestionContent=data.data,obj.chatQuestionContent=angular.copy($scope.vm.extendedQuestion),obj.tagList=data.data,obj.chatQuestionType=angular.copy($scope.vm.weight),$scope.vm.extendedQuestionArr.push(obj),$scope.vm.extendedQuestion="",$scope.$apply()}else layer.msg("扩展问重复")},function(err){})}function addContentDialog(item,index){item&&($scope.vm.contentVal=item.chatKnowledgeContent);ngDialog.openConfirm({template:"/static/materialManagement/faq/addContentDialog.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){if(1===e)if(item){var val=angular.copy($scope.vm.contentVal);$scope.vm.contentArr[index].chatKnowledgeContent=val,$scope.vm.contentVal=""}else addContent();else $scope.vm.contentVal=""}})}function addContent(){0==$scope.vm.contentVal.length||""==$scope.vm.contentVal?layer.msg("扩展不能为空"):checkRepeat($scope.vm.contentVal,$scope.vm.contentArr,"chatKnowledgeContent")?layer.msg("扩展问题重复，请重新输入"):httpRequestPost("/api/ms/chatKnowledge/checkChatKnowledgeContent",{chatKnowledgeContent:$scope.vm.contentVal},function(data){if(1e4==data.status){var obj={};obj.chatKnowledgeContent=angular.copy($scope.vm.contentVal),$scope.vm.contentArr.push(obj),$scope.vm.contentVal="",$scope.$apply()}else layer.msg("扩展问重复")},function(err){})}function remove(item,arr){arr.remove(item)}function scan(){if(check()){var params={chatKnowledgeId:$scope.vm.chatKnowledgeId?$scope.vm.chatKnowledgeId:null,standardQuestion:$scope.vm.standardQuestion,extendedQuestionArr:$scope.vm.extendedQuestionArr,contentArr:$scope.vm.contentArr,chatKnowledgeModifier:$scope.vm.userName,chatKnowledgeSource:"101"};$state.go("materialManagement.chatKnowledgeBasePreview",{scanData:angular.toJson(params)})}}function save(){check()&&httpRequestPost("/api/ms/chatKnowledge/addConceCptChatKnowledge",{chatKnowledgeId:$scope.vm.chatKnowledgeId?$scope.vm.chatKnowledgeId:null,applicationId:APPLICATION_ID,chatKnowledgeModifier:$scope.vm.userName,userId:USER_ID,chatKnowledgeTopic:$scope.vm.standardQuestion,chatQuestionList:$scope.vm.extendedQuestionArr,chatKnowledgeContentList:$scope.vm.contentArr},function(data){10004==data.data?layer.msg("标准问重复"):$state.go("materialManagement.chatKnowledgeBase")},function(err){})}function checkRepeat(val,arr,prop){var result;if(0==arr.length)result=0;else for(var i=0;i<arr.length;i++)arr[i].chatQuestionContent==val&&(result=1);return result}function check(){return null==$scope.vm.standardQuestion||0==$scope.vm.standardQuestion.length?(layer.msg("标准问不能为空"),!1):0!=$scope.vm.contentArr.length||(layer.msg("知识内容不能为空"),!1)}$state.go("materialManagement.conceptChat");var paraOfData=$stateParams.scanDataList?angular.fromJson($stateParams.scanDataList):"";$scope.vm={userName:paraOfData?paraOfData.chatKnowledgeModifier:$cookieStore.get("userName"),standardQuestion:paraOfData?paraOfData.standardQuestion:null,extendedQuestion:"",extendedQuestionArr:paraOfData?paraOfData.extendedQuestionArr:[],chatKnowledgeId:paraOfData?paraOfData.chatKnowledgeId:null,remove:remove,weight:"60",addExtension:addExtension,contentVal:"",contentArr:paraOfData?paraOfData.contentArr:[],addContentDialog:addContentDialog,save:save,scan:scan,scanData:$stateParams.scanData,type:paraOfData?paraOfData.type:1}}]),angular.module("materialManagement").controller("faqChatController",["$scope","$state","ngDialog","$cookieStore","$stateParams",function($scope,$state,ngDialog,$cookieStore,$stateParams){function addExtension(){0==$scope.vm.extendedQuestion.length||""==$scope.vm.extendedQuestion?layer.msg("扩展不能为空",{time:1e3}):checkRepeat($scope.vm.extendedQuestion,$scope.vm.extendedQuestionArr,"chatQuestionContent")?layer.msg("扩展问题重复，请重新输入",{time:1e3}):httpRequestPost("/api/ms/chatKnowledge/checkFAQChatQuestion",{chatQuestionContent:$scope.vm.extendedQuestion},function(data){if(1e4==data.status){var obj={};obj.chatQuestionContent=angular.copy($scope.vm.extendedQuestion),obj.chatQuestionType=angular.copy($scope.vm.weight),$scope.vm.extendedQuestionArr.push(obj),$scope.vm.extendedQuestion="",$scope.$apply()}else layer.msg("扩展问重复",{time:1e3})},function(err){})}function addContentDialog(item,index){item&&($scope.vm.contentVal=item.chatKnowledgeContent);ngDialog.openConfirm({template:"/static/materialManagement/faq/addContentDialog.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){if(1===e)if(item){var val=angular.copy($scope.vm.contentVal);$scope.vm.contentArr[index].chatKnowledgeContent=val,$scope.vm.contentVal=""}else addContent();else $scope.vm.contentVal=""}})}function addContent(){0==$scope.vm.contentVal.length||""==$scope.vm.contentVal?layer.msg("扩展不能为空",{time:1e3}):checkRepeat($scope.vm.contentVal,$scope.vm.contentArr,"chatKnowledgeContent")?layer.msg("扩展问题重复，请重新输入"):httpRequestPost("/api/ms/chatKnowledge/checkChatKnowledgeContent",{chatKnowledgeContent:$scope.vm.contentVal},function(data){if(1e4==data.status){var obj={};obj.chatKnowledgeContent=angular.copy($scope.vm.contentVal),$scope.vm.contentArr.push(obj),$scope.vm.contentVal="",$scope.$apply()}else layer.msg("扩展问重复")},function(err){})}function remove(item,arr){arr.remove(item)}function scan(){if(check()){var params={chatKnowledgeId:$scope.vm.chatKnowledgeId?$scope.vm.chatKnowledgeId:null,standardQuestion:$scope.vm.standardQuestion,extendedQuestionArr:$scope.vm.extendedQuestionArr,contentArr:$scope.vm.contentArr,chatKnowledgeModifier:$scope.vm.userName,chatKnowledgeSource:"100"};$state.go("materialManagement.chatKnowledgeBasePreview",{scanData:angular.toJson(params)})}}function save(){check()&&httpRequestPost("/api/ms/chatKnowledge/addFAQChatKnowledge",{chatKnowledgeId:$scope.vm.chatKnowledgeId?$scope.vm.chatKnowledgeId:null,applicationId:APPLICATION_ID,chatKnowledgeModifier:$scope.vm.userName,userId:USER_ID,chatKnowledgeTopic:$scope.vm.standardQuestion,chatQuestionList:$scope.vm.extendedQuestionArr,chatKnowledgeContentList:$scope.vm.contentArr,knoweledgeId:$scope.vm.knoweledgeId},function(data){10004==data.data?layer.msg("标准问重复",{time:1e3}):$state.go("materialManagement.chatKnowledgeBase")},function(err){})}function checkRepeat(val,arr,prop){var result;return 0==arr.length?result=0:angular.forEach(arr,function(item){result=item[prop]==val?1:0}),result}function check(){return null==$scope.vm.standardQuestion||0==$scope.vm.standardQuestion.length?(layer.msg("标准问不能为空",{time:1e3}),!1):0!=$scope.vm.contentArr.length||(layer.msg("知识内容不能为空",{time:1e3}),!1)}$state.go("materialManagement.faqChat");var paraData=$stateParams.scanDataList?angular.fromJson($stateParams.scanDataList):"";$scope.vm={userName:paraData?paraData.chatKnowledgeModifier:$cookieStore.get("userName"),standardQuestion:paraData?paraData.standardQuestion:null,extendedQuestion:"",extendedQuestionArr:paraData?paraData.extendedQuestionArr:[],remove:remove,weight:"60",addExtension:addExtension,chatKnowledgeId:paraData?paraData.chatKnowledgeId:null,contentVal:"",contentArr:paraData?paraData.contentArr:[],addContentDialog:addContentDialog,save:save,scan:scan,scanData:$stateParams.scanData,type:$stateParams.scanData?$stateParams.scanData.type:1}}]),angular.module("materialManagement").controller("chatKnowledgeBasePreController",["$scope","$state","$stateParams","$window",function($scope,$state,$stateParams,$window){function save(){var api,params=$scope.vm.scanData;switch(params.chatKnowledgeSource){case"100":api="/api/ms/chatKnowledge/addFAQChatKnowledge";break;case"101":api="/api/ms/chatKnowledge/addConceCptChatKnowledge"}httpRequestPost(api,{chatKnowledgeId:params.chatKnowledgeId?params.chatKnowledgeId:null,applicationId:APPLICATION_ID,userId:USER_ID,chatKnowledgeTopic:params.standardQuestion,chatQuestionList:params.extendedQuestionArr,chatKnowledgeContentList:params.contentArr},function(data){10004==data.data?(layer.msg("标准问重复"),$state.go($scope.vm.editUrl,{scanDataList:$stateParams.scanData})):$state.go("materialManagement.chatKnowledgeBase")})}function edit(){$state.go($scope.vm.editUrl,{scanDataList:$stateParams.scanData})}$state.go("materialManagement.chatKnowledgeBasePreview"),$scope.vm={scanData:angular.fromJson($stateParams.scanData),save:save,edit:edit,editUrl:"101"==angular.fromJson($stateParams.scanData).chatKnowledgeSource?"materialManagement.conceptChat":"materialManagement.faqChat"}}]),angular.module("materialManagement").controller("chatKnowledgeBaseController",["$scope","$state","$cookieStore","$timeout","$window","$location",function($scope,$state,$cookieStore,$timeout,$window,$location){function getDel(ev,id){$(ev.target).prop("checked")?$scope.vm.delArr.push(id):$scope.vm.delArr.remove(id)}function delKnowledge(){$scope.vm.delArr.length?layer.confirm("是否确定删除该条知识？",{btn:["确定","取消"]},function(){httpRequestPost("/api/ms/chatKnowledge/deleteConceCptChatKnowledge",{applicationId:APPLICATION_ID,ids:$scope.vm.delArr},function(){layer.msg("删除成功"),$state.reload()})}):layer.msg("请选择要删除的知识")}function search(index){$scope.vm.getType=1,$scope.vm.searchHeighFlag=!1,httpRequestPost("/api/ms/chatKnowledge/queryChatKnowledge",{chatKnowledgeTopic:$scope.vm.chatKnowledgeTopic,chatKnowledgeModifier:$scope.vm.chatKnowledgeModifier,modifyTimeType:$scope.vm.modifyTimeType,chatQuestionContent:$scope.vm.chatQuestionContent,index:(index-1)*$scope.vm.pageSize,pageSize:$scope.vm.pageSize},function(data){10005==data.data?$scope.$apply(function(){$scope.vm.delArr=[],$scope.vm.listData=data.data.objs,$scope.vm.paginationConf.totalItems=0,layer.msg("查询无此相关知识")}):$scope.$apply(function(){$scope.vm.delArr=[],$scope.vm.listData=data.data.objs,$scope.vm.paginationConf={currentPage:index,totalItems:data.data.total,pageSize:$scope.vm.pageSize,pagesLength:8},$scope.vm.title=null})},function(err){})}function exportExcel(){var urlParams="?applicationId="+APPLICATION_ID+"&chatKnowledgeTopic="+$scope.vm.chatKnowledgeTopic+"&chatKnowledgeModifier="+$scope.vm.chatKnowledgeModifier+"&chatQuestionContent="+$scope.vm.chatQuestionContent,url="/api/ms/chatKnowledge/exportExcel"+urlParams;$window.open(url,"_blank")}function selectTimeType(type){$scope.vm.modifyTimeType=type}function getData(index){$scope.vm.getType=0,httpRequestPost("/api/ms/chatKnowledge/queryChatKnowledge",{applicationId:APPLICATION_ID,index:(index-1)*$scope.vm.pageSize,pageSize:$scope.vm.pageSize},function(data){$scope.vm.delArr=[],$scope.vm.listData=data.data.objs,$scope.vm.paginationConf={currentPage:index,totalItems:data.data.total,pageSize:$scope.vm.pageSize,pagesLength:8},$scope.$apply()},function(err){})}function seeDtails(data){var params={standardQuestion:data.chatKnowledgeTopic,extendedQuestionArr:data.chatQuestionList,contentArr:data.chatKnowledgeContentList,applicationId:APPLICATION_ID,chatKnowledgeId:data.chatKnowledgeId,chatKnowledgeSource:data.chatKnowledgeSource,editUrl:100==data.chatKnowledgeSource?"materialManagement.faqChat":"materialManagement.conceptChat"};$state.go("materialManagement.chatKnowledgeBasePreview",{scanData:angular.toJson(params)})}$state.go("materialManagement.chatKnowledgeBase"),$scope.vm={title:"",search:search,exportExcel:exportExcel,seeDtails:seeDtails,paginationConf:"",pageSize:5,getType:0,getDel:getDel,delKnowledge:delKnowledge,delArr:[],searchHeighFlag:!1,chatKnowledgeModifier:"",modifyTimeType:0,chatKnowledgeTopic:"",chatQuestionContent:"",selectTimeType:selectTimeType},$scope.$watch("vm.searchHeighFlag",function(val){val?$(".advanced_search").slideDown():$(".advanced_search").slideUp()}),getData(1);var timeout;$scope.$watch("vm.paginationConf.currentPage",function(current){current&&(timeout&&$timeout.cancel(timeout),timeout=$timeout(function(){1==$scope.vm.getType?search(current):0==$scope.vm.getType&&getData(current)},100))})}]),angular.module("materialManagement").controller("pictureLibraryController",["$scope","$state","ngDialog","$cookieStore","$stateParams","$timeout",function($scope,$state,ngDialog,$cookieStore,$stateParams,$timeout){function getPicList(index){httpRequestPost("/api/ms/picture/queryPicture",{index:(index-1)*$scope.vm.paginationConf.pageSize,pageSize:$scope.vm.paginationConf.pageSize,fileName:$scope.vm.pictureName},function(data){200==data.status&&$scope.$apply(function(){$scope.vm.imageList=data.data,$scope.vm.paginationConf.currentPage=index,$scope.vm.paginationConf.totalItems=data.data.total,$scope.vm.paginationConf.numberOfPages=data.data.total/$scope.vm.paginationConf.pageSize})},function(err){})}function removeImg(item,index){layer.confirm("确认删除该图片？",{btn:["确定","取消"]},function(){httpRequestPost("/api/ms/picture/deletePicture",{fileurl:item.pictureUrl,pictureId:item.pictureId},function(data){200==data.status?(layer.msg("图片删除成功"),getPicList(1)):500==data.status&&layer.msg("图片删除失败")},function(err){})},function(){})}$state.go("materialManagement.pictureLibrary"),$scope.vm={getPicList:getPicList,imageList:[],removeImg:removeImg,pictureName:"",paginationConf:{pageSize:8,pagesLength:10}},getPicList(1);var timeout;$scope.$watch("vm.paginationConf.currentPage",function(current){current&&(timeout&&$timeout.cancel(timeout),timeout=$timeout(function(){getPicList(current)},100))},!0)}]),angular.module("materialManagement").controller("speechLibraryController",["$scope","$state","ngDialog","$cookieStore","$stateParams","$timeout",function($scope,$state,ngDialog,$cookieStore,$stateParams,$timeout){function getVoiceList(index){httpRequestPost("/api/ms/voiceManage/queryVioce ",{index:(index-1)*$scope.vm.paginationConf.pageSize,pageSize:$scope.vm.paginationConf.pageSize},function(data){200==data.status&&$scope.$apply(function(){$scope.vm.voiceList=data.data,$scope.vm.paginationConf.currentPage=index,$scope.vm.paginationConf.totalItems=data.data.total,$scope.vm.paginationConf.numberOfPages=data.data.total/$scope.vm.paginationConf.pageSize})},function(err){})}function removeVoice(item,index){layer.confirm("确认删除该语音？",{btn:["确定","取消"]},function(){httpRequestPost("/api/ms/voiceManage/deleteVoice",{voiceUrl:item.voiceUrl,voiceId:item.voiceId},function(data){200==data.status?(layer.msg("语音删除成功"),getVoiceList(1)):500==data.status&&layer.msg("语音删除失败")},function(err){})},function(){})}function uploadSpeech(callback){ngDialog.openConfirm({template:"/static/materialManagement/speechLibrary/speechLibraryDialog.html",width:"900px",scope:$scope,closeByNavigation:!1,overlay:!0,closeByDocument:!1,closeByEscape:!0,showClose:!0,preCloseCallback:function(e){$scope.vm.isUploadStart=!1}})}$state.go("materialManagement.speechLibrary"),$scope.vm={getVoiceList:getVoiceList,voiceList:[],removeVoice:removeVoice,paginationConf:{pageSize:9,pagesLength:10},uploadSpeech:uploadSpeech,voiceTitle:"",isUploadStart:!1},getVoiceList(1);var timeout;$scope.$watch("vm.paginationConf.currentPage",function(current){current&&(timeout&&$timeout.cancel(timeout),timeout=$timeout(function(){getVoiceList(current)},100))},!0)}]),angular.module("materialManagement").controller("videoLibraryController",["$scope","$state","ngDialog","$cookieStore","$stateParams","$timeout","$window",function($scope,$state,ngDialog,$cookieStore,$stateParams,$timeout,$window){function getVoiceList(index){httpRequestPost("/api/ms/videoManage/queryVideo",{index:(index-1)*$scope.vm.paginationConf.pageSize,pageSize:$scope.vm.paginationConf.pageSize,videoName:$scope.vm.videoSearchName},function(data){200==data.status&&$scope.$apply(function(){$scope.vm.videoList=data.data,$scope.vm.paginationConf.currentPage=index,$scope.vm.paginationConf.totalItems=data.data.total,$scope.vm.paginationConf.numberOfPages=data.data.total/$scope.vm.paginationConf.pageSize})},function(err){})}function removeVoice(videoId){layer.confirm("确认删除该视频？",{btn:["确定","取消"]},function(){httpRequestPost("/api/ms/videoManage/deleteVideo",{videoId:videoId},function(data){200==data.status?(layer.msg("视频删除成功"),getVoiceList(1)):500==data.status&&layer.msg("视频删除失败")},function(err){})},function(){})}function selectAll(){$scope.vm.isSelectAll?($scope.vm.isSelectAll=!1,$scope.vm.videoIds=[]):($scope.vm.isSelectAll=!0,$scope.vm.videoIds=[],angular.forEach($scope.vm.videoList.objs,function(val){$scope.vm.videoIds.push(val.videoId)}))}function selectSingle(id){$scope.vm.videoIds.inArray(id)?($scope.vm.videoIds.remove(id),$scope.vm.isSelectAll=!1):$scope.vm.videoIds.push(id),$scope.vm.videoIds.length==$scope.vm.videoList.objs.length&&($scope.vm.isSelectAll=!0)}function batchDeleteVideo(){0==$scope.vm.videoIds.length?layer.msg("请选择删除的视频"):layer.confirm("确认删除该视频？",{btn:["确定","取消"]},function(){httpRequestPost("/api/ms/videoManage/batchDeleteVideo",{videoIds:$scope.vm.videoIds},function(data){200==data.status?(layer.msg("视频删除成功"),getVoiceList(1),$scope.vm.isSelectAll=!1):500==data.status&&layer.msg("视频删除失败")},function(err){})},function(){})}function exportExcel(){var urlParams="?applicationId="+APPLICATION_ID,url="/api/ms/videoManage/exportVideo"+urlParams;$window.open(url,"_blank")}function changeName(callback){$scope.vm.videoName=callback.videoName,$scope.vm.videoId=callback.videoId;ngDialog.openConfirm({template:"/static/materialManagement/videoLibrary/video_change_name.html",width:"400px",scope:$scope,closeByNavigation:!1,overlay:!0,closeByDocument:!1,closeByEscape:!0,showClose:!0,preCloseCallback:function(e){1===e&&updateVideo()}})}function updateVideo(){httpRequestPost("/api/ms/videoManage/updateVideoName",{videoId:$scope.vm.videoId,videoName:$scope.vm.videoName},function(data){200==data.status?getVoiceList(1):500==data.status&&layer.msg("名称根寻失败")},function(error){})}function uploadSpeech(callback){ngDialog.openConfirm({template:"/static/materialManagement/videoLibrary/video_libraryDialog.html",width:"900px",scope:$scope,closeByNavigation:!1,overlay:!0,closeByDocument:!1,closeByEscape:!0,showClose:!0,preCloseCallback:function(e){$scope.vm.isUploadStart=!1}})}$state.go("materialManagement.videoLibrary"),$scope.vm={getVoiceList:getVoiceList,videoList:[],removeVoice:removeVoice,batchDeleteVideo:batchDeleteVideo,changeName:changeName,exportExcel:exportExcel,paginationConf:{pageSize:5,pagesLength:10},videoTitle:"",isSelectAll:!1,selectAll:selectAll,selectSingle:selectSingle,videoIds:[],videoName:"",videoSearchName:"",uploadSpeech:uploadSpeech,isUploadStart:!1,uploadParemeter:{queueNumber:0,uploadNumber:0,process:"0%"}},getVoiceList(1);var timeout;$scope.$watch("vm.paginationConf.currentPage",function(current){current&&(timeout&&$timeout.cancel(timeout),timeout=$timeout(function(){getVoiceList(current)},100))},!0)}]),knowledge_static_web.directive("imgUpload",["$parse","$state",function($parse,$state){return{restrict:"EA",template:'<span  id="picker" style="float:left">上传图片</span>',link:function(scope,element,attrs){var uploader=WebUploader.create({auto:!0,swf:"/bower_components/webuploader-0.1.5/dist/Uploader.swf",server:"/api/ms/picture/upload",pick:"#picker"});uploader.on("fileQueued",function(file){}),uploader.on("uploadProgress",function(file,percentage){}),uploader.on("uploadError",function(file){}),uploader.on("uploadSuccess",function(file,response){500==response.status?layer.msg("模板错误"):(layer.msg("上传成功"),$state.reload())})}}}]),knowledge_static_web.directive("uploaderBase",["$parse","$cookieStore","$state",function($parse,$cookieStore,$state){return{restrict:"EA",scope:{accept:"=",server:"=",type:"=",isAuto:"=",selectBtn:"=",tableList:"="},template:'<div  id="picker" style="height:30px;font-size:14px;">批量导入</div>',link:function(scope,element,attrs){var uploader=WebUploader.create({auto:!0,swf:"Uploader.swf",formData:{userId:USER_ID,applicationId:APPLICATION_ID,userName:USER_NAME},server:"/api/ms/chatKnowledge/upload",pick:"#picker"});uploader.on("fileQueued",function(file){}),uploader.on("uploadProgress",function(file,percentage){var $li=$("#"+file.id),$percent=$li.find(".progress .progress-bar");$percent.length||($percent=$('<div class="progress progress-striped active" style="height: 50px;background: red; width: 200px;"><div class="progress-bar" role="progressbar" style="width: 0%"></div> </div>').appendTo($li).find(".progress-bar")),$li.find("p.state").text("上传中"),$percent.css("width",100*percentage+"%")}),uploader.on("uploadError",function(file){}),uploader.on("uploadSuccess",function(file,response){500==response.status?layer.msg("模板错误"):10001==response.status?layer.msg("导入失败"):(layer.msg("导入成功",{time:2e3}),$state.reload())})}}}]),knowledge_static_web.directive("videoUpload",["$parse","$state","$timeout","ngDialog",function($parse,$state,$timeout,ngDialog){return{restrict:"EA",template:'<span  id="picker" style="float:left">选择视频</span><br/><br/><p ng-repeat="item in fileNames">{{item}}</p>',link:function(scope,element,attrs){scope.fileNames=[],$timeout(function(){var uploader=WebUploader.create({auto:!1,swf:"/bower_components/webuploader-0.1.5/dist/Uploader.swf",server:"/api/ms/videoManage/uploadVideo",pick:"#picker",fileNumLimit:1,fileSingleSizeLimit:10485760,accept:{title:"Video",extensions:"MP4,RMVB,WMV,AVI"}});uploader.on("fileQueued",function(file){if("mp4"!=file.ext&&"rmvb"!=file.ext&&"wmv"!=file.ext&&"avi"!=file.ext)return layer.msg("请选择格式为rmvb、wmb、avi、mp4类型的视频文件上传");scope.$apply(function(){scope.vm.isUploadStart=!1,scope.fileNames.push(file.name)})}),uploader.on("uploadProgress",function(file,percentage){scope.vm.uploadParemeter.process=100*percentage+"%",$("progress .bar_span").css("width",100*percentage+"%")}),uploader.on("error",function(type,file){var file=file;switch(type){case"Q_EXCEED_NUM_LIMIT":layer.msg("错误：上传文件数量过多！"),scope.$apply(function(){scope.vm.isUploadStart=!0,scope.fileNames.push(file.name)});break;case"Q_EXCEED_SIZE_LIMIT":layer.msg("错误：文件总大小超出限制！");break;case"F_EXCEED_SIZE":layer.msg("文件大小不能超过10M");break;case"Q_TYPE_DENIED":layer.msg("请选择rmvb,wmv,avi,mp4类型视频文件上传");break;case"F_DUPLICATE":layer.msg("错误：请勿重复上传该文件！");break;default:layer.msg("请检查"+type+"后重新上传")}}),uploader.on("uploadError",function(file,reason){layer.msg("请检查"+reason)}),uploader.on("uploadSuccess",function(file,response){500==response.status&&(scope.vm.isUploadStart=!1),200==response.status&&(ngDialog.closeAll(),layer.msg("上传成功"),$state.reload())}),scope.$watch("vm.isUploadStart",function(val){val&&scope.vm.videoTitle&&(scope.vm.videoTitle?(uploader.options.formData={videoName:scope.vm.videoTitle,videoUserName:USER_LOGIN_NAME,applicationId:APPLICATION_ID},uploader.upload()):layer.msg("请添加视频标题"))})},0)}}}]),knowledge_static_web.directive("voiceUpload",["$parse","$state","$timeout","ngDialog",function($parse,$state,$timeout,ngDialog){return{restrict:"EA",template:'<span  id="picker" style="float:left">选择语音</span><br/><br/><p ng-repeat="item in fileNames">{{item}}</p>',link:function(scope,element,attrs){scope.fileNames=[],$timeout(function(){var uploader=WebUploader.create({auto:!1,swf:"/bower_components/webuploader-0.1.5/dist/Uploader.swf",server:"/api/ms/voiceManage/uploadVoice",pick:"#picker"});uploader.on("fileQueued",function(file){if("mp3"!=file.ext&&"amr"!=file.ext)return layer.msg("请选择 mp4 或 amr 类型语音文件上传");scope.$apply(function(){scope.vm.isUploadStart=!1,scope.fileNames.push(file.name)})}),uploader.on("uploadProgress",function(file,percentage){}),uploader.on("uploadError",function(file){}),uploader.on("uploadSuccess",function(file,response){500==response.status?scope.vm.isUploadStart=!1:(ngDialog.closeAll(),layer.msg("上传成功"),$state.reload())}),scope.$watch("vm.isUploadStart",function(val){val&&scope.vm.voiceTitle&&(scope.vm.voiceTitle?(uploader.options.formData={voiceName:scope.vm.voiceTitle},uploader.upload()):layer.msg("请添加语音标题"))})},0)}}}]),angular.module("myApplicationSettingModule").controller("AssociationManageController",["$scope","localStorageService","$state","ngDialog","$cookieStore","$timeout",function($scope,localStorageService,$state,ngDialog,$cookieStore,$timeout){function listApplicationServiceData(index){httpRequestPost("/api/application/relation/listServiceRelation",{applicationId:$scope.vm.applicationId,index:(index-1)*$scope.vm.pageSize,pageSize:$scope.vm.pageSize,searchWord:$scope.vm.searchWord},function(data){$scope.vm.applicationServiceData=data.data,$scope.vm.dataTotal=data.total,$scope.vm.paginationConf={currentPage:index,totalItems:data.total,pageSize:$scope.vm.pageSize,pagesLength:8},$scope.$apply()},function(){layer.msg("请求失败")})}function listOtherApplicationServiceData(index){httpRequestPost("/api/application/relation/listOtherApplicationService",{applicationId:$scope.vm.applicationId,index:(index-1)*$scope.other.pageSize,pageSize:$scope.other.pageSize},function(data){$scope.other.applicationServiceData=data.data,$scope.other.dataTotal=data.total,$scope.other.paginationConf={currentPage:index,totalItems:data.total,pageSize:$scope.vm.pageSize,pagesLength:8},$scope.$apply()},function(){layer.msg("请求失败")})}function addRelatedService(){if(null==$scope.vm.serviceIds||0==$scope.vm.serviceIds.length)layer.msg("请选择服务");else{listOtherApplicationServiceData(1);ngDialog.openConfirm({template:"/static/myApplication/applicationConfig/AssociationManageDialog.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){1===e?null==$scope.vm.relatedServiceIds||0==$scope.vm.relatedServiceIds.length?layer.msg("请选择要关联的服务"):httpRequestPost("/api/application/relation/relatedService",{applicationId:$scope.vm.applicationId,userId:$scope.vm.userId,serviceIds:$scope.vm.serviceIds,relatedServiceIds:$scope.vm.relatedServiceIds},function(data){200==data.status?(layer.msg("关联成功"),listApplicationServiceData(1)):layer.msg("关联出错了")},function(){layer.msg("请求失敗")}):($scope.vm.serviceIds=[],$scope.vm.relatedServiceIds=[])}})}}function cancelRelatedService(){if(null==$scope.vm.serviceIds||0==$scope.vm.serviceIds.length)layer.msg("请选择要取消的服务");else{ngDialog.openConfirm({template:"/static/myApplication/applicationConfig/AssociationManageDialog2.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){1===e&&httpRequestPost("/api/application/relation/cancelRelatedService",{serviceIds:$scope.vm.serviceIds},function(data){200==data.status?(layer.msg("取消关联成功"),listApplicationServiceData(1)):layer.msg("取消关联出错了")},function(){layer.msg("请求失敗")})}})}}function selectRelatedServiceId(relatedServiceId){null==$scope.vm.relatedServiceIds&&($scope.vm.relatedServiceIds=[]),$scope.vm.relatedServiceIds.inArray(relatedServiceId)?$scope.vm.relatedServiceIds.remove(relatedServiceId):$scope.vm.relatedServiceIds.push(relatedServiceId)}function selectServiceId(serviceId){$scope.vm.serviceIds=[],$scope.vm.serviceIds.push(serviceId)}$scope.vm={applicationId:$cookieStore.get("applicationId"),userId:$cookieStore.get("userId"),applicationServiceData:"",paginationConf:"",pageSize:5,dataTotal:"",serviceIds:[],relatedServiceIds:[],searchWord:"",selectRelatedServiceId:selectRelatedServiceId,selectServiceId:selectServiceId,addRelatedService:addRelatedService,cancelRelatedService:cancelRelatedService,listApplicationServiceData:listApplicationServiceData},$scope.other={applicationServiceData:"",paginationConf:"",pageSize:5,dataTotal:""},listApplicationServiceData(1);var timeout;$scope.$watch("vm.paginationConf.currentPage",function(current){current&&(timeout&&$timeout.cancel(timeout),timeout=$timeout(function(){listApplicationServiceData(current)},100))},!0);var timeout2;$scope.$watch("other.paginationConf.currentPage",function(current){current&&(timeout2&&$timeout.cancel(timeout2),timeout2=$timeout(function(){listOtherApplicationServiceData(current)},100))},!0)}]),angular.module("myApplicationSettingModule").controller("newServiceReleaseController",["$scope","localStorageService","$state","ngDialog","$stateParams","$cookieStore","$timeout",function($scope,localStorageService,$state,ngDialog,$stateParams,$cookieStore,$timeout){function findServiceByServiceId(){null!=$stateParams.serviceId?($scope.vm.dialogTitle="编辑服务",httpRequestPost("/api/application/service/findServiceById",{serviceId:$stateParams.serviceId},function(data){200==data.status?($scope.vm.appName=data.data.appName,$scope.vm.categoryIds=data.data.categoryIds,$scope.vm.newCategoryIds=data.data.categoryIds,$scope.vm.channels=data.data.channels,$scope.vm.nodeCode=data.data.nodeCode,$scope.vm.serviceName=data.data.serviceName,$scope.vm.serviceStatus=data.data.serviceStatus,$scope.vm.serviceType=data.data.serviceType,$scope.vm.serviceId=data.data.serviceId,$scope.$apply(),httpRequestPost("/api/application/node/findParentNodeInfo",{nodeCode:data.data.nodeCode},function(data){200==data.status?($scope.vm.nodeData.push(data.data),$scope.$apply()):layer.msg("查询节点信息失败")},function(){layer.msg("请求失败")}),httpRequestPost("/api/application/service/listDimensionByServiceId",{serviceId:$stateParams.serviceId},function(data1){if(200==data1.status){var dimensionSelected=[];angular.forEach(data1.data,function(dimensionId){angular.forEach($scope.vm.dimensionAll,function(dimension){dimensionId==dimension.dimensionId&&dimensionSelected.push(dimension)})}),$scope.vm.dimensionSelected=dimensionSelected,$scope.$apply()}else layer.msg("查询失败")},function(){layer.msg("请求失败")})):layer.msg("查询服务失败")},function(){layer.msg("请求失败")})):$scope.vm.dialogTitle="发布新服务"}function publish(){$scope.vm.allowSubmit&&($scope.vm.dimensions=$scope.vm.dimensionSelected.id,null!=$scope.vm.serviceId?httpRequestPost("/api/application/service/editService",{applicationId:$scope.vm.applicationId,categoryIds:$scope.vm.categoryIds,channels:$scope.vm.channels,dimensions:$scope.vm.dimensions,nodeCode:$scope.vm.nodeCode,serviceName:$scope.vm.serviceName,serviceType:$scope.vm.serviceType,userId:$scope.vm.userId,serviceId:$scope.vm.serviceId},function(data){200==data.status?$state.go("setting.releaseMan"):layer.msg("新增发布服务失败")},function(){layer.msg("请求失败")}):httpRequestPost("/api/application/service/addAndPublishService",{applicationId:$scope.vm.applicationId,categoryIds:$scope.vm.categoryIds,channels:$scope.vm.channels,dimensions:$scope.vm.dimensions,nodeCode:$scope.vm.nodeCode,serviceName:$scope.vm.serviceName,serviceType:$scope.vm.serviceType,userId:$scope.vm.userId},function(data){200==data.status?$state.go("setting.releaseMan"):layer.msg("新增发布服务失败")},function(){layer.msg("请求失败")}))}function cancelPublish(){$state.go("setting.releaseMan")}function listChannelData(){httpRequestPost("/api/application/channel/listChannels",{applicationId:$scope.vm.applicationId},function(data){200==data.status?($scope.vm.channelData=data.data,$scope.$apply()):layer.msg("查询渠道失败")},function(){layer.msg("请求失败")})}function listTypeData(){httpRequestPost("/api/application/service/listServiceType",{},function(data){200==data.status?($scope.vm.typeData=data.data,$scope.$apply()):layer.msg("查询服务类型失败")},function(){layer.msg("请求失败")})}function listNodeData(){httpRequestPost("/api/application/node/listNoUsingNode",{},function(data){200==data.status?($scope.vm.nodeData=data.data,$scope.$apply()):layer.msg("查询可用节点失败")},function(){layer.msg("请求失败")})}function listCategory(){ngDialog.openConfirm({template:"/static/myApplication/applicationRelease/NewServiceReleaseDialog.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){1===e&&($scope.vm.categoryIds=$scope.vm.newCategoryIds)}});$timeout(function(){relationBot()},200)}function selectChannel(channelId){null==$scope.vm.channels&&($scope.vm.channels=[]),$scope.vm.channels.inArray(channelId)?$scope.vm.channels.remove(channelId):$scope.vm.channels.push(channelId)}function selectType(serviceType){$scope.vm.serviceType=serviceType}function selectNode(nodeCode){$scope.vm.nodeCode=nodeCode}function listDimensionData(){httpRequestPost("/api/application/dimension/list",{applicationId:$scope.vm.applicationId},function(data){data.data&&($scope.vm.dimensionAll=data.data,$scope.$apply())},function(err){layer.msg("获取维度失败，请刷新页面")})}function relationBot(){function getBotRoot(){httpRequestPost("/api/ms/modeling/category/listbycategorypid",{categoryApplicationId:$scope.vm.applicationId,categoryPid:"root"},function(data){$scope.vm.botRoot=data.data,$scope.$apply()},function(){layer.msg("获取BOT分类失败")})}getBotRoot(),$(".aside-navs-cont").on("click",".botSelect",function(){var self=angular.element(this),id=self.attr("data-option");self.prop("checked")?($scope.vm.newCategoryIds.push(id),$scope.$apply()):($scope.vm.newCategoryIds.remove(id),$scope.$apply())}),$(".aside-navs-cont").on("click",".icon-jj",function(){var id=$(this).attr("data-option"),that=$(this);that.parent().parent().siblings().length?"0% 0%"==that.css("backgroundPosition")?(that.css("backgroundPosition","0% 100%"),that.parent().parent().next().slideDown()):(that.css("backgroundPosition","0% 0%"),that.parent().parent().next().slideUp()):(that.css("backgroundPosition","0% 100%"),httpRequestPost("/api/ms/modeling/category/listbycategorypid",{categoryApplicationId:$scope.vm.applicationId,categoryPid:id},function(data){if(data.data){for(var html='<ul class="menus">',i=0;i<data.data.length;i++){var checkbox="";null!=$scope.vm.categoryIds&&(checkbox=$scope.vm.categoryIds.inArray(data.data[i].categoryId)),html+='<li><div class="slide-a"> <a class="ellipsis" href="javascript:;"><i class="icon-jj" data-option="'+data.data[i].categoryId+'"></i><input type="checkbox" class="botSelect" ',checkbox&&(html+=" checked "),html+='data-option="'+data.data[i].categoryId+'"/><span>'+data.data[i].categoryName+"</span></a></div></li>"}html+="</ul>",$(html).appendTo(that.parent().parent().parent()),that.parent().parent().next().slideDown()}},function(err){alert(err)}))})}$scope.vm={applicationId:$cookieStore.get("applicationId"),appName:"",categoryIds:[],channels:[],dimensionSelected:[],dimensionAll:[],dimensions:[],nodeCode:"",serviceId:$stateParams.serviceId,serviceName:"",serviceStatus:0,serviceType:0,userId:$cookieStore.get("userId"),categoryData:"",channelData:"",dimensionData:"",typeData:"",nodeData:"",dialogTitle:"",allowSubmit:1,selectChannel:selectChannel,selectType:selectType,selectNode:selectNode,listCategory:listCategory,listNodeData:listNodeData,listChannelData:listChannelData,listTypeData:listTypeData,listDimensionData:listDimensionData,publish:publish,cancelPublish:cancelPublish,findServiceByServiceId:findServiceByServiceId,botRoot:"",newCategoryIds:[]},listDimensionData(),findServiceByServiceId(),listNodeData(),listChannelData(),listTypeData()}]).directive("checkServiceName",function($http){return{require:"ngModel",link:function(scope,ele,attrs,c){scope.$watch(attrs.ngModel,function(n){n&&$http({method:"POST",url:"/api/application/service/checkName",data:{serviceName:scope.vm.serviceName,serviceId:scope.vm.serviceId}}).success(function(data){data.data?(c.$setValidity("unique",!0),scope.vm.allowSubmit=1):(c.$setValidity("unique",!1),scope.vm.allowSubmit=0)}).error(function(data){c.$setValidity("unique",!1),scope.vm.allowSubmit=0})})}}}),angular.module("myApplicationModule").controller("addAdminController",["$scope","$state","$stateParams",function($scope,$state,$stateParams){$state.go("admin.manage",{userPermission:$stateParams.userPermission})}]),angular.module("myApplicationModule").controller("myApplicationController",["$scope","$state","$stateParams",function($scope,$state,$stateParams){$state.go("myApplication.manage",{userPermission:$stateParams.userPermission})}]),angular.module("myApplicationSettingModule").controller("applicationInforController",["$scope","localStorageService","$state","ngDialog","$cookieStore","$rootScope","$timeout",function($scope,localStorageService,$state,ngDialog,$cookieStore,$rootScope,$timeout){function listServiceData(index){httpRequestPost("/api/application/service/listServiceByPage",{applicationId:$scope.vm.applicationId,index:(index-1)*$scope.vm.pageSize,pageSize:$scope.vm.pageSize},function(data){$scope.vm.serviceData=data.data,$scope.vm.dataTotal=data.total,$scope.vm.paginationConf={currentPage:index,totalItems:data.total,pageSize:$scope.vm.pageSize,pagesLength:8},$scope.$apply()},function(){layer.msg("请求失败")})}function publishService(serviceId){httpRequestPost("/api/application/service/publishService",{serviceId:serviceId,applicationId:$scope.vm.applicationId,userId:$scope.vm.userId,userName:$scope.vm.userName},function(data){200==data.status?(layer.msg("发布服务成功"),listServiceData(1)):layer.msg("发布服务失败")},function(){layer.msg("请求失败")})}function startService(serviceId){layer.confirm("确认上线？",{btn:["确认","取消"],shade:!1},function(index){layer.close(index),httpRequestPost("/api/application/service/startService",{serviceId:serviceId},function(data){200==data.status?(layer.msg("上线服务成功"),listServiceData(1)):layer.msg("上线服务失败")},function(){layer.msg("请求失败")})},function(){})}function stopService(serviceId){layer.confirm("确认下线？",{btn:["确认","取消"],shade:!1},function(index){layer.close(index),httpRequestPost("/api/application/service/stopService",{serviceId:serviceId},function(data){200==data.status?(layer.msg("下线服务成功"),listServiceData(1)):layer.msg("下线服务失败")},function(){layer.msg("请求失败")})},function(){})}function restartService(serviceId){layer.confirm("确认重启？",{btn:["确认","取消"],shade:!1},function(index){layer.close(index),httpRequestPost("/api/application/service/restartService",{serviceId:serviceId},function(data){200==data.status?(layer.msg("重启服务成功"),listServiceData(1)):layer.msg("重启服务失败")},function(){layer.msg("请求失败")})},function(){})}function findApplicationInfo(){httpRequestPost("/api/application/application/findApplication",{applicationId:$scope.vm.applicationId},function(data){200==data.status?($rootScope.applicationName=data.data.applicationName,$cookieStore.put("applicationName",data.data.applicationName),$scope.vm.sceneId=data.data.sceneId,$scope.vm.applicationName=data.data.applicationName,$scope.vm.applicationNewName=data.data.applicationName,$scope.vm.applicationDescription=data.data.applicationDescription,$scope.vm.applicationCreateTime=data.data.applicationCreateTime,$scope.vm.statusId=data.data.statusId,$scope.vm.applicationLisence=data.data.applicationLisence,$scope.$apply()):layer.msg("查询失败")},function(){layer.msg("请求失败")})}function findSceneInfo(){httpRequestPost("/api/application/application/findSceneInfo",{applicationId:$scope.vm.applicationId},function(data){200==data.status?($scope.vm.knowledgeTypeNum=data.data.knowledgeTypeNum,$scope.vm.exchangeModeNum=data.data.exchangeModeNum,$scope.vm.businessFrameNum=data.data.businessFrameNum,$scope.$apply()):layer.msg("查询失败")},function(){layer.msg("请求失败")})}function editName(){$scope.vm.applicationNewName=$scope.vm.applicationName;ngDialog.openConfirm({template:"/static/myApplication/applicationInfor/applicationInforDialog.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){1===e?$scope.vm.allowSubmit&&httpRequestPost("/api/application/application/updateApplication",{applicationId:$scope.vm.applicationId,sceneId:$scope.vm.sceneId,applicationName:$scope.vm.applicationNewName,applicationDescription:$scope.vm.applicationDescription,applicationLisence:$scope.vm.applicationLisence,userId:$scope.vm.userId},function(data){200==data.status?findApplicationInfo():layer.msg("修改失败")},function(){layer.msg("请求失败")}):$scope.vm.applicationNewName=""}})}function stopAllServices(){layer.confirm("确认下线所有服务？",{btn:["确认","取消"],shade:!1},function(index){layer.close(index),httpRequestPost("/api/application/service/stopAllService",{applicationId:$scope.vm.applicationId},function(data){200==data.status?(layer.msg("下线所有服务成功"),listServiceData(1),findApplicationInfo()):layer.msg("下线所有服务失败")},function(){layer.msg("请求失败")})},function(){})}function deleteApplication(){layer.confirm("确认删除当前应用？",{btn:["确认","取消"],shade:!1},function(index){layer.close(index),httpRequestPost("/api/application/service/deleteAllServices",{applicationId:$scope.vm.applicationId,userId:$scope.vm.userId,userName:$scope.vm.userName},function(data){200==data.status?(layer.msg("删除成功"),$state.go("admin.manage")):layer.msg("删除失败")},function(){})},function(){})}$scope.vm={applicationId:$cookieStore.get("applicationId"),userId:$cookieStore.get("userId"),userName:$cookieStore.get("userLoginName"),serviceData:"",paginationConf:"",pageSize:3,dataTotal:"",sceneId:"",applicationName:"",applicationNewName:"",applicationDescription:"",applicationCreateTime:"",applicationLisence:"",statusId:"",knowledgeTypeNum:"",exchangeModeNum:"",businessFrameNum:"",allowSubmit:1,findApplicationInfo:findApplicationInfo,findSceneInfo:findSceneInfo,listServiceData:listServiceData,publishService:publishService,startService:startService,stopService:stopService,restartService:restartService,editName:editName,deleteApplication:deleteApplication,stopAllServices:stopAllServices},findApplicationInfo(),findSceneInfo(),listServiceData(1);var timeout;$scope.$watch("vm.paginationConf.currentPage",function(current){current&&(timeout&&$timeout.cancel(timeout),timeout=$timeout(function(){listServiceData(current)},100))},!0)}]).directive("checkName",function($http){return{require:"ngModel",link:function(scope,ele,attrs,c){scope.$watch(attrs.ngModel,function(n){n&&$http({method:"POST",url:"/api/application/application/checkName",data:{applicationId:scope.vm.applicationId,applicationName:scope.vm.applicationNewName}}).success(function(data){data.data?(c.$setValidity("unique",!0),scope.vm.allowSubmit=1):(c.$setValidity("unique",!1),scope.vm.allowSubmit=0)}).error(function(data){c.$setValidity("unique",!1),scope.vm.allowSubmit=0})})}}}),angular.module("myApplicationModule").controller("botApplyController",["$scope","localStorageService","$timeout","$state","$stateParams","ngDialog","$cookieStore","$interval",function($scope,localStorageService,$timeout,$state,$stateParams,ngDialog,$cookieStore,$interval){function autoHeightForBot(){var $win=$(window),winHeight=.75*$win.height();$scope.vm.winHeight=winHeight+5,$(".libraryFt").attr("style","width: 450px;height: "+winHeight+"px;overflow-y: auto;background: #fff;float: left;"),$(".library_mid").attr("style","width: 200px;height: "+winHeight+"px;background: #fff;padding: 50px 20px;"),$(".libraryRth").attr("style","width: 670px;height: "+winHeight+"px;overflow-y: auto;background: #fff;float: right;padding: 30px;")}function locationForBot(suggestion){var currentNodeId=suggestion.data,initHeight=0,sum=$("#library").find("i").length;$.each($("#library").find("i"),function(index,value){if($(value).attr("data-option")==currentNodeId){var lib=$(".libraryFt"),scrollHeight=0;lib.length>0&&(scrollHeight=lib[0].scrollHeight);var offset=0;return scrollHeight-100>0&&(offset=(initHeight+1)/sum*(scrollHeight-100)),$(".libraryFt").animate({scrollTop:offset+"px"},800),!1}initHeight++})}function locationForBot(suggestion){var currentNodeId=suggestion.data,initHeight=0,sum=$("#library").find("i").length;$.each($("#library").find("i"),function(index,value){if($(value).attr("data-option")==currentNodeId){var lib=$(".libraryFt"),scrollHeight=0;lib.length>0&&(scrollHeight=lib[0].scrollHeight);var offset=0;return scrollHeight-100>0&&(offset=(initHeight+1)/sum*(scrollHeight-100)),$(".libraryFt").animate({scrollTop:offset+"px"},800),!1}initHeight++})}function locationForBotFlag(suggestion){var currentNodeId=suggestion.data,flag=!1,sum=$("#library").find("i").length;return $.each($("#library").find("i"),function(index,value){if($(value).attr("data-option")==currentNodeId){var lib=$(".libraryFt"),scrollHeight=0;return lib.length>0&&(scrollHeight=lib[0].scrollHeight),sum>=10&&scrollHeight>=$scope.vm.winHeight?flag=!0:sum<10&&(flag=!0),!1}}),flag}function searchNodeForBot(suggestion){var currentNodeId=suggestion.data,firstNode=$("#library").find("i").filter(":eq(0)");"0% 0%"==$(firstNode).css("backgroundPosition")?appendLibraryTree(firstNode):null==$(firstNode).parent().parent().next()&&appendLibraryTree(firstNode),$(firstNode).attr("data-option")==currentNodeId?(clearColorLibrary(),$scope.vm.knowledgeBotLibraryVal=$(firstNode).next().html(),$scope.vm.botLibrarySelectValue=$(firstNode).next().attr("data-option"),$scope.vm.botSelectType=$(firstNode).next().attr("type-option"),$scope.vm.categoryLibraryAttributeName=$(firstNode).next().attr("node-option"),$(firstNode).next().attr("style","color:black;font-weight:bold;"),$scope.$apply()):recursionForBot(suggestion,firstNode)}function recursionForBot(suggestion,node){var list=$("#library").find("li"),flag=!1;$.each(list,function(index,value){if($(value).attr("data-option")==$(node).attr("data-option")){var currNode=$(value).find("i").filter(":eq(0)");if($(currNode).attr("data-option")==suggestion.data)return clearColorLibrary(),$scope.vm.knowledgeBotLibraryVal=$(currNode).next().html(),$scope.vm.botLibrarySelectValue=$(currNode).next().attr("data-option"),$scope.vm.botSelectType=$(currNode).next().attr("type-option"),$scope.vm.categoryLibraryAttributeName=$(currNode).next().attr("node-option"),$(currNode).next().attr("style","color:black;font-weight:bold;"),$scope.$apply(),flag=!0,!0;if(1==flag)return!0;"0% 0%"==$(currNode).css("backgroundPosition")?appendLibraryTree(currNode):null==$(currNode).parent().parent().next()&&appendLibraryTree(currNode),recursionForBot(suggestion,currNode)}})}function initBot(){$("#category").empty(),httpRequestPostAsync("/api/ms/modeling/category/listbycategorypid",{categoryApplicationId:categoryApplicationId,categoryPid:"root"},function(data){for(var html='<ul class="menus show">',i=0;null!=data.data&&i<data.data.length;i++)html+='<li data-option="'+data.data[i].categoryPid+'"><div class="slide-a"><a class="ellipsis" href="javascript:;" '+categoryDescribeView(data.data[i].categoryDescribe)+"><i "+styleSwitch(data.data[i].categoryTypeId,data.data[i].categoryLeaf,data.data[i].categoryAttributeName)+' data-option="'+data.data[i].categoryId+'"></i><span '+nodeStyleSwitch(data.data[i].categoryAttributeName)+' type-option="'+data.data[i].categoryTypeId+'" node-option="'+data.data[i].categoryAttributeName+'" data-option="'+data.data[i].categoryId+'" title="'+data.data[i].categoryName+'">'+subStringWithTail(data.data[i].categoryName,10,"...")+'</span>&nbsp;<p class="treeEdit" bot-info='+toCategoryString(data.data[i])+'><img class="delete" style="width: 12px;" src="images/detel.png"/></p></a></div></li>';html+="</ul>",$("#category").append(html);var firstNode=$("#category").find("i").filter(":eq(0)");"0% 0%"==$(firstNode).css("backgroundPosition")?appendTree(firstNode):null==$(firstNode).parent().parent().next()&&appendTree(firstNode)},function(){})}function initBotLibrary(){$("#library").empty(),httpRequestPost("/api/ms/modeling/categorylibrary/listbycategorypid",{categoryPid:"root",categorySceneId:categorySceneId},function(data){for(var html='<ul class="menus show">',i=0;null!=data.data&&i<data.data.length;i++)html+='<li data-option="'+data.data[i].categoryPid+'"><div class="slide-a"><a class="ellipsis" href="javascript:;" '+categoryDescribeView(data.data[i].categoryDescribe)+"><i "+styleSwitch(data.data[i].categoryTypeId,data.data[i].categoryLeaf,data.data[i].categoryAttributeName)+' data-option="'+data.data[i].categoryId+'"></i><span '+nodeStyleSwitch(data.data[i].categoryAttributeName)+' node-option="'+data.data[i].categoryAttributeName+'" type-option="'+data.data[i].categoryTypeId+'" data-option="'+data.data[i].categoryId+'" title="'+data.data[i].categoryName+'">'+subStringWithTail(data.data[i].categoryName,10,"...")+'</span>&nbsp;<p class="treeEdit" bot-info='+toCategoryLibraryString(data.data[i])+'><img class="edit" src="images/bot-edit.png"/><img class="delete" style="width: 12px;" src="images/detel.png"/></p></a></div></li>';html+="</ul>",$("#library").append(html);var firstNode=$("#library").find("i").filter(":eq(0)");"0% 0%"==$(firstNode).css("backgroundPosition")?appendLibraryTree(firstNode):null==$(firstNode).parent().parent().next()&&appendLibraryTree(firstNode)},function(){})}function nodeStyleSwitch(attrType){return"edge"==attrType?"style='color:#ED7D31;'":""}function categoryDescribeView(describeStr){return 1==nullCheck(describeStr)?"title='"+describeStr+"'":""}function appendTree(obj){var id=$(obj).attr("data-option"),that=$(obj);that.parent().parent().siblings().length?"0% 0%"==that.css("backgroundPosition")?(that.css("backgroundPosition","0% 100%"),that.parent().parent().next().slideDown()):(that.css("backgroundPosition","0% 0%"),that.parent().parent().next().slideUp()):(that.css("backgroundPosition","0% 100%"),httpRequestPost("/api/ms/modeling/category/listbycategorypid",{categoryApplicationId:categoryApplicationId,categoryPid:id},function(data){if(data.data){for(var html='<ul class="menus">',i=0;i<data.data.length;i++)html+='<li data-option="'+data.data[i].categoryPid+'"><div class="slide-a"><a class="ellipsis" href="javascript:;" '+categoryDescribeView(data.data[i].categoryDescribe)+"><i "+styleSwitch(data.data[i].categoryTypeId,data.data[i].categoryLeaf,data.data[i].categoryAttributeName)+' data-option="'+data.data[i].categoryId+'"></i><span '+nodeStyleSwitch(data.data[i].categoryAttributeName)+' type-option="'+data.data[i].categoryTypeId+'" node-option="'+data.data[i].categoryAttributeName+'" data-option="'+data.data[i].categoryId+'" title="'+data.data[i].categoryName+'">'+subStringWithTail(data.data[i].categoryName,10,"...")+'</span>&nbsp;<p class="treeEdit" bot-info='+toCategoryString(data.data[i])+'><img class="delete" style="width: 12px;" src="images/detel.png"/></p></a></div></li>';html+="</ul>",$(html).appendTo(that.parent().parent().parent()),that.parent().parent().next().slideDown()}},function(err){}))}function appendLibraryTree(obj){var id=$(obj).attr("data-option"),that=$(obj);that.parent().parent().siblings().length?"0% 0%"==that.css("backgroundPosition")?(that.css("backgroundPosition","0% 100%"),that.parent().parent().next().slideDown()):(that.css("backgroundPosition","0% 0%"),that.parent().parent().next().slideUp()):(that.css("backgroundPosition","0% 100%"),httpRequestPostAsync("/api/ms/modeling/categorylibrary/listbycategorypid",{categoryPid:id},function(data){if(data.data){for(var html='<ul class="menus">',i=0;i<data.data.length;i++)html+='<li data-option="'+data.data[i].categoryPid+'"><div class="slide-a"><a class="ellipsis" href="javascript:;" '+categoryDescribeView(data.data[i].categoryDescribe)+"><i "+styleSwitch(data.data[i].categoryTypeId,data.data[i].categoryLeaf,data.data[i].categoryAttributeName)+' data-option="'+data.data[i].categoryId+'"></i><span '+nodeStyleSwitch(data.data[i].categoryAttributeName)+' node-option="'+data.data[i].categoryAttributeName+'" type-option="'+data.data[i].categoryTypeId+'" data-option="'+data.data[i].categoryId+'" title="'+data.data[i].categoryName+'">'+subStringWithTail(data.data[i].categoryName,10,"...")+'</span>&nbsp;<p class="treeEdit" bot-info='+toCategoryLibraryString(data.data[i])+'><img class="edit" src="images/bot-edit.png"/><img class="delete" style="width: 12px;" src="images/detel.png"/></p></a></div></li>';html+="</ul>",$(html).appendTo(that.parent().parent().parent()),that.parent().parent().next().slideDown()}},function(err){}))}function clearColorLibrary(){$.each($("#library").find("span"),function(index,value){"node"==$(this).attr("node-option")?$(this).attr("style",""):"edge"==$(this).attr("node-option")&&$(this).attr("style","color:#ED7D31;")})}function clearColor(){$.each($("#category").find("span"),function(index,value){"node"==$(this).attr("node-option")?$(this).attr("style",""):"edge"==$(this).attr("node-option")&&$(this).attr("style","color:#ED7D31;")})}function styleSwitch(type,leaf,attrType){var styleHidden="display: inline-block;";if(0==leaf&&(styleHidden="display:none;"),"node"==attrType)return"style='"+styleHidden+"position: relative;top: -1px;margin-right: 2px;width: 15px;height: 15px;vertical-align: middle;background-position: left top;background-repeat: no-repeat;background-image: url(../../images/images/aside-nav-icon.png);'";var style='style="'+styleHidden+'position: relative;top: -1px; margin-right: 5px; width: 15px; height: 15px; vertical-align: middle; background-position: left top; background-repeat: no-repeat;background-image:url(../../images/pic-navs-rq.png);"';switch(type){case 161:style='style="'+styleHidden+'position: relative;top: -1px; margin-right: 5px; width: 15px; height: 15px; vertical-align: middle; background-position: left top; background-repeat: no-repeat;background-image:url(../../images/pic-navs-sx.png);"';break;case 160:style='style="'+styleHidden+'position: relative;top: -1px; margin-right: 5px; width: 15px; height: 15px; vertical-align: middle; background-position: left top; background-repeat: no-repeat;background-image:url(../../images/pic-navs-lc.png);"';break;case 162:style='style="'+styleHidden+'position: relative;top: -1px; margin-right: 5px; width: 15px; height: 15px; vertical-align: middle; background-position: left top; background-repeat: no-repeat;background-image:url(../../images/pic-navs-dy.png);"'}return style}function applyCategory(){0!=applyValid()&&httpRequestPost("/api/ms/modeling/categorylibrary/applycategorybyid",{categoryId:$scope.vm.botLibrarySelectValue,categoryPid:$scope.vm.botSelectValue,categoryApplicationId:categoryApplicationId,categoryModifierId:categoryModifierId},function(data){1==responseView(data)&&initBot()},function(err){})}function applyValid(){return"root"==$scope.vm.botLibrarySelectValue?(layer.msg("请选择要套用的bot节点"),!1):$scope.vm.categoryAttributeName!=$scope.vm.categoryLibraryAttributeName||("edge"==$scope.vm.categoryAttributeName?layer.msg("关系以下必须添加节点"):layer.msg("节点以下必须添加关系"),!1)}function deleteBot(){ngDialog.openConfirm({template:"/static/myApplication/applicationDevelopment/deleteCategory.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){1===e&&httpRequestPost("/api/ms/modeling/category/deletebycategoryid",{categoryId:$scope.vm.categoryId,categoryApplicationId:$scope.vm.categoryApplicationId,categoryPid:$scope.vm.categoryPid,categoryLeaf:$scope.vm.categoryLeaf},function(data){1==responseView(data)&&reloadBot(data,1)},function(err){})}})}function botInfoToCategoryAttribute(){if($scope.vm.botInfo){var category=JSON.parse($scope.vm.botInfo);$scope.vm.botSelectValue=category.categoryId,$scope.vm.categoryId=category.categoryId,$scope.vm.categoryTypeId=category.categoryTypeId,$scope.vm.categorySceneId=category.categorySceneId,$scope.vm.categoryAttributeName=category.categoryAttributeName,$scope.vm.categoryName=category.categoryName,$scope.vm.categoryPid=category.categoryPid,$scope.vm.categoryApplicationId=category.categoryApplicationId,$scope.vm.categoryLeaf=category.categoryLeaf}}function botLibraryInfoToCategoryAttribute(){if($scope.vm.botLibraryInfo){var category=JSON.parse($scope.vm.botLibraryInfo);$scope.vm.botLibrarySelectValue=category.categoryId,$scope.vm.categoryLibraryId=category.categoryId,$scope.vm.categoryLibraryTypeId=category.categoryTypeId,$scope.vm.categoryLibrarySceneId=category.categorySceneId,$scope.vm.categoryLibraryAttributeName=category.categoryAttributeName,$scope.vm.categoryLibraryName=category.categoryName,$scope.vm.categoryLibraryPid=category.categoryPid,1==nullCheck(category.categoryDescribe)&&($scope.vm.categoryLibraryDescribe=underlineToWhiteSpace(category.categoryDescribe)),$scope.vm.categoryLibraryLeaf=category.categoryLeaf}}function reloadBot(data,type){if(0!=type&&$.each($(".aside-navs").find("li"),function(index,value){if($(value).find("i").attr("data-option")==$scope.vm.categoryId){$(value).attr("data-option");0==$(value).parent().find("li").length-1&&1==type&&$(value).parent().prev().find("i").attr("style","display:none"),$(value).remove()}}),1!=type)if("root"==$scope.vm.botSelectValue)initBot();else{var count=0;$.each($(".aside-navs").find("i"),function(index,value){if(2==type){if($(value).attr("data-option")==data.data[0].categoryPid){count++;var html='<li data-option="'+data.data[0].categoryPid+'"><div class="slide-a"> <a class="ellipsis" href="javascript:;" '+categoryDescribeView(data.data[0].categoryDescribe)+"><i "+styleSwitch(data.data[0].categoryTypeId,data.data[0].categoryLeaf,data.data[0].categoryAttributeName)+' data-option="'+data.data[0].categoryId+'"></i><span '+nodeStyleSwitch(data.data[0].categoryAttributeName)+' node-option="'+data.data[0].categoryAttributeName+'" type-option="'+data.data[0].categoryTypeId+'" data-option="'+data.data[0].categoryId+'" title="'+data.data[0].categoryName+'">'+subStringWithTail(data.data[0].categoryName,10,"...")+'</span>&nbsp;<p class="treeEdit" bot-info='+toCategoryString(data.data[0])+'><img class="edit" src="images/bot-edit.png"/><img class="delete" style="width: 12px;" src="images/detel.png"/></p></a></div></li>';$(value).parent().parent().next().append(html)}}else if(0==type&&$(value).attr("data-option")==data.data[0].categoryPid){count++;var html='<li data-option="'+data.data[0].categoryPid+'"><div class="slide-a"> <a class="ellipsis" href="javascript:;" '+categoryDescribeView(data.data[0].categoryDescribe)+"><i "+styleSwitch(data.data[0].categoryTypeId,data.data[0].categoryLeaf,data.data[0].categoryAttributeName)+' data-option="'+data.data[0].categoryId+'"></i><span '+nodeStyleSwitch(data.data[0].categoryAttributeName)+' node-option="'+data.data[0].categoryAttributeName+'" type-option="'+data.data[0].categoryTypeId+'" data-option="'+data.data[0].categoryId+'" title="'+data.data[0].categoryName+'">'+subStringWithTail(data.data[0].categoryName,10,"...")+'</span>&nbsp;<p class="treeEdit" bot-info='+toCategoryString(data.data[0])+'><img class="edit" src="images/bot-edit.png"/><img class="delete" style="width: 12px;" src="images/detel.png"/></p></a></div></li>',sty=($(value).parent().parent().next(),styleSwitch(data.data[0].categoryTypeId,1,data.data[0].categoryAttributeName));if(sty=sty.substring(7,sty.length-1),null!=$(value).parent().parent().next()){var len=$(value).parent().parent().next().find("li").length;len>0?$(value).parent().parent().next().append(html):($(value).parent().parent().next().append(html),$(value).attr("style",sty))}else{var htmlAppend='<ul class="menus show">'+html+"</ul>";$(value).parent().parent().parent().append(htmlAppend),$(value).attr("style",sty)}}}),0==count&&initBot()}}function addBotLibrary(){ngDialog.openConfirm({template:"/static/myApplication/applicationDevelopment/addCategoryLibrary.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){if(1===e){if(0==lengthCheck($("#categoryLibraryNameAdd").val(),0,50))return $("#addErrorView").html($scope.vm.categoryNameNullOrBeyondLimit),!1;if(isHtmlLabel($("#categoryLibraryNameAdd").val()))return $("#addErrorView").html($scope.vm.notContainHtmlLabel),!1;if(0==repeatCheckForCategory("#addErrorView",0))return!1;if(1==nullCheck($("#categoryLibraryDescribe").val())){if(0==lengthCheck($("#categoryLibraryDescribe").val(),0,2e3))return $("#describeErrorView").html($scope.vm.categoryDescribeBeyondLimit),!1;if(isHtmlLabel($("#categoryLibraryDescribe").val()))return $("#describeErrorView").html($scope.vm.notContainHtmlLabel),!1;$scope.vm.categoryLibraryDescribe=$("#categoryLibraryDescribe").val()}httpRequestPost("/api/ms/modeling/categorylibrary/add",{categoryPid:$scope.vm.botLibrarySelectValue,categoryAttributeName:$scope.vm.categoryLibraryAttributeName,categoryName:$("#categoryLibraryNameAdd").val(),categoryTypeId:$("#categoryLibraryTypeIdAdd").val(),categoryModifierId:categoryModifierId,categoryDescribe:$scope.vm.categoryLibraryDescribe,categorySceneId:categorySceneId,categoryLeaf:0},function(data){1==responseView(data)&&reloadBotLibrary(data,0),$("#categoryLibraryDescribe").val("")},function(err){})}}})&&$timeout(function(){disableAttributeTypeForApply(),$("#categoryLibraryNameAdd").blur(function(){0==lengthCheck($("#categoryLibraryNameAdd").val(),0,50)?$("#addErrorView").html($scope.vm.categoryNameNullOrBeyondLimit):isHtmlLabel($("#categoryLibraryNameAdd").val())?$("#addErrorView").html($scope.vm.notContainHtmlLabel):($("#addErrorView").html(""),repeatCheckForCategory("#addErrorView",0))})},100)}function repeatCheckForCategory(selector,type){var flag=!1,request=new Object;return 1==type?(request.categoryId=$scope.vm.categoryLibraryId,request.categoryPid=$scope.vm.categoryLibraryPid,request.categoryAttributeName=$("#categoryLibraryName").val(),request.categoryName=$("#categoryLibraryName").val(),request.categorySceneId=categorySceneId):(request.categoryPid=$scope.vm.botLibrarySelectValue,request.categoryAttributeName=$("#categoryLibraryNameAdd").val(),request.categoryName=$("#categoryLibraryNameAdd").val(),request.categorySceneId=categorySceneId),httpRequestPostAsync("/api/ms/modeling/categorylibrary/repeatcheck",request,function(data){0==responseWithoutView(data)?data&&$(selector).html(data.info):flag=!0},function(err){}),flag}function editBotLibrary(){ngDialog.openConfirm({template:"/static/myApplication/applicationDevelopment/editCategoryLibrary.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){if(1===e){if(0==lengthCheck($("#categoryLibraryName").val(),0,50))return $("#editErrorView").html($scope.vm.categoryNameNullOrBeyondLimit),!1;if(isHtmlLabel($("#categoryLibraryName").val()))return $("#editErrorView").html($scope.vm.notContainHtmlLabel),!1;if(0==repeatCheckForCategory("#editErrorView",1))return!1;if(1==nullCheck($("#categoryLibraryDescribe").val())){if(0==lengthCheck($("#categoryLibraryDescribe").val(),0,2e3))return $("#describeErrorView").html($scope.vm.categoryDescribeBeyondLimit),!1;if(isHtmlLabel($("#categoryLibraryDescribe").val()))return $("#describeErrorView").html($scope.vm.notContainHtmlLabel),!1;$scope.vm.categoryLibraryDescribe=$("#categoryLibraryDescribe").val()}httpRequestPost("/api/ms/modeling/categorylibrary/updatebycategoryid",{categoryId:$scope.vm.categoryLibraryId,categoryPid:$scope.vm.categoryLibraryPid,categoryAttributeName:$scope.vm.categoryLibraryAttributeName,categoryName:$("#categoryLibraryName").val(),categoryTypeId:$("#categoryLibraryTypeId").val(),categoryModifierId:categoryModifierId,categoryDescribe:$scope.vm.categoryLibraryDescribe,categorySceneId:categorySceneId,categoryLeaf:$scope.vm.categoryLibraryLeaf},function(data){1==responseView(data)&&reloadBotLibrary(data,2),$("#categoryLibraryDescribe").val("")},function(err){})}}})&&$timeout(function(){$("#categoryLibraryName").blur(function(){0==lengthCheck($("#categoryLibraryName").val(),0,50)?$("#editErrorView").html($scope.vm.categoryNameNullOrBeyondLimit):isHtmlLabel($("#categoryLibraryName").val())?$("#editErrorView").html($scope.vm.notContainHtmlLabel):($("#editErrorView").html(""),repeatCheckForCategory("#editErrorView",1))}),$("#categoryLibraryTypeId").empty();var attrArr=[];attrArr[0]={name:"默认",value:163},attrArr[1]={name:"流程",value:161},attrArr[2]={name:"划分",value:160},attrArr[3]={name:"属性",value:162};for(var index=0;index<attrArr.length;index++)"edge"==$scope.vm.categoryLibraryAttributeName?$("#categoryLibraryTypeId").append("<option value="+attrArr[index].value+">"+attrArr[index].name+"</option>"):(attrArr[index].value==$scope.vm.botSelectType)>0?$("#categoryLibraryTypeId").append("<option value="+attrArr[index].value+">"+attrArr[index].name+"</option>"):$("#categoryLibraryTypeId").append('<option disabled="disabled" style="background-color: lightgrey;" value='+attrArr[index].value+">"+attrArr[index].name+"</option>");$("#categoryLibraryTypeId").val($scope.vm.botSelectType)},100)}function deleteBotLibrary(){ngDialog.openConfirm({template:"/static/myApplication/applicationDevelopment/deleteCategory.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){1===e&&httpRequestPost("/api/ms/modeling/categorylibrary/deletebycategoryid",{categoryId:$scope.vm.categoryLibraryId,categoryPid:$scope.vm.categoryLibraryPid,categoryLeaf:$scope.vm.categoryLibraryLeaf},function(data){1==responseView(data)&&reloadBotLibrary(data,1)},function(err){}),$scope.vm.categoryLibraryAttributeName="edge"}})}function responseView(data){return null!=data&&(layer.msg(data.info),data.status==$scope.vm.success)}function responseWithoutView(data){return null!=data&&data.status==$scope.vm.success}function reloadBotLibrary(data,type){if(0!=type&&$.each($("#library").find("li"),function(index,value){$(value).find("i").attr("data-option")==$scope.vm.botLibrarySelectValue&&(0==length&&1==type&&$(value).parent().prev().find("i").attr("style","display:none"),$(value).remove())}),1!=type)if("root"==$scope.vm.botLibrarySelectValue)initBotLibrary();else{var count=0;$.each($("#library").find("i"),function(index,value){if(2==type){if($(value).attr("data-option")==data.data[0].categoryPid){count++;var html='<li data-option="'+data.data[0].categoryPid+'"><div class="slide-a"> <a class="ellipsis" href="javascript:;" '+categoryDescribeView(data.data[0].categoryDescribe)+"><i "+styleSwitch(data.data[0].categoryTypeId,data.data[0].categoryLeaf,data.data[0].categoryAttributeName)+' data-option="'+data.data[0].categoryId+'"></i><span '+nodeStyleSwitch(data.data[0].categoryAttributeName)+' node-option="'+data.data[0].categoryAttributeName+'" type-option="'+data.data[0].categoryTypeId+'" data-option="'+data.data[0].categoryId+'"title="'+data.data[0].categoryName+'">'+subStringWithTail(data.data[0].categoryName,10,"...")+'</span>&nbsp;<p class="treeEdit" bot-info='+toCategoryLibraryString(data.data[0])+'><img class="edit" src="images/bot-edit.png"/><img class="delete" style="width: 12px;" src="images/detel.png"/></p></a></div></li>';$(value).parent().parent().next().append(html)}}else if(0==type&&$(value).attr("data-option")==data.data[0].categoryPid){count++;var html='<li data-option="'+data.data[0].categoryPid+'"><div class="slide-a"> <a class="ellipsis" href="javascript:;" '+categoryDescribeView(data.data[0].categoryDescribe)+"><i "+styleSwitch(data.data[0].categoryTypeId,data.data[0].categoryLeaf,data.data[0].categoryAttributeName)+' data-option="'+data.data[0].categoryId+'"></i><span '+nodeStyleSwitch(data.data[0].categoryAttributeName)+' node-option="'+data.data[0].categoryAttributeName+'" type-option="'+data.data[0].categoryTypeId+'" data-option="'+data.data[0].categoryId+'"title="'+data.data[0].categoryName+'">'+subStringWithTail(data.data[0].categoryName,10,"...")+'</span>&nbsp;<p class="treeEdit" bot-info='+toCategoryLibraryString(data.data[0])+'><img class="edit" src="images/bot-edit.png"/><img class="delete" style="width: 12px;" src="images/detel.png"/></p></a></div></li>',nodeType=($(value).parent().parent().next(),"edge");"node"==data.data[0].categoryAttributeName?nodeType="edge":"edge"==data.data[0].categoryAttributeName&&(nodeType="node");var sty=styleSwitch(data.data[0].categoryTypeId,1,nodeType);if(sty=sty.substring(7,sty.length-1),null!=$(value).parent().parent().next()){var len=$(value).parent().parent().next().find("li").length;len>0?$(value).parent().parent().next().append(html):($(value).parent().parent().next().append(html),$(value).attr("style",sty))}else{var htmlAppend='<ul class="menus show">'+html+"</ul>";$(value).parent().parent().parent().append(htmlAppend),$(value).attr("style",sty)}}}),0==count&&initBotLibrary()}}function disableAttributeTypeForApply(){$("#categoryLibraryTypeIdAdd").empty();var attrArr=[];attrArr[0]={name:"默认",value:163},attrArr[1]={name:"流程",value:161},attrArr[2]={name:"划分",value:160},attrArr[3]={name:"属性",value:162};for(var index=0;index<attrArr.length;index++)"node"==$scope.vm.categoryLibraryAttributeName?$("#categoryLibraryTypeIdAdd").append("<option value="+attrArr[index].value+">"+attrArr[index].name+"</option>"):(attrArr[index].value==$scope.vm.botSelectType)>0?$("#categoryLibraryTypeIdAdd").append("<option value="+attrArr[index].value+">"+attrArr[index].name+"</option>"):$("#categoryLibraryTypeIdAdd").append('<option disabled="disabled" style="background-color: lightgrey;" value='+attrArr[index].value+">"+attrArr[index].name+"</option>");$("#categoryLibraryTypeIdAdd").val($scope.vm.botSelectType)}$scope.vm={success:1e4,illegal:10003,failed:10004,empty:10005,botSelectValue:"root",categoryNode:"node",categoryEdge:"edge",botRoot:"",knowledgeBotVal:"",botLibrarySelectValue:"root",botLibraryRoot:"",knowledgeBotLibraryVal:"",clearColor:clearColor,clearColorLibrary:clearColorLibrary,applyCategory:applyCategory,botInfo:null,deleteBot:deleteBot,categoryId:"",categoryTypeId:163,botSelectType:163,categorySceneId:0,categoryAttributeName:"edge",categoryName:"",categoryPid:"",categoryApplicationId:"",categoryLeaf:1,botLibraryInfo:null,addBotLibrary:addBotLibrary,editBotLibrary:editBotLibrary,deleteBotLibrary:deleteBotLibrary,categoryLibraryId:"",categoryLibraryTypeId:163,botLibrarySelectType:163,categoryLibrarySceneId:0,categoryLibraryAttributeName:"edge",categoryLibraryName:"",categoryLibraryPid:"",categoryLibraryDescribe:"",categoryLibraryLeaf:1,reloadBotLibrary:reloadBotLibrary,reloadBot:reloadBot,disableAttributeTypeForApply:disableAttributeTypeForApply,repeatCheckForCategory:repeatCheckForCategory,categoryNameNullOrBeyondLimit:"类目名称为空或超过长度限制50",notContainHtmlLabel:"不能包含HTML标签",categoryDescribeBeyondLimit:"描述超过长度限制2000",responseView:responseView,searchNodeForBot:searchNodeForBot,recursionForBot:recursionForBot,autoHeightForBot:autoHeightForBot,locationForBot:locationForBot,suggestionValue:"",suggestionData:"",winHeight:0};var categoryApplicationId=$cookieStore.get("applicationId"),categoryModifierId=$cookieStore.get("userId"),categorySceneId=$cookieStore.get("sceneId");autoHeightForBot();var params={categoryName:$("#category-autocomplete").val(),categoryAttributeName:"node",categorySceneId:categorySceneId};$("#category-autocomplete").autocomplete({serviceUrl:"/api/ms/modeling/categorylibrary/searchbycategoryname",type:"POST",params:params,paramName:"categoryName",dataType:"json",transformResult:function(data){var result=new Object,array=[];if(data.data)for(var i=0;i<data.data.length;i++)array[i]={data:data.data[i].categoryId,value:data.data[i].categoryName};return result.suggestions=array,result},onSelect:function(suggestion){searchNodeForBot(suggestion),$scope.vm.suggestionValue=suggestion.value,$scope.vm.suggestionData=suggestion.data}}),$interval(function(){if(1==nullCheck($scope.vm.suggestionData)){var suggestion=new Object;suggestion.value=$scope.vm.suggestionValue,suggestion.data=$scope.vm.suggestionData,locationForBotFlag(suggestion)&&(locationForBot(suggestion),$scope.vm.suggestionValue="",$scope.vm.suggestionData="")}},2e3),initBot(),initBotLibrary(),$("#category").on("click","span",function(){clearColor(),$scope.vm.knowledgeBotVal=$(this).html(),$scope.vm.botSelectValue=$(this).attr("data-option"),$scope.vm.categoryAttributeName=$(this).attr("node-option"),"node"==$scope.vm.categoryAttributeName?$(this).attr("style","color:black;font-weight:bold;"):"edge"==$scope.vm.categoryAttributeName&&$(this).attr("style","color:#ED7D31;font-weight:bold;"),$scope.$apply()}),$("#library").on("click","span",function(){clearColorLibrary(),$scope.vm.knowledgeBotLibraryVal=$(this).html(),$scope.vm.botLibrarySelectValue=$(this).attr("data-option"),$scope.vm.botSelectType=$(this).attr("type-option"),$scope.vm.categoryLibraryAttributeName=$(this).attr("node-option"),"node"==$scope.vm.categoryLibraryAttributeName?$(this).attr("style","color:black;font-weight:bold;"):"edge"==$scope.vm.categoryLibraryAttributeName&&$(this).attr("style","color:#ED7D31;font-weight:bold;"),$scope.$apply()}),$("#category").on("click","i",function(){appendTree(this)}),$("#library").on("click","i",function(){appendLibraryTree(this)}),$("#category").on("click",".delete",function(){$scope.vm.botInfo=$(this).parent().attr("bot-info"),botInfoToCategoryAttribute(),deleteBot()}),$("#library").on("click",".edit",function(){$scope.vm.botLibraryInfo=$(this).parent().attr("bot-info"),botLibraryInfoToCategoryAttribute(),editBotLibrary()}),$("#library").on("click",".delete",function(){$scope.vm.botLibraryInfo=$(this).parent().attr("bot-info"),botLibraryInfoToCategoryAttribute(),deleteBotLibrary()})}]),angular.module("myApplicationSettingModule").controller("channelManageController",["$scope","localStorageService","$state","ngDialog","$cookieStore","$timeout",function($scope,localStorageService,$state,ngDialog,$cookieStore,$timeout){function listChannelData(index){httpRequestPost("/api/application/channel/listChannelByPage",{applicationId:APPLICATION_ID,index:(index-1)*$scope.vm.pageSize,pageSize:$scope.vm.pageSize},function(data){$scope.vm.channelData=data.data,$scope.vm.channelDataTotal=data.total,$scope.vm.paginationConf={currentPage:index,totalItems:data.total,pageSize:$scope.vm.pageSize,pagesLength:8},$scope.$apply()},function(){layer.msg("请求失败")})}function listBlackListData(index){httpRequestPost("/api/application/channel/listBlackListByPage",{applicationId:APPLICATION_ID,index:(index-1)*$scope.vmo.pageSize,pageSize:$scope.vmo.pageSize},function(data){$scope.vmo.blackListData=data.data,$scope.vmo.blackListDataTotal=data.total,$scope.vmo.paginationConf={currentPage:index,totalItems:data.total,pageSize:$scope.vmo.pageSize,pagesLength:8},$scope.$apply()},function(){layer.msg("请求失败")})}function addChannel(){ngDialog.openConfirm({template:"/static/myApplication/applicationConfig/channelManageDialog.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){if(1===e){if(null==$scope.vm.channelName||""==$scope.vm.channelName)return void layer.msg("渠道名称不能为空！");httpRequestPost("/api/application/channel/addChannel",{applicationId:APPLICATION_ID,channelName:$scope.vm.channelName,statusId:$scope.vm.statusId.statusId,channelUpdateId:USER_ID},function(data){10002===data.data?(layer.msg("渠道重复！"),$scope.vm.channelName=""):10001===data.data?layer.msg("添加出错了！"):(layer.msg("添加成功"),listChannelData(1))},function(){layer.msg("添加失敗"),$scope.vm.channelName=""})}else $scope.vm.channelName=""}})}function editChannel(item){$scope.vm.dialogTitle="编辑渠道",$scope.vm.channelName=item.channelName;for(var i in $scope.vm.channelStatus)if($scope.vm.channelStatus[i].statusId==item.statusId){$scope.vm.statusId=$scope.vm.channelStatus[i];break}addDialog(singleEdit,item)}function addDialog(callback,item){ngDialog.openConfirm({template:"/static/myApplication/applicationConfig/channelManageDialog.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){1===e?callback(item):$scope.vm.channelName=""}})}function singleEdit(item){if(null==$scope.vm.channelName||""==$scope.vm.channelName)return void layer.msg("渠道名称不能为空！");httpRequestPost("/api/application/channel/editChannel",{channelId:item.channelId,applicationId:APPLICATION_ID,channelName:$scope.vm.channelName,statusId:$scope.vm.statusId.statusId,channelUpdateId:USER_ID},function(data){10002==data.data?layer.msg("渠道名称重复"):1e4==data.data?(layer.msg("编辑成功"),listChannelData(1)):layer.msg("编辑失败")},function(){})}function delChannel(channelId){httpRequestPost("/api/application/channel/delChannel",{channelId:channelId},function(data){1e4==data.data?(layer.msg("删除成功"),listChannelData(1)):layer.msg("删除失败")},function(){layer.msg("请求失败")})}function changeChannel(channelId,statusId){if(50001==statusId){ngDialog.openConfirm({template:"/static/admin/updateChannel1.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){1===e&&httpRequestPost("/api/application/channel/changeStatus",{channelId:channelId,applicationId:APPLICATION_ID},function(data){1e4===data.data?(layer.msg("状态修改成功"),listChannelData(1)):12008==data.status?layer.msg("存在是指使用该渠道，请修改知识后操作"):layer.msg("状态修改失败")},function(){layer.msg("请求失败")})}})}else{ngDialog.openConfirm({template:"/static/admin/updateChannel.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){1===e&&httpRequestPost("/api/application/channel/changeStatus",{channelId:channelId},function(data){1e4===data.data?(layer.msg("状态修改成功"),listChannelData(1)):layer.msg("状态修改失败")},function(){layer.msg("请求失败")})}})}}function selectAll(){$scope.vmo.isSelectedAll?($scope.vmo.isSelectedAll=!1,$scope.vmo.selectedList=[]):($scope.vmo.isSelectedAll=!0,$scope.vmo.selectedList=[],angular.forEach($scope.vmo.blackListData,function(item){$scope.vmo.selectedList.push(item.blackListId)}))}function selectSingle(id){$scope.vmo.selectedList.inArray(id)?($scope.vmo.selectedList.remove(id),$scope.vmo.isSelectedAll=!1):$scope.vmo.selectedList.push(id),$scope.vmo.selectedList.length==$scope.vmo.blackListData.length&&($scope.vmo.isSelectedAll=!0)}function addBlacklist(){ngDialog.openConfirm({template:"/static/myApplication/applicationConfig/blacklistManageDialog.html",width:"500px",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){1===e?httpRequestPost("/api/application/channel/addBlackList",{applicationId:APPLICATION_ID,blackListIdentify:$scope.vmo.blackListIdentify,blackListRemark:$scope.vmo.blackListRemark,blackListUpdateId:USER_ID,channelId:$scope.vmo.channelId},function(data){$scope.vmo.blackListRemark="",$scope.vmo.isSelectedAll=!1,$scope.vmo.blackListIdentify="",layer.msg("添加成功"),$scope.vmo.selectedList.length==$scope.vmo.pageSize&&($scope.vmo.selectedList.pop(),$scope.vmo.isSelectedAll=!1),listBlackListData(1)},function(){initBlackBackUp()}):initBlackBackUp()}})}function addBlackListCheck(){$scope.vmo.blackListIdentify?httpRequestPost("/api/application/channel/checkBlackList",{applicationId:APPLICATION_ID,blackListIdentify:$scope.vmo.blackListIdentify,channelId:$scope.vmo.channelId},function(data){10002===data.data?(layer.msg("黑名单重复！"),initBlackBackUp()):10003===data.data?(layer.msg("黑名单IP不合法！"),initBlackBackUp()):ngDialog.closeAll(1)}):layer.msg("请填写正确的ip标识")}function delBlacklist(blackListId){ngDialog.openConfirm({template:"/static/admin/deleteDialog.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){1===e&&httpRequestPost("/api/application/channel/deleteBlackList",{applicationId:APPLICATION_ID,blackListId:blackListId},function(data){initBlackList(),layer.msg("移除成功"),listBlackListData(1)},function(error){})}})}function batchDelBlacklist(){if(0==$scope.vmo.selectedList.length)return void layer.msg("请选择要删除的黑名单!");ngDialog.openConfirm({template:"/static/admin/deleteDialog.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){1===e&&httpRequestPost("/api/application/channel/batchDelBlackList",{applicationId:APPLICATION_ID,blackListIds:$scope.vmo.selectedList},function(data){1e4===data.data?(initBlackList(),layer.msg("移除成功"),listBlackListData(1)):layer.msg("移除失败")},function(error){})}})}function initBlackList(){$scope.vmo.selectedList=[],$scope.vmo.isSelectedAll=!1}function initBlackBackUp(){$scope.vmo.blackListIdentify="",$scope.vmo.blackListRemark=""}$scope.vm={channelData:"",paginationConf:"",pageSize:3,channelDataTotal:"",addChannel:addChannel,editChannel:editChannel,delChannel:delChannel,changeChannel:changeChannel,channelName:"",statusId:"",channelStatus:"",dialogTitle:""},$scope.vmo={blackListData:"",paginationConf:"",pageSize:2,blackListDataTotal:"",addBlacklist:addBlacklist,delBlacklist:delBlacklist,batchDelBlacklist:batchDelBlacklist,channelList:"",blackListIdentify:"",blackListRemark:"",channelId:"",addBlackListCheck:addBlackListCheck,selectedList:[],isSelectedAll:!1,selectAll:selectAll,selectSingle:selectSingle},function(){httpRequestPost("api/application/channel/listChannels",{applicationId:APPLICATION_ID},function(data){$scope.vmo.channelList=data.data},function(){})}(),function(){httpRequestPost("/api/application/channel/listStatus",{applicationId:APPLICATION_ID},function(data){$scope.vm.channelStatus=data.data},function(){})}(),listChannelData(1);var timeout;$scope.$watch("vm.paginationConf.currentPage",function(current){current&&(timeout&&$timeout.cancel(timeout),timeout=$timeout(function(){listChannelData(current)},100))},!0),listBlackListData(1);var timeout2;$scope.$watch("vmo.paginationConf.currentPage",function(current){current&&(timeout2&&$timeout.cancel(timeout2),timeout2=$timeout(function(){initBlackList(),listBlackListData(current)},100))},!0)}]),angular.module("knowledgeManagementModule").controller("chatPageConfigController",["$scope","localStorageService","$state","ngDialog","$cookieStore","$timeout",function($scope,localStorageService,$state,ngDialog,$cookieStore,$timeout){function selectAllDialog(ev){$scope.vm.selectAllCheckDialog?($scope.vm.selectAllCheckDialog=!1,$scope.vm.seleceAddAll=[]):($scope.vm.selectAllCheckDialog=!0,$scope.vm.seleceAddAll=[],angular.forEach($scope.vm.listKnoData,function(item,index){var obj={};obj.chatKnowledgeId=item.knowledgeId,obj.chatKnowledgeTopic=item.knowledgeTitle,obj.index=index,$scope.vm.seleceAddAll.push(obj)}))}function deleteDialog(item){$scope.vm.seleceAddAll.remove(item),$(".selectAllBtnDialog").prop("checked",!1),$(".selectSingle").eq(item.index).attr("checked",!1)}function selectSingleDialog(ev,id,name,index){var self=$(ev.target),prop=self.prop("checked"),obj={};obj.chatKnowledgeId=id,obj.chatKnowledgeTopic=name,obj.index=index,prop?($(".selectAllBtnDialog").prop("checked",!1),$scope.vm.seleceAddAll.push(obj)):(angular.forEach($scope.vm.seleceAddAll,function(item,index){id==item.chatKnowledgeId&&$scope.vm.seleceAddAll.splice(index,1)}),$(".selectAllBtnDialog").prop("checked",!1))}function selectAll(){$scope.vm.selectAllCheck?($scope.vm.selectAllCheck=!1,$scope.vm.deleteIds=[]):($scope.vm.selectAllCheck=!0,$scope.vm.deleteIds=[],angular.forEach($scope.vm.listData,function(item){$scope.vm.deleteIds.push(item.hotQuestionId)}))}function selectSingle(id){$scope.vm.deleteIds.inArray(id)?($scope.vm.deleteIds.remove(id),$scope.vm.selectAllCheck=!1):$scope.vm.deleteIds.push(id),$scope.vm.deleteIds.length==$scope.vm.listData.length&&($scope.vm.selectAllCheck=!0)}function getData(index){httpRequestPost("/api/application/hotQuestion/getHotQuestionList",{index:(index-1)*$scope.vm.pageSize,pageSize:$scope.vm.pageSize,applicationId:$scope.vm.applicationId},function(data){initChatPageConfig(),$scope.vm.listData=data.data.hotQuestionList,$scope.vm.listDataTotal=data.data.total,$scope.vm.listDataLength=data.data.total,$scope.vm.paginationConf={currentPage:index,totalItems:data.data.total,pageSize:$scope.vm.pageSize,pagesLength:8},$scope.$apply()},function(){layer.msg("请求失败")})}function findKnowledge(index){httpRequestPost("/api/ms/knowledgeManage/overView/findKnowledgeByApplicationId",{applicationId:$scope.vm.applicationId,knowledgeTitle:$scope.vm.knowledge,pageSize:$scope.vm.pageSize,index:(index-1)*$scope.vm.pageSize},function(data){initChatPageConfigDialog(),0==data.data.total&&(layer.msg("查询记录为空"),$scope.vm.knowledge=""),$scope.vm.listKnoData=data.data.objs,$scope.vm.listKnoDataTotal=data.data.total,$scope.vm.paginationConf1={currentPage:index,totalItems:data.data.total,pageSize:$scope.vm.pageSize,pagesLength:8},$scope.$apply()},function(){layer.msg("请求失败")})}function deleteKnowledge(){if(0==$scope.vm.deleteIds)return void layer.msg("请选择要删除的知识！");ngDialog.openConfirm({template:"/static/admin/deleteDialog.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){1===e&&httpRequestPost("/api/application/hotQuestion/deleteHotQuestionByIds",{applicationId:$scope.vm.applicationId,ids:$scope.vm.deleteIds},function(data){10013==data.status?(initChatPageConfig(),$scope.vm.selectAllCheck=!1,$state.reload(),layer.msg("删除成功")):layer.msg("删除失败")},function(){layer.msg("请求失败")})}})}function findHotQuestion(){""==$scope.vm.hotQuestionTitle||null==$scope.vm.hotQuestionTitle?getData(1):httpRequestPost("/api/application/hotQuestion/findHotQuestion",{hotQuestionTitle:$scope.vm.hotQuestionTitle,applicationId:$scope.vm.applicationId},function(data){if(10005==data.status)return $scope.vm.listData="",$scope.vm.listDataTotal=0,$scope.$apply(),layer.msg("没有查询到记录!"),$scope.vm.listData=[],void($scope.vm.listDataTotal=0);$scope.vm.listData=data.data.hotQuestionList,$scope.vm.listDataTotal=data.data.total,$scope.$apply()},function(){layer.msg("请求失败")})}function toTop(item){httpRequestPost("/api/application/hotQuestion/top",{applicationId:$scope.vm.applicationId,hotQuestionId:item.hotQuestionId,hotQuestionOrder:item.hotQuestionOrder},function(data){getData(1)},function(){layer.msg("请求失败")})}function move(item){httpRequestPost("/api/application/hotQuestion/moveUp",{applicationId:$scope.vm.applicationId,hotQuestionId:item.hotQuestionId,hotQuestionOrder:item.hotQuestionOrder},function(data){getData(1)},function(){layer.msg("请求失败")})}function down(item){httpRequestPost("/api/application/hotQuestion/moveDown",{applicationId:$scope.vm.applicationId,hotQuestionId:item.hotQuestionId,hotQuestionOrder:item.hotQuestionOrder},function(data){getData(1)},function(){layer.msg("请求失败")})}function addHotIssues(){ngDialog.openConfirm({template:"/static/myApplication/applicationConfig/chatPageConfigDialog.html",width:"660px",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){1===e?(httpRequestPost("/api/application/hotQuestion/batchAdd",{applicationId:$scope.vm.applicationId,userId:$scope.vm.userId,hotKnowledgeList:$scope.vm.seleceAddAll},function(data){getData(1),10012==data.status&&layer.msg("该知识已经存在,请重新添加!")},function(){layer.msg("请求失败")}),$scope.vm.selectAllCheck=!1,$scope.vm.selectAllCheckDialog=!1,$scope.vm.seleceAddAll=[],$scope.vm.listKnoData=[],$scope.vm.knowledge="",$scope.vm.listKnoDataTotal=0,$scope.vm.paginationConf1=""):($scope.vm.selectAllCheckDialog=!1,$scope.vm.seleceAddAll=[],$scope.vm.listKnoData=[],$scope.vm.knowledge="",$scope.vm.listKnoDataTotal=0,$scope.vm.paginationConf1="")}})}function initChatPageConfig(){$scope.vm.deleteIds=[],$scope.vm.selectAllCheck=!1}function initChatPageConfigDialog(){$scope.vm.seleceAddAll=[],$scope.vm.selectAllCheckDialog=!1}$scope.vm={listData:"",listKnoData:"",listDataTotal:"",pageSize:5,indexV:1,listKnoDataTotal:"",knowledgeId:"",knowledgeTitle:"",userId:$cookieStore.get("userId"),applicationId:$cookieStore.get("applicationId"),paginationConf:"",paginationConf1:"",deleteIds:[],selectAllCheck:!1,hotQuestionTitle:"",knowledge:"",listDataLength:"",selectAllCheckDialog:!1,seleceAddAll:[],getData:getData,addHotIssues:addHotIssues,toTop:toTop,move:move,down:down,deleteKnowledge:deleteKnowledge,selectAll:selectAll,selectSingle:selectSingle,findHotQuestion:findHotQuestion,findKnowledge:findKnowledge,selectAllDialog:selectAllDialog,selectSingleDialog:selectSingleDialog,deleteDialog:deleteDialog,setFlag:!1},getData(1);var timeout;$scope.$watch("vm.paginationConf.currentPage",function(current){current&&(timeout&&$timeout.cancel(timeout),timeout=$timeout(function(){initChatPageConfig(),getData(current)},100))},!0);var timeout2;$scope.$watch("vm.paginationConf1.currentPage",function(current){current&&(timeout2&&$timeout.cancel(timeout2),timeout2=$timeout(function(){initChatPageConfigDialog(),findKnowledge(current)},100))},!0)}]),angular.module("myApplicationSettingModule").controller("conceptCodeController",["$scope","localStorageService","$state","ngDialog","$cookieStore","$timeout","$compile","FileUploader","$window","$stateParams","$interval","$rootScope","$filter",function($scope,localStorageService,$state,ngDialog,$cookieStore,$timeout,$compile,FileUploader,$window,$stateParams,$interval,$rootScope,$filter){function getInterfaceList(){httpRequestPost("/webhook/interface/listEffectiveInterface",{},function(data){200==data.status?$scope.vm.interfaceList=data.data:layer.msg("加载接口失败！")},function(){layer.msg("加载接口失败！")})}function listConceptCodeData(index){httpRequestPost("/webhook/conceptCode/listConceptCodeByPage",{interfaceCode:$scope.vm.searchInterfaceCode,conceptName:$scope.vm.searchConceptName,index:(index-1)*$scope.vm.pageSize,pageSize:$scope.vm.pageSize},function(data){$scope.vm.conceptCodeData=data.data,$scope.vm.dataTotal=data.total,$scope.vm.paginationConf={currentPage:index,totalItems:data.total,pageSize:$scope.vm.pageSize,pagesLength:8},$scope.$apply()},function(){layer.msg("请求失败")})}function deleteConceptCode(conceptId){httpRequestPost("/webhook/conceptCode/delConceptCode",{conceptId:conceptId},function(data){200==data.status?listConceptCodeData(1):layer.msg("删除失败，请重新删除！")},function(){layer.msg("删除失败，请重新删除！")})}function batchDelete(){httpRequestPost("/webhook/conceptCode/batchDelConceptCode",{conceptIds:$scope.selectedList},function(data){200==data.status?listConceptCodeData(1):layer.msg("删除失败，请重新删除！")},function(){layer.msg("删除失败，请重新删除！")})}function addConceptCodeDialog(){$scope.vm.dialogTitle="新增概念编码";ngDialog.openConfirm({template:"/static/myApplication/serviceManagement/conceptCodeManageDialog.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){if(1===e){var allowSubmit=0;if(0==nullCheck($scope.vm.interfaceCode))return $("#interfaceAddError").html("请选择接口"),allowSubmit=0,!1;if($("#interfaceAddError").html(""),allowSubmit=1,0==lengthCheck($scope.vm.conceptName,0,50))return $("#nameAddError").html($scope.vm.nameNullOrBeyondLimit),allowSubmit=0,!1;if(httpRequestPostAsync("/webhook/conceptCode/checkConceptCode",{conceptName:$scope.vm.conceptName,interfaceCode:$scope.vm.interfaceCode},function(data){return 880==data.data?($("#nameAddError").html("概念名称已经存在！"),allowSubmit=0,!1):($("#nameAddError").html(""),0==lengthCheck($scope.vm.conceptCode,0,50)?($("#codeAddError").html($scope.vm.codeNullOrBeyondLimit),allowSubmit=0,!1):void httpRequestPostAsync("/webhook/conceptCode/checkConceptCode",{conceptCode:$scope.vm.conceptCode,interfaceCode:$scope.vm.interfaceCode},function(data){if(880==data.data)return $("#codeAddError").html("概念编码已经存在！"),allowSubmit=0,!1;$("#codeAddError").html(""),allowSubmit=1},function(){return $("#codeAddError").html("概念编码校验失败！"),allowSubmit=0,!1}))},function(){return $("#nameAddError").html("概念名称校验失败！"),allowSubmit=0,!1}),0==allowSubmit)return!1;httpRequestPostAsync("/webhook/conceptCode/addConceptCode",{conceptName:$scope.vm.conceptName,conceptCode:$scope.vm.conceptCode,interfaceCode:$scope.vm.interfaceCode},function(data){200==data.status?listConceptCodeData(1):layer.msg("添加失败，请重新添加！")},function(){layer.msg("添加失败，请重新添加！")}),$scope.vm.conceptName="",$scope.vm.conceptCode="",$scope.vm.interfaceCode=""}else $scope.vm.conceptName="",$scope.vm.conceptCode="",$scope.vm.interfaceCode=""}})}function editConceptCode(item){$scope.vm.dialogTitle="修改概念编码",$scope.vm.conceptId=item.conceptId,$scope.vm.conceptName=item.conceptName,$scope.vm.conceptCode=item.conceptCode,$scope.vm.interfaceCode=item.interfaceCode;ngDialog.openConfirm({template:"/static/myApplication/serviceManagement/conceptCodeManageDialog.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){if(1===e){var allowSubmit=0;if(0==nullCheck($scope.vm.interfaceCode))return $("#interfaceAddError").html("请选择接口"),allowSubmit=0,!1;if($("#interfaceAddError").html(""),allowSubmit=1,0==lengthCheck($scope.vm.conceptName,0,50))return $("#nameAddError").html($scope.vm.nameNullOrBeyondLimit),allowSubmit=0,!1;if(httpRequestPostAsync("/webhook/conceptCode/checkConceptCode",{conceptName:$scope.vm.conceptName,interfaceCode:$scope.vm.interfaceCode,conceptId:$scope.vm.conceptId},function(data){return 880==data.data?($("#nameAddError").html("概念名称已经存在！"),allowSubmit=0,!1):($("#nameAddError").html(""),0==lengthCheck($scope.vm.conceptCode,0,50)?($("#codeAddError").html($scope.vm.codeNullOrBeyondLimit),allowSubmit=0,!1):void httpRequestPostAsync("/webhook/conceptCode/checkConceptCode",{conceptCode:$scope.vm.conceptCode,interfaceCode:$scope.vm.interfaceCode,conceptId:$scope.vm.conceptId},function(data){if(880==data.data)return $("#codeAddError").html("概念编码已经存在！"),allowSubmit=0,!1;$("#codeAddError").html(""),allowSubmit=1},function(){return $("#codeAddError").html("概念编码校验失败！"),allowSubmit=0,!1}))},function(){return $("#nameAddError").html("概念名称校验失败！"),allowSubmit=0,!1}),0==allowSubmit)return!1;httpRequestPostAsync("/webhook/conceptCode/modifyConceptCode",{conceptName:$scope.vm.conceptName,conceptCode:$scope.vm.conceptCode,interfaceCode:$scope.vm.interfaceCode,conceptId:$scope.vm.conceptId},function(data){200==data.status?listConceptCodeData(1):layer.msg("修改失败，请重新修改！")},function(){layer.msg("修改失败，请重新修改！")}),$scope.vm.conceptName="",$scope.vm.conceptCode="",$scope.vm.interfaceCode="",$scope.vm.conceptId=""}else $scope.vm.conceptName="",$scope.vm.conceptCode="",$scope.vm.interfaceCode="",$scope.vm.conceptId=""}})}function batchUpload(){ngDialog.openConfirm({template:"/know_index/serviceManagement/batchUpload.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){listConceptCodeData($scope.vm.paginationConf.currentPage)}})&&$timeout(function(){initUpload("/webhook/conceptCode/batchImport")},100)}function downloadTemplate(){downloadFile("/webhook/conceptCode/downloadWithPath","","weatherPlace.xlsx")}function responseView(data){return null!=data&&200==data.status}function exportAll(){httpRequestPost("/webhook/conceptCode/batchExport",{interfaceCode:$scope.vm.interfaceCode},function(data){if(1==responseView(data)){for(var html="",i=0;i<data.exportFileNameList.length;i++)html+='<a href="/webhook/conceptCode/downloadWithPath?filePath='+data.filePath+"&fileName="+data.exportFileNameList[i]+'"><li title="'+data.exportFileNameList[i]+'"><p class="title"></p><p class="imgWrap"><img src="../images/excel.png"></p></li></a>';ngDialog.openConfirm({template:"/static/myApplication/serviceManagement/downloadList.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){}})&&$timeout(function(){$("#downloadList").append(html)},100)}})}function updateSelected(action,id){"add"==action&&-1==$scope.selectedList.indexOf(id)&&$scope.selectedList.push(id),"remove"==action&&-1!=$scope.selectedList.indexOf(id)&&$scope.selectedList.splice($scope.selectedList.indexOf(id),1)}function updateSelection($event,id){updateSelected($event.target.checked?"add":"remove",id)}function isSelected(id){return $scope.selectedList.indexOf(id)>=0}function selectAll($event){for(var checkbox=$event.target,action=checkbox.checked?"add":"remove",i=0;i<$scope.vm.conceptCodeData.length;i++){updateSelected(action,$scope.vm.conceptCodeData[i].conceptId)}}function isSelectedAll(){return $scope.selectedList.length===$scope.vm.conceptCodeData.length}$scope.vm={interfaceCode:"",searchInterfaceCode:"",interfaceList:[],conceptId:"",conceptName:"",searchConceptName:"",conceptCode:"",dialogTitle:"",editConceptCode:editConceptCode,deleteConceptCode:deleteConceptCode,addConceptCodeDialog:addConceptCodeDialog,listConceptCodeData:listConceptCodeData,batchDelete:batchDelete,batchUpload:batchUpload,exportAll:exportAll,downloadTemplate:downloadTemplate,allowSubmit:0,conceptCodeData:"",paginationConf:"",pageSize:5,dataTotal:"",nameNullOrBeyondLimit:"概念名不能为空或超过长度限制50",codeNullOrBeyondLimit:"概念编码不能为空或超过长度限制50",interfaceNull:"概念编码的接口不能为空"},getInterfaceList(),listConceptCodeData(1);var timeout;$scope.$watch("vm.paginationConf.currentPage",function(current){current&&(timeout&&$timeout.cancel(timeout),timeout=$timeout(function(){listConceptCodeData(current)},100))},!0),$scope.selectedList=[],$scope.updateSelection=updateSelection,$scope.selectAll=selectAll,$scope.isSelected=isSelected,$scope.isSelectedAll=isSelectedAll}]),angular.module("myApplicationSettingModule").controller("confingurationController",["$scope","$state","$stateParams","$cookieStore",function($scope,$state,$stateParams,$cookieStore){function addEmail(){var emailReg=/^([a-zA-Z0-9_])+@([a-zA-Z0-9_])+(.[a-zA-Z0-9_])+/;""==$scope.vm.email?layer.msg("请填写邮箱地址"):emailReg.test($scope.vm.email)?$scope.vm.addLine.unshift({alarmName:"预警邮箱",emailAddress:$scope.vm.email,addNum:1}):layer.msg("请填写正确的邮箱地址"),$scope.vm.email=""}function deleteEmail(index){$scope.vm.addLine.splice(index,1)}function save(){for(var email=[],len=$scope.vm.addLine.length,i=0;i<len;i++){var value=$(".email"+i).val();email.push(value);var emailReg=/^([a-zA-Z0-9_])+@([a-zA-Z0-9_])+(.[a-zA-Z0-9_])+/;""==value||null==value?$scope.vm.emailNull=1:""==value&&null==value||($scope.vm.emailNull=0),emailReg.test(value)?emailReg.test(value)&&($scope.vm.emailRegular=0):$scope.vm.emailRegular=1}var emailVal=email.join(";"),flowThreshold=$(".flowThreshold").val();""==flowThreshold?layer.msg("流量阈值不能为空"):1==$scope.vm.emailNull?layer.msg("预警邮箱不能为空"):1==$scope.vm.emailRegular?layer.msg("邮箱格式错误"):httpRequestPost("/api/application/FlowMonitorSetting/saveOrupdate",{applicationId:$scope.vm.applicationId,flowThreshold:flowThreshold,flowMonitorId:$scope.vm.flowMonitorId,email:emailVal},function(data){layer.msg("保存成功"),$state.reload()})}$scope.vm={applicationId:$cookieStore.get("applicationId"),addEmail:addEmail,deleteEmail:deleteEmail,save:save,addLine:"",flowThreshold:"",emailAddress:"",testValueOn:"",emailNull:"",emailRegular:"",concurrentRestrict:"",flowMonitorId:"",email:""};$cookieStore.get("applicationId");$scope.vm.addLine=[{}];for(var email=[],len=$scope.vm.addLine.length,i=0;i<len;i++){var value=$(".email"+i).val();email.push(value)}email.join(";");httpRequestPost("/api/application/FlowMonitorSetting/findOne",{applicationId:$scope.vm.applicationId},function(data){if(200==data.status&&null!=data.data){$scope.vm.flowThreshold=data.data.flowThreshold,$scope.vm.emailAddress=data.data.email,$scope.vm.flowMonitorId=data.data.flowMonitorId;var list=$scope.vm.emailAddress,listVal=list.split(";");$scope.vm.addLine.length=0;for(var i=0;i<listVal.length;i++)$scope.vm.addLine.push({alarmName:"预警邮箱",addNum:i+1,emailAddress:listVal[i]});$scope.$apply()}else 500==data.status&&layer.msg(data.data)})}]),angular.module("knowledgeManagementModule").controller("dimensionManageController",["$scope","localStorageService","$state","ngDialog","$timeout","$interval","$cookieStore",function($scope,localStorageService,$state,ngDialog,$timeout,$interval,$cookieStore){function getData(index){httpRequestPost("/api/application/dimension/listDimension",{index:(index-1)*$scope.vm.pageSize,pageSize:$scope.vm.pageSize,userId:$scope.vm.userId,applicationId:$scope.vm.applicationId,dimensionParentId:0},function(data){if(10005==data.status)return void layer.msg("查询到记录为空！");$scope.vm.listData=data.data.dimensionList,$scope.vm.listDataTotal=data.data.total,$scope.vm.paginationConf={currentPage:index,totalItems:data.data.total,pageSize:$scope.vm.pageSize,pagesLength:8},$scope.$apply()},function(){layer.msg("请求失败")})}function deleteDimension(dimensionId){ngDialog.openConfirm({template:"/static/admin/deleteDialog.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){1===e&&httpRequestPost("/api/application/dimension/deleteById",{applicationId:$scope.vm.applicationId,dimensionId:dimensionId},function(data){1e4==data.status&&layer.msg("存在知识使用该维度，请修改后删除"),10013==data.status&&(getData(1),layer.msg("维度删除成功!"))},function(){layer.msg("请求失败")})}})}function deleteItem(item){httpRequestPost("/api/application/dimension/deleteChildDimensionById",{dimensionId:item.dimensionId},function(data){$scope.vm.oldDimension.remove(item)},function(){layer.msg("请求失败")})}function findDimension(){""==$scope.vm.getDimension||null==$scope.vm.getDimension?getData(1):httpRequestPost("/api/application/dimension/findByDimensionName",{dimensionName:$scope.vm.getDimension,applicationId:$scope.vm.applicationId,dimensionParentId:0},function(data){if(10005==data.status)return $scope.vm.listData="",$scope.vm.listDataTotal=0,layer.msg("没有查询到记录!"),void $scope.$apply();$scope.vm.listData=data.data.dimensionList,$scope.vm.listDataTotal=data.data.total,$scope.$apply()},function(){layer.msg("请求失败")})}function verifyRelease(){return null==$scope.vm.dimension||""==$scope.vm.dimension?(layer.msg("维度名称不能为空!"),$scope.vm.allowSubmit=0,0):$scope.vm.dimension.length>50?(layer.msg("维度名称长度不能超过50个字符!"),$scope.vm.allowSubmit=0,0):0==$scope.vm.newDimensions.length?(layer.msg("请至少添加一个维度表示!"),$scope.vm.allowSubmit=0,0):1}function addDimension(){ngDialog.openConfirm({template:"/static/myApplication/applicationConfig/dimensionManageDialog.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){1===e?($scope.vm.allowSubmit&&httpRequestPost("/api/application/dimension/addDimension",{applicationId:$scope.vm.applicationId,userId:$scope.vm.userId,dimensionName:$scope.vm.dimension,dimensionStatusId:$scope.vm.switchTurn,dimensionParentId:0,dimensionNameArray:$scope.vm.newDimensions},function(data){10002==data.status?layer.msg("维度名称重复，请重新添加！"):(layer.msg("维度添加成功！"),getData(1))},function(){layer.msg("请求失败")}),$scope.vm.newDimensions=[],$scope.vm.dimension="",$scope.vm.getDimensionVal=""):($scope.vm.newDimensions=[],$scope.vm.dimension="",$scope.vm.getDimensionVal="")}})}function check(){return null==$scope.vm.dimensionName||""==$scope.vm.dimensionName?(layer.msg("维度名称不能为空!"),$scope.vm.allowSubmit=0,0):$scope.vm.dimensionName.length>50?(layer.msg("维度名称长度不能超过50个字符!"),$scope.vm.allowSubmit=0,0):1}function editDimension(data){$scope.vm.applicationId=data.applicationId,$scope.vm.dimensionName=data.dimensionName,$scope.vm.dimensionId=data.dimensionId,angular.forEach(data.dimensionChildList,function(data1){var obj={};obj.dimensionName=data1.dimensionName,obj.dimensionId=data1.dimensionId,$scope.vm.oldDimension.push(obj),$scope.vm.oldDimensionName.push(data1.dimensionName)});ngDialog.openConfirm({template:"/static/myApplication/applicationConfig/dimensionManageDialog2.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){1===e?($scope.vm.allowSubmit&&httpRequestPost("/api/application/dimension/updateDimensionById",{dimensionName:$scope.vm.dimensionName,userId:$scope.vm.userId,applicationId:$scope.vm.applicationId,dimensionId:$scope.vm.dimensionId,dimensionStatusId:$scope.vm.switchTurn,dimensionNameArray:$scope.vm.newDimensions,dimensionParentId:0},function(data){if(10002==data.status)return void layer.msg("该维度已经存在，请重新编辑!");getData(1),layer.msg("维度修改成功!")},function(){layer.msg("请求失败")}),$scope.vm.newDimensions=[],$scope.vm.oldDimension=[]):($scope.vm.oldDimension=[],$scope.vm.newDimensions=[])}})}function savePro(vm,arr){return arr.length>0&&-1!=arr.indexOf(vm)?void layer.msg("该维度表示已经存在，请重新添加"):-1!=$scope.vm.oldDimensionName.indexOf(vm)?void layer.msg("该维度表示已经存在，请重新添加!"):0==vm.length?void layer.msg("请添加维度表示!"):(arr.indexOf(vm)&&arr.push(vm),$scope.vm.getDimensionVal="",void($scope.vm.dimensionVal=""))}$scope.vm={addDimension:addDimension,editDimension:editDimension,pageSize:5,listData:"",listDataTotal:"",deleteDimension:deleteDimension,deleteItem:deleteItem,findDimension:findDimension,getData:getData,savePro:savePro,verifyRelease:verifyRelease,check:check,allowSubmit:1,userId:$cookieStore.get("userId"),applicationId:$cookieStore.get("applicationId"),paginationConf:"",switchTurn:10001,newDimensions:[],getDimensionVal:"",getDimension:"",dimension:"",dimensionVal:"",dimensionName:"",dimensionStatusId:"",dimensionParentId:"",dimensionId:"",dimensionNameArray:[],dimensionUpdateNameArray:[],dimensionIdArray:[],oldDimension:[],oldDimensionName:[]},getData(1);var timeout;$scope.$watch("vm.paginationConf.currentPage",function(current){current&&(timeout&&$timeout.cancel(timeout),timeout=$timeout(function(){getData(current)},100))},!0)}]),angular.module("myApplicationSettingModule").controller("errorSettingController",["$scope","$state","$stateParams","$cookieStore",function($scope,$state,$stateParams,$cookieStore){function errorSave(){$scope.vm.errorSettingNum<=2?layer.msg("错误提示错误数量不小于2次"):httpRequestPost("/api/application/errorSetting/save ",{errorSettingId:$scope.vm.errorSettingId,applicationId:$scope.vm.applicationId,errorSettingNum:$scope.vm.errorSettingNum,errorSettingMsg:$scope.vm.errorSettingMsg,secondErrorSettingMsg:$scope.vm.secondErrorSettingMsg},function(data){200==data.status&&(layer.msg(data.data),$scope.$apply(),$state.reload())})}$scope.vm={applicationId:$cookieStore.get("applicationId"),errorSettingNum:"",errorSettingMsg:"",errorSettingId:"",secondErrorSettingMsg:"",errorSave:errorSave},httpRequestPost("/api/application/errorSetting/findOne",{applicationId:$scope.vm.applicationId},function(data){200==data.status&&null!=data.data&&null!=data.data&&($scope.vm.errorSettingNum=data.data.errorSettingNum,$scope.vm.errorSettingMsg=data.data.errorSettingMsg,$scope.vm.errorSettingId=data.data.errorSettingId,$scope.vm.secondErrorSettingMsg=data.data.secondErrorSettingMsg,$scope.$apply())})}]),angular.module("myApplicationSettingModule").controller("interfaceController",["$scope","localStorageService","$state","ngDialog","$cookieStore","$timeout","$compile","FileUploader","$window","$stateParams","$interval","$rootScope","$filter",function($scope,localStorageService,$state,ngDialog,$cookieStore,$timeout,$compile,FileUploader,$window,$stateParams,$interval,$rootScope,$filter){function listInterfaceData(index){httpRequestPost("/webhook/interface/listInterfaceByPage",{interfaceName:$scope.vm.searchInterfaceName,index:(index-1)*$scope.vm.pageSize,pageSize:$scope.vm.pageSize},function(data){$scope.vm.interfaceData=data.data,$scope.vm.dataTotal=data.total,$scope.vm.paginationConf={currentPage:index,totalItems:data.total,pageSize:$scope.vm.pageSize,pagesLength:8},$scope.$apply()},function(){layer.msg("请求失败")})}function deleteInterface(interfaceCode){httpRequestPost("/webhook/interface/del",{interfaceCode:interfaceCode},function(data){200==data.status?listInterfaceData(1):layer.msg("删除失败，请重新删除！")},function(){layer.msg("删除失败，请重新删除！")})}function verifyInterface(){if(null==$scope.vm.interfaceName||""==$scope.vm.interfaceName)return layer.msg("接口名称不能为空!"),0;if(null==$scope.vm.interfaceCode||""==$scope.vm.interfaceCode)return layer.msg("接口编码不能为空!"),0;if(null==$scope.vm.interfaceUrl||""==$scope.vm.interfaceUrl)return layer.msg("接口地址不能为空!"),0;if(null==$scope.vm.interfaceFormat||""==$scope.vm.interfaceFormat)return layer.msg("接口返回的数据格式不能为空!"),0;if(null==$scope.vm.requestType||""==$scope.vm.requestType)return layer.msg("接口请求的方式不能为空!"),0;if(null==$scope.vm.categoryName||""==$scope.vm.categoryName)return layer.msg("接口所属分类不能为空!"),0;var check=!0;return angular.forEach($scope.vm.interfaceParamData,function(param,index){null!=param.paramAsk&&""!=param.paramAsk||(layer.msg("接口的参数反问不能为空！"),check=!1),null!=param.conceptName&&""!=param.conceptName||(layer.msg("接口的参数对应的概念库名称不能为空！"),check=!1),null!=param.paramType&&""!=param.paramType||(layer.msg("接口的参数类型不能为空！"),check=!1),null!=param.paramName&&""!=param.paramName||(layer.msg("接口的参数名称不能为空！"),check=!1),param.paramIf?param.paramIf=1:param.paramIf=0}),check?1:0}function addInterfaceDialog(){$scope.vm.dialogTitle="新增接口";ngDialog.openConfirm({template:"/static/myApplication/serviceManagement/interfaceDialog.html",scope:$scope,width:600,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){1===e?($scope.vm.jsonParam="",httpRequestPost("/webhook/interface/add",{interfaceCode:$scope.vm.interfaceCode,interfaceName:$scope.vm.interfaceName,interfaceDesc:$scope.vm.interfaceDesc,interfaceUrl:$scope.vm.interfaceUrl,interfaceFormat:$scope.vm.interfaceFormat,requestType:$scope.vm.requestType,requestExample:$scope.vm.requestExample,applicationId:0,categoryName:$scope.vm.categoryName,interfaceKey:$scope.vm.interfaceKey,interfaceParamses:$scope.vm.interfaceParamData,responseExample:$scope.vm.responseExample},function(data){200==data.status?listInterfaceData(1):layer.msg("添加失败，请重新添加！"),initDialog()},function(){layer.msg("添加失败，请重新添加！"),initDialog()})):initDialog()}})}function initDialog(){$scope.vm.interfaceCode="",$scope.vm.interfaceName="",$scope.vm.interfaceDesc="",$scope.vm.interfaceUrl="",$scope.vm.interfaceFormat="",$scope.vm.requestType="",$scope.vm.requestExample="",$scope.vm.categoryName="",$scope.vm.interfaceKey="",$scope.vm.responseExample="",$scope.vm.interfaceId="",$scope.vm.interfaceParamData=[]}function editInterface(item){$scope.vm.dialogTitle="修改接口信息",$scope.vm.interfaceCode=item.interfaceCode,$scope.vm.interfaceName=item.interfaceName,$scope.vm.interfaceDesc=item.interfaceDesc,$scope.vm.interfaceUrl=item.interfaceUrl,$scope.vm.interfaceFormat=item.interfaceFormat,$scope.vm.requestType=item.requestType,$scope.vm.requestExample=item.requestExample,$scope.vm.categoryName=item.categoryName,$scope.vm.interfaceKey=item.interfaceKey,$scope.vm.responseExample=item.responseExample,$scope.vm.interfaceId=item.interfaceId,httpRequestPost("/webhook/interface/searchParam",{interfaceCode:$scope.vm.interfaceCode},function(data){if(200==data.status){$scope.vm.interfaceParamData=data.data,angular.forEach($scope.vm.interfaceParamData,function(param,index){1==param.paramIf?param.paramIf=!0:param.paramIf=!1});ngDialog.openConfirm({template:"/static/myApplication/serviceManagement/interfaceDialog.html",scope:$scope,width:600,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){1===e?httpRequestPost("/webhook/interface/modify",{interfaceId:$scope.vm.interfaceId,interfaceCode:$scope.vm.interfaceCode,interfaceName:$scope.vm.interfaceName,interfaceDesc:$scope.vm.interfaceDesc,interfaceUrl:$scope.vm.interfaceUrl,interfaceFormat:$scope.vm.interfaceFormat,requestType:$scope.vm.requestType,requestExample:$scope.vm.requestExample,applicationId:0,categoryName:$scope.vm.categoryName,interfaceKey:$scope.vm.interfaceKey,interfaceParamses:$scope.vm.interfaceParamData,responseExample:$scope.vm.responseExample},function(data){200==data.status?listInterfaceData(1):layer.msg("修改失败，请重新修改！"),initDialog()},function(){layer.msg("修改失败，请重新修改！"),initDialog()}):initDialog()}})}else layer.msg("加载接口参数失败！")},function(){layer.msg("加载接口参数失败！")})}function addRow(){var newParam={};newParam.paramName="",newParam.paramType="string",newParam.paramDesc="",newParam.paramAsk="",newParam.paramIf=0,newParam.conceptName="",$scope.vm.interfaceParamData.push(newParam)}function deleteRow(){null==$scope.vm.tableRow?layer.msg("请先选择要删除的行"):($scope.vm.interfaceParamData.splice($scope.vm.tableRow,1),$scope.vm.tableRow=null)}function tableChange(row,col,val){}function batchUpload(){ngDialog.openConfirm({template:"/static/myApplication/serviceManagement/batchUpload.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){listInterfaceData($scope.vm.paginationConf.currentPage)}})&&$timeout(function(){initUpload("/webhook/interface/batchImport")},100)}function downloadTemplate(){downloadFile("/webhook/interface/downloadWithPath","","interface.xlsx")}function responseView(data){return null!=data&&200==data.status}function exportAll(){httpRequestPost("/webhook/interface/batchExport",{interfaceCode:$scope.vm.interfaceCode},function(data){if(1==responseView(data)){for(var html="",i=0;i<data.exportFileNameList.length;i++)html+='<a href="/webhook/interface/downloadWithPath?filePath='+data.filePath+"&fileName="+data.exportFileNameList[i]+'"><li title="'+data.exportFileNameList[i]+'"><p class="title"></p><p class="imgWrap"><img src="../images/excel.png"></p></li></a>';ngDialog.openConfirm({template:"/know_index/serviceManagement/downloadList.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){}})&&$timeout(function(){$("#downloadList").append(html)},100)}})}$scope.vm={searchInterfaceName:"",interfaceCode:"",interfaceId:"",interfaceName:"",interfaceDesc:"",interfaceUrl:"",interfaceFormat:"",requestType:"",requestExample:"",applicationId:"",categoryName:"",interfaceKey:"",responseExample:"",interfaceParamData:[],tableRow:"",tableColumn:"",addRow:addRow,deleteRow:deleteRow,tableChange:tableChange,dialogTitle:"",allowSubmit:1,editInterface:editInterface,deleteInterface:deleteInterface,addInterfaceDialog:addInterfaceDialog,listInterfaceData:listInterfaceData,verifyInterface:verifyInterface,batchUpload:batchUpload,exportAll:exportAll,downloadTemplate:downloadTemplate,interfaceData:"",paginationConf:"",pageSize:5,dataTotal:""},listInterfaceData(1);var timeout;$scope.$watch("vm.paginationConf.currentPage",function(current){current&&(timeout&&$timeout.cancel(timeout),timeout=$timeout(function(){listInterfaceData(current)},100))},!0)}]).directive("checkInterfaceName",function($http){return{require:"ngModel",link:function(scope,ele,attrs,c){scope.$watch(attrs.ngModel,function(n){n&&httpRequestPost("/webhook/interface/checkInterface",{interfaceName:scope.vm.interfaceName,interfaceId:scope.vm.interfaceId},function(data){data.data?(c.$setValidity("unique",!0),scope.vm.allowSubmit=1):(c.$setValidity("unique",!1),scope.vm.allowSubmit=0)},function(){c.$setValidity("unique",!1),scope.vm.allowSubmit=0})})}}}).directive("checkInterfaceCode",function($http){return{require:"ngModel",link:function(scope,ele,attrs,c){scope.$watch(attrs.ngModel,function(n){n&&httpRequestPost("/webhook/interface/checkInterface",{interfaceCode:scope.vm.interfaceCode,interfaceId:scope.vm.interfaceId},function(data){data.data?(c.$setValidity("unique",!0),scope.vm.allowSubmit=1):(c.$setValidity("unique",!1),scope.vm.allowSubmit=0)},function(){c.$setValidity("unique",!1),scope.vm.allowSubmit=0})})}}}),angular.module("myApplicationSettingModule").controller("nodeManageController",["$scope","localStorageService","$state","ngDialog","$cookieStore","$timeout",function($scope,localStorageService,$state,ngDialog,$cookieStore,$timeout){function listNodeData(index){httpRequestPost("/api/application/node/listNodeByPage",{applicationId:$scope.vm.applicationId,index:(index-1)*$scope.vm.pageSize,pageSize:$scope.vm.pageSize},function(data){$scope.vm.nodeData=data.data,$scope.vm.dataTotal=data.total,$scope.vm.paginationConf={currentPage:index,totalItems:data.total,pageSize:$scope.vm.pageSize,pagesLength:8},$scope.$apply()},function(){layer.msg("请求失败")})}function findNodeInfo(nodeCode){httpRequestPostAsync("/api/application/node/findNodeInfo",{nodeCode:nodeCode},function(data){200==data.status?($scope.vm.nodeId=data.data.nodeId,$scope.vm.nodeAccessIp=data.data.nodeAccessIp,$scope.vm.statusId=data.data.statusId,$scope.vm.nodeType=data.data.nodeType,$scope.vm.nodeCode=data.data.nodeCode,$scope.vm.nodes=data.data.nodes):layer.msg("查询节点信息失败")},function(){layer.msg("请求失败")})}function editNode(nodeCode){if(findNodeInfo(nodeCode),60002==$scope.vm.statusId)return void layer.msg("当前节点正在使用中!");ngDialog.openConfirm({template:"/static/myApplication/applicationRelease/NodeManageDialog.html",width:"550px",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){1===e&&($scope.vm.allowSubmit?(angular.forEach($scope.vm.nodes,function(data1){var obj={};obj.nodeId=data1.nodeId,obj.nodeAccessIp=data1.nodeAccessIp,obj.nodeCode=data1.nodeCode,$scope.vm.newNodes.push(obj)}),angular.forEach($scope.vm.deleteNodes,function(data1){var obj={};obj.nodeId=data1.nodeId,obj.nodeAccessIp=data1.nodeAccessIp,obj.nodeCode=data1.nodeCode,$scope.vm.delNodes.push(obj)}),httpRequestPost("/api/application/node/editNode",{nodeId:$scope.vm.nodeId,nodeAccessIp:$scope.vm.nodeAccessIp,statusId:$scope.vm.statusId,nodeType:$scope.vm.nodeType,nodes:$scope.vm.newNodes,nodeCreateId:$scope.vm.nodeCreateId,nodeCode:$scope.vm.nodeCode,deleteNodes:$scope.vm.delNodes,userId:$scope.vm.nodeCreateId},function(data){200==data.status?(layer.msg("编辑成功"),listNodeData(1)):layer.msg("编辑出错了")},function(){layer.msg("请求失败")})):layer.msg("访问地址或者节点编号不合法！")),initNodeInput()}})}function addNode(){ngDialog.openConfirm({template:"/static/myApplication/applicationRelease/NodeManageDialog.html",width:"550px",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){1===e&&($scope.vm.allowSubmit?(angular.forEach($scope.vm.nodes,function(data1){var obj={};obj.nodeId=data1.nodeId,obj.nodeAccessIp=data1.nodeAccessIp,$scope.vm.newNodes.push(obj)}),httpRequestPost("/api/application/node/addNode",{nodeId:""==$scope.vm.nodeId?0:$scope.vm.nodeId,nodeAccessIp:$scope.vm.nodeAccessIp,statusId:$scope.vm.statusId,nodeType:$scope.vm.nodeType,nodes:$scope.vm.newNodes,nodeCreateId:$scope.vm.nodeCreateId,userId:$scope.vm.nodeCreateId},function(data){200==data.status?(layer.msg("添加成功"),listNodeData(1)):layer.msg("添加出错了！")},function(){layer.msg("添加失败")})):layer.msg("访问地址或者节点编号不合法！")),initNodeInput()}})}function initNodeInput(){$scope.vm.nodeType=$scope.vm.typeData[0].statusId,$scope.vm.channelName="",$scope.vm.nodeId="",$scope.vm.nodeAccessIp="",$scope.vm.nodes=[],$scope.vm.subNode="",$scope.vm.subNodeAccessIp="",$scope.vm.nodeCode=""}function listTypeData(){httpRequestPost("/api/application/node/findNodeType",{},function(data){200==data.status?($scope.vm.typeData=data.data,$scope.$apply()):layer.msg("查询节点类型失败")},function(){layer.msg("请求失败")})}function listStatusData(){httpRequestPost("/api/application/node/findNodeStatus",{},function(data){200==data.status?($scope.vm.statusData=data.data,$scope.$apply()):layer.msg("查询节点类型失败")},function(){layer.msg("请求失败")})}function disabledAndEnabledNode(nodeCode,operator){layer.confirm("确认"+operator+"？",{btn:["确认","取消"],shade:!1},function(index){layer.close(index),httpRequestPost("/api/application/node/disabledAndEnabledNode",{nodeCode:nodeCode},function(data){200==data.status?(layer.msg(data.info),listNodeData(1)):layer.msg("操作失败")},function(){layer.msg("请求失败")})},function(){})}function deleteNode(nodeCode){layer.confirm("确认删除？",{btn:["确认","取消"],shade:!1},function(index){layer.close(index),httpRequestPost("/api/application/node/deleteNode",{nodeCode:nodeCode},function(data){200==data.status?(layer.msg("删除节点成功"),listNodeData(1)):layer.msg("删除节点失败")},function(){layer.msg("请求失败")})},function(){})}function removeOldSubNode(node){null!=node&&null!=node.nodeCode&&$scope.vm.deleteNodes.push(node)}function addSubNode(nodeId,nodeAccessIp){if($scope.vm.nodeAccessIp==nodeAccessIp)return layer.msg("子节点IP与集群节点IP重复了"),void($scope.vm.allowSubmit=0);var obj={};obj.nodeId=nodeId,obj.nodeAccessIp=nodeAccessIp;var repeatFlag=!1;null!=nodeId&&null!=nodeAccessIp&&""!=nodeId&&""!=nodeAccessIp?(angular.forEach($scope.vm.nodes,function(data1){data1.nodeId==nodeId&&data1.nodeAccessIp==nodeAccessIp&&(repeatFlag=!0)}),repeatFlag?layer.msg("重复添加了"):httpRequestPost("/api/application/node/checkNode",{nodeId:nodeId,nodeAccessIp:nodeAccessIp},function(data){200==data.status?($scope.vm.nodes.push(obj),$scope.vm.subNodeId="",$scope.vm.subNodeAccessIp="",$scope.vm.allowSubmit=1,$scope.$apply()):($scope.vm.allowSubmit=0,layer.msg(data.info))},function(){layer.msg("校验失败")})):layer.msg("节点信息不能为空")}$scope.vm={applicationId:$cookieStore.get("applicationId"),nodeData:"",paginationConf:"",pageSize:5,dataTotal:"",nodeCode:"",nodeId:"",nodeAccessIp:"",statusId:"",nodeType:"",nodes:[],newNodes:[],deleteNodes:[],delNodes:[],subNode:"",subNodeAccessIp:"",nodeCreateId:$cookieStore.get("userId"),statusData:"",typeData:"",addNode:addNode,editNode:editNode,disabledAndEnabledNode:disabledAndEnabledNode,deleteNode:deleteNode,findNodeInfo:findNodeInfo,listTypeData:listTypeData,listStatusData:listStatusData,addSubNode:addSubNode,removeOldSubNode:removeOldSubNode,dialogTitle:"",allowSubmit:0,errorTip:"",errorNodeIdTip:""},listTypeData(),listStatusData(),listNodeData(1);var timeout;$scope.$watch("vm.paginationConf.currentPage",function(current){current&&(timeout&&$timeout.cancel(timeout),timeout=$timeout(function(){listNodeData(current)},100))},!0)}]).directive("checkIp",function($http){return{require:"ngModel",link:function(scope,ele,attrs,c){scope.$watch(attrs.ngModel,function(n){n&&$http({method:"POST",url:"/api/application/node/checkNode",data:{nodeAccessIp:scope.vm.nodeAccessIp,nodeCode:scope.vm.nodeCode}}).success(function(data){200==data.status?(c.$setValidity("unique",!0),scope.vm.allowSubmit=1):(c.$setValidity("unique",!1),scope.vm.allowSubmit=0,scope.vm.errorTip=data.info)}).error(function(data){c.$setValidity("unique",!1),scope.vm.allowSubmit=0})})}}}).directive("checkNode",function($http){return{require:"ngModel",link:function(scope,ele,attrs,c){scope.$watch(attrs.ngModel,function(n){n&&$http({method:"POST",url:"/api/application/node/checkNode",data:{nodeId:scope.vm.nodeId,nodeAccessIp:scope.vm.nodeAccessIp,nodeCode:scope.vm.nodeCode}}).success(function(data){200==data.status?(c.$setValidity("unique",!0),scope.vm.allowSubmit=1):(c.$setValidity("unique",!1),scope.vm.allowSubmit=0,scope.vm.errorNodeIdTip=data.info)}).error(function(data){c.$setValidity("unique",!1),scope.vm.allowSubmit=0})})}}}),angular.module("myApplicationModule").controller("relationalCatalogController",["$scope","localStorageService","$timeout","$state","$stateParams","ngDialog","$cookieStore","$interval",function($scope,localStorageService,$timeout,$state,$stateParams,ngDialog,$cookieStore,$interval){function autoHeight(){var $win=$(window),winHeight=.75*$win.height();$scope.vm.winHeight=winHeight+5,$(".libraryFt").attr("style","width: 450px;height: "+winHeight+"px;overflow-y: auto;background: #fff;float: left;"),$(".libraryRth").attr("style","width: 720px;height: "+winHeight+"px;overflow-y: auto;background: #fff;float: right;padding: 30px;")}function searchNode(suggestion){var currentNodeId=suggestion.data,firstNode=$(".aside-navs").find("i").filter(":eq(0)");"0% 0%"==$(firstNode).css("backgroundPosition")?appendTree(firstNode):null==$(firstNode).parent().parent().next()&&appendTree(firstNode),$(firstNode).attr("data-option")==currentNodeId?(clearColor(),$scope.vm.knowledgeBotVal=$(firstNode).next().html(),$scope.vm.botSelectValue=$(firstNode).next().attr("data-option"),$scope.vm.botSelectType=$(firstNode).next().attr("type-option"),$scope.vm.categoryAttributeName=$(firstNode).next().attr("node-option"),$(firstNode).next().attr("style","color:black;font-weight:bold;"),updateCreateMethod($scope.vm.knowledgeBotVal,$scope.vm.categoryAttributeName),disableAttributeType(),$scope.$apply()):recursion(suggestion,firstNode)}function recursion(suggestion,node){var list=$(".aside-navs").find("li"),flag=!1;$.each(list,function(index,value){if($(value).attr("data-option")==$(node).attr("data-option")){var currNode=$(value).find("i").filter(":eq(0)");if($(currNode).attr("data-option")==suggestion.data)return clearColor(),$scope.vm.knowledgeBotVal=$(currNode).next().html(),$scope.vm.botSelectValue=$(currNode).next().attr("data-option"),$scope.vm.botSelectType=$(currNode).next().attr("type-option"),$scope.vm.categoryAttributeName=$(currNode).next().attr("node-option"),$(currNode).next().attr("style","color:black;font-weight:bold;"),updateCreateMethod($scope.vm.knowledgeBotVal,$scope.vm.categoryAttributeName),disableAttributeType(),$scope.$apply(),flag=!0,!1;if("0% 0%"==$(currNode).css("backgroundPosition")?appendTree(currNode):null==$(currNode).parent().parent().next()&&appendTree(currNode),1==flag)return!1;recursion(suggestion,currNode)}})}function location(suggestion){var currentNodeId=suggestion.data,initHeight=0,sum=$(".aside-navs").find("i").length;$.each($(".aside-navs").find("i"),function(index,value){if($(value).attr("data-option")==currentNodeId){var lib=$(".libraryFt"),scrollHeight=0;lib.length>0&&(scrollHeight=lib[0].scrollHeight);var offset=0;return scrollHeight-100>0&&(offset=(initHeight+1)/sum*(scrollHeight-100)),$(".libraryFt").animate({scrollTop:offset+"px"},800),!1}initHeight++})}function locationFlag(suggestion){var currentNodeId=suggestion.data,flag=!1,sum=$(".aside-navs").find("i").length;return $.each($(".aside-navs").find("i"),function(index,value){if($(value).attr("data-option")==currentNodeId){var lib=$(".libraryFt"),scrollHeight=0;return lib.length>0&&(scrollHeight=lib[0].scrollHeight),sum>=10&&scrollHeight>=$scope.vm.winHeight?flag=!0:sum<10&&(flag=!0),!1}}),flag}function initBot(){$(".aside-navs").empty(),httpRequestPost("/api/ms/modeling/category/listbycategorypid",{categoryApplicationId:categoryApplicationId,categoryPid:"root"},function(data){for(var html='<ul class="menus show">',i=0;null!=data.data&&i<data.data.length;i++)html+='<li data-option="'+data.data[i].categoryPid+'"><div class="slide-a"><a class="ellipsis" href="javascript:;" '+categoryDescribeView(data.data[i].categoryDescribe)+"><i "+styleSwitch(data.data[i].categoryTypeId,data.data[i].categoryLeaf,data.data[i].categoryAttributeName)+' data-option="'+data.data[i].categoryId+'"></i><span '+nodeStyleSwitch(data.data[i].categoryAttributeName)+' node-option="'+data.data[i].categoryAttributeName+'" type-option="'+data.data[i].categoryTypeId+'" data-option="'+data.data[i].categoryId+'" title="'+data.data[i].categoryName+'">'+subStringWithTail(data.data[i].categoryName,10,"...")+'</span>&nbsp;<p class="treeEdit" bot-info='+toCategoryString(data.data[i])+'><img class="edit" src="images/bot-edit.png"/><img class="delete" style="width: 12px;" src="images/detel.png"/></p></a></div></li>';html+="</ul>",$(".aside-navs").append(html);var firstNode=$(".aside-navs").find("i").filter(":eq(0)");"0% 0%"==$(firstNode).css("backgroundPosition")?appendTree(firstNode):null==$(firstNode).parent().parent().next()&&appendTree(firstNode)},function(){})}function updateCreateMethod(knowledgeBotVal,categoryAttributeName){"node"==categoryAttributeName?$("#createMethod").html("新建关系到"+knowledgeBotVal+"下面"):"edge"==categoryAttributeName&&$("#createMethod").html("新建节点到"+knowledgeBotVal+"下面")}function editBot(){ngDialog.openConfirm({template:"/static/myApplication/applicationDevelopment/editCategory.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){if(1===e){if(0==lengthCheck($("#categoryName").val(),0,50))return $("#editErrorView").html($scope.vm.categoryNameNullOrBeyondLimit),!1;if(0==repeatCheck("#editErrorView",1))return!1;if(isHtmlLabel($("#categoryName").val()))return $("#editErrorView").html($scope.vm.notContainHtmlLabel),!1;if(1==nullCheck($("#categoryDescribe").val())){if(0==lengthCheck($("#categoryDescribe").val(),0,2e3))return $("#categoryDescribeError").html($scope.vm.categoryDescribeBeyondLimit),!1;if(isHtmlLabel($("#categoryDescribe").val()))return $("#categoryDescribeError").html($scope.vm.notContainHtmlLabel),!1;$scope.vm.categoryDescribe=$("#categoryDescribe").val()}httpRequestPost("/api/ms/modeling/category/updatebycategoryid",{categoryId:$scope.vm.categoryId,categoryApplicationId:$scope.vm.categoryApplicationId,applicationId:categoryApplicationId,categoryPid:$scope.vm.categoryPid,categoryAttributeName:$scope.vm.categoryAttributeName,categoryName:$("#categoryName").val().trim(),categoryTypeId:$("#categoryTypeId").val(),categoryModifierId:categoryModifierId,categoryDescribe:$scope.vm.categoryDescribe.trim(),categorySceneId:categorySceneId,categoryLeaf:$scope.vm.categoryLeaf},function(data){1==responseView(data)&&reloadBot(data,2)},function(err){})}$scope.vm.categoryDescribe="",$scope.vm.categoryAttributeName="edge"}})&&$timeout(function(){$("#categoryName").blur(function(){0==lengthCheck($("#categoryName").val(),0,50)?$("#editErrorView").html($scope.vm.categoryNameNullOrBeyondLimit):($("#editErrorView").html(""),repeatCheck("#editErrorView",1))}),$.each($("#categoryTypeId").find("option"),function(index,value){"edge"==$scope.vm.categoryAttributeName?($(value).attr("disabled",null),$(value).attr("style","")):($(value).val()==$scope.vm.categoryTypeId)>0?($("#categoryTypeId").val($scope.vm.categoryTypeId),$(value).attr("disabled",null),$(value).attr("style","")):($(value).attr("disabled","disabled"),$(value).attr("style","background-color: lightgrey"))})},100)}function deleteBot(){ngDialog.openConfirm({template:"/static/myApplication/applicationDevelopment/deleteCategory.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){1===e&&httpRequestPost("/api/ms/modeling/category/deletebycategoryid",{categoryId:$scope.vm.categoryId,categoryApplicationId:$scope.vm.categoryApplicationId,categoryPid:$scope.vm.categoryPid,categoryLeaf:$scope.vm.categoryLeaf},function(data){1==responseView(data)&&reloadBot(data,1)},function(err){}),$scope.vm.categoryAttributeName="edge"}})}function appendTree(obj){var id=$(obj).attr("data-option"),that=$(obj);that.parent().parent().siblings().length?"0% 0%"==that.css("backgroundPosition")?(that.css("backgroundPosition","0% 100%"),that.parent().parent().next().slideDown()):(that.css("backgroundPosition","0% 0%"),that.parent().parent().next().slideUp()):(that.css("backgroundPosition","0% 100%"),httpRequestPostAsync("/api/ms/modeling/category/listbycategorypid",{categoryApplicationId:categoryApplicationId,categoryPid:id},function(data){if(data.data){for(var html='<ul class="menus">',i=0;i<data.data.length;i++)html+='<li data-option="'+data.data[i].categoryPid+'"><div class="slide-a"><a class="ellipsis" href="javascript:;" '+categoryDescribeView(data.data[i].categoryDescribe)+"><i "+styleSwitch(data.data[i].categoryTypeId,data.data[i].categoryLeaf,data.data[i].categoryAttributeName)+' data-option="'+data.data[i].categoryId+'"></i><span '+nodeStyleSwitch(data.data[i].categoryAttributeName)+' node-option="'+data.data[i].categoryAttributeName+'" type-option="'+data.data[i].categoryTypeId+'" data-option="'+data.data[i].categoryId+'" title="'+data.data[i].categoryName+'">'+subStringWithTail(data.data[i].categoryName,10,"...")+'</span>&nbsp;<p class="treeEdit" bot-info='+toCategoryString(data.data[i])+'><img class="edit" src="images/bot-edit.png"/><img class="delete" style="width: 12px;" src="images/detel.png"/></p></a></div></li>';html+="</ul>",$(html).appendTo(that.parent().parent().parent()),that.parent().parent().next().slideDown()}},function(err){}))}function addBot(){if(""!=$scope.vm.botSelectValue){if(0==lengthCheck($("#category-name").val(),0,50))return void $("#category-name-error").html($scope.vm.categoryNameNullOrBeyondLimit);if(isHtmlLabel($("#category-name").val()))return void $("#category-name-error").html($scope.vm.notContainHtmlLabel);if(0!=repeatCheck("#category-name-error",0)){if(1==nullCheck($("#category-describe").val())){if(0==lengthCheck($("#category-describe").val(),0,2e3))return void $("#category-describe-error").html($scope.vm.categoryDescribeBeyondLimit);if(isHtmlLabel($("#category-describe").val()))return void $("#category-describe-error").html($scope.vm.notContainHtmlLabel);$scope.vm.categoryDescribe=$("#category-describe").val()}httpRequestPost("/api/ms/modeling/category/add",{categoryApplicationId:categoryApplicationId,applicationId:categoryApplicationId,categoryPid:$scope.vm.botSelectValue,categoryAttributeName:$scope.vm.categoryAttributeName,categoryName:$("#category-name").val(),categoryTypeId:$("#category-type").val(),categoryModifierId:categoryModifierId,categorySceneId:categorySceneId,categoryDescribe:$scope.vm.categoryDescribe,categoryLeaf:0},function(data){1==responseView(data)&&($("#category-name").val(""),reloadBot(data,0)),$("#category-describe").val("")},function(err){}),$scope.vm.categoryDescribe=""}}}function repeatCheck(selector,type){var flag=!1,request=new Object;return 1==type?(request.categoryId=$scope.vm.categoryId,request.categoryApplicationId=$scope.vm.categoryApplicationId,request.categoryPid=$scope.vm.categoryPid,request.categoryAttributeName=$scope.vm.categoryAttributeName,request.categoryName=$("#categoryName").val(),request.categorySceneId=categorySceneId):(request.categoryApplicationId=categoryApplicationId,request.categoryPid=$scope.vm.botSelectValue,request.categoryAttributeName=$scope.vm.categoryAttributeName,request.categoryName=$("#category-name").val(),request.categorySceneId=categorySceneId),httpRequestPostAsync("/api/ms/modeling/category/repeatcheck",request,function(data){0==responseWithoutView(data)?data&&$(selector).html(data.info):flag=!0},function(err){}),flag}function reloadBot(data,type){if(0!=type&&$.each($(".aside-navs").find("li"),function(index,value){if($(value).find("i").attr("data-option")==$scope.vm.categoryId){0==$(value).parent().find("li").length-1&&1==type&&$(value).parent().prev().find("i").attr("style","display:none"),$(value).remove()}}),1!=type)if("root"==$scope.vm.botSelectValue)initBot();else{var count=0;$.each($(".aside-navs").find("i"),function(index,value){if(2==type){if($(value).attr("data-option")==data.data[0].categoryPid){count++;var html='<li data-option="'+data.data[0].categoryPid+'"><div class="slide-a"> <a class="ellipsis" href="javascript:;" '+categoryDescribeView(data.data[0].categoryDescribe)+"><i "+styleSwitch(data.data[0].categoryTypeId,data.data[0].categoryLeaf,data.data[0].categoryAttributeName)+' data-option="'+data.data[0].categoryId+'"></i><span '+nodeStyleSwitch(data.data[0].categoryAttributeName)+' node-option="'+data.data[0].categoryAttributeName+'" type-option="'+data.data[0].categoryTypeId+'" data-option="'+data.data[0].categoryId+'" title="'+data.data[0].categoryName+'">'+subStringWithTail(data.data[0].categoryName,10,"...")+'</span>&nbsp;<p class="treeEdit" bot-info='+toCategoryString(data.data[0])+'><img class="edit" src="images/bot-edit.png"/><img class="delete" style="width: 12px;" src="images/detel.png"/></p></a></div></li>';$(value).parent().parent().next().append(html)}}else if(0==type&&$(value).attr("data-option")==data.data[0].categoryPid){count++;var html='<li data-option="'+data.data[0].categoryPid+'"><div class="slide-a"> <a class="ellipsis" href="javascript:;" '+categoryDescribeView(data.data[0].categoryDescribe)+"><i "+styleSwitch(data.data[0].categoryTypeId,data.data[0].categoryLeaf,data.data[0].categoryAttributeName)+' data-option="'+data.data[0].categoryId+'"></i><span '+nodeStyleSwitch(data.data[0].categoryAttributeName)+' node-option="'+data.data[0].categoryAttributeName+'" type-option="'+data.data[0].categoryTypeId+'" data-option="'+data.data[0].categoryId+'" title="'+data.data[0].categoryName+'">'+subStringWithTail(data.data[0].categoryName,10,"...")+'</span>&nbsp;<p class="treeEdit" bot-info='+toCategoryString(data.data[0])+'><img class="edit" src="images/bot-edit.png"/><img class="delete" style="width: 12px;" src="images/detel.png"/></p></a></div></li>',nodeType=($(value).parent().parent().next(),"edge");"node"==data.data[0].categoryAttributeName?nodeType="edge":"edge"==data.data[0].categoryAttributeName&&(nodeType="node");var sty=styleSwitch(data.data[0].categoryTypeId,1,nodeType);if(sty=sty.substring(7,sty.length-1),null!=$(value).parent().parent().next()){var len=$(value).parent().parent().next().find("li").length;len>0?$(value).parent().parent().next().append(html):($(value).parent().parent().next().append(html),$(value).attr("style",sty))}else{var htmlAppend='<ul class="menus show">'+html+"</ul>";$(value).parent().parent().parent().append(htmlAppend),$(value).attr("style",sty)}}}),0==count&&initBot()}}function responseView(data){return null!=data&&(layer.msg(data.info),data.status==$scope.vm.success)}function responseWithoutView(data){return null!=data&&data.status==$scope.vm.success}function botInfoToCategoryAttribute(){if($scope.vm.botInfo){var category=JSON.parse($scope.vm.botInfo);$scope.vm.botSelectValue=category.categoryId,$scope.vm.categoryId=category.categoryId,$scope.vm.categoryTypeId=category.categoryTypeId,categorySceneId=category.categorySceneId,$scope.vm.categoryName=category.categoryName,$scope.vm.categoryAttributeName=category.categoryAttributeName,$scope.vm.categoryPid=category.categoryPid,$scope.vm.categoryApplicationId=category.categoryApplicationId,1==nullCheck(category.categoryDescribe)&&($scope.vm.categoryDescribe=underlineToWhiteSpace(category.categoryDescribe)),$scope.vm.categoryLeaf=category.categoryLeaf}}function disableAttributeType(){$.each($("#category-type").find("option"),function(index,value){"node"==$scope.vm.categoryAttributeName?($(value).attr("disabled",null),$(value).attr("style","")):($(value).val()==$scope.vm.botSelectType)>0?($("#category-type").val($scope.vm.botSelectType),$(value).attr("disabled",null),$(value).attr("style","")):($(value).attr("disabled","disabled"),$(value).attr("style","background-color: lightgrey"))})}function clearColor(){$.each($(".aside-navs").find("span"),function(index,value){"node"==$(this).attr("node-option")?$(this).attr("style",""):"edge"==$(this).attr("node-option")&&$(this).attr("style","color:#ED7D31;")})}function styleSwitch(type,leaf,attrType){var styleHidden="display: inline-block;";if(0==leaf&&(styleHidden="display:none;"),"node"==attrType)return"style='"+styleHidden+"position: relative;top: -1px;margin-right: 2px;width: 15px;height: 15px;vertical-align: middle;background-position: left top;background-repeat: no-repeat;background-image: url(../../images/images/aside-nav-icon.png);'";var style='style="'+styleHidden+'position: relative;top: -1px; margin-right: 5px; width: 15px; height: 15px; vertical-align: middle; background-position: left top; background-repeat: no-repeat;background-image:url(../../images/pic-navs-rq.png);"';switch(type){case 161:style='style="'+styleHidden+'position: relative;top: -1px; margin-right: 5px; width: 15px; height: 15px; vertical-align: middle; background-position: left top; background-repeat: no-repeat;background-image:url(../../images/pic-navs-sx.png);"';break;case 160:style='style="'+styleHidden+'position: relative;top: -1px; margin-right: 5px; width: 15px; height: 15px; vertical-align: middle; background-position: left top; background-repeat: no-repeat;background-image:url(../../images/pic-navs-lc.png);"';break;case 162:style='style="'+styleHidden+'position: relative;top: -1px; margin-right: 5px; width: 15px; height: 15px; vertical-align: middle; background-position: left top; background-repeat: no-repeat;background-image:url(../../images/pic-navs-dy.png);"'}return style}function nodeStyleSwitch(attrType){return"edge"==attrType?"style='color:#ED7D31;'":""}function categoryDescribeView(describeStr){return 1==nullCheck(describeStr)?"title='"+describeStr+"'":""}function downloadTemplate(){downloadFile("/api/ms/knowledgeManage/downloadKnowledgeTemplate","","business_ontology_tree_template.xlsx")}function exportAll(){httpRequestPost("/api/ms/modeling/category/export",{categoryApplicationId:categoryApplicationId},function(data){1==responseView(data)&&data.exportFileNameList.length>0&&downloadFile("/api/ms/modeling/downloadWithPath",data.filePath,data.exportFileNameList[0])})}function batchUpload(){ngDialog.openConfirm({template:"/static/businessModeling/batchUpload.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){initBot()}})&&$timeout(function(){initUpload("/api/ms/modeling/category/batchAdd?applicationId="+categoryApplicationId+"&modifierId="+categoryModifierId+"&sceneId="+categorySceneId+"&pid=root")},100)}$scope.vm={success:1e4,illegal:10003,failed:10004,empty:10005,botSelectValue:"root",categoryNode:"node",categoryEdge:"edge",botRoot:"",knowledgeBotVal:"",botInfo:null,addBot:addBot,editBot:editBot,deleteBot:deleteBot,categoryId:"",categoryTypeId:163,botSelectType:163,categorySceneId:0,categoryAttributeName:"edge",categoryName:"",categoryPid:"",categoryApplicationId:"",categoryLeaf:1,botInfoToCategoryAttribute:botInfoToCategoryAttribute,clearColor:clearColor,repeatCheck:repeatCheck,categoryNameNullOrBeyondLimit:"类目名称为空或超过长度限制50",notContainHtmlLabel:"不能包含HTML标签",categoryDescribeBeyondLimit:"描述内容超过长度限制2000",searchNode:searchNode,recursion:recursion,location:location,autoHeight:autoHeight,downloadTemplate:downloadTemplate,exportAll:exportAll,batchUpload:batchUpload,categoryDescribe:"",suggestionValue:"",suggestionData:"",winHeight:0};var categoryApplicationId=$cookieStore.get("applicationId"),categoryModifierId=$cookieStore.get("userId"),categorySceneId=$cookieStore.get("sceneId");autoHeight();var params={categoryName:$("#category-autocomplete").val(),categoryAttributeName:"node",categoryApplicationId:categoryApplicationId};$("#category-autocomplete").autocomplete({serviceUrl:"/api/ms/modeling/category/searchbycategoryname",type:"POST",params:params,paramName:"categoryName",dataType:"json",transformResult:function(data){var result=new Object,array=[];if(data.data)for(var i=0;i<data.data.length;i++)array[i]={data:data.data[i].categoryId,value:data.data[i].categoryName};return result.suggestions=array,result},onSelect:function(suggestion){searchNode(suggestion),$scope.vm.suggestionValue=suggestion.value,$scope.vm.suggestionData=suggestion.data}}),$interval(function(){if(1==nullCheck($scope.vm.suggestionData)){var suggestion=new Object;suggestion.value=$scope.vm.suggestionValue,suggestion.data=$scope.vm.suggestionData,locationFlag(suggestion)&&(location(suggestion),$scope.vm.suggestionValue="",$scope.vm.suggestionData="")}},2e3),initBot(),$(".aside-navs").on("click","span",function(){clearColor(),$scope.vm.knowledgeBotVal=$(this).html(),$scope.vm.botSelectValue=$(this).attr("data-option"),$scope.vm.botSelectType=$(this).attr("type-option"),$scope.vm.categoryAttributeName=$(this).attr("node-option"),"node"==$scope.vm.categoryAttributeName?$(this).attr("style","color:black;font-weight:bold;"):"edge"==$scope.vm.categoryAttributeName&&$(this).attr("style","color:#ED7D31;font-weight:bold;"),updateCreateMethod($scope.vm.knowledgeBotVal,$scope.vm.categoryAttributeName),disableAttributeType(),$scope.$apply()}),$(".aside-navs").on("click",".edit",function(){$scope.vm.botInfo=$(this).parent().attr("bot-info"),botInfoToCategoryAttribute(),editBot()}),$(".aside-navs").on("click",".delete",function(){$scope.vm.botInfo=$(this).parent().attr("bot-info"),botInfoToCategoryAttribute(),deleteBot()}),$(".aside-navs").on("click","i",function(){appendTree(this)}),$("#category-name").blur(function(){0==lengthCheck($("#category-name").val(),0,50)?$("#category-name-error").html($scope.vm.categoryNameNullOrBeyondLimit):($("#category-name-error").html(""),repeatCheck("#category-name-error",0))})}]),angular.module("myApplicationSettingModule").controller("robotSettingController",["$scope","localStorageService","$state","ngDialog","$http","$cookieStore","$rootScope",function($scope,localStorageService,$state,ngDialog,$http,$cookieStore,$rootScope){function addClassic(){ngDialog.openConfirm({template:"/static/myApplication/applicationConfig/settingContentDialog.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){1===e&&($scope.robot.robotHead=$scope.robot.newRobotHead,httpRequestPost("/api/application/application/saveClassicHead",{robotHead:$scope.robot.robotHead,settingId:$scope.robot.settingId},function(data){200===data.status?(layer.msg("修改头像成功"),$state.reload()):layer.msg("修改头像失敗")},function(){layer.msg("修改头像请求失败")}))}})}function selectClassic(item){$scope.robot.newRobotHead=item}function isHeadPicSize(){document.querySelector("input[type=file]").files[0];ngDialog.closeAll(1)}function addCustom(){ngDialog.openConfirm({template:"/static/myApplication/applicationConfig/settingContentDialog2.html",width:"500px",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){if(1===e){var file=document.querySelector("input[type=file]").files[0],fd=new FormData;fd.append("file",file),fd.append("settingId",$scope.robot.settingId),fd.append("x",$("#x").val()),fd.append("y",$("#y").val()),fd.append("w",$("#w").val()),fd.append("h",$("#h").val()),$http({method:"POST",url:"/api/application/application/uploadHead",data:fd,headers:{"Content-Type":void 0},transformRequest:angular.identity}).success(function(response){200==response.status?(layer.msg("修改头像成功"),$state.reload()):layer.msg("上传头像失敗")})}}})}function parameterLimit(type,val){type?$scope.app[val]<1&&($scope.app[val]=1):$scope.app[val]>1?$scope.app[val]=1:$scope.app[val]<0&&($scope.app[val]=0)}function findRobotSetting(){httpRequestPost("/api/application/application/findRobotSetting",{applicationId:$scope.robot.applicationId},function(data){10005===data.data?($scope.robot.robotExpire="",$scope.robot.robotHead="",$scope.robot.robotHotQuestionTimeout="",$scope.robot.robotLearned="",$scope.robot.robotName="",$scope.robot.robotRepeat="",$scope.robot.robotRepeatNumber="",$scope.robot.robotSensitive="",$scope.robot.robotTimeout="",$scope.robot.robotTimeoutLimit="",$scope.robot.robotUnknown="",$scope.robot.robotWelcome="",$scope.robot.settingId="",$scope.robot.newRobotHead="",$scope.robot.imgUrl=""):($scope.robot.robotExpire=data.data.robotExpire,$scope.robot.robotHead=data.data.robotHead,$scope.robot.imgUrl=data.data.imgUrl,$scope.robot.robotHotQuestionTimeout=data.data.robotHotQuestionTimeout,$scope.robot.robotLearned=data.data.robotLearned,$scope.robot.robotName=data.data.robotName,$scope.robot.robotRepeat=data.data.robotRepeat,$scope.robot.robotRepeatNumber=data.data.robotRepeatNumber,$scope.robot.robotSensitive=data.data.robotSensitive,$scope.robot.robotTimeout=data.data.robotTimeout,$scope.robot.robotTimeoutLimit=data.data.robotTimeoutLimit,$scope.robot.robotUnknown=data.data.robotUnknown,$scope.robot.robotWelcome=data.data.robotWelcome,$scope.robot.settingId=data.data.settingId,$scope.robot.newRobotHead=data.data.robotHead,$scope.$apply())},function(){layer.msg("查询失敗")})}function findApplicationSetting(){httpRequestPost("/api/application/application/findApplicationSetting",{applicationId:$scope.app.applicationId},function(data){10005===data.data?($scope.app.settingCommentOn=1,$scope.app.settingDataTimeoutLimit="",$scope.app.settingGreetingOn=1,$scope.app.settingId="",$scope.app.settingLowerLimit="",$scope.app.settingRecommendNumber="",$scope.app.settingRelateNumber="",$scope.app.settingTurnRoundOn=1,$scope.app.settingUpperLimit="",$scope.app.settingGreetingThreshold="",$scope.app.openDL=!1,$scope.app.dlUpperLimit=0,$scope.app.dlLowerLimit=0):($scope.app.settingCommentOn=data.data.settingCommentOn,$scope.app.settingDataTimeoutLimit=data.data.settingDataTimeoutLimit,$scope.app.settingGreetingOn=data.data.settingGreetingOn,$scope.app.settingGreetingThreshold=data.data.settingGreetingThreshold,$scope.app.settingId=data.data.settingId,$scope.app.settingLowerLimit=data.data.settingLowerLimit,$scope.app.settingRecommendNumber=data.data.settingRecommendNumber,$scope.app.settingRelateNumber=data.data.settingRelateNumber,$scope.app.settingTurnRoundOn=data.data.settingTurnRoundOn,$scope.app.settingUpperLimit=data.data.settingUpperLimit,$scope.app.openDL=data.data.openDL,$scope.app.dlUpperLimit=data.data.dlUpperLimit,$scope.app.dlLowerLimit=data.data.dlLowerLimit,$scope.$apply())},function(){layer.msg("查询失敗")})}function editRobot(flag){flag&&httpRequestPost("/api/application/application/saveRobotSetting",{applicationId:$scope.robot.applicationId,robotExpire:$scope.robot.robotExpire,robotHead:$scope.robot.robotHead,robotHotQuestionTimeout:$scope.robot.robotHotQuestionTimeout,robotLearned:$scope.robot.robotLearned,robotName:$scope.robot.robotName,robotRepeat:$scope.robot.robotRepeat,robotRepeatNumber:$scope.robot.robotRepeatNumber,robotSensitive:$scope.robot.robotSensitive,robotTimeout:$scope.robot.robotTimeout,robotTimeoutLimit:$scope.robot.robotTimeoutLimit,robotUnknown:$scope.robot.robotUnknown,robotUpdateId:$scope.robot.settingUpdateId,robotWelcome:$scope.robot.robotWelcome,settingId:$scope.robot.settingId},function(data){200===data.status?layer.msg("保存成功"):layer.msg("保存失敗")},function(){layer.msg("保存失敗")})}function editApplication(){if($scope.app.dlUpperLimit<$scope.app.dlLowerLimit)return void layer.msg("保存失敗, 深度学习上限阈值必须大于下限阈值");httpRequestPost("/api/application/application/saveApplicationSetting",{applicationId:$scope.app.applicationId,settingCommentOn:$scope.app.settingCommentOn,settingDataTimeoutLimit:$scope.app.settingDataTimeoutLimit,settingGreetingOn:$scope.app.settingGreetingOn,settingGreetingThreshold:$scope.app.settingGreetingThreshold,settingId:$scope.app.settingId,settingLowerLimit:$scope.app.settingLowerLimit,settingRecommendNumber:$scope.app.settingRecommendNumber,settingRelateNumber:$scope.app.settingRelateNumber,settingTurnRoundOn:$scope.app.settingTurnRoundOn,settingUpdateId:$scope.app.settingUpdateId,settingUpperLimit:$scope.app.settingUpperLimit,openDL:$scope.app.openDL,dlUpperLimit:$scope.app.dlUpperLimit,dlLowerLimit:$scope.app.dlLowerLimit},function(data){200===data.status?layer.msg("保存成功"):layer.msg("保存失敗")},function(){layer.msg("保存失敗")})}function turnOn(targetValue,targetName){$scope.app[targetName]=targetValue?0:1}function turnOnBoolean(targetValue,targetName){$scope.app[targetName]=!targetValue}$scope.robot={classicHead:["touxiang1.png","touxiang2.png","touxiang3.png","touxiang4.png","touxiang5.png","touxiang6.png","touxiang7.png","touxiang8.png"],applicationId:$cookieStore.get("applicationId"),userId:$cookieStore.get("userId"),robotExpire:"",robotHead:"",imgUrl:"",newRobotHead:"",robotHotQuestionTimeout:"",robotLearned:"",robotName:"",robotRepeat:"",robotRepeatNumber:"",robotSensitive:"",robotTimeout:"",robotTimeoutLimit:"",robotUnknown:"",robotUpdateId:$cookieStore.get("userId"),robotWelcome:"",settingId:"",editRobot:editRobot,findRobotSetting:findRobotSetting,addClassic:addClassic,addCustom:addCustom,selectClassic:selectClassic,myFile:"",isHeadPicSize:isHeadPicSize},$scope.app={applicationId:$cookieStore.get("applicationId"),userId:$cookieStore.get("userId"),settingCommentOn:1,settingDataTimeoutLimit:"",settingGreetingOn:1,settingGreetingThreshold:"",settingId:"",settingLowerLimit:"",settingRecommendNumber:"",settingRelateNumber:"",settingTurnRoundOn:1,settingUpperLimit:"",openDL:!1,dlUpperLimit:0,dlLowerLimit:0,settingUpdateId:$cookieStore.get("userId"),editApplication:editApplication,findApplicationSetting:findApplicationSetting,turnOn:turnOn,turnOnBoolean:turnOnBoolean,parameterLimit:parameterLimit},findApplicationSetting(),findRobotSetting()}]).directive("checkWelcome",function($http){return{require:"ngModel",link:function(scope,ele,attrs,c){scope.$watch(attrs.ngModel,function(n){if(n){var welcomes=scope.robot.robotWelcome.split("\n");welcomes.length>10?c.$setValidity("len",!1):c.$setValidity("len",!0)}})}}}),angular.module("myApplicationSettingModule").controller("sceneManageController",["$scope","localStorageService","$state","ngDialog","$cookieStore",function($scope,localStorageService,$state,ngDialog,$cookieStore){function findMultiInteractive(){httpRequestPost("/api/application/scene/findMultiInteractiveSetting",{applicationId:$scope.vm.applicationId},function(data){200==data.status?($scope.vm.settingId=data.data.settingId,$scope.vm.categoryFuzzyOn=data.data.categoryFuzzyOn,$scope.vm.recommendedSimilarity=data.data.recommendedSimilarity,$scope.vm.subjectMissingOn=data.data.subjectMissingOn,$scope.vm.subjectMemoryRounds=data.data.subjectMemoryRounds,$scope.vm.memoryMethod=data.data.memoryMethod,$scope.vm.elementMissingOn=data.data.elementMissingOn,$scope.vm.elementRecommendationOrder=data.data.elementRecommendationOrder,$scope.vm.nonZeroStartOn=data.data.nonZeroStartOn,$scope.vm.matchCompleteOn=data.data.matchCompleteOn,$scope.vm.matchTagOn=data.data.matchTagOn,$scope.$apply()):layer.msg("目前还没有进行多轮会话设置")},function(err){layer.msg("请求失败")})}function saveMultiInteractive(){findMultiInteractive();ngDialog.openConfirm({template:"/static/myApplication/applicationConfig/sceneManageDialog.html",width:"600px",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){1===e&&httpRequestPost("/api/application/scene/saveMultiInteractiveSetting",{applicationId:$scope.vm.applicationId,categoryFuzzyOn:$scope.vm.categoryFuzzyOn,elementMissingOn:$scope.vm.elementMissingOn,elementRecommendationOrder:$scope.vm.elementRecommendationOrder,matchCompleteOn:$scope.vm.matchCompleteOn,matchTagOn:$scope.vm.matchTagOn,memoryMethod:$scope.vm.memoryMethod,nonZeroStartOn:$scope.vm.nonZeroStartOn,recommendedSimilarity:$scope.vm.recommendedSimilarity,settingId:$scope.vm.settingId,subjectMemoryRounds:$scope.vm.subjectMemoryRounds,subjectMissingOn:$scope.vm.subjectMissingOn,userId:$scope.vm.userId},function(data){200==data.status?($scope.vm.settingId=data.data.settingId,$scope.vm.categoryFuzzyOn=data.data.categoryFuzzyOn,$scope.vm.recommendedSimilarity=data.data.recommendedSimilarity,$scope.vm.subjectMissingOn=data.data.subjectMissingOn,$scope.vm.subjectMemoryRounds=data.data.subjectMemoryRounds,$scope.vm.memoryMethod=data.data.memoryMethod,$scope.vm.elementMissingOn=data.data.elementMissingOn,$scope.vm.elementRecommendationOrder=data.data.elementRecommendationOrder,$scope.vm.nonZeroStartOn=data.data.nonZeroStartOn,$scope.vm.matchCompleteOn=data.data.matchCompleteOn,$scope.vm.matchTagOn=data.data.matchTagOn,$scope.$apply()):layer.msg("目前还没有进行多轮会话设置")},function(err){layer.msg("请求失败")})}})}function listKnowledgeType(){httpRequestPost("/api/application/scene/listKnowledgeTypeByApplicationId",{applicationId:$scope.vm.applicationId,keyword:$scope.vm.keyword},function(data){$scope.vm.knowledgeTypeData=data.data,$scope.$apply()},function(err){layer.msg("请求失败")})}function listExchangeMode(){httpRequestPost("/api/application/scene/listExchangeModeByApplicationId",{applicationId:$scope.vm.applicationId,keyword:$scope.vm.keyword},function(data){$scope.vm.exchangeModeData=data.data,$scope.$apply()},function(){layer.msg("请求失败")})}function updateKnowledgeType(item){httpRequestPost("/api/application/scene/updateKnowledgeTypeByApplicationId",{applicationId:$scope.vm.applicationId,statusId:item.statusId,knowledgeTypeId:item.knowledgeTypeId},function(data){layer.msg("更新知识类型成功！"),listExchangeMode(),listKnowledgeType()},function(){layer.msg("请求失败")})}function updateExchangeMode(item){httpRequestPost("/api/application/scene/updateExchangeModeByApplicationId",{applicationId:$scope.vm.applicationId,statusId:item.statusId,exchangeModeId:item.exchangeModeId},function(data){layer.msg("更新交互方式成功！"),listExchangeMode(),listKnowledgeType(),$("#exchangeMode").click()},function(){layer.msg("请求失败")})}function turnOn(targetValue,targetName){$scope.vm[targetName]=targetValue?0:1}function turnOn2(targetValue,targetName){$scope.vm[targetName]=targetValue?0:1,0==$scope.vm[targetName]?($scope.vm.subjectMemoryRounds="",$scope.vm.memoryMethod=""):($scope.vm.subjectMemoryRounds=3,$scope.vm.memoryMethod=1)}$scope.vm={applicationId:$cookieStore.get("applicationId"),keyword:"",exchangeModeId:"",knowledgeTypeId:"",statusId:"",knowledgeTypeData:"",exchangeModeData:"",listKnowledgeType:listKnowledgeType,listExchangeMode:listExchangeMode,updateKnowledgeType:updateKnowledgeType,updateExchangeMode:updateExchangeMode,saveMultiInteractive:saveMultiInteractive,findMultiInteractive:findMultiInteractive,turnOn:turnOn,turnOn2:turnOn2,settingId:"",categoryFuzzyOn:1,recommendedSimilarity:.5,subjectMissingOn:1,subjectMemoryRounds:3,memoryMethod:1,elementMissingOn:1,elementRecommendationOrder:1,nonZeroStartOn:1,matchCompleteOn:1,matchTagOn:1,userId:$cookieStore.get("userId"),sceneId:$cookieStore.get("sceneId")},listKnowledgeType(),listExchangeMode()}]),angular.module("myApplicationSettingModule").controller("serviceReleaseController",["$scope","localStorageService","$state","ngDialog","$cookieStore","$timeout","$interval",function($scope,localStorageService,$state,ngDialog,$cookieStore,$timeout,$interval){function findServiceByServiceId(serviceId){$scope.vm.dialogTitle="编辑服务",httpRequestPost("/api/application/service/findServiceById",{serviceId:serviceId},function(data){if(200==data.status){$scope.vm.appName=data.data.appName,$scope.vm.categoryIds=data.data.categoryIds,$scope.vm.newCategoryIds=data.data.categoryIds,$scope.vm.channels=data.data.channels,$scope.vm.nodeCode=data.data.nodeCode,$scope.vm.serviceName=data.data.serviceName,$scope.vm.serviceStatus=data.data.serviceStatus,$scope.vm.serviceType=data.data.serviceType,$scope.vm.serviceId=data.data.serviceId;var dimensionSelected=[];$scope.vm.dimensionAll=$scope.vm.originDimensionAll,angular.forEach(data.data.dimensions,function(dimensionId){angular.forEach($scope.vm.dimensionAll,function(dimension){dimensionId==dimension.dimensionId&&dimensionSelected.push(dimension)})}),$scope.vm.dimensionSelected=dimensionSelected,$scope.$apply(),httpRequestPost("/api/application/node/findParentNodeInfo",{nodeCode:data.data.nodeCode},function(data){200==data.status?($scope.vm.nodeData.push(data.data),$scope.$apply()):layer.msg("查询节点信息失败")},function(){layer.msg("请求失败")})}else layer.msg("查询服务失败")},function(){layer.msg("请求失败")})}function verifyRelease(){return null==$scope.vm.serviceName||""==$scope.vm.serviceName?(layer.msg("发布服务的名称不能为空!"),$scope.vm.allowSubmit=0,0):null==$scope.vm.categoryIds||0==$scope.vm.categoryIds.length?(layer.msg("发布服务时未选择分类!"),$scope.vm.allowSubmit=0,0):null==$scope.vm.nodeCode||""==$scope.vm.nodeCode?(layer.msg("发布服务时未选择发布节点!"),$scope.vm.allowSubmit=0,0):null==$scope.vm.serviceType||""==$scope.vm.serviceType?(layer.msg("发布服务时未选择发布类型!"),$scope.vm.allowSubmit=0,0):1}function addAndPublishService(){listDimensionData(),initPublishServiceInput(),listNodeData(),$scope.vm.dialogTitle="发布新服务";var edit=$interval(function(){if($scope.vm.channels){$interval.cancel(edit);ngDialog.openConfirm({template:"/static/myApplication/applicationRelease/NewServiceRelease.html",width:"700px",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){1===e&&($scope.vm.dimensions=$scope.vm.dimensionSelected.id,null!=$scope.vm.channels&&0!=$scope.vm.channels.length||angular.forEach($scope.vm.channelData,function(channel){$scope.vm.channels.push(channel.channelCode)}),null!=$scope.vm.dimensions&&0!=$scope.vm.dimensions.length||($scope.vm.dimensionAll=$scope.vm.originDimensionAll,angular.forEach($scope.vm.dimensionAll,function(dimension){$scope.vm.dimensions.push(dimension.dimensionId)})),$scope.vm.allowSubmit&&httpRequestPost("/api/application/service/addAndPublishService",{applicationId:$scope.vm.applicationId,categoryIds:$scope.vm.categoryIds,channels:$scope.vm.channels,dimensions:$scope.vm.dimensions,nodeCode:$scope.vm.nodeCode,serviceName:$scope.vm.serviceName,serviceType:$scope.vm.serviceType,userId:$scope.vm.userId,userName:$scope.vm.userName},function(data){200==data.status?listServiceData(1):layer.msg("新增发布服务失败")},function(){layer.msg("请求失败")})),initPublishServiceInput()}})}},5)}function initPublishServiceInput(){$scope.vm.categoryIds=[],$scope.vm.newCategoryIds=[],$scope.vm.channels=[],$scope.vm.dimensions=[],$scope.vm.nodeCode="",$scope.vm.serviceName="",$scope.vm.serviceType="",$scope.vm.dimensionSelected=[],$scope.vm.dimensionAll=$scope.vm.originDimensionAll}function editService(serviceId){listDimensionData(),initPublishServiceInput(),findServiceByServiceId(serviceId),listNodeData();var edit=$interval(function(){if($scope.vm.channels){$interval.cancel(edit);ngDialog.openConfirm({template:"/static/myApplication/applicationRelease/NewServiceRelease.html",width:"700px",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){1===e&&$scope.vm.allowSubmit&&(0==$scope.vm.dimensionSelected.id.length?angular.forEach($scope.vm.originDimensionAll,function(item){$scope.vm.dimensions.push(item.dimensionId)}):$scope.vm.dimensions=$scope.vm.dimensionSelected.id,httpRequestPost("/api/application/service/editService",{applicationId:$scope.vm.applicationId,categoryIds:$scope.vm.categoryIds,channels:$scope.vm.channels,dimensions:$scope.vm.dimensions,nodeCode:$scope.vm.nodeCode,serviceName:$scope.vm.serviceName,serviceType:$scope.vm.serviceType,userId:$scope.vm.userId,serviceId:$scope.vm.serviceId},function(data){200==data.status?listServiceData(1):layer.msg("新增发布服务失败")},function(){layer.msg("请求失败")})),initPublishServiceInput()}})}},5)}function listServiceData(index){httpRequestPost("/api/application/service/listServiceByPage",{applicationId:$scope.vm.applicationId,index:(index-1)*$scope.vm.pageSize,pageSize:$scope.vm.pageSize},function(data){$scope.vm.serviceData=data.data,$scope.vm.dataTotal=data.total,$scope.vm.paginationConf={currentPage:index,totalItems:data.total,pageSize:$scope.vm.pageSize,pagesLength:8},$scope.$apply()},function(){layer.msg("请求失败")})}function publishService(serviceId){layer.confirm("确认发布服务？",{btn:["确认","取消"],shade:!1},function(index){layer.close(index),httpRequestPost("/api/application/service/publishService",{serviceId:serviceId,applicationId:$scope.vm.applicationId,userId:$scope.vm.userId,userName:$scope.vm.userName},function(data){200==data.status?(layer.msg("发布服务成功"),listServiceData(1)):layer.msg("发布服务失败")},function(){layer.msg("请求失败")})},function(){})}function startService(serviceId){layer.confirm("确认上线服务？",{btn:["确认","取消"],shade:!1},function(index){layer.close(index),httpRequestPost("/api/application/service/startService",{serviceId:serviceId},function(data){200==data.status?(layer.msg("上线服务成功"),listServiceData(1)):layer.msg("上线服务失败")},function(){layer.msg("请求失败")})},function(){})}function stopService(serviceId){layer.confirm("确认下线服务？",{btn:["确认","取消"],shade:!1},function(index){layer.close(index),httpRequestPost("/api/application/service/stopService",{serviceId:serviceId},function(data){200==data.status?(layer.msg("下线服务成功"),listServiceData(1)):layer.msg("下线服务失败")},function(){layer.msg("请求失败")})},function(){})}function restartService(serviceId){layer.confirm("确认重启？",{btn:["确认","取消"],shade:!1},function(index){layer.close(index),httpRequestPost("/api/application/service/restartService",{serviceId:serviceId},function(data){200==data.status?(layer.msg("重启服务成功"),listServiceData(1)):layer.msg("重启服务失败")},function(){layer.msg("请求失败")})},function(){})}function deleteService(serviceId){layer.confirm("确认删除当前服务？",{btn:["确认","取消"],shade:!1},function(index){layer.close(index),httpRequestPost("/api/application/service/deleteService",{serviceId:serviceId,applicationId:$scope.vm.applicationId,userId:$scope.vm.userId,userName:$scope.vm.userName},function(data){200==data.status?(layer.msg("删除服务成功"),listServiceData(1)):layer.msg("删除服务失败")},function(){layer.msg("请求失败")})},function(){})}function listChannelData(){httpRequestPost("/api/application/channel/listChannels",{applicationId:$scope.vm.applicationId},function(data){200==data.status?($scope.vm.channelData=data.data,$scope.$apply()):layer.msg("查询渠道失败")},function(){layer.msg("请求失败")})}function listTypeData(){httpRequestPost("/api/application/service/listServiceType",{},function(data){200==data.status?($scope.vm.typeData=data.data,$scope.$apply()):layer.msg("查询服务类型失败")},function(){layer.msg("请求失败")})}function listNodeData(){httpRequestPost("/api/application/node/listNoUsingNode",{},function(data){200==data.status?($scope.vm.nodeData=data.data,$scope.$apply()):layer.msg("查询可用节点失败")},function(){layer.msg("请求失败")})}function listDimensionData(){httpRequestPost("/api/application/dimension/list",{applicationId:$scope.vm.applicationId},function(data){data.data&&($scope.vm.dimensionAll=data.data,$scope.vm.originDimensionAll=data.data,$scope.$apply())},function(err){layer.msg("获取维度失败，请刷新页面")})}function selectChannel(channelId){null==$scope.vm.channels&&($scope.vm.channels=[]),$scope.vm.channels.inArray(channelId)?$scope.vm.channels.remove(channelId):$scope.vm.channels.push(channelId)}function listCategory(){ngDialog.openConfirm({template:"/static/myApplication/applicationRelease/NewServiceReleaseDialog.html",scope:$scope,closeByDocument:!1,closeByEscape:!0,showClose:!0,backdrop:"static",preCloseCallback:function(e){1===e&&($scope.vm.categoryIds=$scope.vm.newCategoryIds)}});$timeout(function(){relationBot()},200)}function relationBot(){function getBotRoot(){httpRequestPost("/api/ms/modeling/category/listbycategorypid",{categoryApplicationId:$scope.vm.applicationId,categoryPid:"root"},function(data){$scope.vm.botRoot=data.data,$scope.$apply()},function(){layer.msg("获取BOT分类失败")})}getBotRoot(),$(".aside-navs-cont").on("click",".botSelect",function(){var self=angular.element(this),id=self.attr("data-option");self.prop("checked")?($scope.vm.newCategoryIds.push(id),$scope.$apply()):($scope.vm.newCategoryIds.remove(id),$scope.$apply())}),$(".aside-navs-cont").on("click",".icon-jj",function(){var id=$(this).attr("data-option"),that=$(this);that.parent().parent().siblings().length?"0% 0%"==that.css("backgroundPosition")?(that.css("backgroundPosition","0% 100%"),that.parent().parent().next().slideDown()):(that.css("backgroundPosition","0% 0%"),that.parent().parent().next().slideUp()):(that.css("backgroundPosition","0% 100%"),httpRequestPost("/api/ms/modeling/category/listbycategorypid",{categoryApplicationId:$scope.vm.applicationId,categoryPid:id},function(data){if(data.data){for(var html='<ul class="menus">',i=0;i<data.data.length;i++){var checkbox="";null!=$scope.vm.categoryIds&&(checkbox=$scope.vm.categoryIds.inArray(data.data[i].categoryId)),html+='<li><div class="slide-a"> <a class="ellipsis" href="javascript:;"><i class="icon-jj" data-option="'+data.data[i].categoryId+'"></i><input type="checkbox" class="botSelect" ',checkbox&&(html+=" checked "),html+='data-option="'+data.data[i].categoryId+'"/><span>'+data.data[i].categoryName+"</span></a></div></li>"}html+="</ul>",$(html).appendTo(that.parent().parent().parent()),that.parent().parent().next().slideDown()}},function(err){alert(err)}))})}$scope.vm={applicationId:$cookieStore.get("applicationId"),serviceData:"",paginationConf:"",pageSize:5,dataTotal:"",publishService:publishService,startService:startService,stopService:stopService,restartService:restartService,deleteService:deleteService,editService:editService,addAndPublishService:addAndPublishService,appName:"",categoryIds:[],channels:[],dimensionSelected:[],dimensionAll:[],originDimensionAll:[],dimensions:[],nodeCode:"",serviceId:"",serviceName:"",serviceStatus:0,serviceType:10,userId:$cookieStore.get("userId"),userName:$cookieStore.get("userLoginName"),categoryData:"",channelData:"",dimensionData:"",typeData:"",nodeData:"",dialogTitle:"",allowSubmit:1,selectChannel:selectChannel,listCategory:listCategory,listNodeData:listNodeData,listChannelData:listChannelData,listTypeData:listTypeData,listDimensionData:listDimensionData,findServiceByServiceId:findServiceByServiceId,botRoot:"",newCategoryIds:[],verifyRelease:verifyRelease},listDimensionData(),listChannelData(),listTypeData(),listServiceData(1);var timeout;$scope.$watch("vm.paginationConf.currentPage",function(current){current&&(timeout&&$timeout.cancel(timeout),timeout=$timeout(function(){listServiceData(current)},100))},!0)}]),angular.module("myApplicationSettingModule").controller("myApplicationSettingController",["$scope","$state","$stateParams","$cookieStore","$rootScope",function($scope,$state,$stateParams,$cookieStore,$rootScope){function isSlide(event){var self=event.target;$(self).hasClass("slideActive")?$(self).removeClass("slideActive").next(".menu_1").stop().slideToggle():$(self).addClass("slideActive").next(".menu_1").stop().slideToggle()}function isSlide2(event){var self=event.target;$(self).hasClass("slideActive")?$(self).removeClass("slideActive").parent().next(".menu_1").stop().slideToggle():$(self).addClass("slideActive").parent().next(".menu_1").stop().slideToggle()}function findRobotHead(){httpRequestPost("/api/application/application/findRobotSetting",{applicationId:APPLICATION_ID},function(data){10005===data.data?$scope.master.headImage="":($cookieStore.put("robotHead","/images/"+data.data.robotHead),$scope.master.headImage="/images/"+data.data.robotHead,$scope.vm.robotName=data.data.robotName,$scope.$apply())},function(){})}$scope.vm={isSlide:isSlide,isSlide2:isSlide2,sceneId:$cookieStore.get("sceneId"),applicationName:$cookieStore.get("applicationName"),robotName:""},findRobotHead()}]);